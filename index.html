
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BeaBoo</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4653147807800151" crossorigin="anonymous"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS completo con gradientes (optimizado para no bloquear) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Configuraci√≥n de Tailwind optimizada - incluye gradientes sin bloqueos
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'beaboo': {
              'primary': '#FE2C55',
              'secondary': '#25F4EE',
              'pink-light': '#FFE8EC'
            }
          }
        }
      },
      // Configuraci√≥n que evita scanning aggressive (previene bloqueos)
      content: [],
      // Separador de clases simple para evitar regex complejos
      separator: ':'
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pap6t+K2bD6xIxQqkQ3sM8e+RXw7C3DyrgXV++o2aL/88+/9kS/l+SmpD8zZR1oN40Nq3QfT7HigDYfFW1zZAQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    /* ===== BEABOO 2.0 - TEMA TIKTOK CON COLORES ROSA PASTEL ===== */
    :root {
      /* Colores principales TikTok Style */
      --beaboo-primary: #FE2C55;
      --beaboo-secondary: #25F4EE;
      --beaboo-pink-light: #FFB7C5;
      --beaboo-pink-pastel: #FFC1D9;
      --beaboo-pink-soft: #FFE4E8;
      --beaboo-pink-bg: #FFF5F7;
      --beaboo-teal: #25F4EE;
      --beaboo-purple: #9747FF;
      --beaboo-gradient: linear-gradient(135deg, #FE2C55, #FF6B7A, #FFB7C5);
      --beaboo-gradient-soft: linear-gradient(135deg, #FFE4E8, #FFF5F7, #FFFFFF);
      --beaboo-shadow: 0 4px 20px rgba(254, 44, 85, 0.15);
      --beaboo-shadow-hover: 0 8px 30px rgba(254, 44, 85, 0.25);
    }

    /* ESTILOS BASE MEJORADOS CON TEMA TIKTOK */
    body {
      font-family: 'Nunito', 'Roboto', sans-serif;
      background: var(--beaboo-pink-bg);
      color: #1a1a1a;
      transition: all 0.3s ease;
    }

    /* Gradientes TikTok para elementos principales */
    .beaboo-gradient {
      background: var(--beaboo-gradient);
    }

    .beaboo-gradient-soft {
      background: var(--beaboo-gradient-soft);
    }

    /* Botones estilo TikTok */
    .beaboo-btn {
      background: var(--beaboo-gradient);
      border: none;
      border-radius: 25px;
      color: white;
      font-weight: 700;
      padding: 12px 24px;
      box-shadow: var(--beaboo-shadow);
      transition: all 0.3s ease;
      text-transform: none;
    }

    .beaboo-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--beaboo-shadow-hover);
    }

    /* Tarjetas con estilo TikTok */
    .beaboo-card {
      background: white;
      border-radius: 20px;
      box-shadow: var(--beaboo-shadow);
      border: 1px solid var(--beaboo-pink-light);
      transition: all 0.3s ease;
    }

    .beaboo-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--beaboo-shadow-hover);
    }

/* Ocultar t√≠tulo "Cap√≠tulos" y tagline en la pantalla de inicio */
#detail-chapters-title,
#tagline {
  display: none;
}

/* BEABOO 2.0 - L√≠nea divisoria con gradiente TikTok */
.section-divider {
  background: var(--beaboo-gradient);
  height: 3px;
  border: none;
  border-radius: 2px;
  margin: 24px 0;
  box-shadow: var(--beaboo-shadow);
}

/* Estrellas con efectos TikTok mejorados */
.star.selected {
  color: var(--beaboo-primary);
  transition: all 0.3s ease-in-out;
  text-shadow: 0 0 15px rgba(254,44,85,0.6);
  transform: scale(1.1);
}

.star {
  transition: all 0.3s ease-in-out;
  cursor: pointer;
}

.star:hover {
  color: var(--beaboo-pink-light);
  transform: scale(1.05);
}

/* BEABOO 2.0 - Tarjetas de historias estilo TikTok */
.story-card {
  background: white;
  border-radius: 20px;
  box-shadow: var(--beaboo-shadow);
  border: 1px solid var(--beaboo-pink-light);
  transition: all 0.3s ease;
  overflow: hidden;
  position: relative;
}

.story-card:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: var(--beaboo-shadow-hover);
  border-color: var(--beaboo-primary);
}

.story-card:before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--beaboo-gradient);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.story-card:hover:before {
  opacity: 1;
}

/* Im√°genes de portada con efectos TikTok */
.story-cover-image {
  border-radius: 16px;
  transition: all 0.3s ease;
  filter: brightness(1.05) saturate(1.1);
}

.story-card:hover .story-cover-image {
  transform: scale(1.05);
  filter: brightness(1.1) saturate(1.2);
}

/* Contenedor de portada */
.story-cover-container {
  position: relative;
  overflow: hidden;
  border-radius: 16px;
}

/* Margen para la lista de cap√≠tulos */
#detail-chapters {
  margin-top: 10px;
}

/* Perfiles con estilo TikTok */
.profile-image {
  border: 3px solid var(--beaboo-pink-light);
  box-shadow: var(--beaboo-shadow);
  transition: all 0.3s ease;
}

.profile-image:hover {
  border-color: var(--beaboo-primary);
  transform: scale(1.05);
  box-shadow: var(--beaboo-shadow-hover);
}

/* Headers mejorados */
#story-title-header {
  color: var(--beaboo-primary);
  font-weight: 600;
}

/* Notificaciones */
.notification-item {
  padding: 10px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-bottom: 8px;
  background: #f9f9f9;
  color: #000;
}

.notification-time {
  font-size: 0.8em;
  color: #FE2C55;
  margin-top: 4px;
}

/* Etiqueta de fundador */
.founder-tag {
  font-size: 0.8rem;
  color: #FE2C55;
  background-color: rgba(254,44,85,0.15);
  border-radius: 4px;
  padding: 2px 4px;
  margin-left: 4px;
}

/* BEABOO 2.0 - Barra inferior estilo TikTok */
#bottom-nav {
  background: linear-gradient(135deg, rgba(255,196,217,0.95), rgba(255,255,255,0.95));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  transition: all 0.3s ease-in-out;
  border-top: 2px solid var(--beaboo-pink-light);
  box-shadow: 0 -4px 20px rgba(254,44,85,0.1);
}

/* Iconos de navegaci√≥n con efectos TikTok */
#bottom-nav button {
  transition: all 0.3s ease;
  border-radius: 15px;
  padding: 8px;
}

#bottom-nav button:hover {
  background: var(--beaboo-pink-soft);
  transform: translateY(-2px);
}

/* Notificaciones estilo TikTok */
.notification-item {
  padding: 16px;
  border: 1px solid var(--beaboo-pink-light);
  border-radius: 16px;
  margin-bottom: 12px;
  background: linear-gradient(135deg, white, var(--beaboo-pink-bg));
  color: #1a1a1a;
  box-shadow: var(--beaboo-shadow);
  transition: all 0.3s ease;
}

.notification-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--beaboo-shadow-hover);
}

.notification-time {
  font-size: 0.8em;
  color: var(--beaboo-primary);
  font-weight: 600;
  margin-top: 6px;
}

/* Etiqueta de fundador con gradiente */
.founder-tag {
  font-size: 0.8rem;
  color: white;
  background: var(--beaboo-gradient);
  border-radius: 8px;
  padding: 4px 8px;
  margin-left: 6px;
  font-weight: 600;
  box-shadow: var(--beaboo-shadow);
}

/* --- MODALES CON Z-INDEX ALTO --- */
/* BEABOO 2.0 - CSS actualizado para modales */
#followers-modal,
#following-modal,
#admin-response-modal {
  z-index: 9999 !important;
}

/* Report modal ya no necesita CSS legacy - usa Tailwind classes */

    /* MODAL DE ERROR PARA USUARIO BLOQUEADO (CORREGIDO - YA NO BLOQUEA) */
#blocked-error-modal {
  position: fixed;
  inset: 0;
  display: none;
  background-color: white;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#blocked-error-modal img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* CR√çTICO: Bot√≥n de cerrar SIEMPRE visible (corrige bloqueos) */
#blocked-error-modal button {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  background: rgba(0,0,0,0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 20px;
  cursor: pointer;
  display: flex !important;
  align-items: center;
  justify-content: center;
}

/* MODAL DE CREACI√ìN DE CAP√çTULO FULL SCREEN MODERNIZADO */
#chapter-creation-modal {
  position: fixed;
  inset: 0;
  display: none;
  background-color: rgba(255, 255, 255, 0.8);
  justify-content: center;
  align-items: center;
  z-index: 50;
}

#chapter-creation-modal .modal-content {
  background: white;
  width: 100%;
  height: 100%;
  padding: 1.5rem;
  position: relative;
  overflow: auto;
  color: #000;
}

/* PORTADAS DE HISTORIAS ADAPTATIVAS */
.story-card {
  flex-shrink: 0;
  width: 100%;
  max-width: 250px;
}

@media (max-width: 640px) {
  .story-card {
    max-width: 160px;
  }
}

.story-cover-container {
  position: relative;
  width: 100%;
  padding-top: 133.33%;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.story-cover-image {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.rating-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background-color: #FE2C55;
  color: white;
  border-radius: 9999px;
  padding: 2px 6px;
  font-size: 0.75rem;
  font-weight: bold;
  z-index: 10;
}

/* ANIMACI√ìN DE CARGA EN B√öSQUEDA ESTILO TIKTOK */
#search-loading {
  position: relative;
  width: 80px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 20px auto;
}

#search-loading .tiktok-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin: 0 3px;
  animation: tiktokBounce 1.4s ease-in-out infinite both;
}

#search-loading .tiktok-dot:nth-child(1) {
  background: linear-gradient(45deg, #FE2C55, #ff6b7a);
  animation-delay: -0.32s;
}

#search-loading .tiktok-dot:nth-child(2) {
  background: linear-gradient(45deg, #25F4EE, #00d4db);
  animation-delay: -0.16s;
}

#search-loading .tiktok-dot:nth-child(3) {
  background: linear-gradient(45deg, #FE2C55, #ff6b7a);
  animation-delay: 0s;
}

@keyframes tiktokBounce {
  0%, 80%, 100% {
    transform: scale(0.8) translateY(0);
    opacity: 0.7;
  }
  40% {
    transform: scale(1.2) translateY(-15px);
    opacity: 1;
    box-shadow: 0 8px 20px rgba(254, 44, 85, 0.3);
  }
}

/* Animaci√≥n alternativa de pulsaci√≥n */
#search-loading.pulse-mode {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(45deg, #FE2C55, #25F4EE, #FE2C55);
  background-size: 200% 200%;
  animation: tiktokPulse 2s ease-in-out infinite, gradientShift 3s ease-in-out infinite;
  display: flex;
  align-items: center;
  justify-content: center;
}

@keyframes tiktokPulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(254, 44, 85, 0.7);
  }
  50% {
    transform: scale(1.1);
    box-shadow: 0 0 0 20px rgba(254, 44, 85, 0);
  }
}

@keyframes gradientShift {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* Spinner moderno adicional */
#search-loading.spinner-mode {
  width: 50px;
  height: 50px;
  border: 3px solid transparent;
  border-top: 3px solid #FE2C55;
  border-right: 3px solid #25F4EE;
  border-radius: 50%;
  animation: modernSpin 1s linear infinite;
  position: relative;
}

#search-loading.spinner-mode::before {
  content: '';
  position: absolute;
  top: -6px;
  left: -6px;
  right: -6px;
  bottom: -6px;
  border: 2px solid transparent;
  border-top: 2px solid #25F4EE;
  border-left: 2px solid #FE2C55;
  border-radius: 50%;
  animation: modernSpin 1.5s linear infinite reverse;
}

@keyframes modernSpin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* ANIMACI√ìN PARA BORDE "LIVE" */
@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(254, 44, 85, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(254, 44, 85, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(254, 44, 85, 0);
  }
}

.live-border {
  border: 4px solid #FE2C55;
  border-radius: 50%;
  position: relative;
  animation: pulse 2s infinite;
}

.live-border::after {
  content: "";
  position: absolute;
  top: -4px;
  left: -4px;
  width: calc(100% + 8px);
  height: calc(100% + 8px);
  border: 2px solid #FE2C55;
  border-radius: 50%;
  animation: pulse 2s infinite;
  pointer-events: none;
}
    /* ----------------- MODIFICACIONES AGREGADAS ----------------- */
    /* Bot√≥n de iniciar transmisi√≥n en vivo: forma circular y sin texto */
    #live-startBtn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #00c6ba, #0082c6);
      box-shadow: 0 4px 10px rgba(0, 198, 186, 0.4);
    }

    /* Ocultar la cruz en el transmisor (se mantiene oculta) */
    #live-closeBtn {
      display: none !important;
      /* Asegura que no se muestre */
    }

    /* Panel de estad√≠sticas en edici√≥n */
    .stats-panel>div:not(:last-child) {
      border-right: 1px solid #1e4994;
    }

    /* Gift Drawer: modal de regalos que se desliza desde abajo */
    #gift-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0;
      background-color: #0d1935;
      overflow: hidden;
      transition: height 0.4s ease;
      z-index: 10000;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.5);
      border-top: 1px solid #1e4994;
    }

    #gift-drawer.open {
      height: 50vh;
      overflow-y: auto;
    }

    #gift-drawer .gift-container {
      padding: 20px;
    }

    #gift-drawer .gift-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      text-align: center;
    }

    #gift-drawer .gift-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #gift-drawer .gift-item span {
      font-size: 0.8rem;
      margin-top: 4px;
      display: block;
      color: #e6f0ff;
    }

    /* Animaci√≥n del regalo (overlay) ‚Äì ajustada para ocupar todo el ancho y centrarse */
    #gift-animation {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 50vh;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 11000;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.5s ease-out;
      font-size: 0.8rem;
      padding: 5px;
    }

    /* MARCOS ANIMADOS PARA FOTOS DE PERFIL */
    .rainbow-frame {
      border: 4px solid;
      border-image: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet) 1;
      animation: rainbow-rotate 3s linear infinite;
    }

    @keyframes rainbow-rotate {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }

    .fire-frame {
      border: 4px solid #ff4500;
      animation: fire-pulse 1.5s ease-in-out infinite alternate;
      box-shadow: 0 0 20px #ff4500;
    }

    @keyframes fire-pulse {
      0% { 
        border-color: #ff4500; 
        box-shadow: 0 0 20px #ff4500, inset 0 0 20px #ff6500;
      }
      50% { 
        border-color: #ff6500; 
        box-shadow: 0 0 30px #ff6500, inset 0 0 30px #ff8500;
      }
      100% { 
        border-color: #ff8500; 
        box-shadow: 0 0 40px #ff8500, inset 0 0 40px #ffa500;
      }
    }

    .electric-frame {
      border: 4px solid #00ffff;
      animation: electric-spark 0.8s ease-in-out infinite;
      box-shadow: 0 0 15px #00ffff;
    }

    @keyframes electric-spark {
      0%, 100% { 
        border-color: #00ffff; 
        box-shadow: 0 0 15px #00ffff;
      }
      25% { 
        border-color: #66ffff; 
        box-shadow: 0 0 25px #66ffff, 0 0 35px #00ccff;
      }
      50% { 
        border-color: #ffffff; 
        box-shadow: 0 0 35px #ffffff, 0 0 45px #00ffff;
      }
      75% { 
        border-color: #ccffff; 
        box-shadow: 0 0 25px #ccffff, 0 0 35px #00aaff;
      }
    }

    .galaxy-frame {
      border: 4px solid #4b0082;
      background: linear-gradient(45deg, #4b0082, #8a2be2, #9932cc, #ba55d3);
      background-size: 400% 400%;
      animation: galaxy-drift 4s ease-in-out infinite;
      position: relative;
    }

    .galaxy-frame::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: linear-gradient(45deg, #ffffff, #ffff00, #ffffff);
      border-radius: 50%;
      z-index: -1;
      animation: stars-twinkle 2s ease-in-out infinite alternate;
    }

    @keyframes galaxy-drift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes stars-twinkle {
      0% { opacity: 0.3; }
      100% { opacity: 0.8; }
    }

    .diamond-frame {
      border: 4px solid #b9f2ff;
      animation: diamond-sparkle 2s ease-in-out infinite;
      box-shadow: 0 0 20px #b9f2ff;
      position: relative;
    }

    .diamond-frame::before {
      content: '‚ú®';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 16px;
      animation: sparkle-rotate 3s linear infinite;
    }

    .diamond-frame::after {
      content: 'üíé';
      position: absolute;
      bottom: -10px;
      left: -10px;
      font-size: 16px;
      animation: sparkle-rotate 3s linear infinite reverse;
    }

    @keyframes diamond-sparkle {
      0%, 100% { 
        border-color: #b9f2ff; 
        box-shadow: 0 0 20px #b9f2ff;
      }
      50% { 
        border-color: #ffffff; 
        box-shadow: 0 0 30px #ffffff, 0 0 40px #b9f2ff;
      }
    }

    @keyframes sparkle-rotate {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.2); }
      100% { transform: rotate(360deg) scale(1); }
    }

    /* Aplicar marcos al perfil */
    #profile-frame.rainbow { 
      border: 4px solid;
      border-image: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet) 1;
      animation: rainbow-rotate 3s linear infinite;
    }

    #profile-frame.fire { 
      border: 4px solid #ff4500;
      animation: fire-pulse 1.5s ease-in-out infinite alternate;
      box-shadow: 0 0 20px #ff4500;
    }

    #profile-frame.electric { 
      border: 4px solid #00ffff;
      animation: electric-spark 0.8s ease-in-out infinite;
      box-shadow: 0 0 15px #00ffff;
    }

    #profile-frame.galaxy { 
      border: 4px solid #4b0082;
      background: linear-gradient(45deg, #4b0082, #8a2be2, #9932cc, #ba55d3);
      background-size: 400% 400%;
      animation: galaxy-drift 4s ease-in-out infinite;
    }

    #profile-frame.galaxy::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: linear-gradient(45deg, #ffffff, #ffff00, #ffffff);
      border-radius: 50%;
      z-index: -1;
      animation: stars-twinkle 2s ease-in-out infinite alternate;
    }

    #profile-frame.diamond { 
      border: 4px solid #b9f2ff;
      animation: diamond-sparkle 2s ease-in-out infinite;
      box-shadow: 0 0 20px #b9f2ff;
    }

    #profile-frame.diamond::before {
      content: '‚ú®';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 16px;
      animation: sparkle-rotate 3s linear infinite;
    }

    #profile-frame.diamond::after {
      content: 'üíé';
      position: absolute;
      bottom: -10px;
      left: -10px;
      font-size: 16px;
      animation: sparkle-rotate 3s linear infinite reverse;
    }

    /* Nuevos marcos */
    .neon-frame {
      border: 4px solid #00ff88;
      animation: neon-glow 2s ease-in-out infinite alternate;
      box-shadow: 0 0 20px #00ff88, inset 0 0 20px #00ff88;
    }

    @keyframes neon-glow {
      0% { 
        border-color: #00ff88; 
        box-shadow: 0 0 20px #00ff88, inset 0 0 20px #00ff88;
      }
      100% { 
        border-color: #00ffff; 
        box-shadow: 0 0 30px #00ffff, inset 0 0 30px #00ffff;
      }
    }

    .royal-frame {
      border: 4px solid #ffd700;
      animation: royal-shine 3s ease-in-out infinite;
      box-shadow: 0 0 25px #ffd700;
      position: relative;
    }

    .royal-frame::before {
      content: 'üëë';
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      animation: crown-bounce 2s ease-in-out infinite;
    }

    @keyframes royal-shine {
      0%, 100% { 
        border-color: #ffd700; 
        box-shadow: 0 0 25px #ffd700;
      }
      50% { 
        border-color: #ffed4e; 
        box-shadow: 0 0 35px #ffed4e, 0 0 45px #ffd700;
      }
    }

    @keyframes crown-bounce {
      0%, 100% { transform: translateX(-50%) translateY(0px); }
      50% { transform: translateX(-50%) translateY(-5px); }
    }

    /* ============ ANIMACIONES SECRETAS DE MENSAJES ============ */
    
    /* Overlay de animaci√≥n secreta */
    #secret-animation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(45deg, rgba(255, 182, 193, 0.9), rgba(255, 105, 180, 0.9));
      z-index: 99999;
      display: none;
      pointer-events: none;
    }

    /* Coraz√≥n gigante central */
    .big-heart {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 8rem;
      color: #ff1744;
      text-shadow: 0 0 20px rgba(255, 23, 68, 0.8);
      animation: heartPulse 2s ease-in-out;
    }

    @keyframes heartPulse {
      0% { 
        transform: translate(-50%, -50%) scale(0) rotate(0deg);
        opacity: 0;
      }
      50% { 
        transform: translate(-50%, -50%) scale(1.5) rotate(5deg);
        opacity: 1;
      }
      100% { 
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    /* Lluvia de corazones */
    .heart-rain {
      position: absolute;
      font-size: 2rem;
      color: #ff1744;
      animation: heartFall linear infinite;
      pointer-events: none;
    }

    @keyframes heartFall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* Mensaje de amor flotante */
    .love-message {
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2rem;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      animation: loveMessageFloat 3s ease-in-out;
      font-weight: bold;
      text-align: center;
    }

    @keyframes loveMessageFloat {
      0% { 
        opacity: 0;
        transform: translateX(-50%) translateY(50px);
      }
      20% { 
        opacity: 1;
        transform: translateX(-50%) translateY(0px);
      }
      80% { 
        opacity: 1;
        transform: translateX(-50%) translateY(0px);
      }
      100% { 
        opacity: 0;
        transform: translateX(-50%) translateY(-50px);
      }
    }

    /* Efectos de part√≠culas */
    .love-particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: radial-gradient(circle, #ff1744, #ff6b9d);
      border-radius: 50%;
      animation: particleFloat 3s ease-out forwards;
    }

    @keyframes particleFloat {
      0% {
        transform: scale(0) translateY(0);
        opacity: 1;
      }
      50% {
        transform: scale(1) translateY(-200px);
        opacity: 0.8;
      }
      100% {
        transform: scale(0) translateY(-400px);
        opacity: 0;
      }
    }

    /* Aplicar nuevos marcos al perfil */
    #profile-frame.neon { 
      border: 4px solid #00ff88;
      animation: neon-glow 2s ease-in-out infinite alternate;
      box-shadow: 0 0 20px #00ff88, inset 0 0 20px #00ff88;
    }

    #profile-frame.royal { 
      border: 4px solid #ffd700;
      animation: royal-shine 3s ease-in-out infinite;
      box-shadow: 0 0 25px #ffd700;
    }

    #profile-frame.royal::before {
      content: 'üëë';
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      animation: crown-bounce 2s ease-in-out infinite;
    }

    /* ============ ANIMACIONES DE CARGA ESTILO TIKTOK ============ */
    
    /* Loader principal con dos bolitas que chocan */
    .tiktok-loader {
      position: relative;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tiktok-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: absolute;
      animation: tiktokCollision 1.5s ease-in-out infinite;
    }

    .tiktok-dot:nth-child(1) {
      background: linear-gradient(45deg, #FE2C55, #ff6b7a);
      left: 0;
      animation-delay: 0s;
    }

    .tiktok-dot:nth-child(2) {
      background: linear-gradient(45deg, #25F4EE, #00d4db);
      right: 0;
      animation-delay: 0.75s;
    }

    @keyframes tiktokCollision {
      0% {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
      40% {
        transform: translateX(15px) scale(1.2);
        opacity: 0.8;
      }
      50% {
        transform: translateX(19px) scale(1.4);
        opacity: 1;
        box-shadow: 0 0 20px currentColor;
      }
      60% {
        transform: translateX(15px) scale(1.2);
        opacity: 0.8;
      }
      100% {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
    }

    /* Animaci√≥n para el bot√≥n de iniciar sesi√≥n */
    .login-loading {
      position: relative;
      overflow: hidden;
    }

    .login-loading::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    /* Efectos de pulsaci√≥n para campos activos */
    .field-active {
      animation: fieldPulse 0.6s ease-out;
    }

    @keyframes fieldPulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(254, 44, 85, 0.7);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(254, 44, 85, 0.2);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(254, 44, 85, 0);
      }
    }

    /* Animaci√≥n de √©xito tipo TikTok */
    .success-bounce {
      animation: successBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes successBounce {
      0% {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.2) rotate(-90deg);
        opacity: 1;
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    /* Animaci√≥n de error con vibraci√≥n */
    .error-shake {
      animation: errorShake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97);
    }

    @keyframes errorShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* Efectos de entrada para modales de pantalla completa */
    .fullscreen-enter {
      animation: fullscreenEnter 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @keyframes fullscreenEnter {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(100px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* Animaci√≥n de loading para botones espec√≠ficos */
    .btn-loading .tiktok-loader .tiktok-dot:nth-child(1) {
      background: rgba(255, 255, 255, 0.8);
    }

    .btn-loading .tiktok-loader .tiktok-dot:nth-child(2) {
      background: rgba(255, 255, 255, 0.6);
    }

    #gift-animation.show {
      opacity: 1;
      animation: slideUpGift 0.8s ease-out;
      /* Ajustamos la duraci√≥n y el efecto */
    }

    @keyframes slideUpGift {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    /* Fondo del regalo para ocupar toda la pantalla */
    #gift-animation::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      /* Fondo semitransparente */
      pointer-events: none;
      z-index: -1;
    }

    /* Estilos para regalos fuertes */
    .gift-strong {
      width: 100%;
      /* Ocupa todo el ancho */
      max-width: 80%;
      /* Para que tenga un margen en pantallas peque√±as */
      background: linear-gradient(135deg, #ff57a8, #7659ff);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      font-size: 1.5rem;
      color: #fff;
      text-align: center;
    }

    #gift-animation::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);
      pointer-events: none;
    }

    /* Modales para reportar historia y bloqueo */
    #report-story-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #0d1935;
      padding: 1rem;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.5);
      display: none;
      max-height: 50vh;
      overflow-y: auto;
      transition: transform 0.3s ease-out;
      transform: translateY(100%);
      z-index: 10000;
      border-top: 1px solid #1e4994;
      color: #e6f0ff;
    }

    #story-blocked-modal {
      position: fixed;
      inset: 0;
      background-color: rgba(3, 10, 23, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    /* VISTA LIVE (iQiyi Style) */
    :root {
      --iqiyi-teal: #00C6B9;
      --iqiyi-blue: #2C7DFA;
      --iqiyi-purple: #7659FF;
      --iqiyi-pink: #FF57A8;
    }

    .live-container {
      position: relative;
      width: 100%;
      height: 100vh;
      background-color: #0d1117;
      overflow: hidden;
    }

    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      background: linear-gradient(to bottom, rgba(13, 17, 23, 0.8) 0%, transparent 100%);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: white;
    }

    .user-profile {
      display: flex;
      align-items: center;
      background-color: var(--iqiyi-teal);
      padding: 0.5rem 1rem;
      border-radius: 12px;
      gap: 0.5rem;
      color: white;
      font-weight: bold;
    }

    .viewer-count {
      background-color: var(--iqiyi-blue);
      padding: 0.5rem 1rem;
      border-radius: 12px;
      color: white;
      font-weight: bold;
    }

    .side-buttons {
      position: absolute;
      right: 1rem;
      bottom: 100px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      align-items: center;
    }

    .side-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      gap: 0.5rem;
    }

    /* En la vista del transmisor se ocultan los botones laterales y el contenedor de comentarios */
    #live-stream-modal .side-buttons,
    #live-stream-modal #broadcasterCommentsContainer,
    #live-stream-modal #live-indicator {
      display: none !important;
    }

    /* Se mantiene la eliminaci√≥n de la bottom-bar (no hay input de comentarios) */
    .bottom-bar {
      display: none;
    }

    /* Botones laterales (teal, purple, pink) para la vista de espectador */
    .icon-button {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .icon-button:hover {
      transform: scale(1.1);
    }

    /* Bot√≥n teal: Heart */
    #heartButton,
    #heartButtonViewer {
      background-color: var(--iqiyi-teal);
    }

    #heartButton img,
    #heartButtonViewer img {
      width: 24px;
      height: 24px;
    }

    /* Bot√≥n purple: Gift */
    #giftButton,
    #giftButtonViewer {
      background-color: var(--iqiyi-purple);
    }

    #giftButton img,
    #giftButtonViewer img {
      width: 24px;
      height: 24px;
    }

    /* Bot√≥n pink: Share */
    #shareButton,
    #shareButtonViewer {
      background-color: var(--iqiyi-pink);
    }

    /* Animaci√≥n de corazones */
    .floating-heart {
      position: absolute;
      animation: float-up 1.5s ease-out forwards;
      opacity: 0;
      width: 24px;
      height: 24px;
    }

    @keyframes float-up {
      0% {
        transform: translateY(0) scale(1) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(-100px) scale(0) rotate(45deg);
        opacity: 0;
      }
    }

    .comments-container {
      position: absolute;
      bottom: 80px;
      left: 0;
      right: 0;
      padding: 1rem;
      pointer-events: none;
    }

    .comment-bubble {
      background-color: var(--duolingo-green);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      margin-bottom: 0.5rem;
      max-width: 80%;
      animation: fade-in-out 3s forwards;
      font-weight: bold;
    }

    @keyframes fade-in-out {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }

      10% {
        opacity: 1;
        transform: translateY(0);
      }

      90% {
        opacity: 1;
        transform: translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    /* Contenedor para comentarios del transmisor (se oculta en este caso) */
    #broadcasterCommentsContainer {
      position: absolute;
      bottom: 80px;
      left: 0;
      right: 0;
      padding: 1rem;
      max-height: 40%;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      color: #111;
      z-index: 101;
    }

    /* ---------- NUEVA SECCI√ìN: Estilos para Computadora ---------- */
    @media (min-width: 1024px) {
      body.desktop {
        background-color: #ffffff;
        font-family: 'Nunito', sans-serif;
      }

      #bottom-nav {
        background-color: rgba(255, 255, 255, 0.9);
      }

      /* Hacer las im√°genes de autores destacados circulares en desktop */
      #featured-authors .story-card img {
        border-radius: 50%;
        width: 160px;
        height: 160px;
        object-fit: cover;
      }
    }

    /* ----------------- NUEVA SECCI√ìN: Banner ApkPure ----------------- */
    #apk-banner {
      position: relative;
      background: #f0f4f8;
      border: 2px solid #58CC02;
      border-radius: 8px;
      padding: 16px;
      margin: 24px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #apk-banner .floating-bubble {
      position: absolute;
      top: -20px;
      right: -20px;
      width: 60px;
      height: 60px;
      background: rgba(88, 204, 2, 0.2);
      border-radius: 50%;
      animation: float 5s infinite ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #58CC02;
    }

    @keyframes float {
      0% {
        transform: translate(0, 0);
      }

      50% {
        transform: translate(-10px, 10px);
      }

      100% {
        transform: translate(0, 0);
      }
    }

    /* NUEVA FUNCI√ìN: Bot√≥n de descarga de historia para lectura offline */
    #download-story-btn {
      cursor: pointer;
    }
  </style>
  <script>
    /*********************** SISTEMA DE GESTI√ìN DE FIREBASE (PREVIENE DUPLICADOS) ***********************/
    let firebaseListeners = {
      authListener: null,
      databaseListeners: new Map(),
      initialized: false
    };

    // Sistema unificado de autenticaci√≥n (elimina duplicados)
    function initializeFirebaseAuth() {
      if (firebaseListeners.authListener) {
        // Desconectar listener anterior si existe
        firebaseListeners.authListener();
        firebaseListeners.authListener = null;
      }
      
      // Crear un solo listener de autenticaci√≥n
      firebaseListeners.authListener = firebase.auth().onAuthStateChanged(user => {
        handleAuthStateChange(user);
      });
    }

    // Funci√≥n unificada para manejar cambios de autenticaci√≥n
    function handleAuthStateChange(user) {
      if (user) {
        // Usuario autenticado
        if (!firebaseListeners.initialized) {
          firebaseListeners.initialized = true;
          setupUserListeners(user);
          initializeStore();
          loadFollowingStories();
          listenForUnreadMessages();
        }
      } else {
        // Usuario no autenticado
        cleanupAllListeners();
        firebaseListeners.initialized = false;
      }
    }

    // Limpiar todos los listeners al desconectar
    function cleanupAllListeners() {
      firebaseListeners.databaseListeners.forEach((unsubscribe, key) => {
        unsubscribe();
      });
      firebaseListeners.databaseListeners.clear();
    }

    // Agregar listener de database con gesti√≥n autom√°tica
    function addDatabaseListener(key, ref, callback) {
      // Limpiar listener anterior si existe
      if (firebaseListeners.databaseListeners.has(key)) {
        firebaseListeners.databaseListeners.get(key)();
      }
      
      // Agregar nuevo listener
      const unsubscribe = ref.on('value', callback);
      firebaseListeners.databaseListeners.set(key, () => ref.off('value', unsubscribe));
      
      return unsubscribe;
    }

    // Sistema de gesti√≥n de intervals (PREVIENE MEMORY LEAKS)
    let activeIntervals = new Map();
    
    function setIntervalManaged(callback, delay, id = null) {
      const intervalId = id || Date.now() + Math.random();
      
      // Limpiar interval anterior si existe
      if (activeIntervals.has(intervalId)) {
        clearInterval(activeIntervals.get(intervalId));
      }
      
      // Crear nuevo interval
      const interval = setInterval(callback, delay);
      activeIntervals.set(intervalId, interval);
      
      return intervalId;
    }
    
    function clearIntervalManaged(intervalId) {
      if (activeIntervals.has(intervalId)) {
        clearInterval(activeIntervals.get(intervalId));
        activeIntervals.delete(intervalId);
        return true;
      }
      return false;
    }
    
    // Limpiar todos los intervals al cambiar p√°gina/usuario
    function clearAllIntervals() {
      activeIntervals.forEach(interval => clearInterval(interval));
      activeIntervals.clear();
    }

    /*********************** BLOQUEO DE ACCESO EN COMPUTADORAS (M√≥vil obligatorio) ***********************/
    function esDispositivoMovil() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    /*********************** MODO OFFLINE ***********************/
    window.addEventListener('offline', function() {
      document.body.innerHTML = `
        <div id="offline-modal">
          <img src="https://ideogram.ai/assets/image/lossless/response/ZL-_GzzNQdy7CzioYPtDHg" alt="Sin conexi√≥n">
        </div>`;
    });
    window.addEventListener('online', function() {
      location.reload();
    });
    /* FUNCI√ìN PARA ESTABLECER EL TEMA GLOBAL (d√≠a/noche) Y COLOR DE FUENTE */
    function setThemeBasedOnTime() {
      const hour = new Date().getHours();
      let bg, fontColor;
      if (hour >= 6 && hour < 18) {
        bg = "#ffffff";
        fontColor = "#58CC02";
      } else {
        bg = "#0d1b2a";
        fontColor = "#58CC02";
      }
      document.body.style.backgroundColor = bg;
      document.body.style.color = fontColor;
      updateSectionThemes(bg, fontColor);
      const bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) {
        bottomNav.style.backgroundColor = (hour >= 6 && hour < 18) ?
          "rgba(255,255,255,0.8)" :
          "rgba(13,27,42,0.8)";
      }
    }

    function updateSectionThemes(bg, fontColor) {
      const sections = [
        "search-view",
        "profile-view",
        "story-detail-modal",
        "comic-creation-view",
        "comic-viewer-modal",
        "profile-edit-modal",
        "author-profile-modal",
        "support-modal",
        "followers-modal",
        "following-modal",
        "notifications-modal",
        "report-modal",
        "report-response-modal",
        "admin-response-modal",
        "blocked-error-modal"
      ];
      sections.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
          el.style.backgroundColor = bg;
          el.style.color = fontColor;
        }
      });
    }
    // Sistema de inicializaci√≥n unificado (corrige m√∫ltiples listeners)
    let appInitialized = false;
    function initializeApp() {
      if (appInitialized) return;
      appInitialized = true;
      
      setThemeBasedOnTime();
      
      if (window.innerWidth >= 1024) {
        document.body.classList.add('desktop');
      }
      
      organizeCarousels();
      initializeLanguage();
      
      // Inicializar detectores con delay
      setTimeout(() => {
        const user = firebase.auth().currentUser;
        if (user) {
          setupAutoDetectors();
          forceProfileUpdate();
        }
      }, 2000);
    }

    function organizeCarousels() {
      const carouselIds = ['new-releases', 'top10', 'popular', 'terror-stories'];
      carouselIds.forEach(id => {
        const carousel = document.getElementById(id);
        if (carousel) {
          carousel.classList.remove('grid', 'grid-cols-2', 'md:grid-cols-4');
          carousel.classList.add('flex', 'space-x-4', 'overflow-x-auto');
        }
      });
    }
    
    // Sistema universal de escape de modales (PREVIENE BLOQUEOS)
    function setupUniversalModalEscape() {
      // ESC key para cerrar cualquier modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          // Buscar modales visibles y cerrarlos
          const visibleModals = document.querySelectorAll('[id*="modal"]:not(.hidden), [id*="modal"][style*="flex"], [id*="modal"][style*="block"]');
          visibleModals.forEach(modal => {
            if (modal.style.display !== 'none' && !modal.classList.contains('hidden')) {
              // Intentar cerrar modal con funci√≥n espec√≠fica
              if (modal.id.includes('blocked-error')) {
                closeBlockedErrorModal();
              } else if (modal.id.includes('live')) {
                closeLiveStreamModal();
              } else {
                // Cerrar modal gen√©rico
                modal.style.display = 'none';
                modal.classList.add('hidden');
              }
            }
          });
          
          // Restaurar scroll del body si est√° bloqueado
          document.body.style.overflow = 'auto';
        }
      }, { passive: true });
      
      // Click fuera del modal para cerrarlo
      document.addEventListener('click', function(e) {
        const modals = document.querySelectorAll('[id*="modal"]');
        modals.forEach(modal => {
          if (modal.style.display !== 'none' && !modal.classList.contains('hidden')) {
            if (e.target === modal) {
              modal.style.display = 'none';
              modal.classList.add('hidden');
              document.body.style.overflow = 'auto';
            }
          }
        });
      }, { passive: true });
    }

    // Funci√≥n para cerrar modal de error bloqueado
    function closeBlockedErrorModal() {
      const modal = document.getElementById('blocked-error-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
    }

    // Una sola llamada de inicializaci√≥n
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        setupUniversalModalEscape();
      }, { once: true });
    } else {
      initializeApp();
      setupUniversalModalEscape();
    }
    // Inicializaci√≥n √∫nica de idioma
    let languageInitialized = false;
    function initializeLanguage() {
      if (languageInitialized) return;
      languageInitialized = true;
      
      const savedLang = localStorage.getItem("selectedLanguage");
      if (savedLang) {
        currentLanguage = savedLang;
        updateTranslations();
      } else {
        const languageModal = document.getElementById("language-modal");
        if (languageModal) {
          languageModal.style.display = "flex";
        }
      }
    }

    // Legacy function removed - chapters not used in comic system
    function updateChapterUI() {
      // No-op function for backward compatibility
      return;
      if (storyTypeSelected === 'cuento') {
        chapterSection.style.display = 'none';
      } else if (storyTypeSelected === 'historia_completa') {
        chapterSection.style.display = 'block';
        document.querySelectorAll('.chapter-label').forEach(label => {
          label.textContent = 'Cap√≠tulo';
        });
      } else if (storyTypeSelected === 'novela') {
        chapterSection.style.display = 'block';
        document.querySelectorAll('.chapter-label').forEach(label => {
          label.textContent = 'Saga';
        });
      }
    }

    function selectStoryType(type) {
      storyTypeSelected = type;
      const comicCreationView = document.getElementById('comic-creation-view');
      if (comicCreationView) comicCreationView.classList.add('hidden');
      // Note: updateChapterUI removed - chapters not used in comic system
    }
    /*************** FUNCIONES PARA COMPRA DE MONEDAS (ELIMINADAS) ***************/
    // Se han removido las funciones openBuyCoinsModal(), closeBuyCoinsModal() y buyCoins()
    /*************** FIN FUNCIONES DE COMPRA DE MONEDAS ***************/
    /*********************** NUEVAS FUNCIONES PARA SUGERENCIAS Y AUTORES DESTACADOS ***********************/
    function loadSuggestedStories() {
      firebase.database().ref('stories').once('value').then(snapshot => {
        let stories = [];
        snapshot.forEach(child => {
          let story = child.val();
          story.id = child.key;
          stories.push(story);
        });
        stories.sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0));
        let suggested = stories.slice(0, 10);
        const container = document.getElementById('suggested-stories');
        container.innerHTML = '';
        suggested.forEach(story => {
          const card = document.createElement('div');
          card.className = 'story-card cursor-pointer';
          card.onclick = () => openStoryDetail(story);
          card.innerHTML = `
              <div class="rounded-2xl overflow-hidden shadow-md">
                <div class="story-cover-container">
                  <img src="${story.coverImage || 'https://via.placeholder.com/200x300/cccccc/666666?text=No+Image'}" alt="${story.title}" class="story-cover-image">
                </div>
              </div>
              <div class="mt-2">
                <h3 class="font-semibold text-sm">${story.title}</h3>
              </div>
            `;
          container.appendChild(card);
        });
      });
    }

    function loadFeaturedAuthors() {
      firebase.database().ref('stories').once('value').then(snapshot => {
        let authorCounts = {};
        snapshot.forEach(child => {
          let story = child.val();
          if (story && story.userId) {
            if (!authorCounts[story.userId]) authorCounts[story.userId] = 0;
            authorCounts[story.userId]++;
          }
        });
        let authorsArray = [];
        for (let uid in authorCounts) {
          authorsArray.push({
            uid: uid,
            count: authorCounts[uid]
          });
        }
        authorsArray.sort((a, b) => b.count - a.count);
        let topAuthors = authorsArray.slice(0, 10);
        const container = document.getElementById('featured-authors');
        container.innerHTML = '';
        topAuthors.forEach(author => {
          firebase.database().ref('users/' + author.uid).once('value').then(userSnap => {
            const userData = userSnap.val();
            const card = document.createElement('div');
            card.className = 'story-card cursor-pointer';
            card.onclick = () => openAuthorProfile(author.uid);
            card.innerHTML = `
                <div class="rounded-2xl overflow-hidden shadow-md">
                  <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" alt="${userData.username}" class="w-full h-40 object-cover">
                </div>
                <div class="mt-2">
                  <h3 class="font-semibold text-sm">${userData.username}</h3>
                </div>
              `;
            container.appendChild(card);
          });
        });
      });
    }
    /*************** FIN NUEVAS FUNCIONES ***********************/
  </script>
</head>

<!-- MODAL DE NOTIFICACIONES -->
<div id="notifications-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center" onclick="closeNotifications()">
  <div class="bg-white w-full max-w-md mx-4 rounded-2xl shadow-xl max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
    <!-- Header con bot√≥n de volver -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-white">
      <button onclick="closeNotifications()" class="flex items-center text-[#FE2C55] hover:text-[#d1244a] transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span class="font-medium">Volver</span>
      </button>
      <h2 class="text-xl font-bold text-gray-800">Notificaciones</h2>
      <div class="w-16"></div> <!-- Espaciador para centrar el t√≠tulo -->
    </div>
    
    <!-- Contenido scrolleable -->
    <div class="p-4 overflow-y-auto max-h-[60vh]">
      <div id="notifications-list" class="space-y-3"></div>
      
      <!-- Mensaje cuando no hay notificaciones -->
      <div id="no-notifications" class="text-center py-8 text-gray-500 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5-5-5h5v-8a2 2 0 112 0v8z" />
        </svg>
        <p class="text-sm">No tienes notificaciones</p>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE REPORTAR PERFIL -->
<div id="report-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 opacity-0 transition-all duration-300">
  <div class="bg-white w-full h-full overflow-y-auto transform scale-95 transition-transform duration-300">
    <!-- Header con degradado rosa TikTok -->
    <div class="bg-gradient-to-r from-pink-100 to-red-100 p-6 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <button onclick="closeReportModal()" class="text-gray-600 hover:text-gray-800 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <div>
            <h2 id="report-title" class="text-2xl font-bold text-[#FE2C55]">‚ö†Ô∏è Reportar Perfil</h2>
            <p class="text-sm text-gray-600">Ay√∫danos a mantener la comunidad segura</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido del modal -->
    <div class="p-6 max-w-2xl mx-auto">
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
        <div class="flex items-start space-x-3">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-yellow-800 mb-1">Informaci√≥n importante</h3>
            <p class="text-sm text-yellow-700">Los reportes falsos pueden resultar en restricciones en tu cuenta. Solo reporta contenido que realmente viole nuestras normas.</p>
          </div>
        </div>
      </div>

      <form id="report-form" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Motivo del reporte</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="relative flex items-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors">
              <input type="radio" name="report-reason" value="perfil_falso" class="sr-only">
              <div class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                <div class="w-2 h-2 bg-[#FE2C55] rounded-full opacity-0 transition-opacity"></div>
              </div>
              <div>
                <div class="font-medium text-gray-900">üé≠ Perfil falso</div>
                <div class="text-sm text-gray-600">Suplantaci√≥n de identidad</div>
              </div>
            </label>
            
            <label class="relative flex items-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors">
              <input type="radio" name="report-reason" value="spam" class="sr-only">
              <div class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                <div class="w-2 h-2 bg-[#FE2C55] rounded-full opacity-0 transition-opacity"></div>
              </div>
              <div>
                <div class="font-medium text-gray-900">üì¢ Spam</div>
                <div class="text-sm text-gray-600">Contenido repetitivo</div>
              </div>
            </label>
            
            <label class="relative flex items-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors">
              <input type="radio" name="report-reason" value="contenido_inapropiado" class="sr-only">
              <div class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                <div class="w-2 h-2 bg-[#FE2C55] rounded-full opacity-0 transition-opacity"></div>
              </div>
              <div>
                <div class="font-medium text-gray-900">üö´ Contenido inapropiado</div>
                <div class="text-sm text-gray-600">Violenta normas de comunidad</div>
              </div>
            </label>
            
            <label class="relative flex items-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors">
              <input type="radio" name="report-reason" value="acoso" class="sr-only">
              <div class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                <div class="w-2 h-2 bg-[#FE2C55] rounded-full opacity-0 transition-opacity"></div>
              </div>
              <div>
                <div class="font-medium text-gray-900">üò† Acoso o bullying</div>
                <div class="text-sm text-gray-600">Comportamiento abusivo</div>
              </div>
            </label>
            
            <label class="relative flex items-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors">
              <input type="radio" name="report-reason" value="propiedad_intelectual" class="sr-only">
              <div class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                <div class="w-2 h-2 bg-[#FE2C55] rounded-full opacity-0 transition-opacity"></div>
              </div>
              <div>
                <div class="font-medium text-gray-900">¬©Ô∏è Propiedad intelectual</div>
                <div class="text-sm text-gray-600">Contenido con derechos de autor</div>
              </div>
            </label>
            
            <label class="relative flex items-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors">
              <input type="radio" name="report-reason" value="otro" class="sr-only">
              <div class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                <div class="w-2 h-2 bg-[#FE2C55] rounded-full opacity-0 transition-opacity"></div>
              </div>
              <div>
                <div class="font-medium text-gray-900">‚ùì Otro</div>
                <div class="text-sm text-gray-600">Especifica en la descripci√≥n</div>
              </div>
            </label>
          </div>
        </div>

        <div>
          <label for="report-description" class="block text-sm font-medium text-gray-700 mb-2">
            Descripci√≥n del problema (opcional)
          </label>
          <textarea 
            id="report-description" 
            placeholder="Proporciona detalles adicionales que puedan ayudarnos a entender el problema..." 
            class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent transition-all resize-none" 
            rows="4"></textarea>
        </div>

        <div class="flex space-x-4 pt-4">
          <button type="button" onclick="closeReportModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-medium hover:bg-gray-300 transition-colors">
            Cancelar
          </button>
          <button id="btn-enviar-report" type="submit" class="flex-1 bg-[#FE2C55] text-white py-3 px-6 rounded-xl font-medium hover:bg-red-600 transition-colors">
            üö® Enviar Reporte
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL DE RESPUESTA AL REPORTE -->
<div id="report-response-modal" class="fixed inset-0 flex flex-col items-center justify-center z-50 hidden" style="z-index: 9999;">
  <div class="bg-white p-6 rounded-xl text-center">
    <div class="flex space-x-2 mb-4">
      <div class="dot" style="animation-duration: 1s;"></div>
      <div class="dot" style="animation-duration: 1.2s;"></div>
    </div>
    <p class="text-xl font-bold mb-2">Procesando tu reporte...</p>
    <p class="text-gray-600">Espera unos instantes.</p>
  </div>
</div>

<!-- MODAL DE RESPUESTA DEL ADMIN -->
<div id="admin-response-modal" class="fixed inset-0 flex flex-col items-center justify-center z-50 hidden" style="z-index: 9999;">
  <!-- Contenido asignado din√°micamente -->
</div>

<!-- MODAL DE ERROR PARA USUARIO BLOQUEADO -->
<div id="blocked-error-modal" class="fixed inset-0 z-50 hidden" style="z-index: 9999;">
  <button onclick="closeBlockedErrorModal()">Volver</button>
  <img src="https://ideogram.ai/assets/image/lossless/response/0-Re3lMzQ6mmstIxlRxb4Q" alt="Usuario bloqueado">
</div>

<!-- MODAL DE LISTA DE SEGUIDORES -->
<div id="followers-modal" class="fixed inset-0 overflow-y-auto z-50 hidden" style="z-index: 9999;">
  <div class="p-6">
    <button onclick="closeFollowersModal()" class="text-[#58CC02] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>
    <h2 class="text-2xl font-bold text-[#58CC02] mb-4">Seguidores</h2>
    <div id="followers-list" class="space-y-4"></div>
  </div>
</div>

<!-- MODAL DE LISTA DE SIGUIENDO -->
<div id="following-modal" class="fixed inset-0 overflow-y-auto z-50 hidden" style="z-index: 9999;">
  <div class="p-4">
    <button onclick="closeFollowingModal()" class="text-[#58CC02] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>
    <h2 class="text-2xl font-bold text-[#58CC02] mb-4">Siguiendo</h2>
    <div id="following-list" class="space-y-4"></div>
  </div>
</div>

<!-- MODAL DE SOPORTE -->
<div id="support-modal" class="fixed inset-0 overflow-y-auto z-50 hidden">
  <div class="p-6">
    <button onclick="closeSupportModal()" class="text-[#58CC02] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>
    <h2 class="text-2xl font-bold text-[#58CC02] mb-4 flex items-center justify-center">
      <i class="fas fa-headset mr-2"></i> Soporte
    </h2>
    <form id="support-form" class="space-y-4">
      <input id="support-subject" type="text" placeholder="Asunto" class="w-full p-3 border border-gray-200 rounded-xl" required>
      <textarea id="support-message" placeholder="Describe tu problema o consulta..." class="w-full p-3 border border-gray-200 rounded-xl" rows="4" required></textarea>
      <button id="btn-send-support" type="submit" class="w-full bg-blue-500 text-white p-3 rounded-xl">Enviar Solicitud</button>
    </form>
  </div>
</div>

<!-- SPINNER DE CERRAR SESI√ìN -->
<div id="signout-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
  <i class="fas fa-spinner fa-spin text-4xl" style="color:#58CC02;"></i>
</div>

<!-- SPINNER PARA PUBLICAR HISTORIA -->
<div id="story-upload-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
  <i class="fas fa-spinner fa-spin text-4xl" style="color:#58CC02;"></i>
</div>

<!-- PANTALLA DE CHAT EN TIEMPO REAL -->
<div id="chat-view" class="fixed inset-0 hidden bg-white text-black" style="z-index: 9999;">
  <!-- Vista de conversaciones (m√≥vil first) -->
  <div id="conversations-view" class="h-full flex flex-col">
    <!-- Header principal -->
    <div class="bg-[#FE2C55] text-white p-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <button onclick="closeChat()" class="lg:hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </button>
        <div class="flex items-center space-x-3">
          <div class="relative">
            <img id="current-user-avatar" src="" alt="" class="w-8 h-8 rounded-full">
            <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
          </div>
          <div class="flex flex-col">
            <h2 class="text-xl font-bold">Chats</h2>
            <span class="text-sm text-red-100">En l√≠nea</span>
          </div>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <button onclick="openNewMessage()" class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
        <div class="relative">
          <button onclick="toggleChatOptions()" class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
          </button>
          <div id="chat-options-menu" class="hidden absolute right-0 top-12 bg-white rounded-lg shadow-lg py-2 w-48 z-10">
            <button onclick="markAllAsRead()" class="w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-100">Marcar todo como le√≠do</button>
            <button onclick="clearAllChats()" class="w-full px-4 py-2 text-left text-red-600 hover:bg-gray-100">Limpiar todos los chats</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Barra de b√∫squeda -->
    <div class="p-4 border-b border-gray-200">
      <div class="relative">
        <input type="text" id="search-conversations" placeholder="Buscar conversaciones..." 
               class="w-full p-3 pl-10 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FE2C55]"
               oninput="searchConversations(this.value)">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
    </div>

    <!-- Lista de conversaciones -->
    <div class="flex-1 overflow-y-auto">
      <div id="conversations-container" class="divide-y divide-gray-100">
        <!-- Las conversaciones se cargar√°n aqu√≠ -->
      </div>
      <div id="no-conversations" class="hidden flex-1 flex items-center justify-center text-gray-500 p-8">
        <div class="text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <p class="text-lg font-medium mb-2">No tienes conversaciones</p>
          <p class="text-sm">Inicia una conversaci√≥n con tus autores favoritos</p>
          <button onclick="openNewMessage()" class="mt-4 bg-[#FE2C55] text-white px-6 py-2 rounded-full hover:bg-red-600 transition">
            Nuevo chat
          </button>
        </div>
      </div>
    </div>

    
  </div>

  <!-- Vista de chat individual -->
  <div id="individual-chat-view" class="hidden h-full flex flex-col">
    <!-- Header del chat -->
    <div class="bg-[#FE2C55] text-white p-4 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <button onclick="backToConversations()" class="lg:hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </button>
        <div>
          <h3 id="chat-user-name" class="font-bold"></h3>
          <p id="chat-user-status" class="text-sm text-red-100">√öltima vez hace 5 min</p>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <button onclick="toggleChatMenu()" class="p-2 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Men√∫ del chat -->
    <div id="chat-menu" class="hidden bg-red-50 p-3 border-b border-red-200">
      <div class="flex flex-wrap gap-2">
        <button onclick="clearCurrentChat()" class="bg-white px-3 py-1 rounded-full text-sm text-gray-700 hover:bg-gray-100 transition">
          Limpiar chat
        </button>
        <button onclick="deleteConversation(currentChatUserId)" class="bg-red-100 px-3 py-1 rounded-full text-sm text-red-700 hover:bg-red-200 transition">
          Eliminar chat
        </button>
        <button onclick="blockUser(currentChatUserId)" class="bg-red-100 px-3 py-1 rounded-full text-sm text-red-700 hover:bg-red-200 transition">
          Bloquear usuario
        </button>
      </div>
    </div>

    <!-- √Årea de mensajes -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" id="messages-container">
      <!-- Los mensajes se cargar√°n aqu√≠ -->
    </div>

    <!-- Indicador de escritura -->
    <div id="typing-indicator" class="hidden px-4 py-2 text-sm text-gray-500">
      <div class="flex items-center space-x-2">
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
        <span id="typing-user-name">Usuario</span>
        <span>est√° escribiendo...</span>
      </div>
    </div>

    <!-- Input de mensaje -->
    <div class="p-4 bg-white border-t border-gray-200">
      <div class="flex items-end space-x-3">
        
        <button onclick="attachFile()" class="p-3 text-gray-500 hover:text-[#FE2C55] transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        </button>
        <div class="flex-1 relative">
          <textarea id="message-input" placeholder="Escribe un mensaje..." 
                   class="w-full p-3 pr-12 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] resize-none max-h-32"
                   rows="1"
                   oninput="handleMessageInput(this)"
                   onkeypress="handleKeyPress(event)"></textarea>
          <button onclick="toggleEmojiPicker()" class="absolute right-3 bottom-3 text-gray-500 hover:text-[#FE2C55] transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
        </div>
        <button onclick="sendMessage()" id="send-button" class="bg-[#FE2C55] text-white p-3 rounded-full hover:bg-red-600 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
      
      <!-- Emoji picker -->
      <div id="emoji-picker" class="hidden absolute bottom-20 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-4 w-80 z-10">
        <div class="grid grid-cols-8 gap-2">
          <button onclick="insertEmoji('üòÄ')" class="p-2 hover:bg-gray-100 rounded">üòÄ</button>
          <button onclick="insertEmoji('üòÇ')" class="p-2 hover:bg-gray-100 rounded">üòÇ</button>
          <button onclick="insertEmoji('‚ù§Ô∏è')" class="p-2 hover:bg-gray-100 rounded">‚ù§Ô∏è</button>
          <button onclick="insertEmoji('üëç')" class="p-2 hover:bg-gray-100 rounded">üëç</button>
          <button onclick="insertEmoji('üëè')" class="p-2 hover:bg-gray-100 rounded">üëè</button>
          <button onclick="insertEmoji('üî•')" class="p-2 hover:bg-gray-100 rounded">üî•</button>
          <button onclick="insertEmoji('‚ú®')" class="p-2 hover:bg-gray-100 rounded">‚ú®</button>
          <button onclick="insertEmoji('üéâ')" class="p-2 hover:bg-gray-100 rounded">üéâ</button>
          <button onclick="insertEmoji('üíï')" class="p-2 hover:bg-gray-100 rounded">üíï</button>
          <button onclick="insertEmoji('ü•∞')" class="p-2 hover:bg-gray-100 rounded">ü•∞</button>
          <button onclick="insertEmoji('üòç')" class="p-2 hover:bg-gray-100 rounded">üòç</button>
          <button onclick="insertEmoji('ü§î')" class="p-2 hover:bg-gray-100 rounded">ü§î</button>
          <button onclick="insertEmoji('üòé')" class="p-2 hover:bg-gray-100 rounded">üòé</button>
          <button onclick="insertEmoji('üôå')" class="p-2 hover:bg-gray-100 rounded">üôå</button>
          <button onclick="insertEmoji('üí™')" class="p-2 hover:bg-gray-100 rounded">üí™</button>
          <button onclick="insertEmoji('üéä')" class="p-2 hover:bg-gray-100 rounded">üéä</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Input oculto para archivos -->
<input type="file" id="file-input" class="hidden" onchange="handleFileAttachment(event)" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"></input>

<!-- SELECTOR DE MARCOS ANIMADOS A PANTALLA COMPLETA -->
<div id="frame-selector-modal" class="fixed inset-0 bg-gradient-to-b from-white to-[#f9f9f9] text-black overflow-y-auto hidden z-50">
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Header con monedas del usuario -->
    <div class="flex justify-between items-center mb-6">
      <button onclick="closeFrameSelector()" class="text-[#FE2C55] flex items-center hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        <span></span>
      </button>
      
      <div class="flex items-center bg-yellow-500 text-white px-4 py-2 rounded-full">
        <span class="text-xl mr-2">ü™ô</span>
        <span id="frame-selector-coins" class="font-bold">0</span>
        <span class="ml-1">monedas</span>
      </div>
    </div>

    <!-- T√≠tulo -->
    <h2 class="text-3xl font-bold mb-4 text-black text-center">Marcos Animados Exclusivos</h2>
    <p class="text-center text-gray-600 mb-8">Personaliza tu perfil con efectos √∫nicos que otros usuarios podr√°n ver</p>
    
    <!-- Grid de marcos expandido -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
      <!-- Sin marco (gratis) -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('none', 0)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-200 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <span class="text-lg font-semibold">Sin marco</span>
        <p class="text-sm text-gray-500 mt-2">Perfil b√°sico</p>
        <div class="mt-3 bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-bold">
          GRATIS
        </div>
      </div>
      
      <!-- Marco Arco√≠ris -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('rainbow', 25)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full rainbow-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-purple-400 to-pink-400"></div>
        </div>
        <span class="text-lg font-semibold">Arco√≠ris</span>
        <p class="text-sm text-gray-500 mt-2">Efecto colorido</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 25
        </div>
      </div>
      
      <!-- Marco de Fuego -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('fire', 35)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full fire-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-red-500 to-orange-500"></div>
        </div>
        <span class="text-lg font-semibold">Fuego</span>
        <p class="text-sm text-gray-500 mt-2">Energ√≠a ardiente</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 35
        </div>
      </div>
      
      <!-- Marco El√©ctrico -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('electric', 30)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full electric-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400"></div>
        </div>
        <span class="text-lg font-semibold">El√©ctrico</span>
        <p class="text-sm text-gray-500 mt-2">Poder el√©ctrico</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 30
        </div>
      </div>
      
      <!-- Marco Galaxia -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('galaxy', 50)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full galaxy-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600"></div>
        </div>
        <span class="text-lg font-semibold">Galaxia</span>
        <p class="text-sm text-gray-500 mt-2">Cosmos infinito</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 50
        </div>
      </div>
      
      <!-- Marco Diamante -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('diamond', 75)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full diamond-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-blue-200 to-blue-300"></div>
        </div>
        <span class="text-lg font-semibold">Diamante</span>
        <p class="text-sm text-gray-500 mt-2">Lujo premium</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 75
        </div>
      </div>

      <!-- Marco Ne√≥n -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('neon', 40)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full neon-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-green-400 to-teal-400"></div>
        </div>
        <span class="text-lg font-semibold">Ne√≥n</span>
        <p class="text-sm text-gray-500 mt-2">Brillo nocturno</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 40
        </div>
      </div>

      <!-- Marco Real -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('royal', 100)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full royal-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-yellow-400 to-amber-500"></div>
        </div>
        <span class="text-lg font-semibold">Real</span>
        <p class="text-sm text-gray-500 mt-2">Elegancia dorada</p>
        <div class="mt-3 bg-purple-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">üëë</span> 100
        </div>
      </div>
    </div>

    <!-- Secci√≥n de cambio de nombre -->
    <div class="mt-8 p-6 bg-blue-50 rounded-xl">
      <h3 class="font-bold text-blue-800 mb-3 text-center">üéØ Funciones Especiales</h3>
      <div class="flex flex-col md:flex-row gap-4">
        <button onclick="openUsernameChange()" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition flex items-center justify-center">
          <span class="mr-2">ü™ô</span>
          <span>7 - Cambiar Nombre de Usuario</span>
        </button>
        <button onclick="showFrameHistory()" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition flex items-center justify-center">
          <span class="mr-2">üìú</span>
          <span>Ver Marcos Comprados</span>
        </button>
      </div>
      <p class="text-blue-600 text-sm mt-3 text-center">El cambio de nombre solo se puede hacer cada 7 d√≠as</p>
    </div>

    <!-- Informaci√≥n adicional -->
    <div class="mt-6 p-4 bg-green-50 rounded-xl text-center">
      <h3 class="font-bold text-green-800 mb-2">üí° ¬øC√≥mo conseguir m√°s monedas?</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-sm text-green-600">
        <div>üìñ Leer cap√≠tulos: +8 monedas</div>
        <div>üë• Seguir usuarios: +5 monedas</div>
        <div>üëÄ Ver perfiles/historias: +2 monedas</div>
        <div>üìù Publicar en comunidad: +10 monedas</div>
        <div>‚ù§Ô∏è Dar like a notas: +5 monedas</div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA NUEVO MENSAJE -->
<div id="new-message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center" style="z-index: 10000;">
  <div class="bg-white rounded-xl p-6 w-96 max-w-[90vw] max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">Nuevo Mensaje</h3>
      <button onclick="closeNewMessage()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">Buscar autor:</label>
        <input type="text" id="author-search" placeholder="Nombre del autor..." 
               class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55]"
               oninput="searchAuthors(this.value)">
      </div>
      
      <div id="authors-results" class="max-h-48 overflow-y-auto border border-gray-200 rounded-xl hidden">
        <!-- Resultados de b√∫squeda de autores -->
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Mensaje:</label>
        <textarea id="new-message-text" placeholder="Escribe tu mensaje..." 
                  class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] resize-none" 
                  rows="3"></textarea>
      </div>
      
      <div class="flex space-x-3">
        <button onclick="closeNewMessage()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition">
          Cancelar
        </button>
        <button onclick="sendNewMessage()" class="flex-1 bg-[#FE2C55] text-white py-3 rounded-xl hover:bg-red-600 transition">
          Enviar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE REPORTAR HISTORIA -->
<div id="report-story-modal">
  <h2 class="text-xl font-bold mb-4 text-[#58CC02]">Reportar Historia</h2>
  <form id="report-story-form">
    <label class="block mb-2">
      <input type="radio" name="reportReason" value="historia_falsa" required> Historia falsa
    </label>
    <label class="block mb-2">
      <input type="radio" name="reportReason" value="no_es_original" required> La historia no es original
    </label>
    <label class="block mb-2">
      <input type="radio" name="reportReason" value="contenido_inapropiado" required> Contenido inapropiado
    </label>
    <textarea id="report-story-description" class="w-full border border-gray-300 rounded p-2 mb-4" placeholder="Describe el problema (opcional)"></textarea>
    <button type="submit" class="w-full bg-red-500 text-white p-2 rounded">Enviar Reporte</button>
  </form>
</div>

<!-- MODAL DE HISTORIA BLOQUEADA -->
<div id="story-blocked-modal">
  <img src="https://ideogram.ai/g/hJJQb0VZSQicLDiADD7CZQ/3" alt="Historia Bloqueada" class="w-3/4 h-auto">
</div>

<!‚Äì‚Äì AUTENTICACI√ìN A PANTALLA COMPLETA (ESTILO TIKTOK) ‚Äì‚Äì>
<body class="bg-white font-sans text-[#161823]">
  
  <div id="auth-form" class="w-full h-screen flex flex-col justify-center p-6">
    <!-- T√≠tulo centrado -->
    <div class="flex justify-center mb-8">
      <img src="https://i.ibb.co/RTS0yszd/IMG-3883.png" alt="BeaBoo" class="h-16 w-auto" id="auth-logo">
    </div>
    <!-- Formulario ocupa todo el ancho disponible -->
    <form id="authForm" class="w-full space-y-6 max-w-lg mx-auto">
      <input
        id="emailInput"
        type="email"
        placeholder="Correo electr√≥nico"
        class="w-full p-4 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FE2C55] transition"
        required
      >
      <input
        id="passwordInput"
        type="password"
        placeholder="Contrase√±a"
        class="w-full p-4 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FE2C55] transition"
        required
      >
      <button
        id="submitButton"
        type="submit"
        class="w-full bg-[#FE2C55] text-white p-4 font-bold rounded-full transform hover:scale-105 transition"
      >
        Iniciar Sesi√≥n
      </button>
    </form>
    <!-- Links y toggle debajo del formulario -->
    <div class="mt-6 text-center space-y-4 max-w-lg mx-auto">
      <a
        href="#"
        onclick="resetPassword()"
        class="block text-sm text-gray-600 hover:text-[#FE2C55] transition"
      >
        ¬øOlvidaste tu contrase√±a?
      </a>
      <button
        id="toggleAuth"
        class="block text-sm font-medium text-[#FE2C55] hover:text-[#25F4EE] transition"
      >
        ¬øNo tienes cuenta? Reg√≠strate
      </button>
      <div id="authError" class="mt-4 text-red-500 hidden"></div>
    </div>
  </div>
</body>

<!-- MODAL DE PIN DE SEGURIDAD -->
<div id="security-pin-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[60] flex items-center justify-center hidden">
  <div class="w-full max-w-md mx-4">
    <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
      <!-- √çcono de seguridad -->
      <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-red-500 to-pink-600 rounded-full flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
      
      <h2 class="text-2xl font-bold text-gray-900 mb-3">Protecci√≥n de Seguridad</h2>
      <p class="text-gray-600 mb-6">Ingresa tu PIN de 6 d√≠gitos para acceder a BeaBoo</p>
      
      <!-- Input del PIN -->
      <div class="flex space-x-2 justify-center mb-6">
        <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-[#FE2C55] focus:outline-none" onkeyup="handlePinInput(this, 0)" onpaste="handlePinPaste(event)">
        <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-[#FE2C55] focus:outline-none" onkeyup="handlePinInput(this, 1)">
        <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-[#FE2C55] focus:outline-none" onkeyup="handlePinInput(this, 2)">
        <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-[#FE2C55] focus:outline-none" onkeyup="handlePinInput(this, 3)">
        <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-[#FE2C55] focus:outline-none" onkeyup="handlePinInput(this, 4)">
        <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-[#FE2C55] focus:outline-none" onkeyup="handlePinInput(this, 5)">
      </div>
      
      <!-- Mensaje de error -->
      <div id="pin-error" class="hidden text-red-500 text-sm mb-4">
        PIN incorrecto. Por favor intenta de nuevo.
      </div>
      
      <!-- Temporizador -->
      <div class="text-sm text-gray-500 mb-6">
        <p>‚è∞ Tiempo restante: <span id="pin-timer" class="font-bold text-[#FE2C55]">23:00</span></p>
        <p class="mt-2">Si no ingresas el PIN a tiempo, la protecci√≥n se desactivar√° autom√°ticamente.</p>
      </div>
      
      <!-- Bot√≥n de verificar -->
      <button onclick="verifyPin()" class="w-full bg-gradient-to-r from-[#FE2C55] to-[#ff6b7a] text-white py-3 rounded-xl font-semibold hover:from-red-600 hover:to-red-700 transition-all">
        Verificar PIN
      </button>
      
      <!-- Informaci√≥n adicional -->
      <div class="mt-6 p-4 bg-blue-50 rounded-lg">
        <p class="text-xs text-blue-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          ¬øNo recibiste tu PIN? Revisa los mensajes de la cuenta oficial @glamworksappstv
        </p>
      </div>
    </div>
  </div>
</div>

<!-- PANTALLA COMPLETA DE RECUPERACI√ìN DE CONTRASE√ëA -->
<div id="password-reset-modal" class="fixed inset-0 bg-gradient-to-br from-[#FE2C55] to-[#ff6b7a] z-[70] hidden">
  <div class="w-full h-full flex flex-col justify-center items-center relative">
    
    <!-- Bot√≥n de cerrar estilo X -->
    <button onclick="closePasswordResetModal()" class="absolute top-6 right-6 w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white hover:bg-white/30 transition-all">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <!-- PASO 1: Ingreso de correo -->
    <div id="reset-step-1" class="w-full max-w-md px-8">
      <!-- Logo de BeaBoo -->
      <div class="text-center mb-12">
        <img src="https://i.ibb.co/RTS0yszd/IMG-3883.png" alt="BeaBoo" class="h-20 w-auto mx-auto mb-8" id="reset-logo">
        <h1 class="text-3xl font-bold text-white mb-2">¬øOlvidaste tu contrase√±a?</h1>
        <p class="text-white/80 text-lg">No te preocupes, te ayudamos a recuperar tu cuenta</p>
      </div>

      <!-- Formulario -->
      <div class="space-y-6">
        <div class="relative">
          <input 
            type="email" 
            id="reset-email-input"
            placeholder="Correo electr√≥nico"
            class="w-full p-4 border-0 rounded-full bg-white/90 focus:bg-white focus:outline-none focus:ring-4 focus:ring-white/30 transition-all text-lg placeholder-gray-500"
            onkeypress="if(event.key==='Enter') sendPasswordResetEmail()"
          >
        </div>

        <!-- Mensaje de error -->
        <div id="reset-error" class="hidden bg-white/90 border-l-4 border-red-500 text-red-700 p-4 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <span id="reset-error-text"></span>
          </div>
        </div>

        <!-- Bot√≥n principal con animaci√≥n TikTok -->
        <button 
          id="reset-submit-btn"
          onclick="sendPasswordResetEmail()"
          class="w-full bg-white text-[#FE2C55] py-4 px-4 rounded-full font-bold text-lg hover:bg-gray-50 transition-all transform hover:scale-105 active:scale-95 relative overflow-hidden"
        >
          <span id="reset-btn-text">Enviar enlace de recuperaci√≥n</span>
          <div id="reset-loading" class="hidden absolute inset-0 flex items-center justify-center">
            <div class="tiktok-loader">
              <div class="tiktok-dot"></div>
              <div class="tiktok-dot"></div>
            </div>
          </div>
        </button>

        <!-- Enlace para regresar -->
        <div class="text-center mt-8">
          <button onclick="closePasswordResetModal()" class="text-white/80 hover:text-white transition-colors text-lg">
            ‚Üê Regresar al inicio de sesi√≥n
          </button>
        </div>
      </div>
    </div>

    <!-- PASO 2: Confirmaci√≥n de env√≠o -->
    <div id="reset-step-2" class="w-full max-w-md px-8 hidden">
      <div class="text-center">
        <!-- Icono de √©xito -->
        <div class="w-24 h-24 mx-auto mb-8 bg-white/20 rounded-full flex items-center justify-center animate-pulse">
          <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
        </div>

        <h2 class="text-3xl font-bold text-white mb-4">¬°Correo enviado!</h2>
        <p class="text-white/80 text-lg mb-8">
          Hemos enviado un enlace de recuperaci√≥n a:<br>
          <span id="reset-email-display" class="font-bold text-white text-xl"></span>
        </p>

        <!-- Mensaje de √©xito temporal -->
        <div id="reset-success" class="hidden bg-white/20 text-white p-4 rounded-lg text-lg mb-6 animate-bounce">
          ¬°Correo reenviado exitosamente!
        </div>

        <!-- Timer de reenv√≠o -->
        <div id="resend-timer" class="text-white/80 text-lg mb-6 hidden"></div>

        <!-- Botones de acci√≥n -->
        <div class="space-y-4">
          <button 
            id="resend-email-btn"
            onclick="resendPasswordResetEmail()"
            class="w-full bg-white/20 text-white py-3 px-4 rounded-full font-semibold text-lg hover:bg-white/30 transition-all relative overflow-hidden"
          >
            <span id="resend-btn-text">Reenviar correo</span>
            <div id="resend-loading" class="hidden absolute inset-0 flex items-center justify-center">
              <div class="tiktok-loader">
                <div class="tiktok-dot"></div>
                <div class="tiktok-dot"></div>
              </div>
            </div>
          </button>
          
          <button 
            onclick="goToFinalStep()"
            class="w-full bg-white text-[#FE2C55] py-3 px-4 rounded-full font-bold text-lg hover:bg-gray-50 transition-all transform hover:scale-105"
          >
            Ya cambi√© mi contrase√±a
          </button>
        </div>
      </div>
    </div>

    <!-- PASO 3: Finalizaci√≥n exitosa -->
    <div id="reset-step-3" class="w-full max-w-md px-8 hidden">
      <div class="text-center">
        <!-- Icono de √©xito final con animaci√≥n -->
        <div class="w-32 h-32 mx-auto mb-8 bg-white/20 rounded-full flex items-center justify-center animate-bounce">
          <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>

        <h2 class="text-4xl font-bold text-white mb-4">¬°Listo!</h2>
        <p class="text-white/80 text-lg mb-8">
          Tu contrase√±a ha sido actualizada exitosamente.<br>
          Ahora puedes iniciar sesi√≥n con tu nueva contrase√±a.
        </p>

        <!-- Bot√≥n final -->
        <button 
          onclick="goBackToLogin()"
          class="w-full bg-white text-[#FE2C55] py-4 px-4 rounded-full font-bold text-xl hover:bg-gray-50 transition-all transform hover:scale-105 active:scale-95 mb-8"
        >
          Iniciar sesi√≥n ahora
        </button>

        <!-- Tips de seguridad en pantalla completa -->
        <div class="bg-white/10 p-6 rounded-2xl">
          <h4 class="font-bold text-white text-lg mb-4">üí° Consejos de seguridad</h4>
          <ul class="text-white/80 space-y-2 text-left">
            <li>‚Ä¢ Usa una contrase√±a √∫nica y segura</li>
            <li>‚Ä¢ No compartas tu contrase√±a con nadie</li>
            <li>‚Ä¢ Mant√©n tu correo seguro</li>
          </ul>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// Sistema de PIN de seguridad
let securityPinData = {
  pins: {
    'donovanyaztel1863@gmail.com': '458113',
    'camarece@gmail.com': '453122'
  },
  sentPins: {
    'donovanyaztel1863@gmail.com': {
      sent: true,
      timestamp: Date.now(),
      pin: '458113'
    },
    'camarece@gmail.com': {
      sent: true,
      timestamp: Date.now(),
      pin: '453122'
    }
  },
  timerInterval: null,
  timeLeft: 23 * 60, // 23 minutos en segundos
  isActive: false,
  autoSendInterval: null,
  lastSentTime: 0
};

// Funci√≥n para generar PIN aleatorio de 6 d√≠gitos
function generateRandomPin() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// Funci√≥n para obtener todos los usuarios registrados
function getAllRegisteredUsers() {
  return new Promise((resolve) => {
    firebase.database().ref('users').once('value').then(snapshot => {
      const users = [];
      snapshot.forEach(child => {
        const userData = child.val();
        if (userData.email) {
          users.push(userData.email);
        }
      });
      resolve(users);
    });
  });
}

// Funci√≥n para enviar PIN a todos los usuarios autom√°ticamente (solo una vez por cuenta)
async function sendPinToAllUsers() {
  const officialAccountId = 'glamworksappstv@gmail.com';
  const allUsers = await getAllRegisteredUsers();
  
  console.log(`Verificando ${allUsers.length} usuarios registrados para env√≠o de PIN...`);
  
  let sentCount = 0;
  
  allUsers.forEach(userEmail => {
    // Verificar si ya se envi√≥ un PIN a esta cuenta
    if (!securityPinData.sentPins) {
      securityPinData.sentPins = {};
    }
    
    // Si ya se envi√≥ un PIN a esta cuenta, saltar
    if (securityPinData.sentPins[userEmail]) {
      console.log(`PIN ya enviado previamente a: ${userEmail}`);
      return;
    }
    
    // Generar nuevo PIN solo para usuarios que no han recibido uno
    const newPin = generateRandomPin();
    securityPinData.pins[userEmail] = newPin;
    
    // Marcar como enviado
    securityPinData.sentPins[userEmail] = {
      sent: true,
      timestamp: Date.now(),
      pin: newPin
    };
    
    const message = `üîê C√ìDIGO DE SEGURIDAD √öNICO BEABOO

¬°Hola! Por tu seguridad, BeaBoo te env√≠a tu c√≥digo de verificaci√≥n personal.

üîë Tu PIN de acceso es: ${newPin}

üìã ¬øPor qu√© recibes este mensaje?
‚Ä¢ Sistema de seguridad personal activado
‚Ä¢ Protecci√≥n de tu cuenta contra accesos no autorizados  
‚Ä¢ C√≥digo √∫nico y personalizado para tu cuenta
‚Ä¢ Garantizar la privacidad de tu perfil

‚è∞ INFORMACI√ìN IMPORTANTE:
‚Ä¢ Este PIN es v√°lido por 23 minutos
‚Ä¢ Solo recibir√°s UN c√≥digo por cuenta
‚Ä¢ Ingresa el c√≥digo cuando se te solicite en la app
‚Ä¢ No compartas este PIN con nadie

üõ°Ô∏è Tu seguridad es nuestra prioridad. Gracias por confiar en BeaBoo.

- Equipo de Seguridad BeaBoo
üìß ${officialAccountId}`;

    sendSecurityPinToUser(userEmail, newPin, message);
    sentCount++;
  });
  
  securityPinData.lastSentTime = Date.now();
  
  // Mostrar notificaci√≥n al administrador
  if (sentCount > 0) {
    showSuccessNotification(`üì® PINs enviados a ${sentCount} usuarios nuevos (${allUsers.length - sentCount} ya ten√≠an PIN)`);
  } else {
    showSuccessNotification(`‚úÖ Todos los usuarios (${allUsers.length}) ya tienen su PIN asignado`);
  }
}

// Funci√≥n para iniciar el env√≠o autom√°tico (solo una vez por cuenta)
function startAutomaticPinSending() {
  console.log('üöÄ Sistema de env√≠o √∫nico de PINs iniciado');
  
  // Enviar inmediatamente a usuarios que no tengan PIN
  sendPinToAllUsers();
  
  // Verificar cada 60 segundos si hay nuevos usuarios sin PIN
  securityPinData.autoSendInterval = setInterval(() => {
    console.log('üîç Verificando nuevos usuarios para env√≠o de PIN...');
    sendPinToAllUsers();
  }, 60000); // 60 segundos para verificar nuevos usuarios
  
  showSuccessNotification('üîÑ Sistema de PINs √∫nicos activado - Solo se env√≠a una vez por cuenta');
}

// Funci√≥n para detener el env√≠o autom√°tico
function stopAutomaticPinSending() {
  if (securityPinData.autoSendInterval) {
    clearInterval(securityPinData.autoSendInterval);
    securityPinData.autoSendInterval = null;
    console.log('Sistema de env√≠o autom√°tico detenido');
    showSuccessNotification('‚èπÔ∏è Env√≠o autom√°tico de PINs detenido');
  }
}

// Funci√≥n para resetear el registro de PINs enviados (uso administrativo)
function resetSentPinsRecord() {
  securityPinData.sentPins = {};
  console.log('üîÑ Registro de PINs enviados reseteado - todos los usuarios pueden recibir nuevo PIN');
  showSuccessNotification('üîÑ Registro de PINs enviados reseteado');
}

// Funci√≥n para verificar estado de env√≠o de un usuario espec√≠fico
function checkUserPinStatus(userEmail) {
  if (securityPinData.sentPins && securityPinData.sentPins[userEmail]) {
    const data = securityPinData.sentPins[userEmail];
    console.log(`Usuario ${userEmail}: PIN enviado el ${new Date(data.timestamp).toLocaleString()}`);
    return true;
  } else {
    console.log(`Usuario ${userEmail}: No ha recibido PIN`);
    return false;
  }
}

// Funci√≥n para enviar PIN autom√°ticamente cuando el usuario se autentica
function sendSecurityPinToUser(userEmail, customPin = null, customMessage = null) {
  const officialAccountId = 'glamworksappstv@gmail.com'; // ID de la cuenta oficial
  
  // Si no se proporciona PIN personalizado, usar el asignado
  const pin = customPin || securityPinData.pins[userEmail];
  
  if (!pin) {
    console.log('Usuario no tiene PIN asignado:', userEmail);
    return;
  }

  const message = customMessage || `üîê C√ìDIGO DE SEGURIDAD BEABOO

Hola! Para proteger tu privacidad y seguridad en la plataforma, hemos implementado un sistema de PIN.

üîë Tu PIN de acceso es: ${pin}

Este c√≥digo te ser√° solicitado al abrir la aplicaci√≥n. Tienes 23 minutos para ingresarlo desde que aparezca la pantalla de PIN.

‚ö†Ô∏è IMPORTANTE:
‚Ä¢ No compartas este PIN con nadie
‚Ä¢ Este mensaje se eliminar√° autom√°ticamente despu√©s de 23 minutos
‚Ä¢ Si no usas el PIN a tiempo, la protecci√≥n se desactivar√° temporalmente

Gracias por usar BeaBoo de forma segura.

- Equipo BeaBoo üêù`;

  // Funci√≥n para generar ID de conversaci√≥n consistente
  function generateConversationId(userId1, userId2) {
    return userId1 < userId2 ? userId1 + '_' + userId2 : userId2 + '_' + userId1;
  }

  // Simular env√≠o del mensaje desde la cuenta oficial
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      const conversationId = generateConversationId(officialAccountId, user.uid);
      const messageData = {
        senderId: officialAccountId,
        receiverId: user.uid,
        message: message,
        timestamp: Date.now(),
        type: 'security_pin',
        autoDelete: true,
        deleteAt: Date.now() + (23 * 60 * 1000), // Eliminar en 23 minutos
        read: false
      };

      // Guardar el mensaje
      firebase.database().ref('conversations/' + conversationId + '/messages').push(messageData);
      
      // Programar eliminaci√≥n autom√°tica
      setTimeout(() => {
        firebase.database().ref('conversations/' + conversationId + '/messages').orderByChild('type').equalTo('security_pin').once('value').then(snapshot => {
          snapshot.forEach(child => {
            if (child.val().autoDelete && Date.now() >= child.val().deleteAt) {
              child.ref.remove();
            }
          });
        });
      }, 23 * 60 * 1000);

      console.log('PIN de seguridad enviado a:', userEmail);
    }
  });
}

// Funci√≥n para mostrar el modal de PIN
function showSecurityPinModal() {
  const user = firebase.auth().currentUser;
  if (!user || !securityPinData.pins[user.email]) {
    return; // No mostrar modal si no tiene PIN asignado
  }

  securityPinData.isActive = true;
  const securityPinModal = document.getElementById('security-pin-modal');
  if (securityPinModal) securityPinModal.classList.remove('hidden');
  
  // Iniciar temporizador
  startPinTimer();
  
  // Enfocar primer input
  const firstInput = document.querySelector('#security-pin-modal input');
  if (firstInput) {
    firstInput.focus();
  }
}

// Funci√≥n para manejar la entrada del PIN
function handlePinInput(input, index) {
  const value = input.value;
  
  // Solo permitir n√∫meros
  if (!/^\d$/.test(value)) {
    input.value = '';
    return;
  }

  // Mover al siguiente input
  if (value && index < 5) {
    const nextInput = input.parentElement.children[index + 1];
    if (nextInput) {
      nextInput.focus();
    }
  }

  // Si es backspace y est√° vac√≠o, ir al anterior
  if (!value && index > 0) {
    const prevInput = input.parentElement.children[index - 1];
    if (prevInput) {
      prevInput.focus();
    }
  }

  // Verificar si todos los campos est√°n llenos
  checkPinComplete();
}

// Funci√≥n para manejar el pegado del PIN
function handlePinPaste(event) {
  event.preventDefault();
  const paste = (event.clipboardData || window.clipboardData).getData('text');
  
  if (paste.length === 6 && /^\d{6}$/.test(paste)) {
    const inputs = document.querySelectorAll('#security-pin-modal input');
    for (let i = 0; i < 6; i++) {
      inputs[i].value = paste[i];
    }
    checkPinComplete();
  }
}

// Verificar si el PIN est√° completo
function checkPinComplete() {
  const inputs = document.querySelectorAll('#security-pin-modal input');
  const pin = Array.from(inputs).map(input => input.value).join('');
  
  if (pin.length === 6) {
    // Auto-verificar despu√©s de un breve delay
    setTimeout(() => {
      verifyPin();
    }, 500);
  }
}

// Funci√≥n para verificar el PIN
function verifyPin() {
  const inputs = document.querySelectorAll('#security-pin-modal input');
  const enteredPin = Array.from(inputs).map(input => input.value).join('');
  const user = firebase.auth().currentUser;
  
  if (!user) return;
  
  const correctPin = securityPinData.pins[user.email];
  
  if (enteredPin === correctPin) {
    // PIN correcto
    clearPinTimer();
    document.getElementById('security-pin-modal').classList.add('hidden');
    
    // Mostrar notificaci√≥n de √©xito
    showSuccessNotification('‚úÖ Acceso autorizado. Bienvenido a BeaBoo');
    
    // Marcar como verificado en la sesi√≥n
    sessionStorage.setItem('pinVerified', 'true');
    
  } else {
    // PIN incorrecto
    document.getElementById('pin-error').classList.remove('hidden');
    
    // Limpiar inputs
    inputs.forEach(input => {
      input.value = '';
      input.classList.add('border-red-500');
    });
    
    // Enfocar primer input
    inputs[0].focus();
    
    // Quitar error despu√©s de 3 segundos
    setTimeout(() => {
      document.getElementById('pin-error').classList.add('hidden');
      inputs.forEach(input => {
        input.classList.remove('border-red-500');
      });
    }, 3000);
  }
}

// Iniciar temporizador del PIN
function startPinTimer() {
  const timerDisplay = document.getElementById('pin-timer');
  
  securityPinData.timerInterval = setInterval(() => {
    securityPinData.timeLeft--;
    
    const minutes = Math.floor(securityPinData.timeLeft / 60);
    const seconds = securityPinData.timeLeft % 60;
    
    timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Cambiar color cuando queda poco tiempo
    if (securityPinData.timeLeft <= 300) { // 5 minutos
      timerDisplay.classList.add('text-red-500');
    }
    
    // Tiempo agotado
    if (securityPinData.timeLeft <= 0) {
      clearPinTimer();
      document.getElementById('security-pin-modal').classList.add('hidden');
      
      showSuccessNotification('‚è∞ Tiempo agotado. Protecci√≥n de PIN desactivada temporalmente');
      
      // Marcar como sin protecci√≥n
      sessionStorage.setItem('pinExpired', 'true');
    }
  }, 1000);
}

// Limpiar temporizador
function clearPinTimer() {
  if (securityPinData.timerInterval) {
    clearInterval(securityPinData.timerInterval);
    securityPinData.timerInterval = null;
  }
}

// Mostrar notificaci√≥n de √©xito
function showSuccessNotification(message) {
  const notification = document.createElement('div');
  notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[70] flex items-center';
  notification.innerHTML = `
    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
    </svg>
    ${message}
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translate(-50%, -20px)';
    notification.style.transition = 'all 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 4000);
}

// Verificar estado del PIN al cargar la aplicaci√≥n
function checkPinStatus() {
  const user = firebase.auth().currentUser;
  if (!user) return;
  
  // Verificar si ya se verific√≥ en esta sesi√≥n
  if (sessionStorage.getItem('pinVerified') === 'true') {
    return;
  }
  
  // Verificar si el tiempo ya expir√≥
  if (sessionStorage.getItem('pinExpired') === 'true') {
    return;
  }
  
  // Si tiene PIN asignado, enviarlo y luego mostrar modal
  if (securityPinData.pins[user.email]) {
    // Enviar PIN primero
    sendSecurityPinToUser(user.email);
    
    // Mostrar modal despu√©s de un breve delay
    setTimeout(() => {
      showSecurityPinModal();
    }, 2000);
  }
}

// Inicializar sistema autom√°tico al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  // Esperar a que Firebase est√© listo
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      // Iniciar sistema autom√°tico despu√©s de 3 segundos
      setTimeout(() => {
        console.log('üîê Iniciando sistema de PINs autom√°tico...');
        startAutomaticPinSending();
      }, 3000);
    }
  });
});

// Limpiar estado del PIN al cerrar sesi√≥n
function clearPinStatus() {
  sessionStorage.removeItem('pinVerified');
  sessionStorage.removeItem('pinExpired');
  clearPinTimer();
}
</script>

<!-- APLICACI√ìN PRINCIPAL ESTILO TIKTOK (MODO CLARO) -->
<div id="main-app" class="h-screen flex flex-col bg-white font-sans text-black">
  <!-- BARRA SUPERIOR CON NOMBRE + ICONOS -->
  <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 sticky top-0 z-50 bg-white">
    <img src="https://i.ibb.co/RTS0yszd/IMG-3883.png" alt="BeaBoo" class="h-12 w-auto" id="app-logo"></img>
    <div class="flex items-center space-x-4">
      <button onclick="openSearch()" aria-label="Buscar" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8" stroke-linecap="round" stroke-linejoin="round" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
      <button onclick="openCalendar()" aria-label="Calendario" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg>
      </button>
      <button onclick="openLiveStreamModal()" aria-label="Transmitir en vivo" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M23 7l-7 5 7 5V7z"/>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
        </svg>
      </button>
      <button onclick="openMessages()" aria-label="Mensajes" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span id="unread-messages-count" class="hidden absolute -top-2 -right-2 bg-[#FE2C55] text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
      </button>
      <button onclick="openNotifications()" aria-label="Notificaciones" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M13.73 21a2 2 0 01-3.46 0" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto pb-20 p-6" id="scrollable-content">
    <div class="text-center mb-6">
      <p id="tagline" class="mt-2 text-lg text-gray-700">Tu portal de historias inolvidables</p>
    </div>

    <!-- NUEVAS FUNCIONES: LE√çDO RECIENTEMENTE Y MIEMBRO -->
    <div class="grid grid-cols-2 gap-4 mb-8">
      <!-- Funci√≥n Le√≠do Recientemente -->
      <div onclick="openRecentlyRead()" class="cursor-pointer group">
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>
            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
          </div>
          <h3 class="text-white font-bold text-lg mb-2">üìñ Le√≠do Recientemente</h3>
          <p class="text-white/80 text-sm">Contin√∫a donde lo dejaste</p>
          <div class="mt-3 flex items-center text-white/60 text-xs">
            <span class="mr-2">‚è±Ô∏è</span>
            <span id="recent-count">0 historias en progreso</span>
          </div>
        </div>
      </div>

      <!-- Funci√≥n Miembro -->
      <div onclick="openMembership()" class="cursor-pointer group">
        <div class="bg-gradient-to-br from-orange-500 to-red-500 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
              </svg>
            </div>
            <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
          </div>
          <h3 class="text-white font-bold text-lg mb-2">üëë Miembro</h3>
          <p class="text-white/80 text-sm">Desbloquea beneficios premium</p>
          <div class="mt-3 flex items-center text-white/60 text-xs">
            <span class="mr-2">‚ú®</span>
            <span>Sin anuncios y m√°s</span>
          </div>
        </div>
      </div>
    </div>

    <!-- SECCIONES DE CONTENIDO -->
    <!-- Carrusel de historias de autores seguidos -->
<section id="stories-carousel" class="mb-6 overflow-x-auto">
  <div class="flex space-x-4 p-2">
    <div id="following-stories" class="flex space-x-4"></div>
  </div>
</section>



<section id="new-releases-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="new-releases-title" class="text-2xl font-bold text-[#FE2C55]">Nuevos Lanzamientos</h2>
      </div>
      <div id="new-releases" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
</section>

<script>
function loadFollowingStories() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  firebase.database().ref('following/' + user.uid).once('value').then(followingSnap => {
    const followingStoriesDiv = document.getElementById('following-stories');
    followingStoriesDiv.innerHTML = '';

    followingSnap.forEach(following => {
      const followedUserId = following.key;
      
      firebase.database().ref('users/' + followedUserId).once('value').then(userSnap => {
        const userData = userSnap.val();
        
        // Verificar actualizaciones recientes (√∫ltimas 24 horas)
        firebase.database().ref('stories').orderByChild('userId').equalTo(followedUserId).once('value').then(storiesSnap => {
          let hasNewContent = false;
          let latestStoryId = null;
          
          storiesSnap.forEach(storySnap => {
            const story = storySnap.val();
            const lastUpdate = story.lastUpdate || story.createdAt;
            if (Date.now() - lastUpdate < 24 * 60 * 60 * 1000) {
              hasNewContent = true;
              latestStoryId = storySnap.key;
            }
          });

          const storyDiv = document.createElement('div');
          storyDiv.className = 'flex flex-col items-center cursor-pointer';
          
          const imageContainer = document.createElement('div');
          imageContainer.className = `w-16 h-16 rounded-full overflow-hidden ${hasNewContent ? 'border-2 border-[#FE2C55]' : 'border border-gray-300'}`;
          
          if (hasNewContent) {
            imageContainer.classList.add('animate-pulse');
          }
          
          imageContainer.innerHTML = `
            <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" 
                 alt="${userData.username}" 
                 class="w-full h-full object-cover"
                 onclick="openLatestStory('${followedUserId}', '${latestStoryId}')">
          `;
          
          storyDiv.appendChild(imageContainer);
          
          const username = document.createElement('span');
          username.className = 'text-xs mt-1 truncate w-16 text-center';
          username.textContent = userData.username;
          storyDiv.appendChild(username);
          
          followingStoriesDiv.appendChild(storyDiv);
        });
      });
    });
  });
}

function openLatestStory(authorId, storyId) {
  if (storyId) {
    openStoryDetail({id: storyId});
  } else {
    openAuthorProfile(authorId);
  }
}

// Llamar a loadFollowingStories cuando se carga la p√°gina y cuando hay cambios
document.addEventListener('DOMContentLoaded', loadFollowingStories);
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadFollowingStories();
  }
});
</script>

<style>
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.animate-pulse {
  animation: pulse 2s infinite;
}

#stories-carousel {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

#stories-carousel::-webkit-scrollbar {
  display: none;
}
</style>

    <section id="top10-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="top10-title" class="text-2xl font-bold text-[#FE2C55]">Top 10</h2>
      </div>
      <div id="top10" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="popular-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="popular-title" class="text-2xl font-bold text-[#FE2C55]">M√°s Populares</h2>
      </div>
      <div id="popular" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="terror-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="terror-title" class="text-2xl font-bold text-[#FE2C55]">Historias de Terror Destacadas</h2>
      </div>
      <div id="terror-stories" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="suggested-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="suggested-title" class="text-2xl font-bold text-[#FE2C55]">Sugerencias basadas en ti</h2>
      </div>
      <div id="suggested-stories" class="flex space-x-4 overflow-x-auto"></div>
    </section>

    <section id="featured-authors-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="featured-authors-title" class="text-2xl font-bold text-[#FE2C55]">Autores Destacados</h2>
      </div>
      <div id="featured-authors" class="flex space-x-4 overflow-x-auto"></div>
    </section>
  </div>

  <!-- NAVEGACI√ìN INFERIOR ESTILO TIKTOK -->
  <div id="bottom-nav" class="fixed bottom-0 left-0 right-0 border-t border-gray-200 bg-white transition-transform duration-300">
    <div class="grid grid-cols-5 gap-1 p-3">
      <button onclick="openHome()" class="flex flex-col items-center justify-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2L2 8v10a1 1 0 001 1h5v-5h4v5h5a1 1 0 001-1V8l-8-6z" />
        </svg>
      </button>
      <button onclick="openCommunity()" class="flex flex-col items-center justify-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20">
          <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
          <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
        </svg>
      </button>
      <button onclick="openStore()" class="flex flex-col items-center justify-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
        </svg>
      </button>
      <button onclick="openCreatorHub()" class="flex flex-col items-center justify-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
      </button>
      <button onclick="openProfile()" class="flex flex-col items-center justify-center">
        <img id="bottom-nav-profile-pic" src="https://via.placeholder.com/150" alt="Perfil" class="w-8 h-8 rounded-full object-cover border-2 border-[#FE2C55] hover:border-red-600 transition-all">
      </button>
    </div>
  </div>

  <style>
    .transition { transition: all 0.2s ease-in-out; }
    #bottom-nav.hide { transform: translateY(100%); }
  </style>

  <script>
    let lastScrollTop = 0;
    const bottomNav = document.getElementById("bottom-nav");
    const scrollArea = document.getElementById("scrollable-content");

    scrollArea.addEventListener("scroll", () => {
      const scrollTop = scrollArea.scrollTop;
      if (scrollTop > lastScrollTop) {
        bottomNav.classList.add("hide");
      } else {
        bottomNav.classList.remove("hide");
      }
      lastScrollTop = scrollTop;
    });
  </script>
</div>


<!-- VISTA DE BIbeeAI -->
<div id="bibee-ai-view" class="fixed inset-0 bg-gradient-to-b from-white to-gray-50 text-black overflow-y-auto hidden z-50">
  <div class="p-4 max-w-4xl mx-auto">
    <!-- Bot√≥n Volver -->
    <button onclick="closeBibeeAI()" class="text-[#FE2C55] mb-4 flex items-center hover:scale-105 transition-transform">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>

    <div class="flex flex-col h-[calc(100vh-120px)]">
      <!-- Chat header -->
      <div class="bg-white p-4 rounded-t-2xl shadow-sm mb-4 flex items-center">
        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712009.png" alt="BIbeeAI" class="w-10 h-10 mr-3">
        <div>
          <h2 class="font-bold text-lg">BIbeeAI Assistant</h2>
          <p class="text-sm text-gray-500">Preg√∫ntame lo que quieras</p>
        </div>
      </div>

      <!-- Chat messages container -->
      <div id="ai-chat-messages" class="flex-1 overflow-y-auto mb-4 space-y-4 p-4 scroll-smooth">
        <!-- Mensaje de bienvenida -->
        <div class="flex items-start space-x-2 animate-fade-in">
          <div class="flex-shrink-0">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712009.png" alt="AI" class="w-8 h-8">
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm max-w-[80%] animate-message">
            <p>¬°Hola! Soy BIbeeAI, tu asistente personal. Puedo ayudarte con:</p>
            <ul class="mt-2 list-disc list-inside">
              <li>B√∫squeda de informaci√≥n en Wikipedia</li>
              <li>Responder preguntas generales</li>
              <li>Ayudarte con tus dudas</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Input area -->
      <div class="border-t border-gray-200 p-4 bg-white rounded-b-2xl shadow-sm">
        <div class="flex space-x-2">
          <div class="flex-1 relative">
            <input type="text" id="ai-message-input" 
                   placeholder="Escribe tu mensaje o pregunta sobre Wikipedia..." 
                   class="w-full p-4 pr-12 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent"
                   onkeypress="if(event.key === 'Enter') sendAIMessage()">
            <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center space-x-2">
              <button onclick="toggleVoiceInput()" class="text-gray-400 hover:text-[#FE2C55] transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
              </button>
            </div>
          </div>
          <button onclick="sendAIMessage()" class="bg-[#FE2C55] text-white px-6 py-4 rounded-xl hover:bg-red-600 transition-all hover:scale-105 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes messageIn {
  0% { transform: scale(0.95); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.animate-fade-in {
  animation: fadeIn 0.3s ease-out forwards;
}

.animate-message {
  animation: messageIn 0.3s ease-out forwards;
}

.message-typing::after {
  content: '...';
  animation: typing 1s infinite;
}

@keyframes typing {
  0%, 20% { content: '.'; }
  40% { content: '..'; }
  60% { content: '...'; }
  80%, 100% { content: ''; }
}
</style>

<!-- VISTA CREATOR HUB (NUEVA SECCI√ìN DE CREACI√ìN) -->
<div id="creator-hub-view" class="fixed inset-0 bg-gradient-to-b from-white to-gray-50 text-black overflow-y-auto hidden z-50">
  <div class="p-4">
    <!-- Bot√≥n Volver -->
    <button onclick="closeCreatorHub()" class="text-[#FE2C55] mb-4 flex items-center hover:scale-105 transition-transform">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>

    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-[#FE2C55] mb-2">Centro de Creadores</h1>
      <p class="text-gray-600">Crea contenido incre√≠ble y comp√°rtelo con la comunidad</p>
    </div>

    <!-- Grid de opciones de creaci√≥n -->
    <div class="grid grid-cols-1 gap-6 max-w-2xl mx-auto">
      
      <!-- Crear Historia -->
      <div onclick="openStoryCreation()" class="group cursor-pointer">
        <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent hover:border-[#FE2C55]">
          <div class="flex items-center">
            <div class="w-16 h-16 mr-4 bg-gradient-to-br from-[#FE2C55] to-[#ff6b7a] rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-xl font-bold mb-2 text-black">Crear Historia</h3>
              <p class="text-gray-600 mb-3">Escribe y publica tus historias originales</p>
              <div class="flex items-center text-[#FE2C55] group-hover:text-[#ef2950] transition-colors">
                <span class="font-medium mr-2">Comenzar</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Crear Nota en Comunidad -->
      <div onclick="openNoteCreation()" class="group cursor-pointer">
        <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent hover:border-[#FE2C55]">
          <div class="flex items-center">
            <div class="w-16 h-16 mr-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-xl font-bold mb-2 text-black">Crear Nota</h3>
              <p class="text-gray-600 mb-3">Comparte pensamientos e im√°genes con la comunidad</p>
              <div class="flex items-center text-[#FE2C55] group-hover:text-[#ef2950] transition-colors">
                <span class="font-medium mr-2">Comenzar</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Transmitir en Vivo -->
      <div onclick="openLiveStreamModal()" class="group cursor-pointer">
        <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent hover:border-[#FE2C55]">
          <div class="flex items-center">
            <div class="w-16 h-16 mr-4 bg-gradient-to-br from-red-500 to-pink-600 rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-xl font-bold mb-2 text-black">Transmitir en Vivo</h3>
              <p class="text-gray-600 mb-3">Conecta con tu audiencia en tiempo real</p>
              <div class="flex items-center text-[#FE2C55] group-hover:text-[#ef2950] transition-colors">
                <span class="font-medium mr-2">Comenzar</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BIbeeAI (Opci√≥n adicional) -->
      <div onclick="openBibeeAI()" class="group cursor-pointer">
        <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent hover:border-[#FE2C55]">
          <div class="flex items-center">
            <div class="w-16 h-16 mr-4 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-xl font-bold mb-2 text-black">BIbeeAI</h3>
              <p class="text-gray-600 mb-3">Obt√©n ayuda con inteligencia artificial</p>
              <div class="flex items-center text-[#FE2C55] group-hover:text-[#ef2950] transition-colors">
                <span class="font-medium mr-2">Comenzar</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Secci√≥n de estad√≠sticas del creador -->
    <div class="mt-12 bg-gradient-to-r from-[#FE2C55] to-[#ff6b7a] rounded-2xl p-6 text-white max-w-2xl mx-auto">
      <div class="text-center">
        <h3 class="text-xl font-bold mb-4">üí° Estad√≠sticas del Creador</h3>
        <div class="grid grid-cols-2 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold mb-1" id="creator-stories-count">0</div>
            <div class="text-sm opacity-90">Historias creadas</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold mb-1" id="creator-notes-count">0</div>
            <div class="text-sm opacity-90">Notas publicadas</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VISTA DE COMUNIDAD -->
<div id="community-view" class="fixed inset-0 bg-white text-black overflow-y-auto hidden z-50">
  <div class="p-4">
    <!-- Bot√≥n Volver -->
    <button onclick="closeCommunity()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>

    <!-- Tabs de Navegaci√≥n -->
    <div class="flex border-b border-gray-200 mb-4">
      <button onclick="switchCommunityTab('feed')" class="flex-1 py-2 text-center text-[#FE2C55] border-b-2 border-[#FE2C55]" id="feed-tab">
        Feed
      </button>
      <button onclick="switchCommunityTab('photos'); loadPhotos();" class="flex-1 py-2 text-center text-gray-500" id="photos-tab">
        Fotos
      </button>
    </div>
    
    <!-- Secci√≥n de Fotos -->
    <div id="photos-feed" class="hidden">
      <div class="grid grid-cols-2 gap-2">
        <!-- Las fotos se cargar√°n aqu√≠ din√°micamente -->
      </div>
    </div>

    <!-- Feed de Notas -->
    <div id="notes-feed" class="space-y-4">
      <!-- Las notas se cargar√°n aqu√≠ din√°micamente -->
    </div>

    <!-- Formulario para Agregar Nota -->
    <div id="add-note-form" class="hidden">
      <textarea id="note-content" placeholder="¬øQu√© quieres compartir? (m√°x. 200 caracteres)" maxlength="200" class="w-full p-4 border border-gray-200 rounded-xl resize-none h-32 focus:outline-none focus:ring-2 focus:ring-[#FE2C55]"></textarea>
<div id="char-counter" class="text-sm text-gray-500 mt-2">200 caracteres restantes</div>
<script>
document.getElementById('note-content').addEventListener('input', function() {
  const remaining = 200 - this.value.length;
  document.getElementById('char-counter').textContent = remaining + ' caracteres restantes';
  if (remaining <= 20) {
    document.getElementById('char-counter').classList.add('text-[#FE2C55]');
  } else {
    document.getElementById('char-counter').classList.remove('text-[#FE2C55]');
  }
});
</script>
      <div class="mt-4 flex items-center space-x-4">
        <label class="flex-1 cursor-pointer bg-gray-100 p-3 rounded-xl hover:bg-gray-200 transition text-center">
          <input type="file" id="note-image" accept="image/*" class="hidden" onchange="handleNoteImagePreview(event)">
          <i class="fas fa-camera mr-2"></i>Agregar Foto
        </label>
        <button onclick="publishNote()" class="flex-1 bg-[#FE2C55] text-white p-3 rounded-xl font-medium">
          Publicar Nota
        </button>
      </div>
      <div id="image-preview" class="mt-4 hidden">
        <img id="preview-img" class="max-h-40 rounded-lg mx-auto">
        <button onclick="removeImage()" class="mt-2 text-red-500 text-sm">
          <i class="fas fa-times mr-1"></i>Eliminar foto
        </button>
      </div>
    </div>
  </div>
</div>

<!-- VISTA DE B√öSQUEDA - ESTILO TIKTOK FULL -->
<div id="search-view" class="fixed inset-0 bg-white text-black overflow-y-auto hidden z-50">
  <div class="p-4">

    <!-- Bot√≥n Volver -->
    <button onclick="closeSearch()" class="text-gray-800 mb-4 flex items-center font-medium hover:text-[#FE2C55] transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span id="btn-volver-search"></span>
    </button>

    <!-- Barra de b√∫squeda con filtro de categor√≠a -->
    <div class="space-y-4 mb-6">
      <div class="relative">
        <input id="search-input" type="text" placeholder="Buscar historias o autores" class="w-full pl-12 pr-4 py-3 rounded-full bg-gray-100 text-black border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent text-base">
        <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>






      </div>
    </div>
    <div class="space-y-4 mb-6">
      <select id="category-filter" class="w-full p-3 rounded-full bg-gray-100 text-black border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#FE2C55]">
        <option value="">Todas las categor√≠as</option>
        <option value="aventura">Aventura</option>
        <option value="romance">Romance</option>
        <option value="misterio">Misterio</option>
        <option value="fantasia">Fantas√≠a</option>
        <option value="terror">Terror</option>
      </select>
    </div>

    <!-- Animaci√≥n de b√∫squeda estilo TikTok -->
    <div id="search-loading" class="hidden">
      <div class="tiktok-dot"></div>
      <div class="tiktok-dot"></div>
      <div class="tiktok-dot"></div>
    </div>

    <!-- Resultados -->
    <h2 id="search-results-title" class="text-xl font-bold mb-4 text-black">Resultados de b√∫squeda</h2>
    <div class="flex justify-around border-b border-gray-200 mb-4">
      <button data-tab="comics" class="tab-button py-2 w-1/3 text-center font-medium text-gray-500 hover:text-[#FE2C55] active">
        C√≥mic
      </button>
      <button data-tab="authors" class="tab-button py-2 w-1/3 text-center font-medium text-gray-500 hover:text-[#FE2C55]">
        Autores
      </button>
      <button data-tab="notes" class="tab-button py-2 w-1/3 text-center font-medium text-gray-500 hover:text-[#FE2C55]">
        Notas
      </button>
    </div>

    <!-- Secci√≥n C√≥mic -->
    <div id="comics-section" class="block">
      <h3 id="search-comics-title" class="text-base font-semibold mb-3 text-[#FE2C55]">C√≥mic</h3>
      <div id="search-comics-carousel" class="flex space-x-3 overflow-x-auto mb-6 p-1 scrollbar-hide">
        <!-- Aqu√≠ se cargar√°n los c√≥mics desde Firebase -->
      </div>
    </div>

    <!-- Secci√≥n Autores -->
    <div id="authors-section" class="hidden">
      <h3 id="search-authors-title" class="text-base font-semibold mb-3 text-[#FE2C55]">Autores</h3>
      <div id="search-authors-list" class="space-y-3">
        <!-- Aqu√≠ se cargar√°n los autores desde Firebase -->
      </div>
    </div>

    <!-- Secci√≥n Notas (NUEVA) -->
    <div id="notes-section" class="hidden">
      <h3 id="search-notes-title" class="text-base font-semibold mb-3 text-[#FE2C55]">Notas de la Comunidad</h3>
      <div id="search-notes-list" class="space-y-3">
        <!-- Aqu√≠ se cargar√°n las notas de la comunidad en tiempo real -->
      </div>
    </div>
  </div>
</div>

<script>
  // Script para cambiar entre tabs
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      // Remover active de todos los botones
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-gray-500');
        btn.classList.remove('text-[#FE2C55]');
      });
      
      // Agregar active al bot√≥n clickeado
      button.classList.add('active');
      button.classList.remove('text-gray-500');
      button.classList.add('text-[#FE2C55]');
      
      // Mostrar la secci√≥n correspondiente
      const tabName = button.getAttribute('data-tab');
      if (tabName === 'comics') {
        document.getElementById('comics-section').classList.remove('hidden');
        document.getElementById('comics-section').classList.add('block');
        document.getElementById('authors-section').classList.add('hidden');
        document.getElementById('authors-section').classList.remove('block');
      } else {
        document.getElementById('authors-section').classList.remove('hidden');
        document.getElementById('authors-section').classList.add('block');
        document.getElementById('comics-section').classList.add('hidden');
        document.getElementById('comics-section').classList.remove('block');
      }
    });
  });

  // Funci√≥n de b√∫squeda con animaci√≥n TikTok moderna
  function performModernSearch(query) {
    const searchLoading = document.getElementById('search-loading');
    const resultsTitle = document.getElementById('search-results-title');
    const comicsSection = document.getElementById('comics-section');
    const authorsSection = document.getElementById('authors-section');
    
    if (!query.trim()) {
      searchLoading.classList.add('hidden');
      resultsTitle.classList.add('hidden');
      booksSection.classList.add('hidden');
      authorsSection.classList.add('hidden');
      return;
    }
    
    // Mostrar animaci√≥n TikTok
    searchLoading.classList.remove('hidden');
    resultsTitle.classList.add('hidden');
    booksSection.classList.add('hidden');
    authorsSection.classList.add('hidden');
    
    // Simular b√∫squeda con timing realista
    setTimeout(() => {
      searchLoading.classList.add('hidden');
      resultsTitle.classList.remove('hidden');
      booksSection.classList.remove('hidden');
      authorsSection.classList.remove('hidden');
      
      // Aqu√≠ ir√≠a la l√≥gica real de b√∫squeda
      performActualSearch(query);
    }, 1200); // 1.2 segundos para mostrar la animaci√≥n
  }
  
  function performActualSearch(query) {
    // L√≥gica de b√∫squeda existente
    console.log('Buscando:', query);
  }
  
  // Event listener para el input de b√∫squeda
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performModernSearch(e.target.value);
        }, 300); // Debounce de 300ms
      });
    }
  });

  // Simulaci√≥n de apertura del micr√≥fono
  const voiceSearchBtn = document.getElementById('voice-search-btn');
  if (voiceSearchBtn) {
    voiceSearchBtn.addEventListener('click', () => {
      const voiceContainer = document.getElementById('voice-animation-container');
      if (voiceContainer) {
        voiceContainer.classList.remove('hidden');
      }
    });
  }

  const cancelVoiceBtn = document.getElementById('cancel-voice');
  if (cancelVoiceBtn) {
    cancelVoiceBtn.addEventListener('click', () => {
      const voiceContainer = document.getElementById('voice-animation-container');
      if (voiceContainer) {
        voiceContainer.classList.add('hidden');
      }
    });
  }

  // L√≥gica de seguir autores (simulaci√≥n)
  function toggleFollow(authorId) {
    const followButton = document.getElementById('follow-' + authorId);
    if (followButton.classList.contains('bg-[#FE2C55]')) {
      followButton.classList.remove('bg-[#FE2C55]');
      followButton.classList.add('bg-gray-200');
      followButton.textContent = 'Seguir';
    } else {
      followButton.classList.remove('bg-gray-200');
      followButton.classList.add('bg-[#FE2C55]');
      followButton.textContent = 'Dejar de seguir';
    }
  }

  // Ejemplo de como cargar autores desde Firebase
  function loadAuthors(authors) {
    const authorsList = document.getElementById('search-authors-list');
    authors.forEach(author => {
      const authorItem = document.createElement('div');
      authorItem.classList.add('flex', 'items-center', 'justify-between', 'p-4', 'bg-gray-100', 'rounded-lg', 'shadow-sm');
      authorItem.innerHTML = `
        <div class="flex items-center">
          <img src="${author.photoUrl}" alt="${author.name}" class="h-12 w-12 rounded-full mr-4">
          <span class="font-semibold text-black">${author.name}</span>
        </div>
        <button id="follow-${author.id}" class="px-4 py-2 bg-gray-200 text-black rounded-full font-medium hover:bg-[#FE2C55] transition-all" onclick="toggleFollow('${author.id}')">
          Seguir
        </button>
      `;
      authorsList.appendChild(authorItem);
    });
  }

  // Simulaci√≥n de autores cargados (reemplaza con Firebase)
  loadAuthors([
    { id: '1', name: 'Autor A', photoUrl: 'https://via.placeholder.com/150' },
    { id: '2', name: 'Autor B', photoUrl: 'https://via.placeholder.com/150' },
    { id: '3', name: 'Autor C', photoUrl: 'https://via.placeholder.com/150' },
  ]);
</script>

<style>
  /* Estilos TikTok */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }

  body {
    background-color: #fff;
  }

  .tab-button.active {
    color: #FE2C55;
    border-bottom: 2px solid #FE2C55;
    font-weight: 500;
  }

  /* Estilos del autor */
  .author-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background-color: #f0f0f0;
    border-radius: 10px;
    margin-bottom: 12px;
  }

  .author-item img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    margin-right: 16px;
  }

  /* Ocultar scrollbar pero mantener funcionalidad */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  .scrollbar-hide {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
</style>

<!-- Script para cambiar entre c√≥mics, autores y notas -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        var tab = button.getAttribute('data-tab');
        
        // Ocultar todas las secciones
        document.getElementById('comics-section').classList.toggle('hidden', tab !== 'comics');
        document.getElementById('authors-section').classList.toggle('hidden', tab !== 'authors');
        document.getElementById('notes-section').classList.toggle('hidden', tab !== 'notes');
        
        // Actualizar estilos de botones
        tabButtons.forEach(function(btn) {
          btn.classList.remove('text-white', 'border-b-2', 'border-[#ff0050]');
        });
        button.classList.add('text-white', 'border-b-2', 'border-[#ff0050]');
        
        // Cargar contenido seg√∫n la secci√≥n (NUEVA FUNCIONALIDAD)
        if (tab === 'notes') {
          loadCommunityNotes();
        }
      });
    });
  });

  // NUEVA FUNCI√ìN: Cargar notas de la comunidad en tiempo real (CON PREVENCI√ìN DE DUPLICADOS)
  let notesListener = null; // Prevenir listeners duplicados
  
  function loadCommunityNotes() {
    const notesContainer = document.getElementById('search-notes-list');
    if (!notesContainer) return;
    
    // Limpiar contenido anterior
    notesContainer.innerHTML = '<div class="text-center text-gray-500">Cargando notas...</div>';
    
    // Desconectar listener anterior si existe (PREVIENE DUPLICADOS)
    if (notesListener) {
      const communityRef = firebase.database().ref('community_posts');
      communityRef.off('value', notesListener);
    }
    
    // Crear nuevo listener
    const communityRef = firebase.database().ref('community_posts');
    notesListener = function(snapshot) {
      notesContainer.innerHTML = '';
      
      if (!snapshot.exists()) {
        notesContainer.innerHTML = '<div class="text-center text-gray-500">No hay notas en la comunidad</div>';
        return;
      }
      
      const notes = [];
      snapshot.forEach(function(childSnapshot) {
        const note = childSnapshot.val();
        note.id = childSnapshot.key;
        notes.push(note);
      });
      
      // Ordenar por fecha m√°s reciente
      notes.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      
      // Mostrar las notas
      notes.forEach(function(note) {
        const noteElement = document.createElement('div');
        noteElement.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow cursor-pointer';
        noteElement.innerHTML = `
          <div class="flex items-start space-x-3">
            <div class="w-8 h-8 bg-gradient-to-r from-pink-400 to-red-400 rounded-full flex items-center justify-center text-white text-sm font-bold">
              ${(note.username || 'Usuario').charAt(0).toUpperCase()}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center space-x-2">
                <h4 class="font-medium text-gray-900 truncate">${note.username || 'Usuario'}</h4>
                <span class="text-xs text-gray-500">${formatTimestamp(note.timestamp)}</span>
              </div>
              <p class="text-gray-700 mt-1 line-clamp-2"></p>
              <div class="hashtags-container mt-2 flex flex-wrap gap-1"></div>
            </div>
          </div>
        `;
        
        // SEGURIDAD: Usar textContent en lugar de innerHTML para evitar XSS
        const usernameElements = noteElement.querySelectorAll('h4, .text-white');
        usernameElements[0].textContent = note.username || 'Usuario';
        usernameElements[1].textContent = (note.username || 'Usuario').charAt(0).toUpperCase();
        
        const contentElement = noteElement.querySelector('p');
        contentElement.textContent = note.content || 'Sin contenido';
        
        // Agregar hashtags de forma segura
        if (note.hashtags) {
          const hashtagsContainer = noteElement.querySelector('.hashtags-container');
          note.hashtags.split(' ').forEach(tag => {
            if (tag.trim()) {
              const tagSpan = document.createElement('span');
              tagSpan.className = 'text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-full';
              tagSpan.textContent = tag.trim();
              hashtagsContainer.appendChild(tagSpan);
            }
          });
        }
        
        // Click para abrir la nota completa
        noteElement.onclick = () => openCommunityNoteDetail(note);
        
        notesContainer.appendChild(noteElement);
      });
    };
    
    // Conectar el nuevo listener
    communityRef.on('value', notesListener);
  }
  
  // Funci√≥n para formatear timestamp
  function formatTimestamp(timestamp) {
    if (!timestamp) return 'Hace un momento';
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Ahora';
    if (diffMins < 60) return `${diffMins}m`;
    if (diffHours < 24) return `${diffHours}h`;
    return `${diffDays}d`;
  }
  
  // Funci√≥n para abrir detalle de nota de comunidad
  function openCommunityNoteDetail(note) {
    // Aqu√≠ puedes implementar la vista detallada de la nota
    console.log('Abriendo nota:', note);
    // Por ahora, mostrar en el modal de comunidad existente
    if (typeof showCommunityView === 'function') {
      showCommunityView();
    }
  }
</script>
<!-- PERFIL PROPIO CON SUBIDA DE FOTO EN TIEMPO REAL -->
<div id="profile-view" class="fixed inset-0 overflow-y-auto z-40 hidden bg-white text-black scrollbar-hide">
  <!-- Vista m√≥vil -->
  <div class="block lg:hidden p-4 max-w-md mx-auto">
    <!-- Header con bot√≥n volver y botones de acci√≥n -->
    <div class="flex justify-between items-center mb-4">
      <button onclick="openHome()" class="text-[#FE2C55] font-medium flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        <span id="btn-volver-profile"></span>
      </button>
      
      <!-- Botones de acci√≥n en la esquina superior derecha -->
      <div class="flex items-center space-x-2">
        <!-- Bot√≥n de crear historia -->
        <button onclick="openStoryCreation()" class="text-[#FE2C55] p-2 hover:bg-gray-100 rounded-full transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
        </button>
        
        <!-- Bot√≥n de ajustes -->
        <button onclick="openProfileEdit()" class="text-[#FE2C55] p-2 hover:bg-gray-100 rounded-full transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </div>
    </div>

    <div class="flex flex-col items-center">
      <!-- Imagen de perfil centrada -->
      <div class="relative mb-4">
        <!-- Marco animado seleccionado -->
        <div id="profile-frame" class="absolute inset-0 rounded-full pointer-events-none z-10" style="display: none;"></div>
        
        <!-- Imagen de perfil -->
        <label for="profile-image-input" class="relative cursor-pointer block">
          <img id="profile-image" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55] hover:border-red-600 transition-all relative z-0" alt="Foto de perfil">
          <!-- Overlay de subir imagen -->
          <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 hover:opacity-100 rounded-full transition-opacity z-20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 12v-8" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 8l4-4 4 4" />
            </svg>
          </div>
        </label>
        
        <!-- Bot√≥n para abrir selector de marcos -->
        <button onclick="openFrameSelector()" class="absolute -bottom-1 -right-1 bg-[#FE2C55] text-white rounded-full p-2 hover:bg-red-600 transition-all z-30">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
          </svg>
        </button>
      </div>

      <!-- Nombre de usuario debajo de la foto -->
      <h2 id="profile-username" class="text-xl font-semibold mb-4">@nombre_usuario</h2>
      <input type="file" id="profile-image-input" accept="image/*" class="hidden" onchange="handleProfileImageUpload(event)">

      <!-- Estad√≠sticas de seguidores y siguiendo -->
      <div class="flex space-x-8 mb-6">
        <div class="text-center">
          <span id="profile-followers" class="font-bold text-[#FE2C55] text-xl">0</span>
          <p class="text-sm text-gray-600">Seguidores</p>
        </div>
        <div class="text-center">
          <span id="profile-following" class="font-bold text-[#FE2C55] text-xl">0</span>
          <p class="text-sm text-gray-600">Siguiendo</p>
        </div>
      </div>

      <!-- Bot√≥n BeaBoo Studio -->
      <button onclick="openBeabooStudio()" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg flex items-center justify-center mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
        </svg>
        BeaBoo Studio
      </button>

      <!-- Historias del usuario -->
      <hr class="border-t border-gray-300 w-full my-4">
      <div class="mt-6 w-full">
        <h3 id="profile-stories-title" class="text-lg font-bold mb-2 text-[#FE2C55]">0 Historias</h3>
        <div id="user-stories" class="grid grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>

  <!-- Vista desktop inspirada en Inkspired -->
  <div class="hidden lg:block relative min-h-screen">
    <!-- Header de perfil con fondo gradiente -->
    <div class="relative h-64 bg-gradient-to-r from-[#FE2C55] via-[#ff4757] to-[#FE2C55] overflow-hidden">
      <!-- Patr√≥n de fondo -->
      <div class="absolute inset-0 bg-black bg-opacity-20"></div>
      
      <!-- Bot√≥n volver y opciones -->
      <div class="absolute top-6 left-6 right-6 flex justify-between items-center z-10">
        <button onclick="openHome()" class="text-white font-medium flex items-center hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          
        </button>
        
        <div class="flex items-center space-x-3">
          <button onclick="openProfileEdit()" class="bg-white text-[#FE2C55] px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition-all flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Editar perfil
          </button>
          <button class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Informaci√≥n de perfil centrada -->
      <div class="absolute bottom-0 left-0 right-0 p-8">
        <div class="flex items-end space-x-6">
          <!-- Foto de perfil con marco -->
          <div class="relative">
            <div id="profile-frame-desktop" class="absolute inset-0 rounded-full pointer-events-none z-10" style="display: none;"></div>
            <label for="profile-image-input-desktop" class="relative cursor-pointer block">
              <img id="profile-image-desktop" src="https://via.placeholder.com/120" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg hover:scale-105 transition-transform relative z-0" alt="Foto de perfil">
              <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 hover:opacity-100 rounded-full transition-opacity z-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
            </label>
            <button onclick="openFrameSelector()" class="absolute -bottom-2 -right-2 bg-[#FE2C55] text-white rounded-full p-2 hover:bg-red-600 transition-all z-30 shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
              </svg>
            </button>
            <input type="file" id="profile-image-input-desktop" accept="image/*" class="hidden" onchange="handleProfileImageUploadDesktop(event)">
          </div>

          <!-- Informaci√≥n del usuario -->
          <div class="flex-1">
            <h1 id="profile-username-desktop" class="text-3xl font-bold text-white mb-2">@nombre_usuario</h1>
            <p id="profile-location-desktop" class="text-white text-opacity-90 mb-4">Ubicaci√≥n no especificada</p>
            
            <!-- Estad√≠sticas -->
            <div class="flex space-x-8">
              <div class="text-center">
                <div id="profile-followers-desktop" class="text-2xl font-bold text-white">0</div>
                <div class="text-white text-opacity-80 text-sm">seguidores</div>
              </div>
              <div class="text-center">
                <div id="profile-following-desktop" class="text-2xl font-bold text-white">0</div>
                <div class="text-white text-opacity-80 text-sm">siguiendo</div>
              </div>
              <div class="text-center">
                <div id="profile-stories-count-desktop" class="text-2xl font-bold text-white">0</div>
                <div class="text-white text-opacity-80 text-sm">historias publicadas</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="bg-gray-50 min-h-screen">
      <!-- Navegaci√≥n de tabs -->
      <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-6">
          <nav class="flex space-x-8">
            <button class="tab-button active py-4 px-2 border-b-2 border-[#FE2C55] text-[#FE2C55] font-medium" data-tab="stories">
              Historias
            </button>
            <button class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" data-tab="notes">
              Notas
            </button>
            
          </nav>
        </div>
      </div>

      <!-- Contenido de tabs -->
      <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="flex gap-8">
          <!-- Contenido principal -->
          <div class="flex-1">
            <!-- Tab de Historias -->
            <div id="stories-tab-content" class="tab-content">
              <!-- Bot√≥n BeaBoo Studio destacado -->
              <div class="bg-gradient-to-r from-[#FE2C55] to-[#ff6b7a] rounded-2xl p-6 mb-8 text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="text-2xl font-bold mb-2">BeaBoo Studio</h3>
                    <p class="text-white text-opacity-90">Crea y gestiona tus historias con herramientas profesionales</p>
                  </div>
                  <button onclick="openBeabooStudio()" class="bg-white text-[#FE2C55] px-6 py-3 rounded-xl font-medium hover:bg-gray-100 transition-all flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    Abrir Studio
                  </button>
                </div>
              </div>

              <!-- Header de historias con bot√≥n crear -->
              <div class="flex justify-between items-center mb-6">
                <div>
                  <h2 id="profile-stories-header" class="text-2xl font-bold text-gray-900">0 Historias</h2>
                  <button onclick="openBeabooStudio()" class="text-[#FE2C55] hover:text-red-600 flex items-center mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Gestionar mis historias
                  </button>
                </div>
                <button onclick="openStoryCreation()" class="bg-[#FE2C55] text-white px-6 py-3 rounded-xl hover:bg-red-600 transition-all flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                  </svg>
                  Nueva historia
                </button>
              </div>

              <!-- Grid de historias -->
              <div id="user-stories-desktop" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Otros tabs (ocultos por defecto) -->
            <div id="notes-tab-content" class="tab-content hidden">
              <h2 class="text-2xl font-bold mb-6">Notas</h2>
              <p class="text-gray-600">Tus notas y pensamientos publicados en la comunidad</p>
            </div>

            
          </div>

          <!-- Sidebar derecho -->
          <div class="w-80">
            <!-- Estad√≠sticas -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border">
              <h3 class="font-bold text-gray-900 mb-4">Estad√≠sticas</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Historias publicadas</span>
                  <span id="sidebar-stories-count" class="font-bold text-[#FE2C55]">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Total de lecturas</span>
                  <span id="sidebar-total-views" class="font-bold text-[#FE2C55]">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Seguidores</span>
                  <span id="sidebar-followers-count" class="font-bold text-[#FE2C55]">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Funciones para manejar tabs en desktop
document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabName = button.getAttribute('data-tab');
      
      // Remover active de todos los botones
      tabButtons.forEach(btn => {
        btn.classList.remove('active', 'border-[#FE2C55]', 'text-[#FE2C55]');
        btn.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Agregar active al bot√≥n clickeado
      button.classList.add('active', 'border-[#FE2C55]', 'text-[#FE2C55]');
      button.classList.remove('border-transparent', 'text-gray-500');
      
      // Ocultar todos los contenidos
      tabContents.forEach(content => {
        content.classList.add('hidden');
      });
      
      // Mostrar el contenido correspondiente
      const targetContent = document.getElementById(tabName + '-tab-content');
      if (targetContent) {
        targetContent.classList.remove('hidden');
        
        // Si es el tab de notas, cargar las notas del usuario
        if (tabName === 'notes') {
          loadUserNotes();
        }
      }
    });
  });
});

function handleProfileImageUploadDesktop(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  
  reader.onload = function(e) {
    document.getElementById('profile-image-desktop').src = e.target.result;
    // Tambi√©n actualizar la imagen m√≥vil
    document.getElementById('profile-image').src = e.target.result;
    
    // Guardar en Firebase
    const user = firebase.auth().currentUser;
    if (user) {
      firebase.database().ref('users/' + user.uid).update({
        profileImage: e.target.result
      });
    }
  }
  
  if (file) {
    reader.readAsDataURL(file);
  }
}
</script>

<!-- CSS espec√≠fico para overlay de subida -->
<style>
  /* Ocultar scrollbar */
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { scrollbar-width: none; -ms-overflow-style: none; }
</style>

<!-- JS para previsualizar la imagen en tiempo real -->
<script>
  function handleProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('profile-image').src = e.target.result;
      // Tambi√©n actualizar la imagen en la navegaci√≥n inferior
      document.getElementById('bottom-nav-profile-pic').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // Funci√≥n para actualizar la foto de perfil en la navegaci√≥n inferior
  function updateBottomNavProfilePic() {
    const user = firebase.auth().currentUser;
    if (user) {
      // Cargar imagen inicial
      firebase.database().ref('users/' + user.uid + '/profileImage').once('value').then(snapshot => {
        const profileImage = snapshot.val();
        updateAllProfileImages(profileImage);
      });

      // Escuchar cambios en tiempo real
      firebase.database().ref('users/' + user.uid + '/profileImage').on('value', snapshot => {
        const profileImage = snapshot.val();
        updateAllProfileImages(profileImage);
      });
    }
  }

  // Detector autom√°tico de cambios en Firebase
  function setupAutoDetectors() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Detector de cambios en foto de perfil
    firebase.database().ref('users/' + user.uid).on('value', snapshot => {
      const userData = snapshot.val();
      if (userData) {
        // Actualizar foto de perfil autom√°ticamente
        if (userData.profileImage) {
          updateAllProfileImages(userData.profileImage);
        }
        
        // Actualizar nombre de usuario
        if (userData.username) {
          updateAllUsernames(userData.username);
        }
        
        // Actualizar datos del perfil
        updateProfileData(userData);
      }
    });

    // Detector de subida de im√°genes
    const imageInputs = document.querySelectorAll('input[type="file"][accept*="image"]');
    imageInputs.forEach(input => {
      input.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
          // Auto-procesar y subir imagen
          autoProcessAndUploadImage(file, input.id);
        }
      });
    });

    // Detector de cambios en elementos de imagen de perfil
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
          const target = mutation.target;
          if (target.classList.contains('profile-image') || target.id.includes('profile')) {
            // Sincronizar cambio a Firebase
            syncImageToFirebase(target.src);
          }
        }
      });
    });

    // Observar todos los elementos de imagen de perfil
    const profileImages = document.querySelectorAll('[id*="profile-image"], [id*="profile"]');
    profileImages.forEach(img => {
      observer.observe(img, { attributes: true });
    });
  }

  // Funci√≥n para auto-procesar y subir imagen
  function autoProcessAndUploadImage(file, inputId) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const imageDataUrl = e.target.result;
      
      // Mostrar imagen inmediatamente
      updateAllProfileImages(imageDataUrl);
      
      // Guardar en Firebase autom√°ticamente
      saveProfileImageToFirebase(imageDataUrl);
      
      // Mostrar confirmaci√≥n
      showImageUploadSuccess();
    };
    reader.readAsDataURL(file);
  }

  // Funci√≥n para sincronizar imagen a Firebase
  function syncImageToFirebase(imageSrc) {
    if (imageSrc && imageSrc.startsWith('data:image/')) {
      saveProfileImageToFirebase(imageSrc);
    }
  }

  // Funci√≥n para actualizar todos los nombres de usuario
  function updateAllUsernames(username) {
    const usernameElements = [
      'profile-username',
      'profile-username-desktop',
      'edit-username',
      'edit-username-desktop',
      'author-profile-name'
    ];
    
    usernameElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        if (element.tagName === 'INPUT') {
          element.value = username;
        } else {
          element.textContent = '@' + username;
        }
      }
    });
  }

  // Funci√≥n para actualizar datos del perfil
  function updateProfileData(userData) {
    // Actualizar estad√≠sticas
    if (userData.followers) {
      updateFollowersCount(Object.keys(userData.followers).length);
    }
    if (userData.following) {
      updateFollowingCount(Object.keys(userData.following).length);
    }
    if (userData.coins) {
      updateCoinsDisplay(userData.coins);
    }
  }

  // Funci√≥n para mostrar √©xito de subida
  function showImageUploadSuccess() {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center';
    notification.innerHTML = `
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      Foto de perfil actualizada
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translate(-50%, -20px)';
      notification.style.transition = 'all 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }, 2000);
  }

  // FUNCIONES PARA LE√çDO RECIENTEMENTE
  function openRecentlyRead() {
    document.getElementById('recently-read-modal').classList.remove('hidden');
    document.getElementById('main-app').classList.add('hidden');
    loadRecentlyReadStories();
  }

  function closeRecentlyRead() {
    document.getElementById('recently-read-modal').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
  }

  function loadRecentlyReadStories() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('recentlyRead/' + user.uid).orderByChild('lastRead').limitToLast(20).once('value').then(snapshot => {
      const recentList = document.getElementById('recently-read-list');
      const emptyState = document.getElementById('recently-read-empty');
      
      recentList.innerHTML = '';
      
      if (!snapshot.exists()) {
        recentList.classList.add('hidden');
        emptyState.classList.remove('hidden');
        updateRecentCount(0);
        return;
      }

      recentList.classList.remove('hidden');
      emptyState.classList.add('hidden');

      const recentStories = [];
      snapshot.forEach(child => {
        recentStories.unshift({
          id: child.key,
          ...child.val()
        });
      });

      updateRecentCount(recentStories.length);

      recentStories.forEach(recent => {
        firebase.database().ref('stories/' + recent.storyId).once('value').then(storySnap => {
          const story = storySnap.val();
          if (story) {
            const recentItem = document.createElement('div');
            recentItem.className = 'bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow cursor-pointer';
            recentItem.onclick = () => continueReading(recent.storyId, recent.chapterIndex);
            
            recentItem.innerHTML = `
              <div class="flex space-x-4">
                <img src="${story.coverImage || 'https://via.placeholder.com/60x80/cccccc/666666?text=Book'}" alt="${story.title}" class="w-15 h-20 object-cover rounded-lg">
                <div class="flex-1">
                  <h3 class="font-bold text-lg mb-1 text-gray-800">${story.title}</h3>
                  <p class="text-gray-600 text-sm mb-2">Cap√≠tulo ${(recent.chapterIndex || 0) + 1}</p>
                  <p class="text-gray-500 text-xs mb-3">Le√≠do hace ${getTimeAgo(recent.lastRead)}</p>
                  <div class="flex items-center justify-between">
                    <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-medium">
                      ${Math.round(recent.progress || 0)}% completado
                    </div>
                    <button class="text-[#FE2C55] text-sm font-medium hover:text-red-600 transition-colors">
                      Continuar leyendo ‚Üí
                    </button>
                  </div>
                </div>
              </div>
            `;
            recentList.appendChild(recentItem);
          }
        });
      });
    });
  }

  function continueReading(storyId, chapterIndex) {
    // Cerrar modal de le√≠do recientemente
    closeRecentlyRead();
    // Abrir el lector de cap√≠tulos
    openChapterReader(storyId, chapterIndex || 0);
  }

  function updateRecentCount(count) {
    const counter = document.getElementById('recent-count');
    if (counter) {
      counter.textContent = `${count} historias en progreso`;
    }
  }

  function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (days > 0) return `${days} d√≠a${days > 1 ? 's' : ''}`;
    if (hours > 0) return `${hours} hora${hours > 1 ? 's' : ''}`;
    if (minutes > 0) return `${minutes} minuto${minutes > 1 ? 's' : ''}`;
    return 'Ahora mismo';
  }

  // Funci√≥n para guardar progreso de lectura
  function saveReadingProgress(storyId, chapterIndex, progress = 0) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const progressData = {
      storyId: storyId,
      chapterIndex: chapterIndex,
      progress: progress,
      lastRead: Date.now()
    };

    firebase.database().ref('recentlyRead/' + user.uid + '/' + storyId).set(progressData);
  }

  // FUNCIONES PARA MEMBRES√çA
  function openMembership() {
    document.getElementById('membership-modal').classList.remove('hidden');
    document.getElementById('main-app').classList.add('hidden');
  }

  function closeMembership() {
    document.getElementById('membership-modal').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
  }

  function subscribeToPlan(planType) {
    // Mostrar modal de confirmaci√≥n
    const confirmModal = document.createElement('div');
    confirmModal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-60';
    
    const planNames = {
      'premium': 'Premium ($4.99/mes)',
      'vip': 'VIP ($9.99/mes)'
    };
    
    confirmModal.innerHTML = `
      <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 text-center">
        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
          </svg>
        </div>
        <h2 class="text-xl font-bold mb-2">¬°Confirmar Suscripci√≥n!</h2>
        <p class="text-gray-600 mb-6">¬øDeseas suscribirte al plan ${planNames[planType]}?</p>
        <div class="flex space-x-3">
          <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg">
            Cancelar
          </button>
          <button onclick="processSubscription('${planType}'); this.closest('.fixed').remove();" class="flex-1 bg-[#FE2C55] text-white py-3 rounded-lg">
            Confirmar
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(confirmModal);
  }

  function processSubscription(planType) {
    // Simular procesamiento de suscripci√≥n
    const loadingModal = document.createElement('div');
    loadingModal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-60';
    loadingModal.innerHTML = `
      <div class="bg-white rounded-xl p-6 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-[#FE2C55] mx-auto mb-4"></div>
        <p class="font-medium">Procesando suscripci√≥n...</p>
      </div>
    `;
    document.body.appendChild(loadingModal);
    
    setTimeout(() => {
      loadingModal.remove();
      
      // Mostrar √©xito
      const successModal = document.createElement('div');
      successModal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-60';
      successModal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-2">¬°Bienvenido a ${planType.toUpperCase()}!</h2>
          <p class="text-gray-600 mb-6">Tu suscripci√≥n est√° activa. Disfruta de todos los beneficios premium.</p>
          <button onclick="this.closest('.fixed').remove(); closeMembership();" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-medium">
            Continuar
          </button>
        </div>
      `;
      document.body.appendChild(successModal);
      
      // Actualizar estado del usuario en Firebase
      const user = firebase.auth().currentUser;
      if (user) {
        firebase.database().ref('users/' + user.uid + '/membership').set({
          plan: planType,
          subscribedAt: Date.now(),
          active: true
        });
      }
    }, 2000);
  }

  // ===== BEABOO 2.0 - SISTEMA SEGURO DE IDENTIDAD DE USUARIO =====
  
  let currentUserSession = null; // Variable para mantener el estado del usuario actual
  
  // Funci√≥n SEGURA para actualizar todas las im√°genes de perfil en la interfaz
  function updateAllProfileImages(imageUrl, targetUserId = null) {
    const user = firebase.auth().currentUser;
    if (!user) return; // No actualizar si no hay usuario autenticado
    
    // VALIDACI√ìN CR√çTICA: Solo actualizar si es para el usuario actual
    if (targetUserId && targetUserId !== user.uid) {
      console.warn('Intento de actualizar imagen para usuario diferente bloqueado');
      return;
    }
    
    const defaultImage = 'https://via.placeholder.com/150';
    const finalImageUrl = imageUrl || defaultImage;
    
    // Lista de todos los elementos de imagen de perfil
    const profileElements = [
      'bottom-nav-profile-pic',
      'profile-image',
      'profile-image-desktop', 
      'edit-profile-image-mobile',
      'edit-profile-image-desktop',
      'current-user-avatar'
    ];
    
    profileElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        // Verificar que el elemento tenga el data-uid correcto o lo asignamos
        element.dataset.userId = user.uid;
        element.src = finalImageUrl;
      }
    });
    
    // Actualizar la sesi√≥n actual
    currentUserSession = {
      uid: user.uid,
      profileImage: finalImageUrl,
      lastUpdated: Date.now()
    };
  }

  // Funci√≥n SEGURA para guardar imagen de perfil en Firebase
  function saveProfileImageToFirebase(imageDataUrl) {
    const user = firebase.auth().currentUser;
    if (!user) {
      console.error('No hay usuario autenticado para guardar imagen');
      return;
    }

    // Validar que la sesi√≥n actual coincida
    if (currentUserSession && currentUserSession.uid !== user.uid) {
      console.warn('Sesi√≥n de usuario cambiada durante carga de imagen - cancelando');
      return;
    }

    firebase.database().ref('users/' + user.uid).update({
      profileImage: imageDataUrl,
      profileUpdatedAt: Date.now()
    }).then(() => {
      console.log('Imagen de perfil guardada para usuario:', user.uid);
      // Solo actualizar si el usuario sigue siendo el mismo
      const currentUser = firebase.auth().currentUser;
      if (currentUser && currentUser.uid === user.uid) {
        updateAllProfileImages(imageDataUrl, user.uid);
      }
    }).catch(error => {
      console.error('Error al guardar imagen:', error);
    });
  }

  // Funci√≥n para limpiar estado cuando cambie el usuario
  function clearUserState() {
    currentUserSession = null;
    
    // Limpiar todas las im√°genes de perfil
    const profileElements = [
      'bottom-nav-profile-pic',
      'profile-image',
      'profile-image-desktop', 
      'edit-profile-image-mobile',
      'edit-profile-image-desktop',
      'current-user-avatar'
    ];
    
    profileElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        element.src = 'https://via.placeholder.com/150';
        element.dataset.userId = '';
      }
    });
    
    console.log('Estado de usuario limpiado');
  }

  // Funci√≥n SEGURA para cargar perfil del usuario completo
  function loadUserProfile() {
    const user = firebase.auth().currentUser;
    if (!user) {
      clearUserState();
      return;
    }

    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      // Verificar que el usuario sigue siendo el mismo despu√©s de la consulta async
      const currentUser = firebase.auth().currentUser;
      if (!currentUser || currentUser.uid !== user.uid) {
        console.warn('Usuario cambi√≥ durante carga de perfil - cancelando');
        return;
      }

      const userData = snapshot.val();
      if (userData) {
        // Actualizar im√°genes de perfil de forma segura
        if (userData.profileImage) {
          updateAllProfileImages(userData.profileImage, user.uid);
        }
        
        // Actualizar otros datos de perfil de forma segura
        updateProfileData(userData, user.uid);
      }
    }).catch(error => {
      console.error('Error al cargar perfil de usuario:', error);
    });
  }

  // Funci√≥n SEGURA para actualizar datos de perfil en la interfaz
  function updateProfileData(userData, targetUserId) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || currentUser.uid !== targetUserId) {
      console.warn('Intento de actualizar datos para usuario diferente bloqueado');
      return;
    }

    // Actualizar nombre de usuario
    const usernameElements = [
      'profile-username',
      'profile-username-desktop',
      'edit-username',
      'edit-username-desktop'
    ];
    
    usernameElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = userData.username || 'Usuario';
        element.dataset.userId = currentUser.uid;
      }
    });

    // Actualizar biograf√≠a
    const bioElements = [
      'profile-bio',
      'profile-bio-desktop',
      'edit-bio',
      'edit-bio-desktop'
    ];
    
    bioElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = userData.bio || '';
        element.dataset.userId = currentUser.uid;
      }
    });

    // Actualizar estad√≠sticas de forma segura
    if (userData.followersCount !== undefined) {
      updateFollowersCount(userData.followersCount);
    }
    if (userData.followingCount !== undefined) {
      updateFollowingCount(userData.followingCount);
    }
  }

  // Funci√≥n SEGURA para subida de imagen m√≥vil - BeaBoo 2.0
  function handleProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n para cambiar tu foto de perfil');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      // Verificar que el usuario sigue autenticado
      const currentUser = firebase.auth().currentUser;
      if (!currentUser || currentUser.uid !== user.uid) {
        console.warn('Usuario cambi√≥ durante carga de imagen');
        return;
      }
      
      const imageDataUrl = e.target.result;
      
      // Actualizar inmediatamente en la interfaz de forma segura
      updateAllProfileImages(imageDataUrl, user.uid);
      
      // Guardar en Firebase de forma segura
      saveProfileImageToFirebase(imageDataUrl);
    }
    
    reader.readAsDataURL(file);
  }

  // Funci√≥n SEGURA para subida de imagen desktop - BeaBoo 2.0
  function handleProfileImageUploadDesktop(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n para cambiar tu foto de perfil');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      // Verificar que el usuario sigue autenticado
      const currentUser = firebase.auth().currentUser;
      if (!currentUser || currentUser.uid !== user.uid) {
        console.warn('Usuario cambi√≥ durante carga de imagen');
        return;
      }
      
      const imageDataUrl = e.target.result;
      
      // Actualizar inmediatamente en la interfaz de forma segura
      updateAllProfileImages(imageDataUrl, user.uid);
      
      // Guardar en Firebase de forma segura
      saveProfileImageToFirebase(imageDataUrl);
    }
    
    reader.readAsDataURL(file);
  }

  // Funciones auxiliares para actualizar estad√≠sticas
  function updateFollowersCount(count) {
    const followersElements = [
      'profile-followers',
      'profile-followers-desktop',
      'edit-followers',
      'edit-followers-desktop'
    ];
    
    followersElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = count;
      }
    });
  }

  function updateFollowingCount(count) {
    const followingElements = [
      'profile-following',
      'profile-following-desktop',
      'edit-following',
      'edit-following-desktop'
    ];
    
    followingElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = count;
      }
    });
  }

  function updateCoinsDisplay(coins) {
    const coinsElements = [
      'edit-coins',
      'edit-coins-desktop',
      'store-balance'
    ];
    
    coinsElements.forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        if (elementId === 'store-balance') {
          element.textContent = '$' + coins.toFixed(2);
        } else {
          element.textContent = coins;
        }
      }
    });
  }

  // Funci√≥n para forzar actualizaci√≥n completa
  function forceProfileUpdate() {
    const user = firebase.auth().currentUser;
    if (user) {
      firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
        const userData = snapshot.val();
        if (userData) {
          updateAllProfileImages(userData.profileImage);
          updateAllUsernames(userData.username);
          updateProfileData(userData);
          showImageUploadSuccess();
        }
      });
    }
  }

  // Funci√≥n modificada para edici√≥n de perfil m√≥vil
  function handleEditProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const imageDataUrl = e.target.result;
      
      // Actualizar inmediatamente en la interfaz
      updateAllProfileImages(imageDataUrl);
      
      // Guardar en Firebase
      saveProfileImageToFirebase(imageDataUrl);
    }
    
    if (file) {
      reader.readAsDataURL(file);
    }
  }

  // Funci√≥n modificada para edici√≥n de perfil desktop
  function handleEditProfileImageUploadDesktop(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const imageDataUrl = e.target.result;
      
      // Actualizar inmediatamente en la interfaz
      updateAllProfileImages(imageDataUrl);
      
      // Guardar en Firebase
      saveProfileImageToFirebase(imageDataUrl);
    }
    
    if (file) {
      reader.readAsDataURL(file);
    }
  }

  // ===== BEABOO 2.0 - LISTENER DE AUTENTICACI√ìN SEGURO =====
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      console.log('‚úÖ Usuario autenticado:', user.email);
      
      // Inicializar detectores autom√°ticos y cargar perfil de forma segura
      setTimeout(() => {
        setupAutoDetectors();
        updateBottomNavProfilePic();
        loadUserProfile(); // Ya usa nuestro sistema seguro
        
        // Cargar datos iniciales del usuario de forma segura
        loadInitialUserData(user);
      }, 1000);
    } else {
      console.log('‚ùå Usuario no autenticado - limpiando estado');
      // CR√çTICO: Limpiar estado cuando no hay usuario autenticado
      clearUserState();
      
      // Tambi√©n ocultar app principal y mostrar formulario de auth
      const authFormContainer = document.getElementById('auth-form');
      const mainApp = document.getElementById('main-app');
      if (authFormContainer && mainApp) {
        authFormContainer.classList.remove('hidden');
        mainApp.classList.add('hidden');
      }
    }
  });

  // Funci√≥n para cargar datos iniciales del usuario
  function loadInitialUserData(user) {
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val();
      if (userData) {
        console.log('Datos del usuario cargados:', userData);
        
        // Actualizar interfaz con datos del usuario
        if (userData.profileImage) {
          updateAllProfileImages(userData.profileImage);
        }
        if (userData.username) {
          updateAllUsernames(userData.username);
        }
        
        // Crear usuario en Firebase si no existe
      } else {
        console.log('Creando perfil de usuario en Firebase...');
        createUserProfile(user);
      }
    }).catch(error => {
      console.error('Error al cargar datos del usuario:', error);
    });
  }

  // Funci√≥n para crear perfil de usuario en Firebase
  function createUserProfile(user) {
    const defaultUserData = {
      email: user.email,
      username: user.email.split('@')[0],
      profileImage: 'https://via.placeholder.com/150',
      createdAt: Date.now(),
      coins: 0,
      followers: {},
      following: {}
    };

    firebase.database().ref('users/' + user.uid).set(defaultUserData).then(() => {
      console.log('Perfil de usuario creado exitosamente');
      updateAllProfileImages(defaultUserData.profileImage);
      updateAllUsernames(defaultUserData.username);
    }).catch(error => {
      console.error('Error al crear perfil de usuario:', error);
    });
  }
        
</script>


<!-- MODAL DE EDICI√ìN DE PERFIL -->
<div id="profile-edit-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-white text-black">
  <!-- Vista m√≥vil (actual) -->
  <div class="block lg:hidden p-6">
    <button onclick="closeProfileEdit()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>
    <div class="flex flex-col items-center">
      <div class="relative">
        <img id="edit-profile-image-mobile" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55]" alt="Foto de perfil">
        <button onclick="document.getElementById('edit-profile-image-input').click();" class="absolute bottom-0 right-0 bg-[#FE2C55] text-white rounded-full p-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v0" />
            <path d="M12 5a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2 2 2 0 0 1-2-2v0a2 2 0 0 1 2-2z" />
            <rect x="3" y="7" width="18" height="14" rx="2" ry="2" />
          </svg>
        </button>
        <input type="file" id="edit-profile-image-input" accept="image/*" class="hidden" onchange="handleEditProfileImageUpload(event)">
      </div>
      <!-- Campos m√≥viles (mantener estructura actual) -->
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Nombre de usuario</label>
        <input id="edit-username" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Tu nombre de usuario">
        <p class="text-xs text-blue-600 mt-1">‚ö†Ô∏è Solo se puede cambiar cada 7 d√≠as</p>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Pronombres</label>
        <input id="edit-pronouns" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Ej. √©l/ella/elle">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Biograf√≠a</label>
        <textarea id="edit-bio" rows="3" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Escribe tu biograf√≠a..."></textarea>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Inkspired</label>
        <input id="edit-inkspired" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu perfil en Inkspired">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Instagram</label>
        <input id="edit-instagram" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu perfil en Instagram">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">TikTok</label>
        <input id="edit-tiktok" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu perfil en TikTok">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">P√°gina Web</label>
        <input id="edit-website" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu p√°gina web">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Ciudad</label>
        <input id="edit-city" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Ingresa tu ciudad">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">G√©nero</label>
        <input id="edit-gender" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Ingresa tu g√©nero">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Cumplea√±os</label>
        <input id="edit-birthday" type="date" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black">
      </div>
      <!-- Panel de estad√≠sticas -->
      <div class="mt-6 w-full flex stats-panel p-4 bg-[#f9f9f9] rounded-xl">
        <div class="flex-1 text-center">
          <p class="font-bold text-[#FE2C55]">Seguidores</p>
          <p id="edit-followers" class="text-[#FE2C55] font-bold text-lg">0</p>
        </div>
        <div class="flex-1 text-center">
          <p class="font-bold text-[#FE2C55]">Siguiendo</p>
          <p id="edit-following" class="text-[#FE2C55] font-bold text-lg">0</p>
        </div>
        <div class="flex-1 text-center">
          <p class="font-bold text-[#FE2C55]">Series</p>
          <p id="edit-stories-count" class="text-[#FE2C55] font-bold text-lg">0</p>
        </div>
        <div class="flex-1 text-center">
          <p class="font-bold text-[#FE2C55]">VIP</p>
          <p id="edit-coins" class="text-[#FE2C55] font-bold text-lg">0</p>
        </div>
      </div>
      <button onclick="saveProfileEdits()" class="mt-6 w-full bg-[#FE2C55] text-white p-3 rounded-lg">Guardar Cambios</button>
      <button onclick="signOutUser()" class="mt-4 w-full bg-[#f9f9f9] text-black p-3 rounded-lg border border-[#FE2C55]">Cerrar Sesi√≥n</button>
      
      <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
        <p class="text-yellow-800 text-sm">
          <span class="text-lg mr-1">‚ú®</span>
          Los efectos y marcos est√°n disponibles en tu perfil
        </p>
      </div>
      <button onclick="openSupportModal()" class="mt-4 w-full bg-[#FE2C55] text-white p-3 rounded-lg flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
        </svg>
        Soporte
      </button>
      <button onclick="openBlockedUsersModal()" class="mt-4 w-full bg-gray-600 text-white p-3 rounded-lg flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
        </svg>
        Personas Bloqueadas
      </button>
      <button id="live-transmit-btn" onclick="openLiveStreamModal()" class="mt-4 w-full bg-[#FE2C55] text-white p-3 rounded-lg flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
        </svg>
        Transmitir en vivo
      </button>
    </div>
  </div>

  <!-- Vista desktop (nueva estructura) -->
  <div class="hidden lg:flex h-full">
    <!-- Header superior -->
    <div class="absolute top-0 left-0 right-0 bg-white border-b p-6 z-10">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-cog text-[#FE2C55] text-2xl"></i>
          <h1 class="text-2xl font-semibold text-gray-700">Editar Perfil</h1>
        </div>
        <button onclick="closeProfileEdit()" class="text-gray-500 hover:text-gray-700 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="flex-1 flex pt-24">
      <!-- Formulario central -->
      <div class="flex-1 p-8 max-w-2xl">
        <h2 class="text-2xl font-semibold text-[#FE2C55] mb-8">Editar Perfil</h2>
        
        <div class="space-y-6">
          <!-- Primera fila: Username y Email -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>Nombre de usuario
              </label>
              <div class="relative">
                <input id="edit-username-desktop" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu nombre de usuario">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>E-mail
              </label>
              <div class="relative">
                <input id="edit-email-desktop" type="email" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="usuario@ejemplo.com" readonly>
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Segunda fila: Nombre y Apellido -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>Nombre
              </label>
              <div class="relative">
                <input id="edit-first-name-desktop" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu nombre">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>Apellido
              </label>
              <div class="relative">
                <input id="edit-last-name-desktop" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu apellido">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Tercera fila: Fecha de nacimiento y G√©nero -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>Fecha de nacimiento
              </label>
              <div class="relative">
                <input id="edit-birthday-desktop" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent">
                <button class="absolute right-10 top-1/2 transform -translate-y-1/2 text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>G√©nero
              </label>
              <div class="relative">
                <select id="edit-gender-desktop" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent appearance-none">
                  <option value="male">Masculino</option>
                  <option value="female">Femenino</option>
                  <option value="other">Otro</option>
                  <option value="prefer-not-to-say">Prefiero no decir</option>
                </select>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Cuarta fila: Pa√≠s y Ciudad -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Pa√≠s</label>
              <div class="relative">
                <select id="edit-country-desktop" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent appearance-none">
                  <option value="us">Estados Unidos</option>
                  <option value="es">Espa√±a</option>
                  <option value="mx">M√©xico</option>
                  <option value="co">Colombia</option>
                  <option value="ar">Argentina</option>
                </select>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
              <div class="relative">
                <input id="edit-city-desktop" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu ciudad">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Campos de redes sociales -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Instagram</label>
              <div class="relative">
                <input id="edit-instagram-desktop" type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Enlace a tu Instagram">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">TikTok</label>
              <div class="relative">
                <input id="edit-tiktok-desktop" type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Enlace a tu TikTok">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Inkspired</label>
              <div class="relative">
                <input id="edit-inkspired-desktop" type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Enlace a tu perfil Inkspired">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">P√°gina Web</label>
              <div class="relative">
                <input id="edit-website-desktop" type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu p√°gina web">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Biograf√≠a -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Biograf√≠a</label>
            <textarea id="edit-bio-desktop" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Escribe algo sobre ti..."></textarea>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="flex space-x-4 pt-6">
            <button onclick="saveProfileEdits()" class="bg-[#FE2C55] text-white px-8 py-3 rounded-lg hover:bg-[#ef2950] transition-colors font-medium">
              Guardar Cambios
            </button>
            <button onclick="signOutUser()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium">
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>

      <!-- Panel derecho con foto de perfil -->
      <div class="w-96 p-8 bg-gray-50">
        <div class="text-right mb-6">
          <h3 class="text-lg font-medium text-gray-700">Profile picture</h3>
        </div>
        
        <div class="flex flex-col items-center">
          <div class="relative mb-6">
            <img id="edit-profile-image-desktop" src="https://via.placeholder.com/200" class="w-48 h-48 rounded-full object-cover border-4 border-white shadow-lg" alt="Profile picture">
            <button onclick="document.getElementById('edit-profile-image-input-desktop').click();" class="absolute bottom-4 right-4 bg-[#FE2C55] text-white rounded-full p-3 shadow-lg hover:bg-[#ef2950] transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
            <input type="file" id="edit-profile-image-input-desktop" accept="image/*" class="hidden" onchange="handleEditProfileImageUploadDesktop(event)">
          </div>
          
          <!-- Panel de estad√≠sticas para desktop -->
          <div class="w-full bg-white rounded-lg p-6 shadow-sm">
            <div class="grid grid-cols-2 gap-4 text-center">
              <div>
                <p class="text-2xl font-bold text-[#FE2C55]" id="edit-followers-desktop">0</p>
                <p class="text-sm text-gray-600">Seguidores</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-[#FE2C55]" id="edit-following-desktop">0</p>
                <p class="text-sm text-gray-600">Siguiendo</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-[#FE2C55]" id="edit-stories-count-desktop">0</p>
                <p class="text-sm text-gray-600">Historias</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-[#FE2C55]" id="edit-coins-desktop">0</p>
                <p class="text-sm text-gray-600">Monedas</p>
              </div>
            </div>
          </div>

          <!-- Botones adicionales -->
          <div class="w-full mt-6 space-y-3">
            
            
            <button onclick="openSupportModal()" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
              </svg>
              Soporte
            </button>
            
            <button onclick="openLiveStreamModal()" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
              </svg>
              Transmitir en vivo
            </button>
            
            <button onclick="openBlockedUsersModal()" class="w-full bg-gray-600 text-white p-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
              </svg>
              Personas Bloqueadas
            </button>

<script>
// SISTEMA DE CARRITO Y TIENDA MODERNA
let cart = [];
let storeBalance = 0;

// Inicializar tienda
function initializeStore() {
  loadStoreBalance();
  updateCartDisplay();
  startOfferCountdown();
}

// Cargar saldo de la tienda
function loadStoreBalance() {
  const user = firebase.auth().currentUser;
  if (user) {
    firebase.database().ref('users/' + user.uid + '/coins').on('value', snapshot => {
      storeBalance = snapshot.val() || 0;
      const balanceElement = document.getElementById('store-balance');
      if (balanceElement) {
        balanceElement.textContent = '$' + storeBalance.toFixed(2);
      }
    });
  }
}

// Cambiar categor√≠a de tienda
function switchStoreCategory(category) {
  // Ocultar todas las categor√≠as
  document.querySelectorAll('.store-category-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Mostrar la categor√≠a seleccionada
  const categoryElement = document.getElementById('store-' + category);
  if (categoryElement) {
    categoryElement.classList.remove('hidden');
  }
  
  // Actualizar botones
  document.querySelectorAll('.store-category-btn').forEach(btn => {
    btn.classList.remove('bg-[#FE2C55]', 'text-white');
    btn.classList.add('bg-gray-100', 'text-gray-700');
  });
  
  // Encontrar el bot√≥n correcto y actualizarlo
  const activeBtn = event.target.closest('.store-category-btn');
  if (activeBtn) {
    activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
    activeBtn.classList.add('bg-[#FE2C55]', 'text-white');
  }
}

// Agregar al carrito
function addToCart(itemId, itemName, price, originalPrice = 0) {
  // Si el precio es 0 (marco gratis), aplicarlo directamente
  if (price === 0) {
    applyFreeFrame(itemId, itemName);
    return;
  }

  const existingItem = cart.find(item => item.id === itemId);
  
  if (existingItem) {
    existingItem.quantity += 1;
  } else {
    cart.push({
      id: itemId,
      name: itemName,
      price: price,
      originalPrice: originalPrice,
      quantity: 1,
      image: getItemImage(itemId),
      deliveryTime: 'Inmediata',
      category: getCategoryFromId(itemId)
    });
  }
  
  updateCartDisplay();
  showAddToCartAnimation(itemName);
  
  // Vibraci√≥n en m√≥vil
  if (navigator.vibrate) {
    navigator.vibrate(50);
  }
}

// Aplicar marco gratuito directamente
function applyFreeFrame(itemId, itemName) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  firebase.database().ref('users/' + user.uid + '/profileFrame').set(itemId).then(() => {
    showAddToCartAnimation(`${itemName} aplicado correctamente`);
    
    // Actualizar el marco en la interfaz si est√° visible
    updateProfileFrame(itemId);
  }).catch(error => {
    console.error('Error al aplicar marco:', error);
    alert('Error al aplicar el marco. Por favor intenta de nuevo.');
  });
}

// Obtener imagen del item
function getItemImage(itemId) {
  const imageMap = {
    'none': '‚≠ï',
    'rainbow': 'üåà', 
    'electric': '‚ö°',
    'fire': 'üî•',
    'galaxy': 'üåå',
    'diamond': 'üíé',
    'neon': 'üíö',
    'royal': 'üëë',
    'premium-rainbow': 'üåà',
    'premium-fire': 'üî•',
    'premium-galaxy': 'üåå',
    'book-romance-paris': 'üìö',
    'gift-cupido': 'üíò',
    'badge-vip': 'üëë'
  };
  return imageMap[itemId] || 'üéÅ';
}

// Obtener categor√≠a del item
function getCategoryFromId(itemId) {
  if (['none', 'rainbow', 'electric', 'fire', 'galaxy', 'diamond', 'neon', 'royal'].includes(itemId)) {
    return 'marco';
  }
  if (itemId.startsWith('book-')) {
    return 'libro';
  }
  if (itemId.startsWith('gift-')) {
    return 'regalo';
  }
  return 'accesorio';
}

// Actualizar marco en el perfil
function updateProfileFrame(frameId) {
  const profileFrame = document.getElementById('profile-frame');
  const profileFrameDesktop = document.getElementById('profile-frame-desktop');
  
  if (profileFrame) {
    profileFrame.className = '';
    if (frameId !== 'none') {
      profileFrame.classList.add(frameId + '-frame');
      profileFrame.style.display = 'block';
    } else {
      profileFrame.style.display = 'none';
    }
  }
  
  if (profileFrameDesktop) {
    profileFrameDesktop.className = '';
    if (frameId !== 'none') {
      profileFrameDesktop.classList.add(frameId + '-frame');
      profileFrameDesktop.style.display = 'block';
    } else {
      profileFrameDesktop.style.display = 'none';
    }
  }
}

// Mostrar animaci√≥n de agregar al carrito
function showAddToCartAnimation(itemName) {
  const notification = document.createElement('div');
  notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center';
  notification.innerHTML = `
    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
    </svg>
    "${itemName}" agregado al carrito
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translate(-50%, -20px)';
    notification.style.transition = 'all 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 2000);
}

// Actualizar display del carrito
function updateCartDisplay() {
  const cartCount = document.getElementById('cart-count');
  const cartItems = document.getElementById('cart-items');
  const cartEmpty = document.getElementById('cart-empty');
  const cartSummary = document.getElementById('cart-summary');
  const checkoutBtn = document.getElementById('checkout-btn');
  
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  cartCount.textContent = totalItems;
  
  if (cart.length === 0) {
    cartItems.classList.add('hidden');
    cartEmpty.classList.remove('hidden');
    cartSummary.classList.add('hidden');
    checkoutBtn.disabled = true;
  } else {
    cartItems.classList.remove('hidden');
    cartEmpty.classList.add('hidden');
    cartSummary.classList.remove('hidden');
    checkoutBtn.disabled = false;
    
    // Renderizar items del carrito
    cartItems.innerHTML = '';
    cart.forEach((item, index) => {
      const itemElement = document.createElement('div');
      itemElement.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg';
      
      const discount = item.originalPrice > 0 ? item.originalPrice - item.price : 0;
      
      itemElement.innerHTML = `
        <div class="text-2xl">${item.image}</div>
        <div class="flex-1">
          <h4 class="font-medium text-sm">${item.name}</h4>
          <div class="flex items-center space-x-2">
            <span class="text-[#FE2C55] font-bold">$${item.price.toFixed(2)}</span>
            ${item.originalPrice > 0 ? `<span class="text-gray-500 line-through text-xs">$${item.originalPrice.toFixed(2)}</span>` : ''}
          </div>
          <div class="flex items-center text-xs text-gray-600 mt-1">
            <span class="mr-2">üöö</span>
            <span>${item.deliveryTime}</span>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button onclick="changeQuantity(${index}, -1)" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs">-</button>
          <span class="text-sm font-medium">${item.quantity}</span>
          <button onclick="changeQuantity(${index}, 1)" class="w-6 h-6 bg-[#FE2C55] text-white rounded-full flex items-center justify-center text-xs">+</button>
        </div>
        <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </button>
      `;
      cartItems.appendChild(itemElement);
    });
    
    // Actualizar resumen
    updateCartSummary();
  }
}

// Cambiar cantidad
function changeQuantity(index, change) {
  cart[index].quantity += change;
  if (cart[index].quantity <= 0) {
    cart.splice(index, 1);
  }
  updateCartDisplay();
}

// Remover del carrito
function removeFromCart(index) {
  cart.splice(index, 1);
  updateCartDisplay();
}

// Actualizar resumen del carrito
function updateCartSummary() {
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const totalDiscount = cart.reduce((sum, item) => {
    if (item.originalPrice > 0) {
      return sum + ((item.originalPrice - item.price) * item.quantity);
    }
    return sum;
  }, 0);
  const total = subtotal;
  
  document.getElementById('cart-subtotal').textContent = '$' + subtotal.toFixed(2);
  document.getElementById('cart-discount').textContent = '-$' + totalDiscount.toFixed(2);
  document.getElementById('cart-total').textContent = '$' + total.toFixed(2);
}

// Toggle carrito
function toggleCart() {
  const cartSidebar = document.getElementById('cart-sidebar');
  if (cartSidebar) {
    cartSidebar.classList.toggle('translate-x-full');
    
    // Si se est√° abriendo el carrito, actualizarlo
    if (!cartSidebar.classList.contains('translate-x-full')) {
      updateCartDisplay();
    }
  }
}

// Proceder al checkout
function proceedToCheckout() {
  if (cart.length === 0) return;
  
  // Llenar resumen del checkout
  const checkoutSummary = document.getElementById('checkout-summary');
  const checkoutTotal = document.getElementById('checkout-total');
  
  checkoutSummary.innerHTML = '';
  let total = 0;
  
  cart.forEach(item => {
    const itemTotal = item.price * item.quantity;
    total += itemTotal;
    
    const itemElement = document.createElement('div');
    itemElement.className = 'flex justify-between text-sm';
    itemElement.innerHTML = `
      <span>${item.name} x${item.quantity}</span>
      <span>$${itemTotal.toFixed(2)}</span>
    `;
    checkoutSummary.appendChild(itemElement);
  });
  
  checkoutTotal.textContent = '$' + total.toFixed(2);
  
  document.getElementById('checkout-modal').classList.remove('hidden');
}

// Cerrar checkout
function closeCheckout() {
  document.getElementById('checkout-modal').classList.add('hidden');
}

// Procesar pago
function processPayment() {
  const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
  
  // Simular procesamiento de pago
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[80]';
  loadingDiv.innerHTML = `
    <div class="bg-white rounded-xl p-6 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-[#FE2C55] mx-auto mb-4"></div>
      <p class="font-medium">Procesando pago...</p>
      <p class="text-sm text-gray-600">M√©todo: ${paymentMethod}</p>
    </div>
  `;
  document.body.appendChild(loadingDiv);
  
  setTimeout(() => {
    loadingDiv.remove();
    showPaymentSuccess();
    
    // Limpiar carrito y cerrar modals
    cart = [];
    updateCartDisplay();
    closeCheckout();
    toggleCart();
  }, 3000);
}

// Mostrar √©xito del pago
function showPaymentSuccess() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[80]';
  modal.innerHTML = `
    <div class="bg-white rounded-xl p-8 text-center max-w-md w-full mx-4">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-xl font-bold mb-2">¬°Pago Exitoso!</h2>
      <p class="text-gray-600 mb-4">Tus productos digitales est√°n disponibles inmediatamente</p>
      <div class="bg-blue-50 p-3 rounded-lg mb-4">
        <p class="text-sm text-blue-800">
          <span class="font-medium">üéØ Entrega Completada:</span><br>
          Todos los productos han sido aplicados a tu cuenta
        </p>
      </div>
      <div class="space-y-2 text-xs text-gray-600 mb-4">
        <div class="flex items-center justify-center">
          <span class="mr-2">üìß</span>
          <span>Recibo enviado por email</span>
        </div>
        <div class="flex items-center justify-center">
          <span class="mr-2">üõ°Ô∏è</span>
          <span>Protegido por garant√≠a BeaBoo</span>
        </div>
      </div>
      <button onclick="this.closest('.fixed').remove()" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-medium">
        Continuar
      </button>
    </div>
  `;
  document.body.appendChild(modal);
}

// Countdown de ofertas
function startOfferCountdown() {
  const countdownElement = document.getElementById('offer-countdown');
  if (!countdownElement) return;
  
  let timeLeft = 24 * 60 * 60; // 24 horas en segundos
  
  setInterval(() => {
    const hours = Math.floor(timeLeft / 3600);
    const minutes = Math.floor((timeLeft % 3600) / 60);
    const seconds = timeLeft % 60;
    
    countdownElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    timeLeft--;
    if (timeLeft < 0) {
      timeLeft = 24 * 60 * 60; // Reiniciar
    }
  }, 1000);
}

// Funciones existentes modificadas
// ===== BEABOO 2.0 - SISTEMA DE MODAL DE TIENDA PANTALLA COMPLETA =====
function openStore() {
  const storeModal = createStoreModal();
  document.body.appendChild(storeModal);
  
  // Bloquear scroll del body
  document.body.style.overflow = 'hidden';
  
  // Inicializar tienda
  initializeStore();
  
  // Animaci√≥n de entrada
  requestAnimationFrame(() => {
    storeModal.classList.remove('opacity-0');
    storeModal.querySelector('.store-content').classList.remove('scale-95');
  });
}

function createStoreModal() {
  const modal = document.createElement('div');
  modal.id = 'store-fullscreen-modal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 transition-all duration-300';
  
  modal.innerHTML = `
    <div class="store-content bg-white w-full h-full overflow-y-auto scale-95 transition-transform duration-300">
      <!-- Header del modal de tienda -->
      <div class="sticky top-0 bg-white z-10 border-b border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <button onclick="closeStoreModal()" class="text-gray-600 hover:text-gray-800 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
            <h1 class="text-2xl font-bold text-[#FE2C55]">üõçÔ∏è BeaBoo Shop</h1>
          </div>
          
          <!-- Bot√≥n del carrito -->
          <div class="relative">
            <button onclick="toggleCartInStore()" class="bg-[#FE2C55] text-white p-3 rounded-full hover:bg-red-600 transition-colors relative">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.65 8.35m1.65-8.35L4.2 3M7 13v8a2 2 0 002 2h6a2 2 0 002-2v-8"/>
              </svg>
              <span id="store-cart-count" class="absolute -top-1 -right-1 bg-yellow-400 text-black text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold min-w-[20px]">0</span>
            </button>
          </div>
        </div>
        
        <!-- Navegaci√≥n de categor√≠as -->
        <div class="flex space-x-4 mt-4 overflow-x-auto">
          <button onclick="switchStoreCategory('books')" class="store-category-btn active whitespace-nowrap px-4 py-2 rounded-lg font-medium transition-colors" data-category="books">
            üìö Libros
          </button>
          <button onclick="switchStoreCategory('gifts')" class="store-category-btn whitespace-nowrap px-4 py-2 rounded-lg font-medium transition-colors" data-category="gifts">
            üéÅ Regalos
          </button>
          <button onclick="switchStoreCategory('accessories')" class="store-category-btn whitespace-nowrap px-4 py-2 rounded-lg font-medium transition-colors" data-category="accessories">
            üíé Accesorios
          </button>
        </div>
      </div>
      
      <!-- Contenido de la tienda -->
      <div id="store-modal-content" class="p-6">
        ${document.getElementById('store-view').innerHTML}
      </div>
      
      <!-- Modal de carrito integrado -->
      <div id="store-cart-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-20">
        <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl transform translate-x-full transition-transform duration-300" id="store-cart-sidebar">
          <div class="flex flex-col h-full">
            <!-- Header del carrito -->
            <div class="p-4 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold">üõí Tu Carrito</h2>
                <button onclick="toggleCartInStore()" class="text-gray-500 hover:text-gray-700">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Contenido del carrito -->
            <div class="flex-1 overflow-y-auto p-4">
              <div id="store-cart-items" class="space-y-4">
                <!-- Los items del carrito se cargar√°n aqu√≠ -->
              </div>
              
              <div id="store-cart-empty" class="text-center py-12">
                <div class="text-gray-400 mb-4">
                  <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.65 8.35m1.65-8.35L4.2 3M7 13v8a2 2 0 002 2h6a2 2 0 002-2v-8"/>
                  </svg>
                </div>
                <p class="text-gray-500 font-medium">Tu carrito est√° vac√≠o</p>
                <p class="text-sm text-gray-400 mt-2">A√±ade algunos productos para comenzar</p>
              </div>
            </div>
            
            <!-- Resumen y BCI -->
            <div id="store-cart-summary" class="border-t border-gray-200 p-4 bg-gray-50">
              <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm">
                  <span>Subtotal:</span>
                  <span id="store-cart-subtotal">$0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>Descuentos:</span>
                  <span id="store-cart-discount" class="text-green-600">-$0.00</span>
                </div>
                <div class="flex justify-between font-bold text-lg border-t pt-2">
                  <span>Total:</span>
                  <span id="store-cart-total" class="text-[#FE2C55]">$0.00</span>
                </div>
              </div>
              
              <!-- BCI - Buy/Checkout Instant -->
              <button id="store-bci-btn" onclick="openStoreBCI()" disabled class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-bold text-lg disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-red-600 transition-colors">
                üí≥ Comprar Ahora (BCI)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  return modal;
}

function closeStoreModal() {
  const modal = document.getElementById('store-fullscreen-modal');
  if (modal) {
    modal.classList.add('opacity-0');
    modal.querySelector('.store-content').classList.add('scale-95');
    
    setTimeout(() => {
      modal.remove();
      document.body.style.overflow = ''; // Restaurar scroll
    }, 300);
  }
}

function toggleCartInStore() {
  const cartModal = document.getElementById('store-cart-modal');
  const cartSidebar = document.getElementById('store-cart-sidebar');
  
  if (cartModal.classList.contains('hidden')) {
    cartModal.classList.remove('hidden');
    requestAnimationFrame(() => {
      cartSidebar.classList.remove('translate-x-full');
    });
    updateStoreCartDisplay();
  } else {
    cartSidebar.classList.add('translate-x-full');
    setTimeout(() => {
      cartModal.classList.add('hidden');
    }, 300);
  }
}

// Funci√≥n para actualizar el display del carrito en la tienda
function updateStoreCartDisplay() {
  const cartCount = document.getElementById('store-cart-count');
  const cartItems = document.getElementById('store-cart-items');
  const cartEmpty = document.getElementById('store-cart-empty');
  const cartSummary = document.getElementById('store-cart-summary');
  const bciBtn = document.getElementById('store-bci-btn');
  
  if (!cartCount || !cartItems || !cartEmpty || !cartSummary || !bciBtn) return;
  
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  cartCount.textContent = totalItems;
  
  if (cart.length === 0) {
    cartItems.classList.add('hidden');
    cartEmpty.classList.remove('hidden');
    cartSummary.classList.add('hidden');
    bciBtn.disabled = true;
  } else {
    cartItems.classList.remove('hidden');
    cartEmpty.classList.add('hidden');
    cartSummary.classList.remove('hidden');
    bciBtn.disabled = false;
    
    // Renderizar items del carrito
    cartItems.innerHTML = '';
    cart.forEach((item, index) => {
      const itemElement = document.createElement('div');
      itemElement.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg';
      
      itemElement.innerHTML = `
        <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
          <span class="text-xl">${getItemIcon(item.id)}</span>
        </div>
        <div class="flex-1">
          <h4 class="font-bold text-sm">${item.name}</h4>
          <p class="text-xs text-gray-600">$${item.price.toFixed(2)} c/u</p>
        </div>
        <div class="flex items-center space-x-2">
          <button onclick="updateStoreCartQuantity(${index}, -1)" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs">-</button>
          <span class="text-sm font-bold min-w-[20px] text-center">${item.quantity}</span>
          <button onclick="updateStoreCartQuantity(${index}, 1)" class="w-6 h-6 bg-[#FE2C55] text-white rounded-full flex items-center justify-center text-xs">+</button>
        </div>
        <button onclick="removeStoreCartItem(${index})" class="text-red-500 hover:text-red-700">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </button>
      `;
      
      cartItems.appendChild(itemElement);
    });
    
    // Actualizar resumen
    updateStoreCartSummary();
  }
}

function updateStoreCartQuantity(index, change) {
  cart[index].quantity += change;
  if (cart[index].quantity <= 0) {
    cart.splice(index, 1);
  }
  updateStoreCartDisplay();
}

function removeStoreCartItem(index) {
  cart.splice(index, 1);
  updateStoreCartDisplay();
}

function updateStoreCartSummary() {
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const totalDiscount = cart.reduce((sum, item) => {
    if (item.originalPrice > 0) {
      return sum + ((item.originalPrice - item.price) * item.quantity);
    }
    return sum;
  }, 0);
  const total = subtotal - totalDiscount;
  
  document.getElementById('store-cart-subtotal').textContent = '$' + subtotal.toFixed(2);
  document.getElementById('store-cart-discount').textContent = '-$' + totalDiscount.toFixed(2);
  document.getElementById('store-cart-total').textContent = '$' + total.toFixed(2);
}

// BCI - Buy/Checkout Instant - Sistema de compra inmediata
function openStoreBCI() {
  if (cart.length === 0) return;
  
  const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  
  // Crear modal de BCI
  const bciModal = document.createElement('div');
  bciModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-30';
  bciModal.innerHTML = `
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-[#FE2C55] rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold mb-2">üí≥ Compra Instant√°nea</h2>
        <p class="text-gray-600">Total a pagar: <span class="font-bold text-[#FE2C55] text-xl">$${total.toFixed(2)}</span></p>
      </div>
      
      <div class="space-y-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">M√©todo de pago</label>
          <select class="w-full p-3 border border-gray-300 rounded-lg">
            <option>üí≥ Tarjeta de cr√©dito</option>
            <option>üè¶ Transferencia bancaria</option>
            <option>üì± PayPal</option>
            <option>üí∞ BeaBoo Coins</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Correo para recibo</label>
          <input type="email" placeholder="tu@email.com" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
      </div>
      
      <div class="flex space-x-3">
        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition-colors">
          Cancelar
        </button>
        <button onclick="processBCIPayment()" class="flex-1 bg-[#FE2C55] text-white py-3 rounded-lg font-medium hover:bg-red-600 transition-colors">
          üí≥ Pagar Ahora
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(bciModal);
  
  // Animaci√≥n de entrada
  requestAnimationFrame(() => {
    bciModal.querySelector('div').classList.remove('scale-95');
  });
}

function processBCIPayment() {
  // Simular procesamiento de pago
  const loadingModal = document.createElement('div');
  loadingModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40';
  loadingModal.innerHTML = `
    <div class="bg-white rounded-xl p-8 text-center">
      <div class="animate-spin w-8 h-8 border-4 border-[#FE2C55] border-t-transparent rounded-full mx-auto mb-4"></div>
      <p class="font-medium">Procesando pago...</p>
    </div>
  `;
  
  document.body.appendChild(loadingModal);
  
  setTimeout(() => {
    loadingModal.remove();
    
    // Mostrar √©xito
    const successModal = document.createElement('div');
    successModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40';
    successModal.innerHTML = `
      <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2 class="text-xl font-bold mb-2">¬°Compra exitosa!</h2>
        <p class="text-gray-600 mb-6">Tu compra se ha procesado correctamente. Revisa tu correo para los detalles.</p>
        <button onclick="completeBCIPurchase()" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-medium">
          Continuar
        </button>
      </div>
    `;
    
    document.body.appendChild(successModal);
  }, 2000);
}

function completeBCIPurchase() {
  // Limpiar carrito
  cart = [];
  
  // Cerrar todos los modales
  document.querySelectorAll('.fixed.inset-0').forEach(modal => {
    if (modal.className.includes('z-40') || modal.className.includes('z-30')) {
      modal.remove();
    }
  });
  
  // Actualizar displays
  updateStoreCartDisplay();
  
  // Cerrar carrito en tienda
  const cartModal = document.getElementById('store-cart-modal');
  const cartSidebar = document.getElementById('store-cart-sidebar');
  if (cartModal && cartSidebar) {
    cartSidebar.classList.add('translate-x-full');
    setTimeout(() => {
      cartModal.classList.add('hidden');
    }, 300);
  }
}

function getItemIcon(itemId) {
  if (itemId.includes('book')) return 'üìö';
  if (itemId.includes('gift')) return 'üéÅ';
  if (itemId.includes('badge')) return 'üëë';
  if (itemId.includes('frame')) return 'üñºÔ∏è';
  return 'üì¶';
}

function closeStore() {
  document.getElementById('store-view').classList.add('hidden');
  document.getElementById('main-app').classList.remove('hidden');
}

// Inicializar Firebase Auth de forma centralizada
document.addEventListener('DOMContentLoaded', function() {
  initializeFirebaseAuth();
}, { once: true });
</script>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function handleEditProfileImageUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      document.getElementById('edit-profile-image').src = e.target.result;
    }
    
    if (file) {
      reader.readAsDataURL(file);
    }
  }
</script>

<!-- MODAL DE PERFIL DEL AUTOR -->
<div id="author-profile-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-4 relative">
    <!-- Bot√≥n de volver -->
    <button onclick="closeAuthorProfile()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span id="btn-volver-author"></span>
    </button>
    <!-- Bot√≥n de opciones (3 puntos) -->
    <button id="options-button" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.75a.75.75 0 100-1.5.75.75 0 000 1.5zM12 13.25a.75.75 0 100-1.5.75.75 0 000 1.5zM12 19.75a.75.75 0 100-1.5.75.75 0 000 1.5z" />
      </svg>
    </button>
    <!-- Men√∫ de opciones -->
    <div id="options-menu" class="absolute top-12 right-4 bg-white border border-gray-300 rounded-lg shadow-lg hidden">
      <ul class="divide-y">
        <li><button onclick="openReportModal()" class="w-full text-left px-4 py-2 hover:bg-gray-100">Reportar</button></li>
      </ul>
    </div>

    <div class="flex flex-col items-center mt-4" id="author-profile-content">
      <!-- Foto del autor -->
      <div id="author-profile-img-container" class="relative">
        <!-- Marco animado del autor -->
        <div id="author-profile-frame" class="absolute inset-0 rounded-full pointer-events-none z-10" style="display: none;"></div>
        <img id="author-profile-image" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55]" alt="Foto del autor">
        <!-- Note bubble -->
        <div id="profile-note" class="hidden absolute -top-16 left-1/2 transform -translate-x-1/2 bg-white p-3 rounded-lg shadow-lg w-48 text-center animate-float">
          <p id="note-text" class="text-sm"></p>
          <p id="note-time" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <style>
          @keyframes float {
            0%, 100% { transform: translate(-50%, 0px); }
            50% { transform: translate(-50%, -10px); }
          }
          .animate-float {
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
          }
        </style>
        <!-- Add note button (only visible for profile owner) -->
        <button id="add-note-btn" onclick="openNoteModal()" class="hidden absolute bottom-0 right-0 bg-[#FE2C55] text-white rounded-full p-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>

      <!-- Note Modal -->
      <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-4 rounded-lg w-80">
          <h3 class="text-lg font-bold mb-4">Agregar nota temporal</h3>
          <textarea id="note-input" class="w-full p-2 border rounded mb-4" placeholder="Escribe tu nota (m√°x. 100 caracteres)" maxlength="100"></textarea>
          <div class="flex justify-end space-x-2">
            <button onclick="closeNoteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
            <button onclick="saveNote()" class="px-4 py-2 bg-[#FE2C55] text-white rounded hover:bg-red-600">Guardar</button>
          </div>
        </div>
      </div>

<script>
function openNoteModal() {
  document.getElementById('note-modal').classList.remove('hidden');
}

function closeNoteModal() {
  document.getElementById('note-modal').classList.add('hidden');
  document.getElementById('note-input').value = '';
}

function saveNote() {
  const noteText = document.getElementById('note-input').value.trim();
  const currentUser = firebase.auth().currentUser;
  
  if (!noteText || !currentUser) return;
  
  firebase.database().ref('profileNotes/' + currentUser.uid).set({
    text: noteText,
    timestamp: Date.now()
  }).then(() => {
    closeNoteModal();
    const profileNote = document.getElementById('profile-note');
    profileNote.classList.remove('hidden');
    document.getElementById('note-text').textContent = noteText;
    document.getElementById('note-time').textContent = 'Expira en 12 horas';
  });
}
</script>
      <!-- Nombre de usuario -->
      <h2 id="author-profile-name" class="text-xl font-bold mt-2 text-black"></h2>
      <!-- Biograf√≠a -->
      <p id="author-bio" class="text-center text-gray-600 mt-2"></p>
      <!-- Redes sociales -->
      <div id="author-social-links" class="flex space-x-4 mt-4"></div>

      <!-- Estad√≠sticas encima de botones -->
      <div class="flex space-x-8 mt-6">
        <div class="text-center">
          <span id="author-following" class="font-bold text-black">0</span>
          <p class="text-sm text-[#FE2C55]">Siguiendo</p>
        </div>
        <div class="text-center">
          <span id="author-followers" class="font-bold text-black">0</span>
          <p class="text-sm text-[#FE2C55]">Seguidores</p>
        </div>
      </div>

      <!-- Botones de acci√≥n: Seguir, Bloquear y Reportar -->
      <div class="flex items-center justify-center w-full mt-4 space-x-2">
        <button id="follow-button" onclick="followAuthor()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg hover:bg-red-600" title="Seguir/Dejar de seguir">
          <span id="follow-button-text">Seguir</span>
        </button>
        <button id="block-button" onclick="blockAuthor()" class="bg-[#f9f9f9] text-[#FE2C55] px-4 py-2 rounded-lg border border-[#FE2C55] hover:bg-gray-100" title="Bloquear/Desbloquear">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
          </svg>
          Bloquear
        </button>
        <button id="report-button" onclick="openReportModal()" class="flex items-center bg-[#f9f9f9] text-[#FE2C55] px-4 py-2 rounded-lg border border-[#FE2C55] hover:bg-gray-100" title="Reportar">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          Reportar
        </button>
      </div>

      <hr class="border-t border-gray-300 w-full my-4">

      <!-- Historias del autor -->
      <div class="mt-4 w-full">
        <h3 id="author-stories-title" class="text-lg font-bold mb-2 text-[#FE2C55]">Historias del autor</h3>
        <div id="author-stories" class="grid grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts para opciones y funcionalidad -->
<script>
  // Toggle men√∫ de opciones
  document.getElementById('options-button').addEventListener('click', function() {
    const menu = document.getElementById('options-menu');
    menu.classList.toggle('hidden');
  });

  // Toggling de texto en bot√≥n de seguir
  function followAuthor() {
    const btn = document.getElementById('follow-button');
    const text = document.getElementById('follow-button-text');
    const isFollowing = text.textContent === 'Seguir';
    text.textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
    // Aqu√≠ ir√≠a l√≥gica real de seguimiento.
  }
</script>



<!-- VISTA DE TIENDA MODERNA ESTILO TIKTOK SHOP -->
<div id="store-view" class="fixed inset-0 bg-gray-50 text-black overflow-y-auto hidden z-50">
  <div class="min-h-screen">
    <!-- Header con carrito y saldo -->
    <div class="sticky top-0 z-10 bg-white shadow-sm border-b border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <button onclick="closeStore()" class="text-[#FE2C55] font-medium flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span></span>
        </button>
        
        <div class="flex items-center space-x-2">
          <div class="flex items-center bg-[#FE2C55] text-white px-3 py-1 rounded-full">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-sm font-bold">BeaBoo Shop</span>
          </div>
        </div>
        
        <div class="flex items-center space-x-3">
          <div class="flex items-center bg-gradient-to-r from-yellow-400 to-yellow-500 text-white px-3 py-2 rounded-full shadow-md">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.736 6.979C9.208 6.193 9.696 6 10 6c.304 0 .792.193 1.264.979.474.787.736 1.979.736 3.021 0 1.042-.262 2.234-.736 3.021C10.792 13.807 10.304 14 10 14c-.304 0-.792-.193-1.264-.979C8.262 12.234 8 11.042 8 10c0-1.042.262-2.234.736-3.021z" clip-rule="evenodd"/>
            </svg>
            <span id="store-balance" class="font-bold">$0.00</span>
          </div>
          <button onclick="toggleCart()" class="relative bg-[#FE2C55] text-white p-3 rounded-full hover:bg-red-600 transition-colors shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-yellow-400 text-black text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold min-w-[20px]">0</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Banner de ofertas modernizado -->
    <div class="bg-gradient-to-r from-purple-600 via-pink-600 to-red-500 text-white p-4 mx-4 mt-4 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-3">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div>
            <p class="font-bold text-lg">Oferta Flash</p>
            <p class="text-sm opacity-90">Hasta 70% de descuento en marcos premium</p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm opacity-90">Termina en</p>
          <p class="font-bold text-xl" id="offer-countdown">23:59:45</p>
        </div>
      </div>
    </div>

    <!-- Navegaci√≥n de categor√≠as modernizada -->
    <div class="bg-white border-b border-gray-200 p-4 mx-4 mt-4 rounded-2xl shadow-sm">
      <div class="flex space-x-3 overflow-x-auto">
        <button onclick="switchStoreCategory('premium')" class="store-category-btn active px-4 py-3 bg-[#FE2C55] text-white rounded-xl whitespace-nowrap flex items-center font-medium shadow-md">
          <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
          Premium
        </button>
        <button onclick="switchStoreCategory('frames')" class="store-category-btn px-4 py-3 bg-gray-100 text-gray-700 rounded-xl whitespace-nowrap flex items-center font-medium hover:bg-gray-200 transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          Marcos
        </button>
        <button onclick="switchStoreCategory('books')" class="store-category-btn px-4 py-3 bg-gray-100 text-gray-700 rounded-xl whitespace-nowrap flex items-center font-medium hover:bg-gray-200 transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          Libros
        </button>
        <button onclick="switchStoreCategory('gifts')" class="store-category-btn px-4 py-3 bg-gray-100 text-gray-700 rounded-xl whitespace-nowrap flex items-center font-medium hover:bg-gray-200 transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/>
          </svg>
          Regalos
        </button>
        <button onclick="switchStoreCategory('accessories')" class="store-category-btn px-4 py-3 bg-gray-100 text-gray-700 rounded-xl whitespace-nowrap flex items-center font-medium hover:bg-gray-200 transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
          </svg>
          Accesorios
        </button>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="p-4">
      
      <!-- Secci√≥n Premium -->
      <div id="store-premium" class="store-category-content">
        <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-xl mb-6">
          <h2 class="text-2xl font-bold mb-2">üåü Colecci√≥n Premium</h2>
          <p class="opacity-90">Los productos m√°s exclusivos con descuentos especiales</p>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Producto Premium 1 -->
          <div class="bg-white rounded-xl shadow-sm border overflow-hidden group hover:shadow-lg transition-all">
            <div class="relative">
              <div class="w-full h-48 bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center relative">
                <div class="w-20 h-20 rounded-full rainbow-frame"></div>
                <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                  -50%
                </div>
                <div class="absolute top-2 right-2 bg-black/20 text-white px-2 py-1 rounded-full text-xs">
                  ‚úì Enviado por BeaBoo
                </div>
              </div>
              <div class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="addToCart('premium-rainbow', 'Marco Arco√≠ris Premium', 9.99, 19.99)" class="bg-[#FE2C55] text-white p-2 rounded-full shadow-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                </button>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-lg mb-1">Marco Arco√≠ris Premium</h3>
              <p class="text-gray-600 text-sm mb-3">Efecto mejorado con part√≠culas brillantes</p>
              
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                  <span class="text-xl font-bold text-[#FE2C55]">$9.99</span>
                  <span class="text-sm text-gray-500 line-through">$19.99</span>
                </div>
                <div class="flex items-center text-yellow-500">
                  <span class="text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                  <span class="text-xs text-gray-500 ml-1">(4.9)</span>
                </div>
              </div>
              
              <div class="space-y-2 text-xs text-gray-600 mb-4">
                <div class="flex items-center">
                  <span class="mr-2">üöö</span>
                  <span>Entrega instant√°nea digital</span>
                </div>
                <div class="flex items-center">
                  <span class="mr-2">üîÑ</span>
                  <span>Garant√≠a de devoluci√≥n 30 d√≠as</span>
                </div>
                <div class="flex items-center">
                  <span class="mr-2">üõ°Ô∏è</span>
                  <span>Pago 100% seguro</span>
                </div>
              </div>
              
              <button onclick="addToCart('premium-rainbow', 'Marco Arco√≠ris Premium', 9.99, 19.99)" class="w-full bg-[#FE2C55] text-white py-2 rounded-lg font-medium hover:bg-red-600 transition-colors">
                A√±adir al carrito
              </button>
            </div>
          </div>

          <!-- Producto Premium 2 -->
          <div class="bg-white rounded-xl shadow-sm border overflow-hidden group hover:shadow-lg transition-all">
            <div class="relative">
              <div class="w-full h-48 bg-gradient-to-br from-yellow-400 to-red-500 flex items-center justify-center relative">
                <div class="w-20 h-20 rounded-full fire-frame"></div>
                <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                  -30%
                </div>
                <div class="absolute top-2 right-2 bg-black/20 text-white px-2 py-1 rounded-full text-xs">
                  ‚úì Enviado por BeaBoo
                </div>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-lg mb-1">Marco de Fuego Elite</h3>
              <p class="text-gray-600 text-sm mb-3">Llamas realistas con efectos de sonido</p>
              
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                  <span class="text-xl font-bold text-[#FE2C55]">$13.99</span>
                  <span class="text-sm text-gray-500 line-through">$19.99</span>
                </div>
                <div class="flex items-center text-yellow-500">
                  <span class="text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                  <span class="text-xs text-gray-500 ml-1">(4.8)</span>
                </div>
              </div>
              
              <div class="space-y-2 text-xs text-gray-600 mb-4">
                <div class="flex items-center">
                  <span class="mr-2">üöö</span>
                  <span>Entrega instant√°nea digital</span>
                </div>
                <div class="flex items-center">
                  <span class="mr-2">üîÑ</span>
                  <span>Garant√≠a de devoluci√≥n 30 d√≠as</span>
                </div>
                <div class="flex items-center">
                  <span class="mr-2">üéµ</span>
                  <span>Incluye efectos de sonido</span>
                </div>
              </div>
              
              <button onclick="addToCart('premium-fire', 'Marco de Fuego Elite', 13.99, 19.99)" class="w-full bg-[#FE2C55] text-white py-2 rounded-lg font-medium hover:bg-red-600 transition-colors">
                A√±adir al carrito
              </button>
            </div>
          </div>

          <!-- Producto Premium 3 -->
          <div class="bg-white rounded-xl shadow-sm border overflow-hidden group hover:shadow-lg transition-all">
            <div class="relative">
              <div class="w-full h-48 bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center relative">
                <div class="w-20 h-20 rounded-full galaxy-frame"></div>
                <div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                  NUEVO
                </div>
                <div class="absolute top-2 right-2 bg-black/20 text-white px-2 py-1 rounded-full text-xs">
                  ‚úì Enviado por BeaBoo
                </div>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-lg mb-1">Marco Galaxia Infinita</h3>
              <p class="text-gray-600 text-sm mb-3">Estrellas animadas y nebulosas en 3D</p>
              
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                  <span class="text-xl font-bold text-[#FE2C55]">$24.99</span>
                </div>
                <div class="flex items-center text-yellow-500">
                  <span class="text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                  <span class="text-xs text-gray-500 ml-1">(5.0)</span>
                </div>
              </div>
              
              <div class="space-y-2 text-xs text-gray-600 mb-4">
                <div class="flex items-center">
                  <span class="mr-2">üöö</span>
                  <span>Entrega instant√°nea digital</span>
                </div>
                <div class="flex items-center">
                  <span class="mr-2">‚ú®</span>
                  <span>Efectos 3D exclusivos</span>
                </div>
                <div class="flex items-center">
                  <span class="mr-2">üèÜ</span>
                  <span>Edici√≥n limitada</span>
                </div>
              </div>
              
              <button onclick="addToCart('premium-galaxy', 'Marco Galaxia Infinita', 24.99, 0)" class="w-full bg-[#FE2C55] text-white py-2 rounded-lg font-medium hover:bg-red-600 transition-colors">
                A√±adir al carrito
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Secci√≥n Marcos Completa -->
      <div id="store-frames" class="store-category-content hidden">
        <div class="mb-6">
          <h2 class="text-3xl font-bold mb-3 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Marcos y Efectos</h2>
          <p class="text-gray-600">Personaliza tu perfil con efectos √∫nicos que otros usuarios podr√°n ver</p>
        </div>
        
        <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          
          <!-- Marco Sin Efecto (Gratis) -->
          <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-4 hover:border-green-300 transition-all">
            <div class="w-full aspect-square mb-3 rounded-full border-2 border-gray-300 flex items-center justify-center relative bg-gray-50">
              <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 715.636 5.636m12.728 12.728L5.636 5.636"/>
                </svg>
              </div>
            </div>
            <h3 class="font-bold mb-1">Sin Marco</h3>
            <p class="text-sm text-gray-600 mb-3">Perfil b√°sico, sin efectos</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-green-600">GRATIS</span>
              <div class="flex items-center text-yellow-500 text-xs">
                <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                <span class="text-gray-500 ml-1">(5.0)</span>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 mb-3 space-y-1">
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                Aplicaci√≥n instant√°nea
              </div>
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                </svg>
                Cambiar cuando quieras
              </div>
            </div>
            
            <button onclick="addToCart('none', 'Sin Marco', 0, 0)" class="w-full bg-green-500 text-white py-3 rounded-xl text-sm font-semibold hover:bg-green-600 transition-colors">
              Aplicar Marco
            </button>
          </div>

          <!-- Marco Arco√≠ris -->
          <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-4 hover:border-purple-300 transition-all">
            <div class="w-full aspect-square mb-3 rounded-full rainbow-frame flex items-center justify-center relative">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-red-400 via-yellow-400 via-green-400 via-blue-400 to-purple-400"></div>
            </div>
            <h3 class="font-bold mb-1">Marco Arco√≠ris</h3>
            <p class="text-sm text-gray-600 mb-3">Efecto colorido giratorio</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$4.99</span>
              <div class="flex items-center text-yellow-500 text-xs">
                <span>‚≠ê‚≠ê‚≠ê‚≠ê</span>
                <span class="text-gray-500 ml-1">(4.2)</span>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 mb-3 space-y-1">
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 1.414L10.586 9.5H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/>
                </svg>
                Entrega instant√°nea
              </div>
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                Efecto especial
              </div>
            </div>
            
            <button onclick="addToCart('rainbow', 'Marco Arco√≠ris', 4.99, 0)" class="w-full bg-[#FE2C55] text-white py-3 rounded-xl text-sm font-semibold hover:bg-red-600 transition-colors">
              A√±adir al carrito
            </button>
          </div>

          <!-- Marco El√©ctrico -->
          <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-4 hover:border-blue-300 transition-all">
            <div class="w-full aspect-square mb-3 rounded-full electric-frame flex items-center justify-center relative">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400"></div>
            </div>
            <h3 class="font-bold mb-1">Marco El√©ctrico</h3>
            <p class="text-sm text-gray-600 mb-3">Chispas el√©ctricas animadas</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$6.99</span>
              <div class="flex items-center text-yellow-500 text-xs">
                <span>‚≠ê‚≠ê‚≠ê‚≠ê</span>
                <span class="text-gray-500 ml-1">(4.3)</span>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 mb-3 space-y-1">
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 1.414L10.586 9.5H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/>
                </svg>
                Entrega instant√°nea
              </div>
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                </svg>
                Efecto el√©ctrico
              </div>
            </div>
            
            <button onclick="addToCart('electric', 'Marco El√©ctrico', 6.99, 0)" class="w-full bg-[#FE2C55] text-white py-3 rounded-xl text-sm font-semibold hover:bg-red-600 transition-colors">
              A√±adir al carrito
            </button>
          </div>

          <!-- Marco de Fuego -->
          <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-4 hover:border-red-300 transition-all">
            <div class="w-full aspect-square mb-3 rounded-full fire-frame flex items-center justify-center relative">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-red-500 to-orange-500"></div>
            </div>
            <h3 class="font-bold mb-1">Marco de Fuego</h3>
            <p class="text-sm text-gray-600 mb-3">Llamas ardientes realistas</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$8.99</span>
              <div class="flex items-center text-yellow-500 text-xs">
                <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                <span class="text-gray-500 ml-1">(4.8)</span>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 mb-3 space-y-1">
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
                </svg>
                Popular
              </div>
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                Premium
              </div>
            </div>
            
            <button onclick="addToCart('fire', 'Marco de Fuego', 8.99, 0)" class="w-full bg-[#FE2C55] text-white py-3 rounded-xl text-sm font-semibold hover:bg-red-600 transition-colors">
              A√±adir al carrito
            </button>
          </div>

          <!-- Marco Galaxia -->
          <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-4 hover:border-purple-300 transition-all">
            <div class="w-full aspect-square mb-3 rounded-full galaxy-frame flex items-center justify-center relative">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600"></div>
            </div>
            <h3 class="font-bold mb-1">Marco Galaxia</h3>
            <p class="text-sm text-gray-600 mb-3">Estrellas y nebulosas 3D</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$12.99</span>
              <div class="flex items-center text-yellow-500 text-xs">
                <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                <span class="text-gray-500 ml-1">(4.9)</span>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 mb-3 space-y-1">
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                Exclusivo
              </div>
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                Efectos 3D
              </div>
            </div>
            
            <button onclick="addToCart('galaxy', 'Marco Galaxia', 12.99, 0)" class="w-full bg-[#FE2C55] text-white py-3 rounded-xl text-sm font-semibold hover:bg-red-600 transition-colors">
              A√±adir al carrito
            </button>
          </div>

          <!-- Marco Diamante -->
          <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-4 hover:border-blue-300 transition-all">
            <div class="w-full aspect-square mb-3 rounded-full diamond-frame flex items-center justify-center relative">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-200 to-blue-300"></div>
            </div>
            <h3 class="font-bold mb-1">Marco Diamante</h3>
            <p class="text-sm text-gray-600 mb-3">Brillo y destellos premium</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$15.99</span>
              <div class="flex items-center text-yellow-500 text-xs">
                <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                <span class="text-gray-500 ml-1">(4.7)</span>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 mb-3 space-y-1">
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                Lujo premium
              </div>
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-cyan-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v7h-2l-1-2H8l-1 2H5V5z" clip-rule="evenodd"/>
                </svg>
                Destellos √∫nicos
              </div>
            </div>
            
            <button onclick="addToCart('diamond', 'Marco Diamante', 15.99, 0)" class="w-full bg-[#FE2C55] text-white py-3 rounded-xl text-sm font-semibold hover:bg-red-600 transition-colors">
              A√±adir al carrito
            </button>
          </div>

          <!-- Marco Ne√≥n -->
          <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-4 hover:border-green-300 transition-all">
            <div class="w-full aspect-square mb-3 rounded-full neon-frame flex items-center justify-center relative">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-green-400 to-teal-400"></div>
            </div>
            <h3 class="font-bold mb-1">Marco Ne√≥n</h3>
            <p class="text-sm text-gray-600 mb-3">Brillo nocturno futurista</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$9.99</span>
              <div class="flex items-center text-yellow-500 text-xs">
                <span>‚≠ê‚≠ê‚≠ê‚≠ê</span>
                <span class="text-gray-500 ml-1">(4.5)</span>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 mb-3 space-y-1">
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                </svg>
                Efecto ne√≥n
              </div>
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-teal-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"/>
                </svg>
                Futurista
              </div>
            </div>
            
            <button onclick="addToCart('neon', 'Marco Ne√≥n', 9.99, 0)" class="w-full bg-[#FE2C55] text-white py-3 rounded-xl text-sm font-semibold hover:bg-red-600 transition-colors">
              A√±adir al carrito
            </button>
          </div>

          <!-- Marco Real -->
          <div class="bg-white rounded-2xl shadow-lg border-2 border-yellow-200 p-4 hover:border-yellow-400 transition-all">
            <div class="w-full aspect-square mb-3 rounded-full royal-frame flex items-center justify-center relative">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-yellow-400 to-amber-500"></div>
            </div>
            <h3 class="font-bold mb-1">Marco Real</h3>
            <p class="text-sm text-gray-600 mb-3">Elegancia dorada exclusiva</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$24.99</span>
              <div class="flex items-center text-yellow-500 text-xs">
                <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                <span class="text-gray-500 ml-1">(5.0)</span>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 mb-3 space-y-1">
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Edici√≥n limitada
              </div>
              <div class="flex items-center">
                <svg class="w-3 h-3 mr-2 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                VIP exclusivo
              </div>
            </div>
            
            <button onclick="addToCart('royal', 'Marco Real', 24.99, 0)" class="w-full bg-gradient-to-r from-yellow-500 to-amber-500 text-white py-3 rounded-xl text-sm font-semibold hover:from-yellow-600 hover:to-amber-600 transition-colors">
              A√±adir al carrito
            </button>
          </div>

        </div>
      </div>

      <!-- Libros Digitales -->
      <div id="store-books" class="store-category-content hidden">
        <div class="mb-6">
          <h2 class="text-2xl font-bold mb-2">üìö Libros Digitales Exclusivos</h2>
          <p class="text-gray-600">Historias premium de autores destacados</p>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex space-x-4">
              <img src="https://via.placeholder.com/80x120/cccccc/666666?text=Book" alt="Libro" class="w-20 h-30 object-cover rounded-lg">
              <div class="flex-1">
                <h3 class="font-bold mb-1">Romance en Par√≠s</h3>
                <p class="text-sm text-gray-600 mb-2">Por Mar√≠a Gonz√°lez</p>
                <p class="text-xs text-gray-500 mb-3">Una historia de amor en la ciudad de la luz...</p>
                
                <div class="flex items-center justify-between mb-3">
                  <span class="text-lg font-bold text-[#FE2C55]">$12.99</span>
                  <div class="flex items-center text-yellow-500 text-xs">
                    <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                    <span class="text-gray-500 ml-1">(4.9)</span>
                  </div>
                </div>
                
                <div class="text-xs text-gray-600 mb-3">
                  <div class="flex items-center mb-1">
                    <span class="mr-2">üìñ</span>320 p√°ginas
                  </div>
                  <div class="flex items-center">
                    <span class="mr-2">üîÑ</span>Devoluci√≥n garantizada
                  </div>
                </div>
                
                <button onclick="addToCart('book-romance-paris', 'Romance en Par√≠s', 12.99, 0)" class="w-full bg-[#FE2C55] text-white py-2 rounded-lg text-sm font-medium">
                  A√±adir al carrito
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Regalos LIVE -->
      <div id="store-gifts" class="store-category-content hidden">
        <div class="mb-6">
          <h2 class="text-2xl font-bold mb-2">üéÅ Regalos para Transmisiones</h2>
          <p class="text-gray-600">Sorprende a tus streamers favoritos</p>
        </div>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-white rounded-xl shadow-sm border p-4 text-center">
            <div class="w-full aspect-square mb-3 flex items-center justify-center">
              <img src="https://i.pinimg.com/originals/2d/f8/97/2df897364f655a0b14070a9e2f95d602.gif" alt="Cupido" class="w-16 h-16 rounded-lg">
            </div>
            <h3 class="font-bold mb-1">Cupido</h3>
            <p class="text-sm text-gray-600 mb-3">Regalo rom√°ntico</p>
            
            <div class="flex items-center justify-center mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$2.99</span>
            </div>
            
            <button onclick="addToCart('gift-cupido', 'Regalo Cupido', 2.99, 0)" class="w-full bg-[#FE2C55] text-white py-2 rounded-lg text-sm font-medium">
              A√±adir al carrito
            </button>
          </div>
        </div>
      </div>

      <!-- Accesorios Digitales -->
      <div id="store-accessories" class="store-category-content hidden">
        <div class="mb-6">
          <h2 class="text-2xl font-bold mb-2">üíé Accesorios Digitales</h2>
          <p class="text-gray-600">Badges, t√≠tulos y efectos especiales</p>
        </div>
        
        <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="w-full h-24 mb-3 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center">
              <span class="text-white font-bold text-lg">üëë VIP</span>
            </div>
            <h3 class="font-bold mb-1">Badge VIP</h3>
            <p class="text-sm text-gray-600 mb-3">Insignia dorada premium</p>
            
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-[#FE2C55]">$19.99</span>
              <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Popular</span>
            </div>
            
            <button onclick="addToCart('badge-vip', 'Badge VIP', 19.99, 0)" class="w-full bg-[#FE2C55] text-white py-2 rounded-lg text-sm font-medium">
              A√±adir al carrito
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer con protecciones de BeaBoo modernizado -->
    <div class="bg-gradient-to-r from-gray-50 to-white border-t border-gray-200 p-8 mt-8">
      <div class="text-center mb-8">
        <div class="flex items-center justify-center mb-4">
          <div class="w-8 h-8 bg-[#FE2C55] rounded-full flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
          </div>
          <h3 class="font-bold text-2xl text-gray-900">Protecciones de BeaBoo Shop</h3>
        </div>
        <p class="text-gray-600 max-w-2xl mx-auto">Compra con total confianza. Nuestras garant√≠as te protegen en cada transacci√≥n digital.</p>
      </div>
      
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4 mx-auto">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <p class="font-semibold text-gray-900 mb-2">Pago Seguro</p>
          <p class="text-sm text-gray-600">Encriptaci√≥n SSL 256-bit</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-4 mx-auto">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
          </div>
          <p class="font-semibold text-gray-900 mb-2">Garant√≠a de Devoluci√≥n</p>
          <p class="text-sm text-gray-600">30 d√≠as garantizado</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-4 mx-auto">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
          </div>
          <p class="font-semibold text-gray-900 mb-2">Reembolso Autom√°tico</p>
          <p class="text-sm text-gray-600">Por p√©rdidas o da√±os</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mb-4 mx-auto">
            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192L5.636 18.364M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
          </div>
          <p class="font-semibold text-gray-900 mb-2">Soporte 24/7</p>
          <p class="text-sm text-gray-600">Asistencia continua</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mb-4 mx-auto">
            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
          </div>
          <p class="font-semibold text-gray-900 mb-2">Privacidad de Datos</p>
          <p class="text-sm text-gray-600">Informaci√≥n protegida</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mb-4 mx-auto">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
          <p class="font-semibold text-gray-900 mb-2">Entrega Instant√°nea</p>
          <p class="text-sm text-gray-600">Productos digitales</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4 mx-auto">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <p class="font-semibold text-gray-900 mb-2">Verificado por BeaBoo</p>
          <p class="text-sm text-gray-600">Productos aut√©nticos</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mb-4 mx-auto">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
            </svg>
          </div>
          <p class="font-semibold text-gray-900 mb-2">Calidad Premium</p>
          <p class="text-sm text-gray-600">100% original</p>
        </div>
      </div>
      
      <!-- Informaci√≥n adicional -->
      <div class="mt-8 text-center">
        <div class="inline-flex items-center bg-[#FE2C55] text-white px-6 py-3 rounded-full">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
          <span class="font-medium">Protegido por BeaBoo Shield</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CARRITO DE COMPRAS -->
<div id="cart-sidebar" class="fixed right-0 top-0 h-full w-80 bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-60 border-l border-gray-200">
  <div class="flex flex-col h-full">
    <!-- Header del carrito -->
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">üõí Mi Carrito</h2>
        <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Contenido del carrito -->
    <div class="flex-1 overflow-y-auto p-4">
      <div id="cart-items" class="space-y-4">
        <!-- Los items del carrito se cargar√°n aqu√≠ -->
      </div>
      
      <div id="cart-empty" class="text-center py-12">
        <div class="text-gray-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.65 8.35m1.65-8.35L4.2 3M7 13v8a2 2 0 002 2h6a2 2 0 002-2v-8" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-600 mb-2">Tu carrito est√° vac√≠o</h3>
        <p class="text-gray-500 text-sm">Agrega productos para comenzar tu compra</p>
      </div>
    </div>
    
    <!-- Resumen y checkout -->
    <div id="cart-summary" class="border-t border-gray-200 p-4 bg-gray-50">
      <div class="space-y-2 mb-4">
        <div class="flex justify-between text-sm">
          <span>Subtotal:</span>
          <span id="cart-subtotal">$0.00</span>
        </div>
        <div class="flex justify-between text-sm">
          <span>Descuentos:</span>
          <span id="cart-discount" class="text-green-600">-$0.00</span>
        </div>
        <div class="flex justify-between text-sm">
          <span>Env√≠o:</span>
          <span class="text-green-600">GRATIS (Digital)</span>
        </div>
        <hr class="border-gray-300">
        <div class="flex justify-between font-bold text-lg">
          <span>Total:</span>
          <span id="cart-total" class="text-[#FE2C55]">$0.00</span>
        </div>
      </div>
      
      <button onclick="proceedToCheckout()" id="checkout-btn" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-bold hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        Proceder al Pago
      </button>
      
      <div class="flex items-center justify-center mt-3 space-x-2 text-xs text-gray-600">
        <span>üîí</span>
        <span>Pago seguro con protecci√≥n BeaBoo</span>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CHECKOUT -->
<div id="checkout-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-70 hidden">
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">üí≥ Finalizar Compra</h2>
      <button onclick="closeCheckout()" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Resumen de compra -->
    <div class="bg-gray-50 p-4 rounded-lg mb-4">
      <h3 class="font-bold mb-2">Resumen de tu pedido</h3>
      <div id="checkout-summary" class="space-y-2">
        <!-- Items del checkout -->
      </div>
      <hr class="my-3 border-gray-300">
      <div class="flex justify-between font-bold">
        <span>Total a pagar:</span>
        <span id="checkout-total" class="text-[#FE2C55]">$0.00</span>
      </div>
    </div>
    
    <!-- M√©todo de pago -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">M√©todo de pago</label>
      <div class="space-y-2">
        <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
          <input type="radio" name="payment" value="card" class="mr-3" checked>
          <span class="mr-2">üí≥</span>
          <span>Tarjeta de cr√©dito/d√©bito</span>
        </label>
        <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
          <input type="radio" name="payment" value="paypal" class="mr-3">
          <span class="mr-2">üÖøÔ∏è</span>
          <span>PayPal</span>
        </label>
        <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
          <input type="radio" name="payment" value="crypto" class="mr-3">
          <span class="mr-2">‚Çø</span>
          <span>Criptomonedas</span>
        </label>
      </div>
    </div>
    
    <!-- Informaci√≥n de entrega -->
    <div class="bg-blue-50 p-3 rounded-lg mb-4">
      <div class="flex items-center">
        <span class="mr-2">‚ö°</span>
        <div>
          <p class="font-medium text-sm">Entrega Digital Instant√°nea</p>
          <p class="text-xs text-gray-600">Recibir√°s tus productos inmediatamente despu√©s del pago</p>
        </div>
      </div>
    </div>
    
    <!-- Garant√≠as -->
    <div class="mb-4">
      <div class="grid grid-cols-2 gap-2 text-xs">
        <div class="flex items-center text-green-600">
          <span class="mr-1">‚úÖ</span>
          <span>Pago seguro</span>
        </div>
        <div class="flex items-center text-green-600">
          <span class="mr-1">üîÑ</span>
          <span>30 d√≠as garant√≠a</span>
        </div>
        <div class="flex items-center text-green-600">
          <span class="mr-1">üõ°Ô∏è</span>
          <span>Datos protegidos</span>
        </div>
        <div class="flex items-center text-green-600">
          <span class="mr-1">üí∏</span>
          <span>Reembolso seguro</span>
        </div>
      </div>
    </div>
    
    <button onclick="processPayment()" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-bold hover:bg-red-600 transition-colors">
      Pagar Ahora
    </button>
    
    <p class="text-xs text-center text-gray-500 mt-3">
      Al continuar, aceptas los t√©rminos y condiciones de BeaBoo Shop
    </p>
  </div>
</div>

<!-- MODAL DE DETALLE DE LIBRO EXCLUSIVO -->
<div id="book-detail-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-60 hidden">
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
    <div class="flex justify-between items-center mb-4">
      <h2 id="book-detail-title" class="text-xl font-bold">Libro Exclusivo</h2>
      <button onclick="closeBookDetail()" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <div class="flex space-x-4 mb-4">
      <img id="book-detail-cover" src="" alt="Portada" class="w-20 h-28 object-cover rounded-lg">
      <div class="flex-1">
        <p id="book-detail-author" class="text-gray-600 mb-2"></p>
        <p id="book-detail-synopsis" class="text-sm text-gray-600 mb-3"></p>
        <div class="flex items-center space-x-4 text-sm">
          <span id="book-detail-views" class="text-gray-500"></span>
          <span id="book-detail-rating" class="text-yellow-500"></span>
        </div>
      </div>
    </div>
    
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="font-bold text-lg">Precio: <span id="book-detail-price" class="text-[#FE2C55]"></span></p>
          <p class="text-sm text-gray-600">Acceso completo a todos los cap√≠tulos</p>
        </div>
      </div>
    </div>
    
    <div class="space-y-3">
      <button id="buy-book-btn" onclick="purchaseExclusiveBook()" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-medium">
        Comprar Libro
      </button>
      <button onclick="closeBookDetail()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN DE COMPRA -->
<div id="purchase-confirmation-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-60 hidden">
  <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 text-center">
    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>
    <h2 class="text-xl font-bold mb-2">¬°Compra Exitosa!</h2>
    <p id="purchase-message" class="text-gray-600 mb-6"></p>
    <button onclick="closePurchaseConfirmation()" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-medium">
      Continuar
    </button>
  </div>
</div>

<!-- MODAL DE LE√çDO RECIENTEMENTE -->
<div id="recently-read-modal" class="fixed inset-0 bg-white text-black overflow-y-auto hidden z-50">
  <div class="p-4">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <button onclick="closeRecentlyRead()" class="text-[#FE2C55] flex items-center hover:bg-gray-100 px-3 py-2 rounded-lg transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span>Volver</span>
      </button>
      <h1 class="text-2xl font-bold text-center flex-1">üìñ Le√≠do Recientemente</h1>
      <div class="w-20"></div>
    </div>

    <!-- Descripci√≥n -->
    <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
      <p class="text-purple-800 text-center">
        <span class="text-lg">‚è±Ô∏è</span> Aqu√≠ encontrar√°s todas las historias que has estado leyendo. 
        Contin√∫a desde donde lo dejaste.
      </p>
    </div>

    <!-- Lista de historias recientes -->
    <div id="recently-read-list" class="space-y-4">
      <!-- Las historias se cargar√°n aqu√≠ din√°micamente -->
    </div>

    <!-- Estado vac√≠o -->
    <div id="recently-read-empty" class="text-center py-12 hidden">
      <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-600 mb-2">A√∫n no has le√≠do nada</h3>
      <p class="text-gray-500 mb-6">Comienza a leer historias y aparecer√°n aqu√≠ autom√°ticamente</p>
      <button onclick="closeRecentlyRead(); openHome();" class="bg-[#FE2C55] text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors">
        Explorar Historias
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE MEMBRES√çA -->
<div id="membership-modal" class="fixed inset-0 bg-white text-black overflow-y-auto hidden z-50">
  <div class="p-4">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <button onclick="closeMembership()" class="text-[#FE2C55] flex items-center hover:bg-gray-100 px-3 py-2 rounded-lg transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span>Volver</span>
      </button>
      <h1 class="text-2xl font-bold text-center flex-1">üëë BeaBoo Premium</h1>
      <div class="w-20"></div>
    </div>

    <!-- Descripci√≥n premium -->
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl p-6 mb-8 text-center">
      <h2 class="text-2xl font-bold mb-3">‚ú® Desbloquea la experiencia completa</h2>
      <p class="opacity-90">Disfruta de BeaBoo sin l√≠mites con nuestra suscripci√≥n premium</p>
    </div>

    <!-- Planes de suscripci√≥n -->
    <div class="space-y-4 mb-8">
      <!-- Plan B√°sico -->
      <div class="bg-white border-2 border-gray-200 rounded-xl p-6 hover:border-[#FE2C55] transition-colors">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-800">B√°sico</h3>
            <p class="text-gray-600">Para lectores ocasionales</p>
          </div>
          <div class="text-right">
            <span class="text-sm text-gray-500">GRATIS</span>
          </div>
        </div>
        <ul class="space-y-2 mb-6">
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Acceso a historias p√∫blicas
          </li>
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Comentarios b√°sicos
          </li>
          <li class="flex items-center text-sm text-gray-400">
            <svg class="w-4 h-4 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            Incluye anuncios
          </li>
        </ul>
        <button class="w-full bg-gray-200 text-gray-600 py-3 rounded-lg font-medium cursor-not-allowed">
          Plan Actual
        </button>
      </div>

      <!-- Plan Premium -->
      <div class="bg-gradient-to-br from-orange-50 to-red-50 border-2 border-orange-300 rounded-xl p-6 relative">
        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
          <span class="bg-orange-500 text-white px-4 py-1 rounded-full text-sm font-bold">M√ÅS POPULAR</span>
        </div>
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-800">Premium</h3>
            <p class="text-gray-600">Para lectores activos</p>
          </div>
          <div class="text-right">
            <span class="text-2xl font-bold text-[#FE2C55]">$4.99</span>
            <span class="text-sm text-gray-500">/mes</span>
          </div>
        </div>
        <ul class="space-y-2 mb-6">
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            ‚ú® Sin anuncios
          </li>
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Acceso a contenido exclusivo
          </li>
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Lectura offline
          </li>
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Marco de perfil especial
          </li>
        </ul>
        <button onclick="subscribeToPlan('premium')" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 rounded-lg font-medium hover:from-orange-600 hover:to-red-600 transition-colors">
          Suscribirse a Premium
        </button>
      </div>

      <!-- Plan VIP -->
      <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-300 rounded-xl p-6">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-800">VIP</h3>
            <p class="text-gray-600">Para super fans</p>
          </div>
          <div class="text-right">
            <span class="text-2xl font-bold text-[#FE2C55]">$9.99</span>
            <span class="text-sm text-gray-500">/mes</span>
          </div>
        </div>
        <ul class="space-y-2 mb-6">
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Todo lo de Premium +
          </li>
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            üëë Badge VIP dorado
          </li>
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Acceso anticipado a nuevas funciones
          </li>
          <li class="flex items-center text-sm">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Soporte prioritario
          </li>
        </ul>
        <button onclick="subscribeToPlan('vip')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-colors">
          Suscribirse a VIP
        </button>
      </div>
    </div>

    <!-- Garant√≠a -->
    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
      <p class="text-green-800">
        <span class="text-lg">üõ°Ô∏è</span> Garant√≠a de 7 d√≠as. Cancela cuando quieras sin preguntas.
      </p>
    </div>
  </div>
</div>

<!-- VISTA DE CREACI√ìN DE C√ìMICS - PANTALLA COMPLETA -->
<div id="comic-creation-view" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="min-h-screen w-full">
    <!-- Header fijo -->
    <div class="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-gray-200 p-4">
      <div class="flex items-center justify-between max-w-4xl mx-auto">
        <button onclick="closeComicCreation()" class="text-[#FE2C55] font-medium flex items-center hover:bg-gray-100 px-3 py-2 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span>Volver</span>
        </button>
        <h1 class="text-xl font-bold text-[#FE2C55]">BeaBoo Comics Studio</h1>
        <div class="w-20"></div> <!-- Spacer para centrar el t√≠tulo -->
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="max-w-4xl mx-auto px-4 py-8">
      <div class="text-center mb-12">
        <h2 class="text-4xl md:text-5xl font-bold mb-4 text-black">Crea tu Comic</h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">Sube tus p√°ginas de c√≥mic y crea una experiencia de lectura vertical √∫nica estilo WEBTOON para tus lectores.</p>
      </div>

      <!-- Formulario de creaci√≥n de c√≥mic -->
      <form id="comic-creation-form" class="max-w-2xl mx-auto">
        <!-- T√≠tulo del c√≥mic -->
        <div class="mb-8">
          <label class="block text-lg font-semibold mb-3 text-gray-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
            T√≠tulo del C√≥mic
          </label>
          <input type="text" id="comic-title" placeholder="Ej: Mi Aventura Fant√°stica" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-[#FE2C55] focus:ring-2 focus:ring-[#FE2C55]/20 text-lg transition-all" required>
        </div>

        <!-- Descripci√≥n -->
        <div class="mb-8">
          <label class="block text-lg font-semibold mb-3 text-gray-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Descripci√≥n
          </label>
          <textarea id="comic-description" placeholder="Describe brevemente tu c√≥mic..." class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-[#FE2C55] focus:ring-2 focus:ring-[#FE2C55]/20 text-lg resize-none" rows="3" required></textarea>
        </div>

        <!-- Categor√≠a -->
        <div class="mb-8">
          <label class="block text-lg font-semibold mb-3 text-gray-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a4 4 0 014-4z" />
            </svg>
            Categor√≠a
          </label>
          <select id="comic-category" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-[#FE2C55] focus:ring-2 focus:ring-[#FE2C55]/20 text-lg" required>
            <option value="">Selecciona una categor√≠a</option>
            <option value="accion">üî• Acci√≥n</option>
            <option value="aventura">üó∫Ô∏è Aventura</option>
            <option value="romance">üíï Romance</option>
            <option value="fantasia">üßô‚Äç‚ôÇÔ∏è Fantas√≠a</option>
            <option value="drama">üé≠ Drama</option>
            <option value="comedia">üòÑ Comedia</option>
            <option value="terror">üëª Terror</option>
            <option value="slice_of_life">üåü Slice of Life</option>
          </select>
        </div>

        <!-- Zona de subida de p√°ginas -->
        <div class="mb-8">
          <label class="block text-lg font-semibold mb-3 text-gray-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            P√°ginas del C√≥mic
          </label>
          <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-[#FE2C55] transition-colors">
            <input type="file" id="comic-pages" multiple accept="image/*" class="hidden" onchange="handleComicPagesUpload(event)">
            <button type="button" onclick="document.getElementById('comic-pages').click()" class="inline-flex items-center px-6 py-3 bg-[#FE2C55] text-white rounded-lg hover:bg-red-600 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              Subir P√°ginas
            </button>
            <p class="text-gray-500 mt-2">Arrastra y suelta archivos aqu√≠ o haz clic para seleccionar</p>
            <p class="text-sm text-gray-400 mt-1">Formatos: PNG, JPG, JPEG. M√°ximo 20 p√°ginas.</p>
          </div>
          
          <!-- Preview de p√°ginas subidas -->
          <div id="pages-preview" class="mt-6 grid grid-cols-3 gap-4 hidden">
            <!-- Las p√°ginas se mostrar√°n aqu√≠ din√°micamente -->
          </div>
        </div>

        <!-- Imagen de portada -->
        <div class="mb-8">
          <label class="block text-lg font-semibold mb-3 text-gray-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Imagen de Portada
          </label>
          <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-[#FE2C55] transition-colors">
            <input type="file" id="comic-cover" accept="image/*" class="hidden" onchange="handleCoverUpload(event)">
            <button type="button" onclick="document.getElementById('comic-cover').click()" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              Seleccionar Portada
            </button>
            <div id="cover-preview" class="mt-4 hidden">
              <!-- Preview de la portada -->
            </div>
          </div>
        </div>

        <!-- Bot√≥n de crear c√≥mic -->
        <div class="text-center">
          <button type="submit" class="inline-flex items-center px-12 py-4 text-lg font-semibold text-white bg-gradient-to-r from-[#FE2C55] to-[#f97f97] rounded-xl shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Publicar C√≥mic
          </button>
        </div>
      </form>

      <!-- Consejos para c√≥mics -->
      <div class="mt-16 bg-gradient-to-r from-[#FE2C55] to-[#ff6b7a] rounded-2xl p-8 text-white">
        <div class="text-center">
          <h3 class="text-2xl font-bold mb-4">Consejos para tu Comic</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="text-center">
              <div class="w-12 h-12 mx-auto mb-3 bg-white/20 rounded-full flex items-center justify-center">
                <span class="text-xl">üìè</span>
              </div>
              <h4 class="font-semibold mb-2">Formato Vertical</h4>
              <p class="text-sm opacity-90">Dise√±a tus p√°ginas pensando en lectura vertical continua</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 mx-auto mb-3 bg-white/20 rounded-full flex items-center justify-center">
                <span class="text-xl">üé®</span>
              </div>
              <h4 class="font-semibold mb-2">Alta Calidad</h4>
              <p class="text-sm opacity-90">Usa im√°genes de alta resoluci√≥n para mejor experiencia</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 mx-auto mb-3 bg-white/20 rounded-full flex items-center justify-center">
                <span class="text-xl">üîÑ</span>
              </div>
              <h4 class="font-semibold mb-2">Conecta con lectores</h4>
              <p class="text-sm opacity-90">Comparte tu trabajo y recibe feedback de la comunidad</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LECTOR DE WEBTOON - SCROLL VERTICAL -->
<div id="webtoon-reader" class="fixed inset-0 z-50 hidden bg-black">
  <div class="relative w-full h-full flex flex-col">
    <!-- Header del lector -->
    <div class="absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/80 to-transparent p-4">
      <div class="flex items-center justify-between text-white">
        <button onclick="closeWebtoonReader()" class="flex items-center hover:bg-white/10 px-3 py-2 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span>Volver</span>
        </button>
        
        <div class="text-center">
          <h1 id="comic-title-header" class="text-lg font-bold">T√≠tulo del C√≥mic</h1>
          <p id="comic-episode-info" class="text-sm opacity-75">Episodio 1</p>
        </div>
        
        <div class="flex items-center space-x-3">
          <!-- Bot√≥n de configuraci√≥n -->
          <button onclick="toggleReaderSettings()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
          
          <!-- Bot√≥n de me gusta -->
          <button onclick="toggleComicLike()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Contenedor principal con scroll -->
    <div id="webtoon-scroll-container" class="flex-1 overflow-y-auto" style="scroll-behavior: smooth;">
      <div id="webtoon-pages-container" class="min-h-full flex flex-col items-center bg-black">
        <!-- Las p√°ginas del c√≥mic se cargar√°n aqu√≠ din√°micamente -->
        <div class="w-full max-w-2xl mx-auto">
          <!-- P√°gina de ejemplo - ser√° reemplazada por contenido din√°mico -->
          <div class="comic-page w-full mb-2">
            <img src="https://via.placeholder.com/800x2000/333333/666666?text=P√°gina+1" 
                 alt="P√°gina del c√≥mic" 
                 class="w-full h-auto block">
          </div>
        </div>
      </div>
    </div>

    <!-- Indicador de progreso de lectura -->
    <div class="fixed right-4 top-1/2 transform -translate-y-1/2 z-30">
      <div class="bg-white/20 backdrop-blur-sm rounded-full p-2 text-white text-xs">
        <div id="reading-progress" class="w-16 text-center">0%</div>
      </div>
    </div>

    <!-- Controles de navegaci√≥n (aparecen al tocar) -->
    <div id="navigation-controls" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 z-20 bg-black/50 backdrop-blur-sm rounded-full px-6 py-3 text-white opacity-0 transition-opacity duration-300">
      <div class="flex items-center space-x-4">
        <button onclick="previousEpisode()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        
        <span id="episode-counter" class="text-sm">1 / 1</span>
        
        <button onclick="nextEpisode()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Panel de configuraci√≥n del lector -->
    <div id="reader-settings" class="absolute top-0 right-0 w-80 h-full bg-black/90 backdrop-blur-sm transform translate-x-full transition-transform duration-300 z-30">
      <div class="p-6 text-white">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-bold">Configuraci√≥n</h3>
          <button onclick="toggleReaderSettings()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <!-- Brillo -->
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Brillo</label>
          <input type="range" id="brightness-slider" min="50" max="150" value="100" 
                 class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                 onchange="adjustBrightness(this.value)">
        </div>
        
        <!-- Modo de lectura -->
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Modo de lectura</label>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="radio" name="reading-mode" value="fit-width" checked class="mr-2">
              <span class="text-sm">Ajustar al ancho</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="reading-mode" value="fit-height" class="mr-2">
              <span class="text-sm">Ajustar a la altura</span>
            </label>
          </div>
        </div>
        
        <!-- Auto-scroll -->
        <div class="mb-6">
          <label class="flex items-center justify-between">
            <span class="text-sm font-medium">Auto-scroll</span>
            <input type="checkbox" id="auto-scroll" class="toggle-checkbox">
          </label>
          <div id="auto-scroll-settings" class="mt-2 hidden">
            <label class="block text-xs text-gray-300 mb-1">Velocidad</label>
            <input type="range" id="scroll-speed" min="1" max="10" value="3" 
                   class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE EDICI√ìN DE C√ìMICS -->
<div id="comic-edit-view" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-4 relative max-w-md mx-auto">
    <!-- Bot√≥n de cerrar -->
    <button onclick="closeStoryEdit()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      <span>Cerrar</span>
    </button>

    <!-- T√≠tulo -->
    <h2 id="edit-story-title" class="text-2xl font-bold mb-6 text-black">Editar Historia</h2>

    <!-- Edici√≥n de idioma -->
    <div class="mb-5">
      <label for="edit-story-language" class="text-sm text-gray-600 ml-2 mb-1 block">Idioma de la historia</label>
      <div class="relative">
        <select id="edit-story-language" class="w-full p-3 pl-10 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] text-black appearance-none">
          <option value="">Selecciona un idioma</option>
          <option value="English">English</option>
          <option value="Spanish">Espa√±ol</option>
        </select>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>

    <!-- Bot√≥n guardar -->
    <button onclick="saveStoryEdits()" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium mb-6 flex items-center justify-center hover:bg-red-600 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
      <span>Guardar Cambios</span>
    </button>

    <!-- Lista de cap√≠tulos -->
    <div id="chapter-section" class="mb-8">
      <h3 class="text-xl font-semibold mb-4 flex items-center text-[#FE2C55]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <span>Cap√≠tulos</span>
      </h3>
      <div id="chapter-list" class="space-y-3 mb-4 max-h-60 overflow-y-auto pr-2"></div>
      <button onclick="openChapterCreationModal()" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <span>Agregar Cap√≠tulo</span>
      </button>
    </div>

    <hr class="border-t border-gray-300 w-full my-4">

    <!-- Botones adicionales -->
    <button onclick="toggleStoryPrivacy()" class="w-full bg-[#f9f9f9] text-[#FE2C55] border border-[#FE2C55] p-3 rounded-lg font-medium mb-4 flex items-center justify-center hover:bg-gray-100 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
      <span>Hacer privada</span>
    </button>

    <button onclick="deleteStory(currentEditingStory.id)" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
      <span>Eliminar Historia</span>
    </button>
  </div>
</div>

<!-- MODAL DE CREACI√ìN/EDICI√ìN DE CAP√çTULO -->
<div id="chapter-creation-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
  <div class="modal-content bg-gradient-to-b from-white to-[#f9f9f9] text-black p-4 rounded-xl shadow-lg w-11/12 max-w-3xl">
    <div class="flex justify-between items-center mb-4">
      <h2 id="chapter-creation-title" class="text-2xl font-bold text-[#FE2C55]">Agregar Nuevo Cap√≠tulo</h2>
      <button onclick="closeChapterCreationModal()" class="text-gray-500 hover:text-black transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Barra de herramientas -->
    <div id="chapter-creation-toolbar" class="bg-white p-3 rounded-lg mb-4 flex flex-wrap gap-4 items-center">
      <div class="flex items-center">
        <label for="font-family" class="text-sm text-gray-600 mr-2">Fuente:</label>
        <select id="font-family" class="bg-white border border-gray-300 rounded-lg text-black text-sm p-1.5 focus:ring-2 focus:ring-[#FE2C55]">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
          <option value="Georgia">Georgia</option>
        </select>
      </div>

      <div class="flex items-center flex-1 min-w-[200px]">
        <label for="font-size" class="text-sm text-gray-600 mr-2">Tama√±o:</label>
        <input type="range" id="font-size" min="12" max="36" value="16" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-[#FE2C55] mr-2">
        <span id="font-size-value" class="text-sm">16px</span>
      </div>

      <div class="bg-white py-1 px-3 rounded-lg text-sm text-gray-600">
        <span id="word-count">0 palabras</span> - <span id="letter-count">0 letras</span>
      </div>
    </div>

    <form id="chapter-form" class="space-y-4">
      <div class="flex items-center gap-4 mb-4">
        <input type="datetime-local" id="chapter-schedule" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55]">
        <label class="text-sm text-gray-600">Fecha de publicaci√≥n (opcional)</label>
      </div>
      <textarea id="chapter-content" placeholder="Escribe el contenido del cap√≠tulo aqu√≠..." class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] text-black placeholder-gray-500 resize-none" style="font-size:16px; font-family: Arial;" rows="12" required></textarea>

      <button id="btn-save-chapter" type="submit" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <span>Guardar Cap√≠tulo</span>
      </button>
    </form>
  </div>
</div>

<!-- MODAL DE LECTURA DE CAP√çTULO - DISE√ëO MODERNO ESTILO WEBTOON/WATTPAD -->
<div id="chapter-read-modal" class="fixed inset-0 z-50 hidden">
  <!-- Tema claro por defecto (como Webtoon) con rosa pastel -->
  <div class="w-full h-screen flex flex-col bg-gradient-to-b from-pink-50 via-rose-50 to-pink-100" id="readerContainer">
    
    <!-- Header moderno flotante -->
    <div class="absolute top-0 left-0 right-0 z-20 bg-white/80 backdrop-blur-lg border-b border-orange-200/50 shadow-sm">
      <div class="flex items-center justify-between p-4 max-w-4xl mx-auto">
        <!-- Bot√≥n volver con estilo moderno -->
        <button onclick="closeChapterReadModal()" class="flex items-center space-x-2 text-gray-700 hover:text-orange-600 transition-all duration-200 bg-white/60 hover:bg-white/80 px-4 py-2 rounded-full shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span class="font-medium text-sm">Volver</span>
        </button>

        <!-- T√≠tulo del cap√≠tulo centrado -->
        <div class="flex-1 text-center mx-4">
          <h1 id="read-chapter-number" class="text-xl font-bold text-gray-800 truncate">Cargando...</h1>
          <p class="text-xs text-gray-500 mt-1" id="story-title-header">Cargando historia...</p>
        </div>

        <!-- Controles del lector -->
        <div class="flex items-center space-x-2">
          <!-- Bot√≥n de configuraci√≥n de tema -->
          <button onclick="toggleReaderTheme()" class="p-2 text-gray-700 hover:text-orange-600 bg-white/60 hover:bg-white/80 rounded-full shadow-sm transition-all duration-200" title="Cambiar tema">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          </button>

          <!-- Bot√≥n de configuraci√≥n de fuente -->
          <button onclick="toggleFontSettings()" class="p-2 text-gray-700 hover:text-orange-600 bg-white/60 hover:bg-white/80 rounded-full shadow-sm transition-all duration-200" title="Configurar fuente">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Panel de configuraci√≥n de fuente (oculto por defecto) -->
    <div id="font-settings-panel" class="absolute top-16 right-4 z-30 bg-white rounded-xl shadow-xl p-4 hidden max-w-xs border border-orange-200">
      <h3 class="font-semibold text-gray-800 mb-3">Configuraci√≥n de lectura</h3>
      
      <!-- Tama√±o de fuente -->
      <div class="mb-4">
        <label class="text-sm text-gray-600 block mb-2">Tama√±o de fuente</label>
        <div class="flex items-center space-x-2">
          <button onclick="adjustFontSize(-1)" class="w-8 h-8 bg-orange-100 hover:bg-orange-200 rounded-full text-orange-600 flex items-center justify-center text-sm font-bold transition-colors">-</button>
          <span id="font-size-display" class="text-sm text-gray-700 min-w-[40px] text-center">16px</span>
          <button onclick="adjustFontSize(1)" class="w-8 h-8 bg-orange-100 hover:bg-orange-200 rounded-full text-orange-600 flex items-center justify-center text-sm font-bold transition-colors">+</button>
        </div>
      </div>

      <!-- Espaciado de l√≠neas -->
      <div class="mb-4">
        <label class="text-sm text-gray-600 block mb-2">Espaciado</label>
        <input type="range" id="line-height-slider" min="1.2" max="2.5" step="0.1" value="1.6" class="w-full accent-orange-500" oninput="adjustLineHeight(this.value)">
      </div>

      <!-- Familia de fuente -->
      <div>
        <label class="text-sm text-gray-600 block mb-2">Fuente</label>
        <select id="font-family-select" onchange="changeFontFamily(this.value)" class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500">
          <option value="Georgia, serif">Georgia (Serif)</option>
          <option value="Arial, sans-serif">Arial (Sans-serif)</option>
          <option value="'Times New Roman', serif">Times New Roman</option>
          <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
          <option value="'Courier New', monospace">Courier New</option>
        </select>
      </div>
    </div>

    <!-- Contenido principal del cap√≠tulo -->
    <div class="flex-1 pt-20 pb-20 overflow-y-auto">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- √Årea de texto principal -->
        <article class="prose prose-lg max-w-none">
          <div id="read-chapter-text" class="text-gray-800 leading-relaxed text-base sm:text-lg" style="font-family: Georgia, serif; line-height: 1.6;">
            <!-- El contenido del cap√≠tulo se cargar√° aqu√≠ -->
          </div>
        </article>

        <!-- Indicador de progreso de lectura -->
        <div class="mt-12 mb-8">
          <div class="w-full bg-pink-200 rounded-full h-2">
            <div id="reading-progress" class="bg-gradient-to-r from-[#FE2C55] to-pink-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <p class="text-center text-sm text-gray-500 mt-2">Progreso de lectura</p>
        </div>

        <!-- Secci√≥n de interacci√≥n (comentarios y calificaci√≥n) -->
        <div class="bg-white rounded-xl border border-pink-200 shadow-sm p-6 mb-8">
          <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
            <!-- Sistema de calificaci√≥n moderno -->
            <div class="flex items-center space-x-4">
              <span class="text-gray-700 font-medium">¬øTe gust√≥ este cap√≠tulo?</span>
              <div id="star-rating" class="flex items-center space-x-1">
                <button class="star text-2xl text-gray-300 hover:text-pink-400 transition-colors duration-200 transform hover:scale-110" data-value="1" onclick="rateChapter(1)">‚≠ê</button>
                <button class="star text-2xl text-gray-300 hover:text-pink-400 transition-colors duration-200 transform hover:scale-110" data-value="2" onclick="rateChapter(2)">‚≠ê</button>
                <button class="star text-2xl text-gray-300 hover:text-pink-400 transition-colors duration-200 transform hover:scale-110" data-value="3" onclick="rateChapter(3)">‚≠ê</button>
                <button class="star text-2xl text-gray-300 hover:text-pink-400 transition-colors duration-200 transform hover:scale-110" data-value="4" onclick="rateChapter(4)">‚≠ê</button>
                <button class="star text-2xl text-gray-300 hover:text-pink-400 transition-colors duration-200 transform hover:scale-110" data-value="5" onclick="rateChapter(5)">‚≠ê</button>
              </div>
            </div>

            <!-- Bot√≥n de compartir -->
            <button onclick="shareChapter()" class="flex items-center space-x-2 bg-gradient-to-r from-[#FE2C55] to-pink-400 text-white px-4 py-2 rounded-full hover:from-pink-600 hover:to-pink-500 transition-all duration-200 transform hover:scale-105">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
              </svg>
              <span>Compartir</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer moderno con navegaci√≥n -->
    <div class="absolute bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-pink-200/50">
      <div class="max-w-4xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <!-- Bot√≥n cap√≠tulo anterior -->
          <button id="prev-chapter-btn" onclick="prevChapter()" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-full transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="font-medium text-sm">Anterior</span>
          </button>

          <!-- Indicador de cap√≠tulo actual -->
          <div class="flex items-center space-x-4 text-center">
            <div class="bg-gradient-to-r from-[#FE2C55] to-pink-400 text-white px-4 py-2 rounded-full">
              <span class="font-bold text-sm" id="chapter-indicator">Cap. 1 de 10</span>
            </div>
          </div>

          <!-- Bot√≥n cap√≠tulo siguiente -->
          <button id="next-chapter-btn" onclick="nextChapter()" class="flex items-center space-x-2 bg-gradient-to-r from-[#FE2C55] to-pink-400 hover:from-pink-600 hover:to-pink-500 text-white px-4 py-3 rounded-full transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
            <span class="font-medium text-sm">Siguiente</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts para funcionalidades del lector moderno -->
<script>
let currentReaderTheme = 'light';
let currentFontSize = 16;

// Variables globales para Firebase
let currentStoryId = null;
let currentChapterIndex = 0;
let storyChapters = [];
let currentStory = null;

// Conectar Firebase en tiempo real para cargar cap√≠tulos
function loadChapterFromFirebase(storyId, chapterIndex) {
  if (!storyId) {
    console.error('No se proporcion√≥ ID de historia');
    return;
  }

  currentStoryId = storyId;
  currentChapterIndex = chapterIndex || 0;

  // Cargar datos de la historia desde Firebase
  firebase.database().ref('stories/' + storyId).on('value', (snapshot) => {
    currentStory = snapshot.val();
    if (!currentStory) {
      console.error('Historia no encontrada');
      return;
    }

    // Obtener cap√≠tulos ordenados
    if (currentStory.chapters) {
      storyChapters = Object.keys(currentStory.chapters).map(key => ({
        id: key,
        ...currentStory.chapters[key]
      })).sort((a, b) => a.order - b.order);
    }

    // Cargar cap√≠tulo espec√≠fico
    if (storyChapters[currentChapterIndex]) {
      displayChapter(storyChapters[currentChapterIndex]);
      updateChapterNavigation();
    }

    // Actualizar informaci√≥n de la historia
    updateStoryInfo();
  });
}

// Mostrar el cap√≠tulo en el lector
function displayChapter(chapter) {
  const chapterText = document.getElementById('read-chapter-text');
  const chapterNumber = document.getElementById('read-chapter-number');
  
  if (chapterText && chapterNumber && chapter) {
    // Cargar contenido real desde Firebase
    chapterText.innerHTML = chapter.content || 'Contenido no disponible';
    chapterNumber.textContent = chapter.title || `Cap√≠tulo ${currentChapterIndex + 1}`;
    
    // Resetear progreso de lectura
    document.getElementById('reading-progress').style.width = '0%';
    
    // Guardar autom√°ticamente en historial de lectura
    if (currentStoryId) {
      saveReadingProgress(currentStoryId, currentChapterIndex, 0);
    }
  }
}

// Actualizar informaci√≥n de la historia
function updateStoryInfo() {
  if (currentStory) {
    // Actualizar indicador de cap√≠tulos
    const indicator = document.getElementById('chapter-indicator');
    if (indicator) {
      indicator.textContent = `Cap. ${currentChapterIndex + 1} de ${storyChapters.length}`;
    }

    // Actualizar t√≠tulo en el header si existe
    const storyTitle = document.querySelector('#chapter-read-modal .text-xs.text-gray-500');
    if (storyTitle) {
      storyTitle.textContent = currentStory.title || 'Historia sin t√≠tulo';
    }
  }
}

// Actualizar navegaci√≥n entre cap√≠tulos
function updateChapterNavigation() {
  const prevBtn = document.getElementById('prev-chapter-btn');
  const nextBtn = document.getElementById('next-chapter-btn');
  
  if (prevBtn) {
    prevBtn.disabled = currentChapterIndex <= 0;
    if (currentChapterIndex <= 0) {
      prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
      prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }
  
  if (nextBtn) {
    nextBtn.disabled = currentChapterIndex >= storyChapters.length - 1;
    if (currentChapterIndex >= storyChapters.length - 1) {
      nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
      nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }
}

// Navegar al cap√≠tulo anterior
function prevChapter() {
  if (currentChapterIndex > 0) {
    currentChapterIndex--;
    if (storyChapters[currentChapterIndex]) {
      displayChapter(storyChapters[currentChapterIndex]);
      updateChapterNavigation();
      updateStoryInfo();
    }
  }
}

// Navegar al cap√≠tulo siguiente
function nextChapter() {
  if (currentChapterIndex < storyChapters.length - 1) {
    currentChapterIndex++;
    if (storyChapters[currentChapterIndex]) {
      displayChapter(storyChapters[currentChapterIndex]);
      updateChapterNavigation();
      updateStoryInfo();
    }
  }
}

// Funci√≥n para abrir cap√≠tulo desde otra parte de la aplicaci√≥n
function openChapterReader(storyId, chapterIndex = 0) {
  document.getElementById('chapter-read-modal').classList.remove('hidden');
  loadChapterFromFirebase(storyId, chapterIndex);
}

// Cerrar modal del lector
function closeChapterReadModal() {
  document.getElementById('chapter-read-modal').classList.add('hidden');
  
  // Limpiar listeners de Firebase
  if (currentStoryId) {
    firebase.database().ref('stories/' + currentStoryId).off();
  }
  
  // Resetear variables
  currentStoryId = null;
  currentChapterIndex = 0;
  storyChapters = [];
  currentStory = null;
}

// Cambiar tema del lector (claro/oscuro) con colores rosa pastel
function toggleReaderTheme() {
  const container = document.getElementById('readerContainer');
  const textArea = document.getElementById('read-chapter-text');
  
  if (currentReaderTheme === 'light') {
    // Cambiar a tema oscuro (estilo Wattpad)
    container.className = 'w-full h-screen flex flex-col bg-gradient-to-b from-gray-900 via-gray-800 to-gray-900';
    textArea.style.color = '#f3f4f6';
    currentReaderTheme = 'dark';
  } else {
    // Cambiar a tema claro (estilo Webtoon con rosa pastel)
    container.className = 'w-full h-screen flex flex-col bg-gradient-to-b from-pink-50 via-rose-50 to-pink-100';
    textArea.style.color = '#1f2937';
    currentReaderTheme = 'light';
  }
}

// Calificar cap√≠tulo con conexi√≥n a Firebase
function rateChapter(rating) {
  const stars = document.querySelectorAll('.star');
  stars.forEach((star, index) => {
    if (index < rating) {
      star.style.color = '#FE2C55'; // Rosa pastel
      star.classList.add('selected');
    } else {
      star.style.color = '#d1d5db'; // gray-300
      star.classList.remove('selected');
    }
  });
  
  // Guardar calificaci√≥n en Firebase
  if (currentStoryId && storyChapters[currentChapterIndex]) {
    const user = firebase.auth().currentUser;
    if (user) {
      const chapterId = storyChapters[currentChapterIndex].id;
      firebase.database().ref(`chapterRatings/${currentStoryId}/${chapterId}/${user.uid}`).set({
        rating: rating,
        timestamp: Date.now()
      });
      
      // Mostrar confirmaci√≥n
      showRatingConfirmation(rating);
    }
  }
}

// Mostrar confirmaci√≥n de calificaci√≥n
function showRatingConfirmation(rating) {
  const notification = document.createElement('div');
  notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-[#FE2C55] text-white px-4 py-2 rounded-lg shadow-lg z-[70] flex items-center';
  notification.innerHTML = `
    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
    </svg>
    ¬°Calificaste con ${rating} estrella${rating > 1 ? 's' : ''}!
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translate(-50%, -20px)';
    notification.style.transition = 'all 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 2000);
}

// Mostrar/ocultar panel de configuraci√≥n
function toggleFontSettings() {
  const panel = document.getElementById('font-settings-panel');
  panel.classList.toggle('hidden');
}

// Ajustar tama√±o de fuente
function adjustFontSize(change) {
  currentFontSize += change * 2;
  if (currentFontSize < 12) currentFontSize = 12;
  if (currentFontSize > 24) currentFontSize = 24;
  
  const textArea = document.getElementById('read-chapter-text');
  textArea.style.fontSize = currentFontSize + 'px';
  document.getElementById('font-size-display').textContent = currentFontSize + 'px';
}

// Ajustar espaciado de l√≠neas
function adjustLineHeight(value) {
  const textArea = document.getElementById('read-chapter-text');
  textArea.style.lineHeight = value;
}

// Cambiar familia de fuente
function changeFontFamily(fontFamily) {
  const textArea = document.getElementById('read-chapter-text');
  textArea.style.fontFamily = fontFamily;
}

// Actualizar progreso de lectura
function updateReadingProgress() {
  const container = document.getElementById('readerContainer').children[1]; // El contenedor scrolleable
  const scrolled = container.scrollTop;
  const maxScroll = container.scrollHeight - container.clientHeight;
  const progress = (scrolled / maxScroll) * 100;
  const finalProgress = Math.min(progress, 100);
  
  document.getElementById('reading-progress').style.width = finalProgress + '%';
  
  // Guardar progreso autom√°ticamente cada 10% de avance
  if (currentStoryId && finalProgress > 0 && finalProgress % 10 < 1) {
    saveReadingProgress(currentStoryId, currentChapterIndex, finalProgress);
  }
}

// Calificar cap√≠tulo
function rateChapter(rating) {
  const stars = document.querySelectorAll('.star');
  stars.forEach((star, index) => {
    if (index < rating) {
      star.style.color = '#f59e0b'; // amber-500
      star.classList.add('selected');
    } else {
      star.style.color = '#d1d5db'; // gray-300
      star.classList.remove('selected');
    }
  });
  
  // Aqu√≠ puedes agregar la l√≥gica para enviar la calificaci√≥n a tu backend
  console.log('Cap√≠tulo calificado con', rating, 'estrellas');
}

// Compartir cap√≠tulo
function shareChapter() {
  if (navigator.share) {
    navigator.share({
      title: 'Mira este cap√≠tulo incre√≠ble',
      text: 'Te recomiendo leer este cap√≠tulo en BeaBoo',
      url: window.location.href
    });
  } else {
    // Fallback para navegadores que no soportan Web Share API
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
      alert('¬°Enlace copiado al portapapeles!');
    });
  }
}

// Event listener para el progreso de lectura
document.addEventListener('DOMContentLoaded', function() {
  const scrollContainer = document.querySelector('#chapter-read-modal .overflow-y-auto');
  if (scrollContainer) {
    scrollContainer.addEventListener('scroll', updateReadingProgress);
  }
});
</script>

<!-- Estilos adicionales para el lector moderno -->
<style>
/* Animaciones suaves para el lector */
#chapter-read-modal .prose {
  transition: all 0.3s ease;
}

/* Hover effects para las estrellas */
.star:hover {
  transform: scale(1.1);
  filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.5));
}

/* Animaci√≥n para el progreso de lectura */
#reading-progress {
  transition: width 0.3s ease;
}

/* Efectos de hover para botones */
button {
  transition: all 0.2s ease;
}

/* Scrollbar personalizado para tema claro */
.overflow-y-auto::-webkit-scrollbar {
  width: 6px;
}

.overflow-y-auto::-webkit-scrollbar-track {
  background: rgba(251, 191, 36, 0.1);
  border-radius: 3px;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
  background: linear-gradient(to bottom, #f59e0b, #f97316);
  border-radius: 3px;
}

.overflow-y-auto::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(to bottom, #d97706, #ea580c);
}

/* Animaci√≥n de entrada para el panel de configuraci√≥n */
#font-settings-panel {
  animation: slideInDown 0.3s ease;
}

@keyframes slideInDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<!-- MODAL DE DETALLE DE HISTORIA -->
<div id="story-detail-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-6 relative max-w-4xl mx-auto bg-white min-h-screen">

    <!-- Header con botones de volver y reportar -->
    <div class="flex justify-between items-center mb-6">
      <button onclick="closeStoryDetail()" class="text-[#FE2C55] flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        <span></span>
      </button>
      
      <!-- Bot√≥n de reportar historia -->
      <button onclick="openReportStoryModal()" class="text-red-500 flex items-center space-x-1 bg-red-50 hover:bg-red-100 px-3 py-2 rounded-lg transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span>Reportar</span>
      </button>
    </div>

    <!-- Secci√≥n principal: portada + t√≠tulo/autor -->
    <div class="flex items-start space-x-6 mb-8">
      <!-- Portada estilo Inkitt/Wattpad -->
      <img id="detail-cover" src="https://via.placeholder.com/400x600/cccccc/666666?text=Story+Cover" alt="Portada de la historia"
           class="w-40 sm:w-48 md:w-56 aspect-[2/3] object-cover rounded-2xl border-2 border-[#FE2C55] shadow-lg">
      
      <!-- Detalles de historia -->
      <div class="flex-1 flex flex-col">
        <h2 id="detail-title" class="text-2xl sm:text-3xl font-bold text-black mb-2">
          T√≠tulo de la historia
        </h2>
        <p id="detail-author"
           class="text-gray-600 mb-4 cursor-pointer hover:text-[#FE2C55] transition-colors duration-200"
           onclick="openAuthorProfile(this.dataset.userid)">
          Nombre del autor
        </p>
      </div>
    </div>

    <!-- Lista de cap√≠tulos -->
    <div class="w-full mb-8">
      <h3 class="text-lg font-bold mb-4 text-[#FE2C55]">Cap√≠tulos</h3>
      <ul id="detail-chapters" class="space-y-3">
        <!-- Los cap√≠tulos se cargar√°n desde Firebase -->
      </ul>
    </div>

    <!-- Sinopsis -->
    <div class="w-full mb-6">
      <h3 class="text-lg font-semibold mb-3 text-[#FE2C55]">Sinopsis</h3>
      <p id="detail-synopsis" class="text-gray-600 leading-relaxed">
        Sinopsis de la historia...
      </p>
    </div>

    <!-- M√©tricas estilizadas debajo de sinopsis -->
    <div id="detail-metrics" class="flex justify-center gap-4">
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">3</span>
        <p class="text-xs text-[#FE2C55] mt-1">Visitas</p>
      </div>
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">4.5</span>
        <p class="text-xs text-[#FE2C55] mt-1">Calificaci√≥n</p>
      </div>
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">12</span>
        <p class="text-xs text-[#FE2C55] mt-1">Cap√≠tulos</p>
      </div>
    </div>

  </div>
</div>

<!-- MODAL DE REPORTAR HISTORIA ESPEC√çFICO -->
<div id="report-story-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-[#FE2C55]">Reportar Historia</h2>
      <button onclick="closeReportStoryModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <p class="text-gray-600 mb-4">Selecciona el motivo del reporte:</p>
    
    <form id="report-story-form" class="space-y-3">
      <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
        <input type="radio" name="reportReason" value="contenido_inapropiado" class="text-[#FE2C55]" required>
        <div>
          <div class="font-medium">Contenido inapropiado</div>
          <div class="text-sm text-gray-500">Contenido sexual, violento o ofensivo</div>
        </div>
      </label>
      
      <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
        <input type="radio" name="reportReason" value="plagio" class="text-[#FE2C55]" required>
        <div>
          <div class="font-medium">Plagio</div>
          <div class="text-sm text-gray-500">La historia no es original del autor</div>
        </div>
      </label>
      
      <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
        <input type="radio" name="reportReason" value="spam" class="text-[#FE2C55]" required>
        <div>
          <div class="font-medium">Spam o enga√±o</div>
          <div class="text-sm text-gray-500">Contenido promocional no deseado</div>
        </div>
      </label>
      
      <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
        <input type="radio" name="reportReason" value="derechos_autor" class="text-[#FE2C55]" required>
        <div>
          <div class="font-medium">Infracci√≥n de derechos de autor</div>
          <div class="text-sm text-gray-500">Uso no autorizado de contenido protegido</div>
        </div>
      </label>
      
      <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
        <input type="radio" name="reportReason" value="otro" class="text-[#FE2C55]" required>
        <div>
          <div class="font-medium">Otro motivo</div>
          <div class="text-sm text-gray-500">Especifica en la descripci√≥n</div>
        </div>
      </label>
      
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n adicional (opcional):</label>
        <textarea id="report-story-description" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent resize-none" rows="3" placeholder="Proporciona m√°s detalles sobre el problema..."></textarea>
      </div>
      
      <div class="flex space-x-3 mt-6">
        <button type="button" onclick="closeReportStoryModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition-colors">
          Cancelar
        </button>
        <button type="submit" class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-colors">
          Enviar Reporte
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL DE PERSONAS BLOQUEADAS -->
<div id="blocked-users-modal" class="fixed inset-0 bg-white text-black overflow-y-auto z-50 hidden">
  <div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <button onclick="closeBlockedUsersModal()" class="text-[#FE2C55] flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        <span></span>
      </button>
      <h2 class="text-2xl font-bold text-[#FE2C55]">Personas Bloqueadas</h2>
      <div class="w-20"></div>
    </div>

    <!-- Lista de usuarios bloqueados -->
    <div id="blocked-users-list" class="space-y-4">
      <!-- Los usuarios bloqueados se cargar√°n aqu√≠ -->
    </div>

    <!-- Mensaje cuando no hay usuarios bloqueados -->
    <div id="no-blocked-users" class="hidden text-center py-12">
      <div class="text-gray-400 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-600 mb-2">No has bloqueado a nadie</h3>
      <p class="text-gray-500">Los usuarios que bloquees aparecer√°n aqu√≠</p>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN DE REPORTE ENVIADO -->
<div id="report-story-success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 text-center">
    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </div>
    <h2 class="text-xl font-bold text-gray-900 mb-2">¬°Reporte Enviado!</h2>
    <p class="text-gray-600 mb-6">Gracias por ayudarnos a mantener la comunidad segura. Revisaremos tu reporte pronto.</p>
    <button onclick="closeReportStorySuccessModal()" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg hover:bg-red-600 transition-colors">
      Continuar
    </button>
  </div>
</div>






<!-- MODAL DE PERFIL DEL AUTOR -->
<div id="author-profile-modal" class="fixed inset-0 bg-[#0a0f1a] bg-opacity-90 flex items-center justify-center z-50 hidden backdrop-blur-sm">
  <div class="bg-[#101730] dark:bg-[#0a0f1a] w-full h-full md:h-auto md:max-h-[90vh] md:max-w-2xl mx-auto rounded-t-2xl md:rounded-2xl md:my-8 overflow-y-auto shadow-2xl">
    <div class="sticky top-0 z-10 p-4 bg-[#101730]/80 dark:bg-[#0a0f1a]/80 backdrop-blur-md">
      <button onclick="closeAuthorProfile()" class="text-gray-400 dark:text-gray-300 hover:text-teal-400 dark:hover:text-teal-400 flex items-center gap-2 font-medium transition-colors duration-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span id="btn-volver-author"></span>
      </button>
    </div>

    <div class="p-6 pt-0 md:p-8" id="author-profile-content">
      <div class="flex flex-col items-center">
        <div id="author-profile-img-container" class="relative mb-4">
          <img id="author-profile-image" src="https://via.placeholder.com/150" class="w-28 h-28 rounded-full object-cover border-4 border-teal-900 dark:border-teal-900 shadow-md" alt="Foto del autor">
        </div>
        <h2 id="author-profile-name" class="text-2xl font-bold mb-2 text-gray-100 dark:text-gray-100"></h2>
        <p id="author-bio" class="text-center text-gray-400 dark:text-gray-400 mb-4 max-w-md"></p>

        <div id="author-social-links" class="flex space-x-4 mb-6"></div>

        

        <div class="w-full max-w-sm bg-[#1e2c4a] dark:bg-[#1e2c4a] rounded-lg p-4 mb-6">
          <div class="flex items-center justify-around w-full">
            <div class="flex-1 flex items-center justify-center">
              <button id="follow-button" onclick="followAuthor()" class="p-3 rounded-full bg-[#132040] dark:bg-[#132040] shadow hover:shadow-md transition-shadow duration-200" title="Seguir/Dejar de seguir">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-400 dark:text-teal-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
              </button>
            </div>
            <div class="w-px h-12 bg-[#283a5e] dark:bg-[#283a5e] mx-2"></div>
            <div class="flex-1 flex items-center justify-center">
              <button id="message-author-button" onclick="startConversationWithAuthor(currentViewedAuthorId)" class="p-3 rounded-full bg-blue-500 shadow hover:shadow-md transition-shadow duration-200" title="Enviar mensaje">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
              </button>
            </div>
            <div class="w-px h-12 bg-[#283a5e] dark:bg-[#283a5e] mx-2"></div>
            <div class="flex-1 flex items-center justify-center">
              <button id="block-button" onclick="blockAuthor()" class="mx-2 flex items-center bg-[#f9f9f9] text-[#FE2C55] px-4 py-2 rounded-lg border border-[#FE2C55] hover:bg-gray-100" title="Bloquear/Desbloquear">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 715.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                Bloquear
              </button>
              <button id="report-button" onclick="openReportModal()" class="p-3 rounded-full bg-[#132040] dark:bg-[#132040] shadow hover:shadow-md transition-shadow duration-200" title="Reportar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="flex w-full max-w-sm justify-around mb-6 bg-[#1e2c4a] dark:bg-[#1e2c4a] rounded-lg p-4">
          <div class="text-center">
            <button onclick="openFollowersModal()" class="focus:outline-none hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-200">
              <span id="author-followers" class="font-bold text-xl text-teal-400 dark:text-teal-400">0</span>
              <p class="text-sm text-gray-400 dark:text-gray-400">Seguidores</p>
            </button>
          </div>
          <div class="text-center">
            <button onclick="openFollowingModal()" class="focus:outline-none hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-200">
              <span id="author-following" class="font-bold text-xl text-teal-400 dark:text-teal-400">0</span>
              <p class="text-sm text-gray-400 dark:text-gray-400">Siguiendo</p>
            </button>
          </div>
          <div class="text-center">
            <span id="author-rated" class="font-bold text-xl text-teal-400 dark:text-teal-400">0</span>
            <p class="text-sm text-gray-400 dark:text-gray-400">Calificaciones</p>
          </div>
        </div>

        <div class="w-full">
          <h3 id="author-stories-title" class="text-xl font-bold mb-4 text-gray-100 dark:text-gray-100">Historias del autor</h3>
          <div id="author-stories" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--
  C√≥digo Completo de Transmisi√≥n en Vivo (Transmisor y Espectador)
  ----------------------------------------------------------------------------
  Funcionalidades:
    ‚Ä¢ Vista de transmisi√≥n en vivo para el transmisor y el espectador.
    ‚Ä¢ Panel de ajustes del transmisor se muestra a pantalla completa.
         - Opciones: Notificaciones, Mostrar estado, Comentarios, Filtro de contenido.
         - Detector de rostro (simulaci√≥n: se aplica un filtro de brillo/contraste para "aclarar" la imagen).
         - Opci√≥n para ocultar la barra de vistas.
    ‚Ä¢ Gestos swipe:
         - En la vista del transmisor: deslizar a la izquierda oculta todos los controles y a la derecha los muestra.
         - En la vista del espectador: deslizar a la izquierda oculta funciones (regalos, likes, etc.) y a la derecha las muestra.
    ‚Ä¢ Otras funcionalidades originales: env√≠o de corazones (taps), cuenta regresiva, reporte, gift drawer, etc.
    ‚Ä¢ En la vista del espectador se muestra el √≠cono de vistas proporcionado.
    ‚Ä¢ En el banner expandido se elimina el bot√≥n ‚ÄúActivar LIVE‚Äù y se reemplaza por una animaci√≥n infinita de ‚Äúhilos‚Äù subiendo.
    ‚Ä¢ En el Gift Drawer, algunos regalos se muestran en formato video (moderno) en lugar de solo GIF.
-->

<!-- VISTA DE TRANSMISI√ìN EN VIVO (Transmisor) - Estilo Twitter/X -->
<div id="live-stream-modal" class="fixed inset-0 bg-black z-50 hidden">
  <div class="relative w-full h-full">
    <!-- Header superior estilo Twitter -->
    <div class="absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/80 to-transparent p-4">
      <div class="flex items-center justify-between">
        <!-- Bot√≥n cerrar -->
        <button onclick="closeLiveStreamModal()" class="w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        
        <!-- Contador de vistas estilo Twitter -->
        <div id="live-viewCount" class="bg-black/70 backdrop-blur-sm px-4 py-2 rounded-full text-white font-medium flex items-center space-x-2">
          <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
          <span class="text-sm">0 visualizaciones</span>
        </div>
        
        <!-- Bot√≥n de ajustes -->
        <button id="live-settingsBtn" class="w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition-colors" onclick="openSettingsFullscreen()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Contador de interacciones -->
    <div id="live-tapCount" class="absolute top-20 right-4 z-20 bg-black/70 backdrop-blur-sm px-3 py-2 rounded-full text-white text-sm font-medium">
      0 ‚ù§Ô∏è
    </div>
    
    <!-- Video local -->
    <video id="live-localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
    
    <!-- Overlay con cuenta regresiva -->
    <div id="live-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/30">
      <div id="live-countdown" class="text-6xl font-bold text-white mb-4"></div>
      <div id="live-indicator" class="hidden"></div>
    </div>
    
    <!-- Bot√≥n de iniciar transmisi√≥n estilo Instagram -->
    <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent">
      <button id="live-startBtn" class="w-20 h-20 bg-gradient-to-br from-purple-500 via-pink-500 to-red-500 hover:from-purple-600 hover:via-pink-600 hover:to-red-600 text-white rounded-full transition-all duration-200 flex items-center justify-center shadow-xl mx-auto" onclick="startLiveStream()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
      </button>
    </div>

    <!-- Bot√≥n para finalizar transmisi√≥n (oculto inicialmente) -->
    <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent hidden" id="live-end-container">
      <button id="live-endBtn" class="w-full bg-red-500 hover:bg-red-600 text-white text-lg font-bold rounded-full py-4 transition-all duration-200 flex items-center justify-center space-x-3 shadow-xl" onclick="endLiveStream()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10l6 6m0-6l-6 6" />
        </svg>
        <span>Finalizar transmisi√≥n</span>
      </button>
    </div>
    <!-- Spinner -->
    <div id="live-spinner" class="absolute inset-0 flex items-center justify-center">
      <i class="fas fa-spinner fa-spin text-6xl" style="color:#00D6C9;"></i>
    </div>
  </div>
</div>
<!-- Modal de Bloqueo para Transmisi√≥n (por red y operador) -->
<div id="transmission-block-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" style="background: rgba(0,0,0,0.8);">
  <div class="bg-white p-6 rounded-xl text-center max-w-md mx-4">
    <!-- Spinner animado (usamos Font Awesome para el spinner) -->
    <div class="spinner mb-4">
      <i class="fas fa-spinner fa-spin fa-3x" style="color:#00D6C9;"></i>
    </div>
    <p class="text-lg font-bold mb-2">Funci√≥n no disponible</p>
    <p class="text-sm">
      Por motivos de privacidad, esta funci√≥n estar√° inhabilitada hasta nuevo aviso.<br><br>
      Estamos trabajando para resolver este asunto lo antes posible. Mientras tanto, puedes seguir usando las dem√°s funciones incre√≠bles de la plataforma.<br><br>
      ¬°Gracias por tu comprensi√≥n!
    </p>
  </div>
</div>

<!-- Estilos para el spinner -->
<style>
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>

<!-- Funciones y detecciones para bloqueos y ajustes de transmisi√≥n -->
<script>
  // Funci√≥n para detectar restricciones basadas en pa√≠s y operador
  function checkTransmissionAvailability() {
    return true;
  }
  // Funci√≥n para aplicar la vista "cinematogr√°fica" (YouTube) al video
  function setLiveStreamYouTubeView() {
    const video = document.getElementById('live-localVideo');
    if (video) {
      // Se muestra el video completo sin recortes (similar a letterboxing)
      video.style.objectFit = 'contain';
      video.style.width = '100vw';
      video.style.height = 'auto';
      // Se puede ajustar el contenedor para que tenga fondo negro
      const container = video.parentElement;
      if (container) {
        container.style.backgroundColor = 'black';
        container.style.display = 'flex';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';
      }
    }
  }
  // Funci√≥n duplicada eliminada - se mantiene la versi√≥n completa m√°s adelante
</script>

<!-- MODAL DE VISUALIZACI√ìN EN VIVO (Espectador) - Estilo Twitter/X -->
<div id="live-view-modal" class="fixed inset-0 z-50 hidden bg-black">
  <div class="live-container relative w-full h-full bg-black" id="liveContainer">
    <!-- Top Bar estilo Twitter/X -->
    <div class="absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/80 to-transparent p-4">
      <div class="flex items-center justify-between">
        <!-- Bot√≥n volver -->
        <button onclick="closeLiveViewModal()" class="w-10 h-10 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </button>
        
        <!-- Info del streamer -->
        <div class="flex items-center space-x-3">
          <div class="flex items-center bg-black/70 backdrop-blur-sm px-4 py-2 rounded-full">
            <img id="streamerProfileImage" src="https://via.placeholder.com/150" alt="Streamer" class="w-8 h-8 rounded-full object-cover mr-3">
            <div>
              <p id="streamerName" class="text-white font-bold text-sm">Broadcast Name</p>
              <div class="flex items-center space-x-1">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-red-400 text-xs font-medium">EN VIVO</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Contador de vistas estilo Twitter -->
        <div class="bg-black/70 backdrop-blur-sm px-4 py-2 rounded-full text-white font-medium flex items-center space-x-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <span id="viewerCountLive" class="text-sm">0</span>
        </div>
      </div>
    </div>

    <!-- Banner promocional peque√±o (estilo TikTok) -->
    <div id="promo-banner" class="absolute bottom-24 left-4 right-4 bg-black/30 backdrop-blur-sm rounded-lg p-2 flex items-center cursor-pointer" onclick="expandPromoBanner()">
      <div class="flex-shrink-0 mr-2">
        <i class="fas fa-broadcast-tower" style="color: #00D6C9; font-size: 20px;"></i>
      </div>
      <div class="flex-grow">
        <p class="text-white text-sm">Descubre funciones LIVE exclusivas</p>
      </div>
      <div class="flex-shrink-0">
        <i class="fas fa-chevron-up text-white"></i>
      </div>
    </div>

    <!-- Banner expandido -->
    <div id="expanded-banner" class="fixed inset-x-0 bottom-0 h-1/2 bg-black/80 backdrop-blur-md z-60 rounded-t-xl transition-transform duration-300 transform translate-y-full">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-[#00D6C9] text-xl font-bold">Funciones LIVE</h3>
          <button onclick="closeExpandedBanner()" class="text-white">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-white/10 p-3 rounded-lg">
            <i class="fas fa-heart text-pink-500 text-2xl mb-2"></i>
            <h4 class="text-white font-medium mb-1">Doble tap</h4>
            <p class="text-gray-300 text-sm">Toca dos veces para enviar corazones</p>
          </div>
          <div class="bg-white/10 p-3 rounded-lg">
            <i class="fas fa-gift text-[#00D6C9] text-2xl mb-2"></i>
            <h4 class="text-white font-medium mb-1">Regalos</h4>
            <p class="text-gray-300 text-sm">Env√≠a regalos y sorprende al creador</p>
          </div>
          <div class="bg-white/10 p-3 rounded-lg">
            <i class="fas fa-star text-yellow-500 text-2xl mb-2"></i>
            <h4 class="text-white font-medium mb-1">Monetizaci√≥n</h4>
            <p class="text-gray-300 text-sm">Gana por tus transmisiones</p>
          </div>
          <div class="bg-white/10 p-3 rounded-lg">
            <i class="fas fa-users text-blue-500 text-2xl mb-2"></i>
            <h4 class="text-white font-medium mb-1">Comunidad</h4>
            <p class="text-gray-300 text-sm">Conecta con tus seguidores en vivo</p>
          </div>
        </div>
        <!-- Animaci√≥n moderna de hilos subiendo de forma infinita -->
        <div id="animated-lines">
          <div class="line" style="left: 10%; animation-delay: 0s;"></div>
          <div class="line" style="left: 30%; animation-delay: 0.5s;"></div>
          <div class="line" style="left: 50%; animation-delay: 1s;"></div>
          <div class="line" style="left: 70%; animation-delay: 1.5s;"></div>
          <div class="line" style="left: 90%; animation-delay: 2s;"></div>
        </div>
      </div>
    </div>

    <!-- Contador de taps/corazones para el espectador -->
    <div id="viewer-tapCount" class="absolute top-16 right-4 text-lg bg-black/30 backdrop-blur-sm px-3 py-1 rounded-full text-[#00D6C9]">
      0 ‚ù§Ô∏è
    </div>

    <!-- Video Element -->
    <video id="live-remoteVideo" autoplay playsinline class="w-full h-full object-cover" ondblclick="handleDoubleTap(event)"></video>

    <!-- Contenedor para corazones animados -->
    <div id="hearts-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>

    <!-- Botones laterales estilo Twitter/X para espectador -->
    <div class="side-buttons absolute bottom-24 right-4 flex flex-col items-center space-y-4">
      <!-- Bot√≥n de regalo -->
      <div class="side-button flex flex-col items-center">
        <button class="w-14 h-14 bg-black/40 backdrop-blur-sm border border-white/20 rounded-full flex items-center justify-center hover:bg-purple-500/20 hover:border-purple-500/50 transition-all duration-200 group" id="giftButtonViewer" onclick="openGiftDrawer()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white group-hover:text-purple-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
          </svg>
        </button>
        <span class="text-white text-xs mt-1 font-medium">Regalar</span>
      </div>
      
      <!-- Bot√≥n de compartir -->
      <div class="side-button flex flex-col items-center">
        <button class="w-14 h-14 bg-black/40 backdrop-blur-sm border border-white/20 rounded-full flex items-center justify-center hover:bg-blue-500/20 hover:border-blue-500/50 transition-all duration-200 group" onclick="shareStream()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white group-hover:text-blue-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
          </svg>
        </button>
        <span class="text-white text-xs mt-1 font-medium">Compartir</span>
      </div>
      
      <!-- Bot√≥n de reportar -->
      <div class="side-button flex flex-col items-center">
        <button class="w-14 h-14 bg-black/40 backdrop-blur-sm border border-white/20 rounded-full flex items-center justify-center hover:bg-red-500/20 hover:border-red-500/50 transition-all duration-200 group" id="reportButtonViewer" onclick="showReportModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white group-hover:text-red-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
          </svg>
        </button>
        <span class="text-white text-xs mt-1 font-medium">Reportar</span>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE GIFT DRAWER - Estilo Twitter/X -->
<div id="gift-drawer" class="bg-black/95 backdrop-blur-lg border-t border-white/10">
  <div class="gift-container">
    <!-- Header moderno con saldo -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold text-white">Enviar Regalo</h2>
        <div class="flex items-center mt-2 bg-yellow-500/20 px-3 py-1 rounded-full">
          <span class="text-yellow-400 mr-1">ü™ô</span>
          <span id="gift-drawer-balance" class="text-yellow-400 font-bold">0</span>
          <span class="text-yellow-300 text-sm ml-1">monedas disponibles</span>
        </div>
      </div>
      <button onclick="closeGiftDrawer()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center text-white/70 hover:text-white hover:bg-white/20 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <!-- Grid de regalos estilo TikTok compacto -->
    <div class="gift-grid grid grid-cols-6 gap-2 mb-4">
      <!-- √çtems de regalo estilo TikTok -->
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('cupido', 25)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://i.pinimg.com/originals/2d/f8/97/2df897364f655a0b14070a9e2f95d602.gif" alt="Cupido" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Cupido</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô25</span>
        </div>
      </div>
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('diamante', 100)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://i.pinimg.com/originals/79/a5/49/79a54992591652b1595c6c61c49170fb.gif" alt="Diamante" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Diamante</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô100</span>
        </div>
      </div>
      
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('oso_beaboo', 15)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://www.icegif.com/wp-content/uploads/2021/11/icegif-346.gif" alt="oso Beaboo" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Oso BeaBoo</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô15</span>
        </div>
      </div>
      
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('oso_saltarin', 20)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://www.icegif.com/wp-content/uploads/2021/11/icegif-347.gif" alt="oso saltar√≠n" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Oso Saltar√≠n</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô20</span>
        </div>
      </div>
      
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('besboos_carinosos', 35)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://i.pinimg.com/originals/3b/d4/d9/3bd4d9778b5e0a11ab141cb7b545ab10.gif" alt="Besboos cari√±osos" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Amor</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô35</span>
        </div>
      </div>
      
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('besboos_leyendo', 30)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://i.pinimg.com/originals/c6/41/ba/c641babc376ffe10f65ee472a646c6e1.gif" alt="besboos leyendo" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Lectura</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô30</span>
        </div>
      </div>
      
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('arcoiris', 45)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://i.pinimg.com/originals/17/9c/e7/179ce7068a3c543261505ea69398b714.gif" alt="Arcoiris" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Arco√≠ris</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô45</span>
        </div>
      </div>
      
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('Love_Max', 50)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://i.pinimg.com/originals/28/89/15/28891591a6c88725b46c3e9774c3aefc.gif" alt="Love Max" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Love Max</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô50</span>
        </div>
      </div>
      
      <div class="gift-item bg-white/10 rounded-lg p-2 hover:bg-white/20 transition-all cursor-pointer" onclick="sendGift('galaxia', 75)">
        <div class="aspect-square rounded-md overflow-hidden mb-1 flex items-center justify-center">
          <img src="https://64.media.tumblr.com/632f8d471cdef6eb0a5018d125ce6475/tumblr_mv4rb608vh1s5jjtzo1_400.gif" alt="Galaxia" class="w-8 h-8 object-cover rounded">
        </div>
        <span class="text-white text-xs text-center block">Galaxia</span>
        <div class="flex items-center justify-center mt-1">
          <span class="text-yellow-400 text-xs">ü™ô75</span>
        </div>
      </div>
    </div>
    
    <!-- Bot√≥n de cancelar modernizado -->
    <div class="mt-6 flex space-x-3">
      <button onclick="closeGiftDrawer()" class="flex-1 bg-white/10 border border-white/20 text-white py-3 rounded-xl hover:bg-white/20 transition-all font-medium">
        Cancelar
      </button>
      <button class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all font-medium">
        Ver M√°s Regalos
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE REPORTE (Estilo TikTok) -->
<div id="report-modal" class="fixed inset-0 bg-black/50 flex items-end justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="w-full max-w-lg bg-white rounded-t-2xl p-6 transform translate-y-full transition-transform duration-300 ease-out">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-[#FE2C55] text-xl font-bold">Reportar transmisi√≥n</h3>
      <button onclick="closeReportModal()" class="text-gray-400 hover:text-[#FE2C55] transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <p class="text-gray-600 mb-4">Selecciona el motivo del reporte:</p>
    <div class="space-y-3 mb-6">
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-sexual" class="mr-3 accent-[#FE2C55]">
        <label for="reason-sexual" class="text-gray-800">Contenido sexual</label>
      </div>
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-violence" class="mr-3 accent-[#FE2C55]">
        <label for="reason-violence" class="text-gray-800">Violencia o acoso</label>
      </div>
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-spam" class="mr-3 accent-[#FE2C55]">
        <label for="reason-spam" class="text-gray-800">Spam o enga√±o</label>
      </div>
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-rights" class="mr-3 accent-[#FE2C55]">
        <label for="reason-rights" class="text-gray-800">Infracci√≥n de derechos</label>
      </div>
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-other" class="mr-3 accent-[#FE2C55]">
        <label for="reason-other" class="text-gray-800">Otro motivo</label>
      </div>
    </div>
    <button onclick="submitReport()" class="w-full bg-[#FE2C55] hover:bg-[#ef2950] text-white py-4 rounded-full font-medium transition-colors shadow-lg">
      Enviar reporte
    </button>
  </div>
</div>

<!-- ANIMACI√ìN DE REPORTE ENVIADO -->
<div id="report-success" class="fixed inset-0 bg-black/70 backdrop-blur-md z-70 hidden flex items-center justify-center">
  <div class="text-center">
    <div class="verification-animation">
      <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
      </svg>
    </div>
    <h3 class="text-white text-xl font-bold mt-4">¬°Reporte enviado!</h3>
    <p class="text-gray-300 mt-2">Gracias por ayudarnos a mantener la comunidad segura</p>
    <button onclick="closeReportSuccess()" class="mt-6 bg-gradient-to-r from-[#00D6C9] to-[#00A0B0] text-white py-2 px-6 rounded-full font-medium">
      Continuar
    </button>
  </div>
</div>

<!-- CONTENEDOR PARA LA ANIMACI√ìN DEL REGALO -->
<div id="gift-animation"></div>

<!-- INPUTS ocultos para video pregrabado y audio -->
<input type="file" id="live-video-input" accept="video/*" class="hidden" onchange="handleLiveVideoUpload(event)">
<input type="file" id="live-audio-es" accept="audio/*" class="hidden">
<input type="file" id="live-audio-en" accept="audio/*" class="hidden">

<!-- PANEL DE AJUSTES A PANTALLA COMPLETA -->
<div id="settings-fullscreen" class="fixed inset-0 bg-black/80 z-50 hidden">
  <div class="w-full h-full flex flex-col">
    <!-- Encabezado -->
    <header class="p-4 bg-gradient-to-r from-[#00D6C9] to-[#00A0B0] flex justify-between items-center">
      <h2 class="text-white text-xl">Ajustes de Transmisi√≥n</h2>
      <button onclick="closeSettingsFullscreen()" class="text-white text-2xl">&times;</button>
    </header>
    <!-- Contenido de ajustes -->
    <div class="flex-1 overflow-y-auto p-4 bg-[#171F30]">
      <!-- Opciones originales -->
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <span class="text-white">Notificaciones</span>
          <label class="switch">
            <input type="checkbox" id="notifications-toggle" checked>
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white">Mostrar estado</span>
          <label class="switch">
            <input type="checkbox" id="status-toggle" checked>
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white">Comentarios</span>
          <label class="switch">
            <input type="checkbox" id="comments-toggle" checked>
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white">Filtro de contenido</span>
          <label class="switch">
            <input type="checkbox" id="filter-toggle">
            <span class="slider round"></span>
          </label>
        </div>
        <!-- Nuevas opciones de ajustes -->
        <div class="flex items-center justify-between">
          <span class="text-white">Detector de rostro (efecto belleza)</span>
          <label class="switch">
            <input type="checkbox" id="face-detection-toggle">
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white">Ocultar barra de vistas</span>
          <label class="switch">
            <input type="checkbox" id="hide-viewbar-toggle">
            <span class="slider round"></span>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estilos adicionales -->
<style>
  /* Estilos para los botones laterales */
  .side-buttons {
    z-index: 20;
  }

  /* Estilo para el gift drawer modernizado (abrir desde abajo) */
  #gift-drawer {
    position: fixed;
    bottom: -100%;
    left: 0;
    right: 0;
    height: 75%;
    z-index: 60;
    border-radius: 24px 24px 0 0;
    padding: 24px;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    overflow-y: auto;
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
  }

  #gift-drawer.open {
    bottom: 0;
    transform: translateY(0);
  }

  #gift-drawer::-webkit-scrollbar {
    width: 6px;
  }

  #gift-drawer::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
  }

  #gift-drawer::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
  }

  #gift-drawer::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }

  /* Estilo para corazones animados */
  .heart {
    position: absolute;
    font-size: 25px;
    color: #00D6C9;
    animation: float-up 2s ease-out forwards;
    opacity: 0.8;
    z-index: 10;
    pointer-events: none;
  }

  @keyframes float-up {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0.8;
    }

    100% {
      transform: translateY(-100px) scale(1.5);
      opacity: 0;
    }
  }

  /* Estilo para switch toggle */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
  }

  input:checked+.slider {
    background-color: #00D6C9;
  }

  input:focus+.slider {
    box-shadow: 0 0 1px #00D6C9;
  }

  input:checked+.slider:before {
    transform: translateX(26px);
  }

  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }

  /* Animaci√≥n de verificaci√≥n */
  .verification-animation {
    display: inline-block;
    margin: 0 auto;
  }

  .checkmark {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: #00D6C9;
    stroke-miterlimit: 10;
    box-shadow: inset 0px 0px 0px #00D6C9;
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
  }

  .checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #00D6C9;
    fill: none;
    animation: stroke .6s cubic-bezier(0.650, 0.000, 0.450, 1.000) forwards;
  }

  .checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke .3s cubic-bezier(0.650, 0.000, 0.450, 1.000) .8s forwards;
  }

  @keyframes stroke {
    100% {
      stroke-dashoffset: 0;
    }
  }

  @keyframes scale {

    0%,
    100% {
      transform: none;
    }

    50% {
      transform: scale3d(1.1, 1.1, 1);
    }
  }

  @keyframes fill {
    100% {
      box-shadow: inset 0px 0px 0px 30px #00D6C9;
    }
  }

  /* Animaci√≥n de hilos subiendo en el banner expandido */
  #animated-lines {
    position: relative;
    width: 100%;
    height: 50px;
    overflow: hidden;
    margin-top: 20px;
  }

  .line {
    position: absolute;
    width: 2px;
    height: 100%;
    background: linear-gradient(to top, transparent, #00D6C9);
    animation: rise 3s linear infinite;
    opacity: 0.7;
  }

  @keyframes rise {
    0% {
      top: 100%;
      opacity: 0;
    }

    50% {
      opacity: 1;
    }

    100% {
      top: -50px;
      opacity: 0;
    }
  }
</style>

<!-- JavaScript: Funcionalidades y Gestos -->
<script>
  // FUNCI√ìN PARA CARGAR FOTOS DE COMUNIDAD
  function loadPhotos() {
    const photosFeed = document.getElementById('photos-feed');
    const photosContainer = photosFeed.querySelector('.grid');
    photosContainer.innerHTML = '';

    firebase.database().ref('communityNotes').orderByChild('timestamp').once('value').then(snapshot => {
      const photos = [];
      snapshot.forEach(child => {
        const note = child.val();
        if (note.imageUrl) {
          photos.push(note);
        }
      });

      photos.reverse().forEach(photo => {
        const photoCard = document.createElement('div');
        photoCard.className = 'relative aspect-square cursor-pointer';
        photoCard.innerHTML = `
          <img src="${photo.imageUrl}" alt="" class="w-full h-full object-cover">
          <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2">
            <div class="flex items-center">
              <img src="${photo.authorImage}" alt="${photo.authorName}" class="w-6 h-6 rounded-full mr-2">
              <span class="text-white text-sm truncate">${photo.authorName}</span>
            </div>
          </div>
        `;
        photoCard.onclick = () => {
          openPhotoDetail(photo);
        };
        photosContainer.appendChild(photoCard);
      });
    });
  }

  function openPhotoDetail(photo) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="max-w-2xl w-full bg-white rounded-xl overflow-hidden">
        <img src="${photo.imageUrl}" alt="" class="w-full h-auto">
        <div class="p-4">
          <div class="flex items-center mb-4">
            <img src="${photo.authorImage}" alt="${photo.authorName}" class="w-8 h-8 rounded-full mr-2">
            <span class="font-bold">${photo.authorName}</span>
          </div>
          ${photo.content ? `<p class="text-gray-700">${photo.content}</p>` : ''}
          <div class="mt-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <button onclick="likePhoto('${photo.id}')" class="flex items-center text-gray-600">
                <i class="fas fa-heart mr-1"></i>
                <span>${photo.likes || 0}</span>
              </button>
            </div>
            <span class="text-gray-500 text-sm">${new Date(photo.timestamp).toLocaleDateString()}</span>
          </div>
        </div>
      </div>
      <button onclick="this.parentElement.remove()" class="absolute top-4 right-4 text-white text-xl">
        <i class="fas fa-times"></i>
      </button>
    `;
    document.body.appendChild(modal);
  }

  // VARIABLES GLOBALES PARA TIENDA
  let currentBookDetail = null;
  let userGiftInventory = [];

  // FUNCIONES DE LA TIENDA
  // Funci√≥n openStore() ya implementada arriba con modal de pantalla completa - BeaBoo 2.0

  function closeStore() {
    document.getElementById('store-view').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
  }

  function updateStoreCoinsBalance(userId) {
    firebase.database().ref('users/' + userId + '/coins').on('value', snapshot => {
      const coins = snapshot.val() || 0;
      document.getElementById('store-coins-balance').textContent = coins;
      
      // Tambi√©n actualizar el saldo en el gift drawer
      const giftDrawerBalance = document.getElementById('gift-drawer-balance');
      if (giftDrawerBalance) {
        giftDrawerBalance.textContent = coins;
      }
    });
  }

  function switchStoreCategory(category) {
    // Ocultar todas las categor√≠as
    document.querySelectorAll('.store-category-content').forEach(content => {
      content.classList.add('hidden');
    });
    
    // Mostrar la categor√≠a seleccionada
    document.getElementById('store-' + category).classList.remove('hidden');
    
    // Actualizar botones
    document.querySelectorAll('.store-category-btn').forEach(btn => {
      btn.classList.remove('bg-[#FE2C55]', 'text-white');
      btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    event.target.classList.remove('bg-gray-200', 'text-gray-700');
    event.target.classList.add('bg-[#FE2C55]', 'text-white');
  }

  function buyStoreItem(itemId, cost, itemType) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Verificar saldo
    firebase.database().ref('users/' + user.uid + '/coins').once('value').then(snapshot => {
      const currentCoins = snapshot.val() || 0;
      
      if (currentCoins < cost) {
        alert(`No tienes suficientes monedas. Necesitas ${cost} monedas pero solo tienes ${currentCoins}.`);
        return;
      }

      // Procesar compra
      if (confirm(`¬øConfirmar compra de ${itemId} por ${cost} monedas?`)) {
        processPurchase(user.uid, itemId, cost, itemType);
      }
    });
  }

  function processPurchase(userId, itemId, cost, itemType) {
    const updates = {};
    updates[`/users/${userId}/coins`] = firebase.database.ServerValue.increment(-cost);
    
    if (itemType === 'frame') {
      updates[`/users/${userId}/purchasedFrames/${itemId}`] = {
        purchaseDate: Date.now(),
        cost: cost
      };
      // Aplicar el marco autom√°ticamente
      updates[`/users/${userId}/profileFrame`] = itemId;
    } else if (itemType === 'gift') {
      updates[`/users/${userId}/giftInventory/${itemId}`] = firebase.database.ServerValue.increment(1);
    }

    firebase.database().ref().update(updates).then(() => {
      addCoinHistory(userId, -cost, `Comprar ${itemType}: ${itemId}`);
      
      let message = '';
      if (itemType === 'frame') {
        message = `Marco "${itemId}" comprado y aplicado correctamente`;
      } else if (itemType === 'gift') {
        message = `Regalo "${itemId}" agregado a tu inventario`;
        loadUserGiftInventory(userId);
      }
      
      showPurchaseConfirmation(message);
      updateStoreCoinsBalance(userId);
    }).catch(error => {
      console.error('Error al procesar compra:', error);
      alert('Error al procesar la compra. Por favor intenta de nuevo.');
    });
  }

  function loadExclusiveBooks() {
    firebase.database().ref('stories').orderByChild('views').once('value').then(snapshot => {
      const exclusiveBooks = [];
      
      snapshot.forEach(child => {
        const story = child.val();
        story.id = child.key;
        
        // Marcar como exclusivo si tiene m√°s de 300K vistas
        if (story.views >= 300000) {
          story.isExclusive = true;
          story.price = Math.ceil(story.views / 10000); // Precio basado en popularidad
          exclusiveBooks.push(story);
        }
      });
      
      const booksGrid = document.getElementById('exclusive-books-grid');
      booksGrid.innerHTML = '';
      
      if (exclusiveBooks.length === 0) {
        booksGrid.innerHTML = `
          <div class="text-center py-12">
            <div class="text-gray-400 mb-4">
              <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-600 mb-2">No hay libros exclusivos disponibles</h3>
            <p class="text-gray-500">Los libros con m√°s de 300K lecturas aparecer√°n aqu√≠</p>
          </div>
        `;
        return;
      }
      
      exclusiveBooks.forEach(book => {
        const bookCard = document.createElement('div');
        bookCard.className = 'bg-white rounded-xl shadow-sm border p-4 cursor-pointer hover:shadow-md transition-shadow';
        bookCard.onclick = () => openBookDetail(book);
        
        bookCard.innerHTML = `
          <div class="flex space-x-4">
            <div class="relative">
              <img src="${book.coverImage || 'https://via.placeholder.com/300x400/cccccc/666666?text=Book+Cover'}" alt="${book.title}" class="w-16 h-24 object-cover rounded-lg">
              <div class="absolute -top-2 -right-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                EXCLUSIVO
              </div>
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-1">${book.title}</h3>
              <p class="text-gray-600 text-sm mb-2">Por ${book.authorName || 'Autor desconocido'}</p>
              <p class="text-gray-500 text-xs mb-3">${formatNumber(book.views)} lecturas</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center bg-yellow-100 px-2 py-1 rounded-full">
                  <span class="text-yellow-600 font-bold">ü™ô ${book.price}</span>
                </div>
                <span class="text-xs text-gray-500">Editorial BeaBoo</span>
              </div>
            </div>
          </div>
        `;
        
        booksGrid.appendChild(bookCard);
      });
    });
  }

  function openBookDetail(book) {
    currentBookDetail = book;
    
    document.getElementById('book-detail-title').textContent = book.title;
    document.getElementById('book-detail-cover').src = book.coverImage || 'https://via.placeholder.com/300x400/cccccc/666666?text=Book+Cover';
    document.getElementById('book-detail-author').textContent = `Por ${book.authorName || 'Autor desconocido'}`;
    document.getElementById('book-detail-synopsis').textContent = book.synopsis || 'Sin descripci√≥n disponible';
    document.getElementById('book-detail-views').textContent = `${formatNumber(book.views)} lecturas`;
    document.getElementById('book-detail-rating').textContent = `‚≠ê ${book.ratingValue || 'Sin calificar'}`;
    document.getElementById('book-detail-price').textContent = `ü™ô ${book.price} monedas`;
    
    document.getElementById('book-detail-modal').classList.remove('hidden');
  }

  function closeBookDetail() {
    document.getElementById('book-detail-modal').classList.add('hidden');
    currentBookDetail = null;
  }

  function purchaseExclusiveBook() {
    if (!currentBookDetail) return;
    
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Verificar saldo
    firebase.database().ref('users/' + user.uid + '/coins').once('value').then(snapshot => {
      const currentCoins = snapshot.val() || 0;
      
      if (currentCoins < currentBookDetail.price) {
        alert(`No tienes suficientes monedas. Necesitas ${currentBookDetail.price} monedas pero solo tienes ${currentCoins}.`);
        return;
      }

      // Procesar compra
      const updates = {};
      updates[`/users/${user.uid}/coins`] = firebase.database.ServerValue.increment(-currentBookDetail.price);
      updates[`/users/${user.uid}/purchasedBooks/${currentBookDetail.id}`] = {
        purchaseDate: Date.now(),
        price: currentBookDetail.price,
        title: currentBookDetail.title
      };

      firebase.database().ref().update(updates).then(() => {
        addCoinHistory(user.uid, -currentBookDetail.price, `Comprar libro: ${currentBookDetail.title}`);
        closeBookDetail();
        showPurchaseConfirmation(`¬°Has comprado "${currentBookDetail.title}"! Ya puedes leer todos los cap√≠tulos.`);
        updateStoreCoinsBalance(user.uid);
      });
    });
  }

  function purchaseCoins(amount, price) {
    // Simular compra de monedas (aqu√≠ integrar√≠as con un procesador de pagos real)
    if (confirm(`¬øConfirmar compra de ${amount} monedas por $${price}?`)) {
      const user = firebase.auth().currentUser;
      if (!user) return;

      // Simular procesamiento de pago exitoso
      setTimeout(() => {
        const updates = {};
        updates[`/users/${user.uid}/coins`] = firebase.database.ServerValue.increment(amount);
        
        firebase.database().ref().update(updates).then(() => {
          addCoinHistory(user.uid, amount, `Compra de monedas - $${price}`);
          showPurchaseConfirmation(`¬°Compra exitosa! Se agregaron ${amount} monedas a tu cuenta.`);
          updateStoreCoinsBalance(user.uid);
        });
      }, 2000);

      // Mostrar loading
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[70]';
      loadingDiv.innerHTML = `
        <div class="bg-white rounded-xl p-6 text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-[#FE2C55] mx-auto mb-4"></div>
          <p>Procesando pago...</p>
        </div>
      `;
      document.body.appendChild(loadingDiv);
      
      setTimeout(() => {
        loadingDiv.remove();
      }, 2000);
    }
  }

  function showPurchaseConfirmation(message) {
    document.getElementById('purchase-message').textContent = message;
    document.getElementById('purchase-confirmation-modal').classList.remove('hidden');
  }

  function closePurchaseConfirmation() {
    document.getElementById('purchase-confirmation-modal').classList.add('hidden');
  }

  function loadUserGiftInventory(userId) {
    firebase.database().ref('users/' + userId + '/giftInventory').on('value', snapshot => {
      userGiftInventory = snapshot.val() || {};
      updateGiftDrawerWithInventory();
    });
  }

  function updateGiftDrawerWithInventory() {
    // Esta funci√≥n actualizar√° el gift drawer para mostrar solo los regalos que el usuario tiene
    // Se llamar√° cuando se abra el gift drawer
  }

  // FUNCIONES MODIFICADAS PARA TRANSMISIONES EN VIVO
  function sendGift(giftName, cost = 0) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Verificar si el usuario tiene el regalo en su inventario
    if (!userGiftInventory[giftName] || userGiftInventory[giftName] <= 0) {
      alert('No tienes este regalo en tu inventario. Ve a la tienda para comprarlo.');
      openStore();
      switchStoreCategory('gifts');
      return;
    }

    // Usar el regalo del inventario
    firebase.database().ref('users/' + user.uid + '/giftInventory/' + giftName).transaction(currentAmount => {
      return Math.max(0, (currentAmount || 0) - 1);
    }).then(() => {
      // Mostrar animaci√≥n de regalo enviado
      showGiftAnimation(giftName, cost);
      
      // Simular env√≠o al transmisor
      console.log(`Regalo ${giftName} enviado desde inventario`);
      
      // Cerrar drawer
      closeGiftDrawer();
      
      // Actualizar inventario
      loadUserGiftInventory(user.uid);
    });
  }

  // FUNCIONES PARA USUARIOS BLOQUEADOS
  function openBlockedUsersModal() {
    document.getElementById('blocked-users-modal').classList.remove('hidden');
    loadBlockedUsers();
  }

  function closeBlockedUsersModal() {
    document.getElementById('blocked-users-modal').classList.add('hidden');
  }

  function loadBlockedUsers() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const blockedUsersList = document.getElementById('blocked-users-list');
    const noBlockedUsers = document.getElementById('no-blocked-users');

    firebase.database().ref('blockedUsers/' + user.uid).once('value').then(snapshot => {
      blockedUsersList.innerHTML = '';

      if (!snapshot.exists()) {
        blockedUsersList.classList.add('hidden');
        noBlockedUsers.classList.remove('hidden');
        return;
      }

      blockedUsersList.classList.remove('hidden');
      noBlockedUsers.classList.add('hidden');

      const promises = [];
      snapshot.forEach(child => {
        const blockedUserId = child.key;
        const blockedData = child.val();
        
        const promise = firebase.database().ref('users/' + blockedUserId).once('value').then(userSnapshot => {
          const userData = userSnapshot.val();
          if (userData) {
            const userElement = document.createElement('div');
            userElement.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
            userElement.innerHTML = `
              <div class="flex items-center space-x-3">
                <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" alt="${userData.username}" class="w-12 h-12 rounded-full object-cover">
                <div>
                  <h3 class="font-bold text-gray-900">${userData.username}</h3>
                  <p class="text-sm text-gray-500">Bloqueado el ${new Date(blockedData.blockedAt).toLocaleDateString()}</p>
                </div>
              </div>
              <button onclick="unblockUser('${blockedUserId}')" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                Desbloquear
              </button>
            `;
            blockedUsersList.appendChild(userElement);
          }
        });
        promises.push(promise);
      });

      Promise.all(promises).catch(error => {
        console.error('Error al cargar usuarios bloqueados:', error);
      });
    });
  }

  function blockUser(userId) {
    const user = firebase.auth().currentUser;
    if (!user || user.uid === userId) return;

    if (confirm('¬øEst√°s seguro de que quieres bloquear a este usuario? No podr√°s ver su contenido ni historias.')) {
      const updates = {};
      updates[`/blockedUsers/${user.uid}/${userId}`] = {
        blockedAt: Date.now()
      };
      updates[`/blockedBy/${userId}/${user.uid}`] = {
        blockedAt: Date.now()
      };

      firebase.database().ref().update(updates).then(() => {
        alert('Usuario bloqueado correctamente');
        
        // Actualizar UI si estamos en el perfil del autor
        const blockButton = document.getElementById('block-button');
        if (blockButton) {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Desbloqueado
          `;
          blockButton.onclick = () => unblockUser(userId);
        }

        // Recargar contenido para ocultar historias del usuario bloqueado
        if (typeof loadHomeContent === 'function') {
          loadHomeContent();
        }
        
        closeAuthorProfile();
      }).catch(error => {
        console.error('Error al bloquear usuario:', error);
        alert('Error al bloquear usuario. Por favor intenta de nuevo.');
      });
    }
  }

  function unblockUser(userId) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    if (confirm('¬øEst√°s seguro de que quieres desbloquear a este usuario?')) {
      const updates = {};
      updates[`/blockedUsers/${user.uid}/${userId}`] = null;
      updates[`/blockedBy/${userId}/${user.uid}`] = null;

      firebase.database().ref().update(updates).then(() => {
        alert('Usuario desbloqueado correctamente');
        
        // Actualizar UI si estamos en el perfil del autor
        const blockButton = document.getElementById('block-button');
        if (blockButton) {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 715.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
            Bloquear
          `;
          blockButton.onclick = () => blockUser(userId);
        }

        // Recargar lista si estamos en el modal de bloqueados
        if (!document.getElementById('blocked-users-modal').classList.contains('hidden')) {
          loadBlockedUsers();
        }

        // Recargar contenido para mostrar historias del usuario desbloqueado
        if (typeof loadHomeContent === 'function') {
          loadHomeContent();
        }
      }).catch(error => {
        console.error('Error al desbloquear usuario:', error);
        alert('Error al desbloquear usuario. Por favor intenta de nuevo.');
      });
    }
  }

  function isUserBlocked(userId) {
    return new Promise((resolve) => {
      const user = firebase.auth().currentUser;
      if (!user) {
        resolve(false);
        return;
      }

      firebase.database().ref('blockedUsers/' + user.uid + '/' + userId).once('value').then(snapshot => {
        resolve(snapshot.exists());
      }).catch(() => {
        resolve(false);
      });
    });
  }

  // Funci√≥n para filtrar contenido de usuarios bloqueados
  function filterBlockedContent(stories) {
    const user = firebase.auth().currentUser;
    if (!user) return Promise.resolve(stories);

    return firebase.database().ref('blockedUsers/' + user.uid).once('value').then(snapshot => {
      if (!snapshot.exists()) return stories;

      const blockedUserIds = Object.keys(snapshot.val());
      return stories.filter(story => !blockedUserIds.includes(story.userId));
    });
  }

  // FUNCIONES PARA REPORTAR HISTORIAS
  let currentStoryForReport = null;

  function openReportStoryModal() {
    document.getElementById('report-story-modal').classList.remove('hidden');
  }

  function closeReportStoryModal() {
    document.getElementById('report-story-modal').classList.add('hidden');
    // Limpiar formulario
    document.getElementById('report-story-form').reset();
    document.getElementById('report-story-description').value = '';
  }

  function closeReportStorySuccessModal() {
    document.getElementById('report-story-success-modal').classList.add('hidden');
  }

  // Manejar env√≠o del formulario de reporte
  document.addEventListener('DOMContentLoaded', function() {
    const reportForm = document.getElementById('report-story-form');
    if (reportForm) {
      reportForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitStoryReport();
      });
    }
  });

  function submitStoryReport() {
    const form = document.getElementById('report-story-form');
    const formData = new FormData(form);
    const reason = formData.get('reportReason');
    const description = document.getElementById('report-story-description').value.trim();
    const user = firebase.auth().currentUser;

    if (!user) {
      alert('Debes iniciar sesi√≥n para reportar una historia.');
      return;
    }

    if (!reason) {
      alert('Por favor selecciona un motivo para el reporte.');
      return;
    }

    // Crear el reporte en Firebase
    const reportData = {
      reporterId: user.uid,
      reporterEmail: user.email,
      storyId: currentStoryForReport?.id || 'unknown',
      storyTitle: currentStoryForReport?.title || 'T√≠tulo desconocido',
      storyAuthorId: currentStoryForReport?.userId || 'unknown',
      reason: reason,
      description: description,
      timestamp: Date.now(),
      status: 'pending'
    };

    firebase.database().ref('storyReports').push(reportData)
      .then(() => {
        closeReportStoryModal();
        document.getElementById('report-story-success-modal').classList.remove('hidden');
        
        // Enviar notificaci√≥n a los administradores (opcional)
        sendReportNotificationToAdmins(reportData);
      })
      .catch(error => {
        console.error('Error al enviar reporte:', error);
        alert('Error al enviar el reporte. Por favor intenta de nuevo.');
      });
  }

  function sendReportNotificationToAdmins(reportData) {
    // Lista de administradores (puedes cambiar estos IDs)
    const adminEmails = ['darelvega6@icloud.com', 'glamworksappstv@gmail.com'];
    
    // Aqu√≠ podr√≠as implementar notificaciones a administradores
    console.log('Reporte enviado para revisi√≥n:', reportData);
  }

  

  // FUNCIONES DE MARCOS ANIMADOS
  function openFrameSelector() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Actualizar display de monedas - usar listener en tiempo real
    firebase.database().ref('users/' + user.uid + '/coins').on('value', snapshot => {
      const coins = snapshot.val() || 0;
      const frameCoinsElement = document.getElementById('frame-selector-coins');
      if (frameCoinsElement) {
        frameCoinsElement.textContent = coins;
      }
    });

    document.getElementById('frame-selector-modal').classList.remove('hidden');
  }

  function closeFrameSelector() {
    document.getElementById('frame-selector-modal').classList.add('hidden');
    
    // Limpiar listener espec√≠fico del selector de marcos
    const user = firebase.auth().currentUser;
    if (user) {
      firebase.database().ref('users/' + user.uid + '/coins').off();
      // Reactivar el listener principal
      updateCoinDisplay(user.uid);
    }
  }

  function selectFrame(frameType, cost = 0) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Si es gratis (sin marco), aplicar directamente
    if (cost === 0) {
      applyFrame(frameType, cost);
      return;
    }

    // Verificar si ya tiene el marco
    firebase.database().ref('users/' + user.uid + '/purchasedFrames/' + frameType).once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Ya tiene el marco, aplicar directamente
        applyFrame(frameType, 0);
      } else {
        // Verificar monedas y proceder con la compra
        firebase.database().ref('users/' + user.uid + '/coins').once('value').then(coinsSnapshot => {
          const currentCoins = coinsSnapshot.val() || 0;
          
          if (currentCoins < cost) {
            alert(`No tienes suficientes monedas. Necesitas ${cost} monedas pero solo tienes ${currentCoins}.`);
            return;
          }

          // Confirmar compra
          if (confirm(`¬øQuieres comprar el marco "${frameType}" por ${cost} monedas?`)) {
            purchaseFrame(frameType, cost);
          }
        });
      }
    });
  }

  function applyFrame(frameType, cost) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Mostrar loading
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]';
    loadingDiv.innerHTML = `
      <div class="bg-white p-6 rounded-xl text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-[#FE2C55] mx-auto mb-4"></div>
        <p>${cost > 0 ? 'Comprando y aplicando marco...' : 'Aplicando marco...'}</p>
      </div>
    `;
    document.body.appendChild(loadingDiv);

    const profileFrame = document.getElementById('profile-frame');
    
    // Limpiar clases anteriores
    if (profileFrame) {
      profileFrame.className = 'absolute inset-0 rounded-full pointer-events-none z-10';
      
      if (frameType === 'none') {
        profileFrame.style.display = 'none';
      } else {
        profileFrame.style.display = 'block';
        profileFrame.classList.add(frameType);
      }
    }

    // Guardar en Firebase para que otros usuarios lo vean
    firebase.database().ref('users/' + user.uid).update({
      profileFrame: frameType
    }).then(() => {
      // Verificar que el marco se guard√≥ correctamente
      return firebase.database().ref('users/' + user.uid + '/profileFrame').once('value');
    }).then((snapshot) => {
      loadingDiv.remove();
      closeFrameSelector();
      
      // Mostrar notificaci√≥n de √©xito mejorada
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
      notification.innerHTML = `
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        ${frameType === 'none' ? 'Marco removido correctamente' : 
          cost > 0 ? `Marco "${frameType}" comprado y aplicado correctamente` : 'Marco aplicado - Otros usuarios podr√°n verlo'}
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -20px)';
        notification.style.transition = 'all 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }).catch((error) => {
      loadingDiv.remove();
      console.error('Error al aplicar marco:', error);
      alert('Error al aplicar el marco. Por favor intenta de nuevo.');
    });
  }

  function purchaseFrame(frameType, cost) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Deducir monedas y marcar como comprado
    const updates = {};
    updates[`/users/${user.uid}/coins`] = firebase.database.ServerValue.increment(-cost);
    updates[`/users/${user.uid}/purchasedFrames/${frameType}`] = {
      purchaseDate: Date.now(),
      cost: cost
    };

    firebase.database().ref().update(updates).then(() => {
      // Agregar al historial de monedas
      addCoinHistory(user.uid, -cost, `Comprar marco: ${frameType}`);
      
      // Aplicar el marco
      applyFrame(frameType, cost);
      
      // Actualizar display de monedas
      updateCoinDisplay(user.uid);
    }).catch(error => {
      console.error('Error al comprar marco:', error);
      alert('Error al procesar la compra. Por favor intenta de nuevo.');
    });
  }

  function showFrameHistory() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('users/' + user.uid + '/purchasedFrames').once('value').then(snapshot => {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      
      let framesHTML = '';
      if (snapshot.exists()) {
        snapshot.forEach(child => {
          const frameData = child.val();
          const frameName = child.key;
          framesHTML += `
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
              <div>
                <span class="font-bold capitalize">${frameName}</span>
                <p class="text-sm text-gray-600">Comprado: ${new Date(frameData.purchaseDate).toLocaleDateString()}</p>
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-yellow-600 font-bold">ü™ô ${frameData.cost}</span>
                <button onclick="applyFrame('${frameName}', 0); this.closest('.fixed').remove();" class="bg-[#FE2C55] text-white px-3 py-1 rounded text-sm">
                  Usar
                </button>
              </div>
            </div>
          `;
        });
      } else {
        framesHTML = '<p class="text-center text-gray-500">No has comprado ning√∫n marco a√∫n</p>';
      }

      modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Marcos Comprados</h2>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div>${framesHTML}</div>
        </div>
      `;
      
      document.body.appendChild(modal);
    });
  }

  function loadUserFrame(userId, targetElementId) {
    firebase.database().ref('users/' + userId + '/profileFrame').on('value', snapshot => {
      const frameType = snapshot.val();
      const profileFrame = document.getElementById(targetElementId);
      
      if (profileFrame) {
        // Limpiar todas las clases de marcos anteriores
        profileFrame.className = 'absolute inset-0 rounded-full pointer-events-none z-10';
        
        if (frameType && frameType !== 'none') {
          profileFrame.classList.add(frameType);
          profileFrame.style.display = 'block';
          console.log(`Marco ${frameType} aplicado para usuario ${userId}`);
        } else {
          profileFrame.style.display = 'none';
        }
      }
    });
  }

  // Funci√≥n para cargar estad√≠sticas del perfil en tiempo real
  // DETECTOR AUTOM√ÅTICO DE HISTORIAS POPULARES
  function checkAndMarkExclusiveStories() {
    firebase.database().ref('stories').on('value', snapshot => {
      const updates = {};
      
      snapshot.forEach(child => {
        const story = child.val();
        const storyId = child.key;
        
        // Marcar como exclusiva si tiene m√°s de 300K vistas y no est√° ya marcada
        if (story.views >= 300000 && !story.isExclusive) {
          updates[`/stories/${storyId}/isExclusive`] = true;
          updates[`/stories/${storyId}/exclusivePrice`] = Math.ceil(story.views / 10000);
          updates[`/stories/${storyId}/exclusiveDate`] = Date.now();
          
          // Notificar al autor
          if (story.userId) {
            addNotification(story.userId, 
              `¬°Felicidades! Tu historia "${story.title}" ahora es exclusiva en BeaBoo Shop por alcanzar ${formatNumber(story.views)} lecturas.`, 
              'exclusive'
            );
          }
        }
        
        // Quitar exclusividad si las vistas bajan de 300K (caso raro pero posible)
        if (story.views < 300000 && story.isExclusive) {
          updates[`/stories/${storyId}/isExclusive`] = false;
          updates[`/stories/${storyId}/exclusivePrice`] = null;
        }
      });
      
      // Aplicar actualizaciones si hay cambios
      if (Object.keys(updates).length > 0) {
        firebase.database().ref().update(updates);
      }
    });
  }

  // Ejecutar detector cada 5 minutos
  setInterval(checkAndMarkExclusiveStories, 5 * 60 * 1000);

  // Ejecutar al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkAndMarkExclusiveStories, 3000);
  });

  function loadUserStats(userId) {
    // Contador de historias publicadas
    firebase.database().ref('stories').orderByChild('userId').equalTo(userId).on('value', storiesSnapshot => {
      const storiesCount = storiesSnapshot.numChildren();
      
      // Actualizar en m√≥vil
      const profileStoriesTitle = document.getElementById('profile-stories-title');
      if (profileStoriesTitle) {
        profileStoriesTitle.textContent = `${storiesCount} Historias`;
      }
      
      // Actualizar en desktop
      const profileStoriesHeader = document.getElementById('profile-stories-header');
      const sidebarStoriesCount = document.getElementById('sidebar-stories-count');
      const profileStoriesCountDesktop = document.getElementById('profile-stories-count-desktop');
      
      if (profileStoriesHeader) {
        profileStoriesHeader.textContent = `${storiesCount} Historias`;
      }
      if (sidebarStoriesCount) {
        sidebarStoriesCount.textContent = storiesCount;
      }
      if (profileStoriesCountDesktop) {
        profileStoriesCountDesktop.textContent = storiesCount;
      }
      
      // Cargar las historias en el grid
      loadUserStoriesGrid(userId, storiesSnapshot);
    });

    // Total de lecturas (vistas de todas las historias)
    firebase.database().ref('stories').orderByChild('userId').equalTo(userId).on('value', storiesSnapshot => {
      let totalViews = 0;
      storiesSnapshot.forEach(storyChild => {
        const story = storyChild.val();
        totalViews += story.views || 0;
      });
      
      const sidebarTotalViews = document.getElementById('sidebar-total-views');
      if (sidebarTotalViews) {
        sidebarTotalViews.textContent = totalViews;
      }
    });

    // Seguidores en tiempo real
    firebase.database().ref('users/' + userId + '/followersCount').on('value', snapshot => {
      const followersCount = snapshot.val() || 0;
      
      // Actualizar en desktop
      const sidebarFollowersCount = document.getElementById('sidebar-followers-count');
      if (sidebarFollowersCount) {
        sidebarFollowersCount.textContent = followersCount;
      }
    });
  }

  // Funci√≥n para cargar las historias del usuario en el grid
  function loadUserStoriesGrid(userId, storiesSnapshot) {
    const userStoriesDesktop = document.getElementById('user-stories-desktop');
    const userStoriesMobile = document.getElementById('user-stories');
    
    if (userStoriesDesktop) {
      userStoriesDesktop.innerHTML = '';
    }
    if (userStoriesMobile) {
      userStoriesMobile.innerHTML = '';
    }
    
    if (!storiesSnapshot.exists()) {
      // Mostrar mensaje cuando no hay historias
      const noStoriesMessage = `
        <div class="col-span-full text-center py-12">
          <div class="text-gray-400 mb-4">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-600 mb-2">No tienes historias a√∫n</h3>
          <p class="text-gray-500 mb-4">Crea tu primera historia para comenzar</p>
          <button onclick="openStoryCreation()" class="bg-[#FE2C55] text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
            Crear primera historia
          </button>
        </div>
      `;
      
      if (userStoriesDesktop) {
        userStoriesDesktop.innerHTML = noStoriesMessage;
      }
      if (userStoriesMobile) {
        userStoriesMobile.innerHTML = noStoriesMessage;
      }
      return;
    }

    // Cargar historias existentes
    storiesSnapshot.forEach(child => {
      const story = child.val();
      story.id = child.key;
      
      const storyCard = createStoryCard(story, userId);
      
      if (userStoriesDesktop) {
        userStoriesDesktop.appendChild(storyCard.cloneNode(true));
      }
      if (userStoriesMobile) {
        userStoriesMobile.appendChild(storyCard);
      }
    });
  }

  // Funci√≥n para crear una tarjeta de historia
  function createStoryCard(story, userId) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow-sm border hover:shadow-md transition-shadow cursor-pointer';
    
    const currentUser = firebase.auth().currentUser;
    const isOwner = currentUser && currentUser.uid === userId;
    
    card.innerHTML = `
      <div class="aspect-[3/4] relative">
        <img src="${story.coverImage || 'https://via.placeholder.com/300x400/cccccc/666666?text=Book+Cover'}" 
             alt="${story.title}" 
             class="w-full h-full object-cover rounded-t-xl">
        <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded-full text-xs">
          ${story.views || 0} vistas
        </div>
        ${isOwner ? `
          <div class="absolute top-2 left-2 flex space-x-1">
            <button onclick="openStoryEdit(${JSON.stringify(story).replace(/"/g, '&quot;')})" 
                    class="bg-blue-500 text-white p-1 rounded-full hover:bg-blue-600 transition-colors"
                    title="Editar historia">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
          </div>
        ` : ''}
      </div>
      <div class="p-4">
        <h3 class="font-semibold text-gray-900 mb-1 line-clamp-1">${story.title}</h3>
        <p class="text-sm text-gray-600 mb-2 line-clamp-2">${story.synopsis || 'Sin descripci√≥n'}</p>
        <div class="flex items-center justify-between">
          <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
            ${story.category || 'Sin categor√≠a'}
          </span>
          <button onclick="openStoryDetail(${JSON.stringify(story).replace(/"/g, '&quot;')})" 
                  class="text-[#FE2C55] text-sm font-medium hover:text-red-600 transition-colors">
            Leer ‚Üí
          </button>
        </div>
      </div>
    `;
    
    return card;
  }

  // FUNCIONES DEL CREATOR HUB
  function openCreatorHub() {
    document.getElementById('creator-hub-view').classList.remove('hidden');
    mainApp.classList.add('hidden');
    loadCreatorStats();
  }

  function closeCreatorHub() {
    document.getElementById('creator-hub-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }

  function openNoteCreation() {
    // Abrir la comunidad pero directamente en el tab de agregar nota
    closeCreatorHub();
    document.getElementById('community-view').classList.remove('hidden');
    switchCommunityTab('add');
  }

  function loadCreatorStats() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Cargar estad√≠sticas de historias
    firebase.database().ref('stories').orderByChild('userId').equalTo(user.uid).once('value').then(snapshot => {
      document.getElementById('creator-stories-count').textContent = snapshot.numChildren();
    });

    // Cargar estad√≠sticas de notas
    firebase.database().ref('communityNotes').orderByChild('authorId').equalTo(user.uid).once('value').then(snapshot => {
      document.getElementById('creator-notes-count').textContent = snapshot.numChildren();
    });
  }

  // FUNCIONES DE COMUNIDAD
  function openCommunity() {
    document.getElementById('community-view').classList.remove('hidden');
    mainApp.classList.add('hidden');
    loadNotes();
  }

  function closeCommunity() {
    document.getElementById('community-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }

  function switchCommunityTab(tab) {
    const feedTab = document.getElementById('feed-tab');
    const photosTab = document.getElementById('photos-tab');
    const notesFeed = document.getElementById('notes-feed');
    const photosFeed = document.getElementById('photos-feed');
    const addNoteForm = document.getElementById('add-note-form');

    if (tab === 'feed') {
      feedTab.classList.add('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      photosTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      notesFeed.classList.remove('hidden');
      photosFeed.classList.add('hidden');
      if (addNoteForm) addNoteForm.classList.add('hidden');
      loadNotes();
    } else if (tab === 'photos') {
      photosTab.classList.add('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      feedTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      photosFeed.classList.remove('hidden');
      notesFeed.classList.add('hidden');
      if (addNoteForm) addNoteForm.classList.add('hidden');
      loadPhotos();
    } else if (tab === 'add') {
      // Mostrar formulario de agregar nota (accesible desde Creator Hub)
      feedTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      photosTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      notesFeed.classList.add('hidden');
      photosFeed.classList.add('hidden');
      if (addNoteForm) addNoteForm.classList.remove('hidden');
    }
  }

  function handleNoteImagePreview(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview-img').src = e.target.result;
      document.getElementById('image-preview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }

  function removeImage() {
    document.getElementById('note-image').value = '';
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('preview-img').src = '';
  }

  function publishNote() {
    const content = document.getElementById('note-content').value.trim();
    const imageInput = document.getElementById('note-image');
    
    if (!content && !imageInput.files.length) {
      alert('Por favor escribe algo o agrega una imagen');
      return;
    }

    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n para publicar notas');
      return;
    }

    // Mostrar indicador de carga
    const publishButton = document.querySelector('button[onclick="publishNote()"]');
    publishButton.disabled = true;
    publishButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';

    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val();
      const note = {
        content: content,
        authorId: user.uid,
        authorName: userData.username || 'Usuario',
        authorImage: userData.profileImage || 'https://via.placeholder.com/150',
        timestamp: Date.now(),
        likes: 0
      };

      if (imageInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = function(e) {
          note.imageUrl = e.target.result;
          firebase.database().ref('communityNotes').push(note).then(() => {
            document.getElementById('note-content').value = '';
            imageInput.value = '';
            document.getElementById('image-preview').classList.add('hidden');
            switchCommunityTab('feed');
            publishButton.disabled = false;
            publishButton.innerHTML = 'Publicar Nota';
            alert('¬°Nota publicada con √©xito!');
          }).catch(error => {
            console.error('Error al publicar:', error);
            alert('Error al publicar la nota. Por favor intenta de nuevo.');
            publishButton.disabled = false;
            publishButton.innerHTML = 'Publicar Nota';
          });
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        firebase.database().ref('communityNotes').push(note).then(() => {
          document.getElementById('note-content').value = '';
          switchCommunityTab('feed');
          publishButton.disabled = false;
          publishButton.innerHTML = 'Publicar Nota';
          
          // GANAR MONEDAS POR PUBLICAR NOTA EN COMUNIDAD
          earnCoinsForCommunityNote(user.uid);
          
          alert('¬°Nota publicada con √©xito!');
        }).catch(error => {
          console.error('Error al publicar:', error);
          alert('Error al publicar la nota. Por favor intenta de nuevo.');
          publishButton.disabled = false;
          publishButton.innerHTML = 'Publicar Nota';
        });
      }
    });
  }

  function publishNoteToDatabase(note) {
    // Verifica el contenido de la nota espec√≠ficamente
    if (moderarContenidoNota(note.content)) {
      alert('Tu nota no puede ser publicada porque contiene contenido inapropiado.');
      return;
    }
    
    // Verificar l√≠mites antes de publicar
    // Verificaci√≥n de l√≠mites deshabilitada
    
    incrementUsage('writes', 1);
    firebase.database().ref('communityNotes').push(note).then((ref) => {
      // Verifica una vez m√°s despu√©s de publicar (por si acaso)
      moderarContenidoAutomaticamente(ref.key, note.content);
      
      document.getElementById('note-content').value = '';
      document.getElementById('note-image').value = '';
      document.getElementById('image-preview').classList.add('hidden');
      switchCommunityTab('feed');
    });
  }

  function loadNotes() {
    const feedContainer = document.getElementById('notes-feed');
    
    firebase.database().ref('communityNotes').orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
      // Limpiar completamente el contenedor antes de agregar nuevas notas
      feedContainer.innerHTML = '';
      
      const notes = [];
      snapshot.forEach(child => {
        notes.unshift({...child.val(), id: child.key});
      });

      notes.forEach(note => {
        const noteElement = document.createElement('div');
        noteElement.className = 'bg-white p-4 rounded-xl shadow';
        noteElement.innerHTML = `
          <div class="flex items-center mb-3">
            <img src="${note.authorImage}" alt="${note.authorName}" class="w-10 h-10 rounded-full mr-3">
            <div>
              <h3 class="font-bold">${note.authorName}</h3>
              <p class="text-sm text-gray-500">${new Date(note.timestamp).toLocaleString()}</p>
            </div>
          </div>
          <p class="mb-3">${note.content}</p>
          ${note.imageUrl ? `<img src="${note.imageUrl}" alt="Imagen de la nota" class="w-full rounded-lg mb-3 max-h-96 object-cover">` : ''}
          <div class="flex items-center space-x-4">
            <button id="like-btn-${note.id}" onclick="likeNote('${note.id}')" class="flex items-center text-[#FE2C55] hover:text-red-600 transition-colors">
              <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
              </svg>
              <span id="like-count-${note.id}">${note.likes || 0}</span>
            </button>
            ${note.authorId === firebase.auth().currentUser?.uid ? 
              `<button onclick="deleteNote('${note.id}')" class="text-red-500 hover:text-red-700">
                <i class="fas fa-trash"></i> Eliminar
              </button>` : 
              `<button onclick="reportNote('${note.id}')" class="text-gray-500 hover:text-gray-700 flex items-center">
                <i class="fas fa-flag mr-1"></i> Reportar
              </button>`
            }
          </div>
        `;
        
        // Verificar si el usuario ya dio like a esta nota
        const user = firebase.auth().currentUser;
        if (user) {
          firebase.database().ref('userLikes/' + user.uid + '/' + note.id).once('value').then(likeSnapshot => {
            const likeBtn = document.getElementById(`like-btn-${note.id}`);
            if (likeSnapshot.exists() && likeBtn) {
              likeBtn.style.opacity = '0.6';
              likeBtn.style.pointerEvents = 'none';
              likeBtn.title = 'Ya diste like a esta nota';
            }
          });
        }
        feedContainer.appendChild(noteElement);
      });
    });
  }

  function moderarContenidoNota(texto) {
  const palabrasProhibidasNotas = [
    // Insultos y lenguaje ofensivo
    "idiota", "est√∫pido", "imb√©cil", "tonto", "pendejo",
    "maldito", "puta", "mierda", "carajo", "joder",
    "perra", "zorra", "maric√≥n", "puto", "cabr√≥n",
    // Discriminaci√≥n
    "negro", "sudaca", "indio", "gitano", "judio",
    // Contenido inapropiado
    "xxx", "porn", "sex", "desnudo",
    // Violencia
    "matar", "muerte", "suicidio", "sangre",
    // Spam y estafas
    "ganar dinero", "hazte rico", "click aqu√≠",
    // Enlaces maliciosos
    "bit.ly", "acortar.link", "short.io"
  ];
  
  const textoNormalizado = texto.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z\s]/g, ''); // Elimina caracteres especiales
    
  // Busca palabras completas, no partes de palabras
  const palabras = textoNormalizado.split(/\s+/);
  return palabras.some(palabra => 
    palabrasOfensivas.includes(palabra) ||
    palabrasOfensivas.some(palabraOfensiva => 
      palabra.includes(palabraOfensiva) && palabra.length < palabraOfensiva.length + 3
    )
  );
}

function moderarContenidoAutomaticamente(noteId, content) {
  if (contienePalabrasOfensivas(content)) {
    firebase.database().ref('communityNotes/' + noteId).remove()
      .then(() => {
        console.log('Nota eliminada por contener lenguaje ofensivo');
        alert('Tu nota ha sido eliminada por contener lenguaje inapropiado.');
      });
    return true;
  }
  return false;
}

function contieneContenidoInapropiado(texto) {
  const patronesInapropiados = [
    /\b(?:porn|xxx)\b/i,
    /\b(?:kill|murder)\b/i,
    /\b(?:suicide|death)\b/i,
    /\b(?:cocaine|heroin|drugs)\b/i,
    /\b(?:terrorist|bomb)\b/i
  ];
  
  return patronesInapropiados.some(patron => patron.test(texto));
}

function moderarNota(noteId, content) {
  const loadingDiv = document.createElement('div');
  loadingDiv.innerHTML = `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-[#FE2C55] mx-auto mb-4"></div>
        <p>Analizando contenido...</p>
      </div>
    </div>
  `;
  document.body.appendChild(loadingDiv);

  setTimeout(() => {
    document.body.removeChild(loadingDiv);
    
    if (contienePalabrasOfensivas(content)) {
      firebase.database().ref('communityNotes/' + noteId).remove();
      alert('La nota ha sido eliminada por contener lenguaje ofensivo.');
    } else if (contieneContenidoInapropiado(content)) {
      firebase.database().ref('communityNotes/' + noteId).update({
        blocked: true,
        blockReason: 'Contenido inapropiado detectado'
      });
      alert('La nota ha sido bloqueada por posible contenido inapropiado.');
    }
  }, 5000);
}

function deleteNote(noteId) {
  if (!confirm('¬øEst√°s seguro de que quieres eliminar esta nota?')) return;
  
  firebase.database().ref('communityNotes/' + noteId).remove()
    .then(() => {
      alert('Nota eliminada correctamente');
    })
    .catch(error => {
      console.error('Error al eliminar la nota:', error);
      alert('Error al eliminar la nota');
    });
}

function reportNote(noteId) {
  const noteRef = firebase.database().ref('communityNotes/' + noteId);
  noteRef.once('value').then(snapshot => {
    const note = snapshot.val();
    if (note) {
      moderarNota(noteId, note.content);
    }
  });
}

function likeNote(noteId) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const userLikeRef = firebase.database().ref('userLikes/' + user.uid + '/' + noteId);
    
    userLikeRef.once('value').then(snapshot => {
      if (!snapshot.exists()) {
        // Marcar que el usuario ya dio like
        userLikeRef.set(true);
        
        // Incrementar el contador de likes
        const noteRef = firebase.database().ref('communityNotes/' + noteId);
        noteRef.transaction(note => {
          if (note) {
            note.likes = (note.likes || 0) + 1;
          }
          return note;
        });

        // GANAR MONEDAS POR DAR LIKE A NOTA
        earnCoinsForLikingNote(user.uid, noteId);

        // Obtener informaci√≥n de la nota para notificar al autor
        noteRef.once('value').then(noteSnapshot => {
          const noteData = noteSnapshot.val();
          if (noteData && noteData.authorId !== user.uid) {
            // Solo notificar si no es el propio autor
            firebase.database().ref('users/' + user.uid).once('value').then(userSnap => {
              const userData = userSnap.val();
              const userName = userData.username || 'Alguien';
              addNotification(noteData.authorId, `${userName} le dio like a tu nota en la comunidad`, 'like');
            });
          }
        });
      } else {
        // El usuario ya dio like, mostrar mensaje
        console.log('Ya has dado like a esta nota');
      }
    });
}

  // VARIABLES GLOBALES (OPTIMIZADAS)
  let tapCount = 0,
    lastTap = 0,
    heartCount = 0;
  let touchstartX = 0,
    touchendX = 0;
  // Sistema de gesti√≥n de efectos DOM (PREVIENE SATURACI√ìN)
  let activeHearts = [];
  const MAX_HEARTS = 20; // L√≠mite m√°ximo de corazones en pantalla
  
  // -------------------------------
  // Funciones para Corazones (Taps) - OPTIMIZADAS
  // -------------------------------
  function handleDoubleTap(event) {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    if (tapLength < 300 && tapLength > 0) {
      createHeartOptimized(event.clientX, event.clientY);
      incrementHeartCount();
      lastTap = 0;
    } else {
      lastTap = currentTime;
    }
  }

  function createHeartOptimized(x, y) {
    // Limpiar corazones viejos si hay demasiados (PREVIENE SATURACI√ìN)
    if (activeHearts.length >= MAX_HEARTS) {
      const oldestHeart = activeHearts.shift();
      if (oldestHeart && oldestHeart.parentNode) {
        oldestHeart.remove();
      }
    }
    
    const heart = document.createElement('div');
    heart.classList.add('heart');
    heart.style.cssText = `
      position: fixed;
      left: ${x - 12}px;
      top: ${y - 12}px;
      pointer-events: none;
      z-index: 1000;
      animation: heartFloat 2s ease-out forwards;
    `;
    heart.innerHTML = '‚ù§Ô∏è';
    
    const container = document.getElementById('hearts-container');
    if (container) {
      container.appendChild(heart);
      activeHearts.push(heart);
      
      // Remover despu√©s de animaci√≥n
      setTimeout(() => {
        if (heart.parentNode) {
          heart.remove();
          const index = activeHearts.indexOf(heart);
          if (index > -1) activeHearts.splice(index, 1);
        }
      }, 2000);
    }
  }
  
  // Mantener compatibilidad con c√≥digo existente
  function createHeart(x, y) {
    createHeartOptimized(x, y);
  }

  function incrementHeartCount() {
    heartCount++;
    document.getElementById('live-tapCount').textContent = heartCount + " ‚ù§Ô∏è";
    document.getElementById('viewer-tapCount').textContent = heartCount + " ‚ù§Ô∏è";
    document.getElementById('likeCountLiveViewer').textContent = heartCount;
  }

  function sendHeart() {
    const video = document.getElementById('live-remoteVideo');
    const rect = video.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top + rect.height / 2;
    createHeart(x, y);
    incrementHeartCount();
  }
  // -------------------------------
  // Funciones de Ajustes y Modales
  // -------------------------------
  function openSettingsFullscreen() {
    document.getElementById("settings-fullscreen").classList.remove("hidden");
  }

  function closeSettingsFullscreen() {
    document.getElementById("settings-fullscreen").classList.add("hidden");
  }

  function closeLiveStreamModal() {
    // Detener la transmisi√≥n si est√° activa
    const video = document.getElementById('live-localVideo');
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
    
    // Resetear la interfaz
    document.getElementById('live-startBtn').classList.remove('hidden');
    document.getElementById('live-endBtn').classList.add('hidden');
    document.getElementById('live-indicator').classList.add('hidden');
    document.getElementById('live-overlay').classList.remove('hidden');
    
    // Cerrar modal
    document.getElementById('live-stream-modal').classList.add('hidden');
  }

  function closeLiveViewModal() {
    document.getElementById('live-view-modal').classList.add('hidden');
  }

  function expandPromoBanner() {
    document.getElementById('expanded-banner').classList.remove('translate-y-full');
  }

  function closeExpandedBanner() {
    document.getElementById('expanded-banner').classList.add('translate-y-full');
  }

  function openGiftDrawer() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    // Cargar saldo de monedas en tiempo real
    updateStoreCoinsBalance(user.uid);
    
    // Verificar si tiene regalos en inventario
    firebase.database().ref('users/' + user.uid + '/giftInventory').once('value').then(snapshot => {
      const inventory = snapshot.val() || {};
      const hasGifts = Object.values(inventory).some(amount => amount > 0);
      
      if (!hasGifts) {
        // Si no tiene regalos, mostrar mensaje y redirigir a tienda
        if (confirm('No tienes regalos en tu inventario. ¬øQuieres ir a la tienda para comprar regalos?')) {
          closeGiftDrawer();
          openStore();
          switchStoreCategory('gifts');
          return;
        }
      }
      
      // Actualizar gift drawer con inventario disponible
      updateGiftDrawerDisplay(inventory);
      document.getElementById('gift-drawer').classList.add('open');
    });
  }

  function updateGiftDrawerDisplay(inventory) {
    const giftGrid = document.querySelector('#gift-drawer .gift-grid');
    if (!giftGrid) return;
    
    // Obtener todos los elementos de regalo
    const giftItems = giftGrid.querySelectorAll('.gift-item');
    
    giftItems.forEach(item => {
      const giftName = item.getAttribute('onclick')?.match(/sendGift\('([^']+)'/)?.[1];
      if (giftName) {
        const amount = inventory[giftName] || 0;
        
        // Agregar contador de cantidad
        let quantityBadge = item.querySelector('.quantity-badge');
        if (!quantityBadge) {
          quantityBadge = document.createElement('div');
          quantityBadge.className = 'quantity-badge absolute -top-2 -right-2 bg-[#FE2C55] text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold';
          item.style.position = 'relative';
          item.appendChild(quantityBadge);
        }
        
        quantityBadge.textContent = amount;
        
        // Deshabilitar si no tiene cantidad
        if (amount <= 0) {
          item.style.opacity = '0.5';
          item.style.pointerEvents = 'none';
          quantityBadge.style.backgroundColor = '#gray';
        } else {
          item.style.opacity = '1';
          item.style.pointerEvents = 'auto';
          quantityBadge.style.backgroundColor = '#FE2C55';
        }
      }
    });
  }

  function sendGift(giftName, cost = 0) {
    // Mostrar animaci√≥n de regalo enviado
    showGiftAnimation(giftName, cost);
    
    // Simular env√≠o al transmisor
    console.log(`Regalo ${giftName} enviado por ${cost} monedas`);
    
    // Cerrar drawer
    closeGiftDrawer();
  }

  function showGiftAnimation(giftName, cost) {
    const giftAnimation = document.getElementById('gift-animation');
    giftAnimation.innerHTML = `
      <div class="gift-strong bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl p-6 text-center">
        <div class="text-4xl mb-2">üéÅ</div>
        <div class="text-xl font-bold">${giftName}</div>
        <div class="text-sm opacity-90">${cost} monedas enviadas</div>
      </div>
    `;
    giftAnimation.classList.add('show');
    
    setTimeout(() => {
      giftAnimation.classList.remove('show');
    }, 3000);
  }

  function shareStream() {
    if (navigator.share) {
      navigator.share({
        title: 'Transmisi√≥n en vivo en BeaBoo',
        text: 'Mira esta incre√≠ble transmisi√≥n en vivo',
        url: window.location.href
      });
    } else {
      // Fallback para navegadores sin soporte nativo
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Enlace copiado al portapapeles');
      });
    }
  }

  function closeGiftDrawer() {
    document.getElementById('gift-drawer').classList.remove('open');
  }

  function showReportModal() {
    document.getElementById('report-modal').classList.remove('translate-y-full');
  }

  function closeReportModal() {
    document.getElementById('report-modal').classList.add('translate-y-full');
  }

  function submitReport() {
    closeReportModal();
    document.getElementById('report-success').classList.remove('hidden');
    setTimeout(closeReportSuccess, 3000);
  }

  function closeReportSuccess() {
    document.getElementById('report-success').classList.add('hidden');
  }

  function handleLiveVideoUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const video = document.getElementById('live-localVideo');
      video.src = URL.createObjectURL(file);
      video.play();
    }
  }
  // Funci√≥n para iniciar transmisi√≥n
  function startLiveStream() {
    const startBtn = document.getElementById('live-startBtn');
    const startContainer = startBtn.parentElement;
    const endContainer = document.getElementById('live-end-container');
    const spinner = document.getElementById('live-spinner');
    const overlay = document.getElementById('live-overlay');
    const indicator = document.getElementById('live-indicator');
    
    // Mostrar spinner
    spinner.classList.remove('hidden');
    
    // Cambiar bot√≥n a estado de "iniciando" (mantener estilo circular)
    startBtn.innerHTML = `
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
    `;
    startBtn.disabled = true;
    startBtn.className = "w-20 h-20 bg-gray-600 text-white rounded-full cursor-not-allowed flex items-center justify-center mx-auto";
    
    // Simular inicio de transmisi√≥n
    setTimeout(() => {
      spinner.classList.add('hidden');
      overlay.classList.add('hidden');
      
      // Ocultar contenedor de inicio y mostrar el de finalizaci√≥n
      startContainer.classList.add('hidden');
      endContainer.classList.remove('hidden');
      
      // Mostrar indicador de transmisi√≥n en vivo
      if (indicator) {
        indicator.classList.remove('hidden');
        indicator.innerHTML = '<div class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-bold flex items-center shadow-lg"><div class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></div>EN VIVO</div>';
      }
      
      // Actualizar contador de vistas
      document.getElementById('live-viewCount').innerHTML = `
        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        <span class="text-sm font-medium">LIVE ‚Ä¢ 0 visualizaciones</span>
      `;
      
      // Iniciar sincronizaci√≥n de vistas en tiempo real
      syncViewerCount();
      
      console.log('Transmisi√≥n iniciada correctamente');
    }, 2000);
  }
  
  // Funci√≥n para finalizar transmisi√≥n
  function endLiveStream() {
    const startBtn = document.getElementById('live-startBtn');
    const endContainer = document.getElementById('live-end-container');
    const indicator = document.getElementById('live-indicator');
    const overlay = document.getElementById('live-overlay');
    
    // Mostrar confirmaci√≥n
    if (confirm('¬øEst√°s seguro de que quieres finalizar la transmisi√≥n?')) {
      // Ocultar bot√≥n de finalizar y mostrar el de inicio
      endContainer.classList.add('hidden');
      startBtn.parentElement.classList.remove('hidden');
      
      // Restaurar bot√≥n de inicio al estado original (estilo Instagram circular)
      startBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
      `;
      startBtn.className = "w-20 h-20 bg-gradient-to-br from-purple-500 via-pink-500 to-red-500 hover:from-purple-600 hover:via-pink-600 hover:to-red-600 text-white rounded-full transition-all duration-200 flex items-center justify-center shadow-xl mx-auto";
      startBtn.disabled = false;
      
      if (indicator) {
        indicator.classList.add('hidden');
      }
      
      if (overlay) {
        overlay.classList.remove('hidden');
      }
      
      // Resetear contador de vistas
      document.getElementById('live-viewCount').innerHTML = `
        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        <span class="text-sm">0 visualizaciones</span>
      `;
      
      console.log('Transmisi√≥n finalizada');
    }
  }
  
  // Funci√≥n para sincronizar contador de vistas en tiempo real
  function syncViewerCount() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    // Cargar datos del usuario transmisor
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val();
      if (userData) {
        document.getElementById('streamerName').textContent = userData.username || 'Usuario';
        document.getElementById('streamerProfileImage').src = userData.profileImage || 'https://via.placeholder.com/150';
      }
    });
    
    // Crear referencia de la transmisi√≥n en vivo
    const liveStreamRef = firebase.database().ref('liveStreams/' + user.uid);
    
    // Escuchar cambios en tiempo real de espectadores
    liveStreamRef.child('viewers').on('value', snapshot => {
      const viewers = snapshot.numChildren() || 0;
      const viewCountElement = document.getElementById('live-viewCount');
      if (viewCountElement) {
        viewCountElement.innerHTML = `
          <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
          <span class="text-sm font-medium">LIVE ‚Ä¢ ${viewers} visualizaciones</span>
        `;
      }
    });
  }
  
  // Event listeners mejorados
  document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('live-startBtn');
    const endBtn = document.getElementById('live-endBtn');
    
    if (startBtn) {
      startBtn.addEventListener('click', startLiveStream);
    }
    
    if (endBtn) {
      endBtn.addEventListener('click', endLiveStream);
    }
  });

  function startCountdown() {
    let countdownElement = document.getElementById('live-countdown');
    let count = 3;
    countdownElement.textContent = count;
    let interval = setInterval(() => {
      count--;
      if (count > 0) {
        countdownElement.textContent = count;
      } else {
        clearInterval(interval);
        countdownElement.textContent = "¬°En vivo!";
        setTimeout(() => {
          document.getElementById('live-overlay').classList.add('hidden');
        }, 1000);
      }
    }, 1000);
  }
  // -------------------------------
  // Nuevas Funcionalidades en Ajustes
  // -------------------------------
  // Detector de rostro (simulaci√≥n: se aplica filtro de brillo/contraste)
  function startFaceDetection() {
    console.log("Detecci√≥n de rostro activada - aplicando efecto belleza");
    document.getElementById("live-localVideo").style.filter = "brightness(1.2) contrast(1.1)";
  }

  function stopFaceDetection() {
    console.log("Detecci√≥n de rostro desactivada - quitando efecto");
    document.getElementById("live-localVideo").style.filter = "";
  }
  document.getElementById('face-detection-toggle').addEventListener('change', function() {
    if (this.checked) {
      startFaceDetection();
    } else {
      stopFaceDetection();
    }
  });
  // Ocultar barra de vistas seg√∫n el ajuste
  document.getElementById('hide-viewbar-toggle').addEventListener('change', function() {
    const viewBar = document.getElementById('live-viewCount');
    if (this.checked) {
      viewBar.classList.add('hidden');
    } else {
      viewBar.classList.remove('hidden');
    }
  });
  // -------------------------------
  // Detecci√≥n de Swipe (Deslizar a la izquierda/derecha)
  // -------------------------------
  // Para vista del Transmisor: ocultar/mostrar todos los controles
  const transmitterModal = document.getElementById("live-stream-modal");
  transmitterModal.addEventListener("touchstart", function(e) {
    touchstartX = e.changedTouches[0].screenX;

function openNoteModal() {
  document.getElementById('note-modal').classList.remove('hidden');
}

function closeNoteModal() {
  document.getElementById('note-modal').classList.add('hidden');
  document.getElementById('note-input').value = '';
}

function saveNote() {
  const noteText = document.getElementById('note-input').value.trim();
  const currentUser = firebase.auth().currentUser;
  
  if (!noteText || !currentUser) return;
  
  firebase.database().ref('profileNotes/' + currentUser.uid).set({
    text: noteText,
    timestamp: Date.now()
  }).then(() => {
    closeNoteModal();
    const profileNote = document.getElementById('profile-note');
    profileNote.classList.remove('hidden');
    document.getElementById('note-text').textContent = noteText;
    document.getElementById('note-time').textContent = 'Expira en 12 horas';
  });
}

  }, false);
  transmitterModal.addEventListener("touchend", function(e) {
    touchendX = e.changedTouches[0].screenX;
    handleTransmitterSwipe();
  }, false);

  function handleTransmitterSwipe() {
    if (touchstartX - touchendX > 50) {
      hideTransmitterFunctions();
    } else if (touchendX - touchstartX > 50) {
      showTransmitterFunctions();
    }
  }

  function hideTransmitterFunctions() {
    document.getElementById("live-settingsBtn").classList.add("hidden");
    document.getElementById("live-viewCount").classList.add("hidden");
    document.getElementById("live-tapCount").classList.add("hidden");
  }

  function showTransmitterFunctions() {
    document.getElementById("live-settingsBtn").classList.remove("hidden");
    if (!document.getElementById('hide-viewbar-toggle').checked) {
      document.getElementById("live-viewCount").classList.remove("hidden");
    }
    document.getElementById("live-tapCount").classList.remove("hidden");
  }
  // Para vista del Espectador: ocultar/mostrar funciones (regalos, likes)
  const viewerModal = document.getElementById("live-view-modal");
  viewerModal.addEventListener("touchstart", function(e) {
    touchstartX = e.changedTouches[0].screenX;
  }, false);
  viewerModal.addEventListener("touchend", function(e) {
    touchendX = e.changedTouches[0].screenX;
    handleViewerSwipe();
  }, false);

  function handleViewerSwipe() {
    if (touchstartX - touchendX > 50) {
      hideViewerFunctions();
    } else if (touchendX - touchstartX > 50) {
      showViewerFunctions();
    }
  }

  function hideViewerFunctions() {
    const sideButtons = document.querySelector(".side-buttons");
    if (sideButtons) {
      sideButtons.classList.add("hidden");
    }
    document.getElementById("viewer-tapCount").classList.add("hidden");
    document.getElementById("likeCountLiveViewer").classList.add("hidden");
  }

  function showViewerFunctions() {
    const sideButtons = document.querySelector(".side-buttons");
    if (sideButtons) {
      sideButtons.classList.remove("hidden");
    }
    document.getElementById("viewer-tapCount").classList.remove("hidden");
  }

  
</script>

<!-- JAVASCRIPT -->
<script>
  /*********************** CONFIGURACI√ìN DE FIREBASE **************************/
  const firebaseConfig = {
    apiKey: "AIzaSyBWBr3sud1_lDPmtLJI42pCBZnco5_vyCc",
    authDomain: "noble-amp-458106-g0.firebaseapp.com",
    databaseURL: "https://noble-amp-458106-g0-default-rtdb.firebaseio.com",
    projectId: "noble-amp-458106-g0",
    storageBucket: "noble-amp-458106-g0.firebasestorage.app",
    messagingSenderId: "744574411059",
    appId: "1:744574411059:web:72a70955f1400df6645e46",
    measurementId: "G-XEQ1J354HM"
  };
  firebase.initializeApp(firebaseConfig);
  // Todos los usuarios est√°n autorizados para transmitir en vivo
  const authorizedEmails = [];
  /*********************** FUNCIONES ADICIONALES **************************/
  // Cache para optimizar filtro de profanidad (CORRIGE BLOQUEOS)
  let profanityRegexCache = null;
  let lastCheckedText = '';
  let lastProfanityResult = false;
  
  function contienePalabrasOfensivas(texto) {
    // Cache simple para evitar re-procesar el mismo texto
    if (texto === lastCheckedText) {
      return lastProfanityResult;
    }
    
    // Crear regex una sola vez (OPTIMIZACI√ìN CR√çTICA)
    if (!profanityRegexCache) {
      const listaOfensiva = [
        "imb√©cil", "idiota", "est√∫pido", "tarado", "pendejo",
        "capullo", "gilipollas", "subnormal", "malparido", "bobo",
        "tonto", "in√∫til", "cretino", "est√∫pida", "pendeja",
        "zorra", "perra", "mierda", "cabr√≥n", "merda"
      ];
      
      // Compilar regex una sola vez para mejor rendimiento
      const pattern = listaOfensiva.map(word => `\\b${word}\\b`).join('|');
      profanityRegexCache = new RegExp(pattern, 'i');
    }
    
    // Normalizaci√≥n optimizada
    const textoNormalizado = texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    
    // Cache del resultado
    lastCheckedText = texto;
    lastProfanityResult = profanityRegexCache.test(textoNormalizado);
    
    return lastProfanityResult;
  }
  
  // Funci√≥n con debounce para inputs (evita bloqueos en tiempo real)
  let profanityDebounceTimer = null;
  function checkProfanityWithDebounce(texto, callback, delay = 300) {
    clearTimeout(profanityDebounceTimer);
    profanityDebounceTimer = setTimeout(() => {
      callback(contienePalabrasOfensivas(texto));
    }, delay);
  }
  /*********************** VARIABLES Y ELEMENTOS DEL DOM **************************/
  const authForm = document.getElementById('authForm');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const submitButton = document.getElementById('submitButton');
  const toggleAuth = document.getElementById('toggleAuth');
  const authError = document.getElementById('authError');
  const authFormContainer = document.getElementById('auth-form');
  const mainApp = document.getElementById('main-app');
  let isLogin = true;
  let storyTypeSelected = "";
  let currentEditingStory = null;
  let currentChapters = [];
  let currentViewedAuthorId = null;
  let liveBroadcasterId = null;
  let currentChapterEditId = null;
  let currentLanguage = 'es';
  const translations = {
    es: {
      appName: "BeaBoo",
      tagline: "Tu portal de historias inolvidables",
      authTitle: "BeaBoo",
      emailPlaceholder: "Correo electr√≥nico",
      passwordPlaceholder: "Contrase√±a",
      btnIniciarSesion: "Iniciar Sesi√≥n",
      btnToggleAuth: "¬øNo tienes cuenta? Reg√≠strate",
      btnVolver: "Volver",
      newReleases: "Nuevos Lanzamientos",
      top10: "Top 10",
      popular: "M√°s Populares",
      terror: "Historias de Terror Destacadas",
      searchPlaceholder: "Buscar historias o autores",
      searchResults: "Resultados de b√∫squeda",
      searchBooks: "C√≥mic",
      searchAuthors: "Autores",
      profileStories: "Mis Historias",
      editProfile: "Editar nombre",
      saveBio: "Guardar biograf√≠a",
      createStory: "Crear Historia",
      storyTitlePlaceholder: "T√≠tulo de la historia",
      selectCategory: "Selecciona una categor√≠a",
      btnCreateStory: "Crear Historia",
      editStory: "Editar Historia",
      addChapter: "Agregar Cap√≠tulo",
      deleteStory: "Eliminar Historia",
      makePrivate: "Hacer privada",
      chapterCreationTitle: "Agregar Nuevo Cap√≠tulo",
      chapterPlaceholder: "Escribe el contenido del cap√≠tulo aqu√≠...",
      btnSaveChapter: "Guardar Cap√≠tulo",
      readChapter: "Cap√≠tulo",
      btnPrevChapter: "Anterior",
      btnNextChapter: "Siguiente",
      rateChapter: "Califica:",
      authorProfile: "Por",
      reportProfile: "Reportar Perfil",
      reportInstructions: "Selecciona un motivo o describe el problema:",
      btnSendReport: "Enviar Reporte",
      reportSuccess: "Reporte enviado con √©xito. En breve recibir√°s una respuesta.",
      noInfraccion: "No se detectaron infracciones en este perfil.",
      followers: "Seguidores",
      following: "Siguiendo",
      ratings: "Calificaciones",
      languageModalTitle: "Selecciona tu idioma",
      editUsernamePrompt: "Introduce tu nuevo nombre de usuario:",
      usernameUpdated: "Nombre de usuario actualizado.",
      bioUpdated: "Biograf√≠a actualizada.",
      chapterAdded: "Cap√≠tulo agregado.",
      noEditingStory: "No hay historia en edici√≥n.",
      userNotAuthenticated: "Usuario no autenticado.",
      chapterNotFound: "Cap√≠tulo no encontrado.",
      firstChapter: "Este es el primer cap√≠tulo.",
      lastChapter: "Este es el √∫ltimo cap√≠tulo.",
      chapterRated: "Cap√≠tulo calificado con {value} estrella(s).",
      followSelfError: "No puedes seguirte a ti mismo.",
      nowFollowing: "Ahora sigues a este autor.",
      stoppedFollowing: "Has dejado de seguir a este autor.",
      alreadyFollowing: "Ya sigues a este usuario.",
      storyDeleted: "Historia eliminada.",
      editLater: "Puedes editar tu historia m√°s tarde desde tu perfil."
    },
    en: {
      /* Traducciones en ingl√©s */ },
    pt: {
      /* Traducciones en portugu√©s */ }
  };

  function getVerificationIcon(email) {
    // Si el correo es uno de los que deben estar verificados,
    // se mostrar√° el icono nuevo.
    if (email === "robertolorenzo1224@gmail.com" || email === "robertolorenzo1224@gmail.com"|| email === "glamworksappstv@gmail.com" || email === "linapaolaromero99@gmail.com") {
      return '<img src="https://static.vecteezy.com/system/resources/previews/028/084/106/original/verified-check-mark-icon-png.png" alt="Verificado" class="inline-block w-4 h-4 ml-1">';
    }
    return "";
  }

  function updateTranslations() {
    document.getElementById('app-name').innerText = translations[currentLanguage].appName;
    document.getElementById('tagline').innerText = translations[currentLanguage].tagline;
    document.getElementById('auth-title').innerText = translations[currentLanguage].authTitle;
    emailInput.placeholder = translations[currentLanguage].emailPlaceholder;
    passwordInput.placeholder = translations[currentLanguage].passwordPlaceholder;
    submitButton.innerText = translations[currentLanguage].btnIniciarSesion;
    toggleAuth.innerText = translations[currentLanguage].btnToggleAuth;
    document.getElementById('btn-volver-search').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('btn-volver-profile').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('btn-volver-author').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('new-releases-title').innerText = translations[currentLanguage].newReleases;
    document.getElementById('top10-title').innerText = translations[currentLanguage].top10;
    document.getElementById('popular-title').innerText = translations[currentLanguage].popular;
    document.getElementById('terror-title').innerText = translations[currentLanguage].terror;
    document.getElementById('search-input').placeholder = translations[currentLanguage].searchPlaceholder;
    document.getElementById('search-results-title').innerText = translations[currentLanguage].searchResults;
    document.getElementById('search-comics-title').innerText = translations[currentLanguage].searchBooks;
    document.getElementById('search-authors-title').innerText = translations[currentLanguage].searchAuthors;
    document.getElementById('profile-stories-title').innerText = translations[currentLanguage].profileStories;
    document.getElementById('story-type-title').innerText = translations[currentLanguage].createStory;
    document.getElementById('create-story-title').innerText = translations[currentLanguage].createStory;
    document.getElementById('story-title').placeholder = translations[currentLanguage].storyTitlePlaceholder;
    document.getElementById('story-category').options[0].text = translations[currentLanguage].selectCategory;
    document.getElementById('btn-create-story').innerText = translations[currentLanguage].btnCreateStory;
    document.getElementById('edit-story-title').innerText = translations[currentLanguage].editStory;
    document.getElementById('chapter-creation-title').innerText = translations[currentLanguage].chapterCreationTitle;
    document.getElementById('chapter-content').placeholder = translations[currentLanguage].chapterPlaceholder;
    document.getElementById('btn-save-chapter').innerText = translations[currentLanguage].btnSaveChapter;
    document.getElementById('prev-chapter-btn').innerText = translations[currentLanguage].btnPrevChapter;
    document.getElementById('next-chapter-btn').innerText = translations[currentLanguage].btnNextChapter;
    document.getElementById('detail-synopsis').innerText = "Sinopsis de la historia...";
    document.getElementById('detail-metrics').innerHTML =
      `<span><strong>0</strong> Visitas</span>
         <span><strong>0</strong> ${translations[currentLanguage].ratings}</span>
         <span><strong>0</strong> Cap√≠tulos</span>`;
    document.getElementById('report-title').innerText = translations[currentLanguage].reportProfile;
    document.getElementById('report-instructions').innerText = translations[currentLanguage].reportInstructions;
    document.getElementById('btn-enviar-report').innerText = translations[currentLanguage].btnSendReport;
    document.getElementById('lang-modal-title').innerText = translations[currentLanguage].languageModalTitle;
  }

  function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem("selectedLanguage", lang);
    const langOverlay = document.getElementById('lang-loading-overlay');
    langOverlay.style.display = "flex";
    setTimeout(() => {
      updateTranslations();
      langOverlay.style.display = "none";
      const languageModal = document.getElementById('language-modal');
      if (languageModal) {
        languageModal.style.display = "none";
      }
    }, 1000);
  }
  window.addEventListener('load', () => {
    setTimeout(() => {
      const splash = document.getElementById('splash-screen');
      if (splash) {
        splash.style.opacity = '0';
        setTimeout(() => {
          splash.style.display = 'none';
        }, 1000);
      }
    }, 3000);
  });
  /*********************** NOTIFICACIONES **************************/
  async function addNotification(userId, message, type = 'info') {
    const notificationsRef = firebase.database().ref('notifications/' + userId);
    const newNotificationRef = notificationsRef.push();
    newNotificationRef.set({
      message: message,
      timestamp: Date.now(),
      read: false,
      type: type,
      notificationId: newNotificationRef.key
    });
    
    // Play sound based on notification type
    const audio = new Audio();
    switch(type) {
      case 'follow':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/213/213.wav';
        break;
      case 'like':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/208/208.wav';
        break;
      case 'comment':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/221/221.wav';
        break;
      default:
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/206/206.wav';
    }
    audio.play().catch(e => console.log('Audio play failed:', e));
    
    // Handle notifications for both mobile and desktop
    if ('Notification' in window) {
      if (Notification.permission === "granted") {
        new Notification("BeaBoo", {
          body: message,
          icon: "https://cdn-icons-png.flaticon.com/512/907/907822.png",
          vibrate: [200, 100, 200]
        });
      } else if (Notification.permission !== "denied") {
        // Request permission on mobile
        try {
          const permission = await Notification.requestPermission();
          if (permission === "granted") {
            new Notification("BeaBoo", {
              body: message,
              icon: "https://cdn-icons-png.flaticon.com/512/907/907822.png",
              vibrate: [200, 100, 200]
            });
          }
        } catch (error) {
          console.log('Notification permission error:', error);
        }
      }
    }
    
    // Fallback vibration for mobile devices
    if (navigator.vibrate) {
      navigator.vibrate([200, 100, 200]);
    }
}

  function openNotifications() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;
    
    // Request notification permission if not granted
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    
    document.getElementById('notifications-modal').classList.remove('hidden');
    const notificationsRef = firebase.database().ref('notifications/' + currentUser.uid);
    notificationsRef.on('value', snapshot => {
      const notificationsList = document.getElementById('notifications-list');
      const noNotifications = document.getElementById('no-notifications');
      notificationsList.innerHTML = "";
      
      let hasNotifications = false;
      
      snapshot.forEach(child => {
        hasNotifications = true;
        const notification = child.val();
        const div = document.createElement('div');
        div.className = 'bg-gray-50 rounded-xl p-3 border border-gray-100 hover:bg-gray-100 transition-colors cursor-pointer';
        
        // Icon based on notification type
        const iconMap = {
          follow: 'üë§',
          like: '‚ù§Ô∏è',
          comment: 'üí¨',
          info: '‚ÑπÔ∏è',
          chapter_published: 'üìö'
        };
        
        div.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="text-2xl">${iconMap[notification.type] || '‚ÑπÔ∏è'}</div>
            <div class="flex-1 min-w-0">
              <div class="text-sm text-gray-800">${notification.message}</div>
              <div class="text-xs text-[#FE2C55] mt-1">${new Date(notification.timestamp).toLocaleString()}</div>
            </div>
            ${!notification.read ? '<div class="w-2 h-2 bg-[#FE2C55] rounded-full flex-shrink-0 mt-2"></div>' : ''}
          </div>
        `;
        
        // Mark as read when clicked
        div.onclick = () => {
          if (!notification.read) {
            firebase.database().ref('notifications/' + currentUser.uid + '/' + child.key).update({
              read: true
            });
          }
        };
        
        notificationsList.appendChild(div);
      });
      
      // Show/hide empty state
      if (hasNotifications) {
        noNotifications.classList.add('hidden');
      } else {
        noNotifications.classList.remove('hidden');
      }
    });
  }

  function closeNotifications() {
    document.getElementById('notifications-modal').classList.add('hidden');
  }
  /*********************** SISTEMA SIMPLIFICADO **************************/
  
  // Funci√≥n stub para incrementUsage (previene errores)
  function incrementUsage(type, amount = 1) {
    // Funci√≥n deshabilitada para evitar errores de permisos
    // console.log(`Usage tracking disabled: ${type} +${amount}`);
  }
  
  // Modal de l√≠mite excedido
  function showLimitExceededModal(type, percentage) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-[70]';
    modal.innerHTML = `
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-2xl font-bold text-red-600 mb-4">Servidor Sobrecargado</h2>
        <p class="text-gray-600 mb-6">
          Hemos alcanzado el ${Math.round(percentage * 100)}% del l√≠mite mensual de ${type}.
          El servicio estar√° limitado hasta el pr√≥ximo mes para mantener la estabilidad.
        </p>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
          <p class="text-sm text-red-800">
            <strong>¬øQu√© puedes hacer?</strong><br>
            ‚Ä¢ Las historias existentes permanecen disponibles<br>
            ‚Ä¢ Funciones limitadas temporalmente<br>
            ‚Ä¢ Servicio completo se restaura el pr√≥ximo mes
          </p>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" 
                class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold">
          Entendido
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Deshabilitar funciones cr√≠ticas
    disableCriticalFunctions();
  }
  
  // Advertencia de l√≠mite
  function showLimitWarning(type, percentage) {
    const warning = document.createElement('div');
    warning.className = 'fixed top-4 right-4 bg-yellow-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
    warning.innerHTML = `
      <div class="flex items-start gap-3">
        <span class="text-2xl">‚ö†Ô∏è</span>
        <div>
          <div class="font-bold">Advertencia de L√≠mite</div>
          <div class="text-sm opacity-90">
            Uso de ${type}: ${Math.round(percentage * 100)}%
          </div>
          <div class="text-xs mt-1">
            El servicio puede limitarse pronto
          </div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" 
                class="text-white/80 hover:text-white ml-2">√ó</button>
      </div>
    `;
    
    document.body.appendChild(warning);
    
    // Auto-remover despu√©s de 10 segundos
    setTimeout(() => {
      if (warning.parentElement) {
        warning.remove();
      }
    }, 10000);
  }
  
  // Deshabilitar funciones cr√≠ticas cuando se excede el l√≠mite
  function disableCriticalFunctions() {
    // Deshabilitar escrituras no esenciales
    window.limitExceeded = true;
    
    // Interceptar funciones de escritura
    const originalPush = firebase.database.Reference.prototype.push;
    const originalSet = firebase.database.Reference.prototype.set;
    const originalUpdate = firebase.database.Reference.prototype.update;
    
    firebase.database.Reference.prototype.push = function(...args) {
      if (window.limitExceeded && !this.toString().includes('essential')) {
        console.warn('Operaci√≥n bloqueada: l√≠mite excedido');
        return Promise.reject(new Error('L√≠mite de Firebase excedido'));
      }
      return originalPush.apply(this, args);
    };
    
    firebase.database.Reference.prototype.set = function(...args) {
      if (window.limitExceeded && !this.toString().includes('essential')) {
        console.warn('Operaci√≥n bloqueada: l√≠mite excedido');
        return Promise.reject(new Error('L√≠mite de Firebase excedido'));
      }
      return originalSet.apply(this, args);
    };
    
    firebase.database.Reference.prototype.update = function(...args) {
      if (window.limitExceeded && !this.toString().includes('essential')) {
        console.warn('Operaci√≥n bloqueada: l√≠mite excedido');
        return Promise.reject(new Error('L√≠mite de Firebase excedido'));
      }
      return originalUpdate.apply(this, args);
    };
  }
  
  // Funci√≥n para verificar si una operaci√≥n est√° permitida
  function isOperationAllowed() {
    // Siempre permitir operaciones (sistema de l√≠mites deshabilitado)
    return true;
  }
  
  // Verificar l√≠mites al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    // Verificaci√≥n de l√≠mites deshabilitada para evitar errores de permisos
  });
  
  // Interceptar operaciones de Firebase para contar uso
  const originalOnce = firebase.database.Reference.prototype.once;
  const originalOn = firebase.database.Reference.prototype.on;
  
  firebase.database.Reference.prototype.once = function(...args) {
    // incrementUsage('reads', 1); // Deshabilitado
    return originalOnce.apply(this, args);
  };
  
  firebase.database.Reference.prototype.on = function(...args) {
    // incrementUsage('reads', 1); // Deshabilitado
    return originalOn.apply(this, args);
  };

  /*********************** SISTEMA DE MONETIZACI√ìN **************************/
  let coinAnimationQueue = [];
  let lastUsernameChange = 0;
  const USERNAME_CHANGE_COOLDOWN = 7 * 24 * 60 * 60 * 1000; // 7 d√≠as en milisegundos

  function addCoins(userId, amount, reason) {
    // Verificar l√≠mites antes de realizar operaciones
    // Verificaci√≥n de l√≠mites deshabilitada
    
    const userCoinsRef = firebase.database().ref('users/' + userId + '/coins');
    return userCoinsRef.transaction(currentCoins => {
      return (currentCoins || 0) + amount;
    }).then(() => {
      // Mostrar animaci√≥n de monedas ganadas
      showCoinAnimation(amount, reason);
      
      // Actualizar contador en tiempo real
      updateCoinDisplay(userId);
      
      // Agregar a historial de monedas
      addCoinHistory(userId, amount, reason);
      
      console.log(`Usuario ${userId} gan√≥ ${amount} monedas por: ${reason}`);
    });
  }

  function showCoinAnimation(amount, reason) {
    const coinNotification = document.createElement('div');
    coinNotification.className = 'fixed top-4 right-4 bg-yellow-500 text-white p-4 rounded-lg shadow-lg z-50 transform transition-all duration-500';
    coinNotification.innerHTML = `
      <div class="flex items-center space-x-2">
        <span class="text-2xl">ü™ô</span>
        <div>
          <div class="font-bold">+${amount} monedas</div>
          <div class="text-sm opacity-90">${reason}</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(coinNotification);
    
    // Animaci√≥n de entrada
    setTimeout(() => {
      coinNotification.style.transform = 'translateX(0)';
    }, 100);
    
    // Animaci√≥n de salida
    setTimeout(() => {
      coinNotification.style.transform = 'translateX(100%)';
      setTimeout(() => {
        coinNotification.remove();
      }, 500);
    }, 3000);
  }

  function formatNumber(num) {
    if (num >= 1000000000) {
      return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
    }
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
    }
    if (num >= 1000) {
      return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
    }
    return num.toString();
  }

  function updateCoinDisplay(userId) {
    firebase.database().ref('users/' + userId + '/coins').on('value', snapshot => {
      const coins = snapshot.val() || 0;
      
      // Actualizar en perfil de edici√≥n
      const editCoinsElement = document.getElementById('edit-coins');
      if (editCoinsElement) {
        editCoinsElement.textContent = coins;
      }
      
      // Actualizar en header si existe
      const headerCoinsElement = document.getElementById('header-coins');
      if (headerCoinsElement) {
        headerCoinsElement.textContent = coins;
      }
      
      // Actualizar en selector de marcos
      const frameSelectorCoins = document.getElementById('frame-selector-coins');
      if (frameSelectorCoins) {
        frameSelectorCoins.textContent = coins;
      }
      
      // Actualizar contador en tiempo real en la barra superior
      updateTopBarCoins(coins);
    });

    // Actualizar contadores de seguidores y siguiendo con formato
    firebase.database().ref('users/' + userId).on('value', snapshot => {
      const userData = snapshot.val() || {};
      
      const followersElement = document.getElementById('profile-followers');
      if (followersElement) {
        followersElement.textContent = formatNumber(userData.followersCount || 0);
      }
      
      const followingElement = document.getElementById('profile-following');
      if (followingElement) {
        followingElement.textContent = formatNumber(userData.followingCount || 0);
      }
      
      // Tambi√©n actualizar en modal de edici√≥n con formato
      const editFollowersElement = document.getElementById('edit-followers');
      if (editFollowersElement) {
        editFollowersElement.textContent = formatNumber(userData.followersCount || 0);
      }
      
      const editFollowingElement = document.getElementById('edit-following');
      if (editFollowingElement) {
        editFollowingElement.textContent = formatNumber(userData.followingCount || 0);
      }
    });
  }

  function updateTopBarCoins(coins) {
    let coinDisplay = document.getElementById('coin-display');
    if (!coinDisplay) {
      // Crear el display de monedas en la barra superior para todos los dispositivos
      coinDisplay = document.createElement('div');
      coinDisplay.id = 'coin-display';
      coinDisplay.className = 'flex items-center space-x-1 bg-yellow-500 text-white px-2 py-1 rounded-full text-xs md:text-sm font-bold';
      coinDisplay.innerHTML = `
        <span>ü™ô</span>
        <span id="coin-count">${coins}</span>
      `;
      
      // Insertar en la barra superior (funciona tanto en m√≥vil como escritorio)
      const topBar = document.querySelector('.flex.items-center.justify-between.px-4.py-3');
      if (topBar) {
        const rightSection = topBar.children[1];
        if (rightSection) {
          rightSection.insertBefore(coinDisplay, rightSection.firstChild);
        }
      }
    } else {
      const coinCountElement = document.getElementById('coin-count');
      if (coinCountElement) {
        coinCountElement.textContent = coins;
      }
    }
  }

  function addCoinHistory(userId, amount, reason) {
    firebase.database().ref('coinHistory/' + userId).push({
      amount: amount,
      reason: reason,
      timestamp: Date.now()
    });
  }

  // Funciones espec√≠ficas para ganar monedas
  function earnCoinsForReading(userId, chapterId) {
    const readKey = `read_${chapterId}`;
    firebase.database().ref('userCoinActions/' + userId + '/' + readKey).once('value').then(snapshot => {
      if (!snapshot.exists()) {
        // Primera vez leyendo este cap√≠tulo
        firebase.database().ref('userCoinActions/' + userId + '/' + readKey).set(true);
        addCoins(userId, 8, 'Leer cap√≠tulo');
      }
    });
  }

  function earnCoinsForFollowing(userId, followedUserId) {
    addCoins(userId, 5, 'Seguir usuario');
  }

  function earnCoinsForViewing(userId, targetType, targetId) {
    const viewKey = `view_${targetType}_${targetId}_${new Date().toDateString()}`;
    firebase.database().ref('userCoinActions/' + userId + '/' + viewKey).once('value').then(snapshot => {
      if (!snapshot.exists()) {
        // Primera vista del d√≠a
        firebase.database().ref('userCoinActions/' + userId + '/' + viewKey).set(true);
        addCoins(userId, 2, `Ver ${targetType}`);
      }
    });
  }

  function earnCoinsForCommunityNote(userId) {
    addCoins(userId, 10, 'Publicar nota en comunidad');
  }

  function earnCoinsForLikingNote(userId, noteId) {
    const likeKey = `like_${noteId}`;
    firebase.database().ref('userCoinActions/' + userId + '/' + likeKey).once('value').then(snapshot => {
      if (!snapshot.exists()) {
        firebase.database().ref('userCoinActions/' + userId + '/' + likeKey).set(true);
        addCoins(userId, 5, 'Dar like a nota');
      }
    });
  }

  // Sistema de tienda de efectos
  function openEffectsStore() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-[#FE2C55]">Tienda de Efectos</h2>
          <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <div class="effect-item border rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer" onclick="buyEffect('sparkle', 20)">
            <div class="text-4xl mb-2">‚ú®</div>
            <h3 class="font-bold">Efecto Brillos</h3>
            <p class="text-sm text-gray-600">A√±ade brillos a tu perfil</p>
            <div class="mt-2 flex items-center justify-center space-x-1">
              <span>ü™ô</span>
              <span class="font-bold">20</span>
            </div>
          </div>
          
          <div class="effect-item border rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer" onclick="buyEffect('rainbow', 35)">
            <div class="text-4xl mb-2">üåà</div>
            <h3 class="font-bold">Efecto Arco√≠ris</h3>
            <p class="text-sm text-gray-600">Colores vibrantes</p>
            <div class="mt-2 flex items-center justify-center space-x-1">
              <span>ü™ô</span>
              <span class="font-bold">35</span>
            </div>
          </div>
          
          <div class="effect-item border rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer" onclick="buyEffect('fire', 50)">
            <div class="text-4xl mb-2">üî•</div>
            <h3 class="font-bold">Efecto Fuego</h3>
            <p class="text-sm text-gray-600">Llamas ardientes</p>
            <div class="mt-2 flex items-center justify-center space-x-1">
              <span>ü™ô</span>
              <span class="font-bold">50</span>
            </div>
          </div>
          
          <div class="effect-item border rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer" onclick="buyEffect('hearts', 30)">
            <div class="text-4xl mb-2">üíï</div>
            <h3 class="font-bold">Efecto Corazones</h3>
            <p class="text-sm text-gray-600">Corazones flotantes</p>
            <div class="mt-2 flex items-center justify-center space-x-1">
              <span>ü™ô</span>
              <span class="font-bold">30</span>
            </div>
          </div>
          
          <div class="effect-item border rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer" onclick="buyEffect('galaxy', 75)">
            <div class="text-4xl mb-2">üåå</div>
            <h3 class="font-bold">Efecto Galaxia</h3>
            <p class="text-sm text-gray-600">Estrellas c√≥smicas</p>
            <div class="mt-2 flex items-center justify-center space-x-1">
              <span>ü™ô</span>
              <span class="font-bold">75</span>
            </div>
          </div>
          
          <div class="effect-item border rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer" onclick="buyEffect('premium', 100)">
            <div class="text-4xl mb-2">üëë</div>
            <h3 class="font-bold">Efecto Premium</h3>
            <p class="text-sm text-gray-600">Corona dorada</p>
            <div class="mt-2 flex items-center justify-center space-x-1">
              <span>ü™ô</span>
              <span class="font-bold">100</span>
            </div>
          </div>
        </div>
        
        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
          <h3 class="font-bold text-blue-800 mb-2">Cambio de Nombre de Usuario</h3>
          <p class="text-blue-600 text-sm mb-3">Cambia tu nombre de usuario por 7 monedas. Solo se puede hacer cada 7 d√≠as.</p>
          <button onclick="openUsernameChange()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
            ü™ô 7 - Cambiar Nombre
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  function buyEffect(effectType, cost) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('users/' + user.uid + '/coins').once('value').then(snapshot => {
      const currentCoins = snapshot.val() || 0;
      
      if (currentCoins < cost) {
        alert(`No tienes suficientes monedas. Necesitas ${cost} monedas pero solo tienes ${currentCoins}.`);
        return;
      }

      // Deducir monedas
      firebase.database().ref('users/' + user.uid + '/coins').set(currentCoins - cost);
      
      // Agregar efecto al usuario
      firebase.database().ref('users/' + user.uid + '/effects/' + effectType).set({
        purchased: true,
        purchaseDate: Date.now()
      });

      // Agregar al historial
      addCoinHistory(user.uid, -cost, `Comprar efecto: ${effectType}`);

      alert(`¬°Efecto ${effectType} comprado exitosamente! Te cost√≥ ${cost} monedas.`);
      
      // Cerrar modal
      document.querySelector('.fixed.inset-0').remove();
    });
  }

  function openUsernameChange() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val();
      const currentCoins = userData.coins || 0;
      const lastChange = userData.lastUsernameChange || 0;
      const timeSinceLastChange = Date.now() - lastChange;
      
      if (timeSinceLastChange < USERNAME_CHANGE_COOLDOWN && currentCoins < 50) {
        const daysLeft = Math.ceil((USERNAME_CHANGE_COOLDOWN - timeSinceLastChange) / (24 * 60 * 60 * 1000));
        alert(`Debes esperar ${daysLeft} d√≠as m√°s para cambiar tu nombre gratis, o pagar 50 monedas para acelerar el proceso.`);
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      
      let cost = 7;
      let accelerationCost = 0;
      
      if (timeSinceLastChange < USERNAME_CHANGE_COOLDOWN) {
        accelerationCost = 50;
        cost += accelerationCost;
      }

      modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
          <h2 class="text-xl font-bold mb-4">Cambiar Nombre de Usuario</h2>
          <p class="text-gray-600 mb-4">Costo: 7 monedas ${accelerationCost > 0 ? `+ ${accelerationCost} por acelerar` : ''}</p>
          <input type="text" id="new-username" placeholder="Nuevo nombre de usuario" class="w-full p-3 border rounded-lg mb-4">
          <div class="flex space-x-3">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg">Cancelar</button>
            <button onclick="changeUsername()" class="flex-1 bg-[#FE2C55] text-white py-2 rounded-lg">ü™ô ${cost} - Cambiar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    });
  }

  function changeUsername() {
    const user = firebase.auth().currentUser;
    const newUsername = document.getElementById('new-username').value.trim();
    
    if (!newUsername) {
      alert('Por favor ingresa un nombre de usuario v√°lido.');
      return;
    }

    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val();
      const currentCoins = userData.coins || 0;
      const lastChange = userData.lastUsernameChange || 0;
      const timeSinceLastChange = Date.now() - lastChange;
      
      let totalCost = 7;
      if (timeSinceLastChange < USERNAME_CHANGE_COOLDOWN) {
        totalCost += 50; // Costo de aceleraci√≥n
      }

      if (currentCoins < totalCost) {
        alert(`No tienes suficientes monedas. Necesitas ${totalCost} monedas.`);
        return;
      }

      // Deducir monedas y actualizar username
      const updates = {
        username: newUsername,
        coins: currentCoins - totalCost,
        lastUsernameChange: Date.now()
      };

      firebase.database().ref('users/' + user.uid).update(updates).then(() => {
        addCoinHistory(user.uid, -totalCost, 'Cambio de nombre de usuario');
        alert('¬°Nombre de usuario cambiado exitosamente!');
        
        // Actualizar en la interfaz
        document.getElementById('profile-username').textContent = newUsername;
        
        // Cerrar modal
        document.querySelector('.fixed.inset-0').remove();
      });
    });
  }

  /*********************** AUTENTICACI√ìN **************************/
  toggleAuth.addEventListener('click', () => {
    isLogin = !isLogin;
    submitButton.textContent = isLogin ? translations[currentLanguage].btnIniciarSesion : 'Registrarse';
    toggleAuth.textContent = isLogin ? translations[currentLanguage].btnToggleAuth : '¬øYa tienes cuenta? Inicia sesi√≥n';
  });
  authForm.addEventListener('submit', e => {
    e.preventDefault();
    authError.classList.add('hidden');
    
    const email = emailInput.value;
    const password = passwordInput.value;
    
    // Validar campos
    if (!email || !password) {
      authError.textContent = "Por favor, completa todos los campos";
      authError.classList.remove('hidden');
      authError.classList.add('error-shake');
      setTimeout(() => authError.classList.remove('error-shake'), 500);
      return;
    }

    // Animaciones de campo activo
    emailInput.classList.add('field-active');
    passwordInput.classList.add('field-active');
    setTimeout(() => {
      emailInput.classList.remove('field-active');
      passwordInput.classList.remove('field-active');
    }, 600);

    // Convertir bot√≥n a loading con animaci√≥n TikTok
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.classList.add('login-loading');
    submitButton.innerHTML = `
      <div class="flex items-center justify-center">
        <div class="tiktok-loader mr-3">
          <div class="tiktok-dot"></div>
          <div class="tiktok-dot"></div>
        </div>
        <span>${isLogin ? 'Iniciando sesi√≥n...' : 'Creando cuenta...'}</span>
      </div>
    `;

    if (isLogin) {
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Usuario autenticado:", userCredential.user);
          
          // Animaci√≥n de √©xito
          submitButton.classList.remove('login-loading');
          submitButton.classList.add('success-bounce');
          submitButton.innerHTML = `
            <div class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              ¬°Bienvenido!
            </div>
          `;
        })
        .catch(error => {
          console.error(error);
          authError.textContent = getAuthErrorMessage(error.code);
          authError.classList.remove('hidden');
          authError.classList.add('error-shake');
          
          // Animaci√≥n de error en el bot√≥n
          submitButton.classList.remove('login-loading');
          submitButton.classList.add('error-shake');
          submitButton.textContent = originalText;
          
          setTimeout(() => {
            authError.classList.remove('error-shake');
            submitButton.classList.remove('error-shake');
            submitButton.disabled = false;
          }, 500);
        });
    } else {
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          const user = userCredential.user;
          
          // Animaci√≥n de √©xito
          submitButton.classList.remove('login-loading');
          submitButton.classList.add('success-bounce');
          submitButton.innerHTML = `
            <div class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              ¬°Cuenta creada!
            </div>
          `;
          
          const userCountRef = firebase.database().ref('userCount');
          userCountRef.transaction(count => (count || 0) + 1).then(result => {
            const newCount = result.snapshot.val();
            let isVerified = newCount <= 100;
            let isFounder = false;
            
            // Verificar email espec√≠fico para fundador
            if (user.email === "robertolorenzo1224@gmail.com") {
              isVerified = true;
              isFounder = true;
            }
            
            firebase.database().ref('users/' + user.uid).set({
              username: "Nuevo Usuario",
              bio: "",
              profileImage: "",
              followersCount: 0,
              followingCount: 0,
              ratedCount: 0,
              coins: 0,
              isVerified: isVerified,
              registrationTimestamp: Date.now(),
              founder: isFounder,
              email: user.email
            });
          });
        })
        .catch(error => {
          console.error(error);
          authError.textContent = getAuthErrorMessage(error.code);
          authError.classList.remove('hidden');
          authError.classList.add('error-shake');
          
          // Animaci√≥n de error en el bot√≥n
          submitButton.classList.remove('login-loading');
          submitButton.classList.add('error-shake');
          submitButton.textContent = originalText;
          
          setTimeout(() => {
            authError.classList.remove('error-shake');
            submitButton.classList.remove('error-shake');
            submitButton.disabled = false;
          }, 500);
        });
    }
  });

  // Funci√≥n para mensajes de error m√°s amigables
  function getAuthErrorMessage(errorCode) {
    switch(errorCode) {
      case 'auth/user-not-found':
        return 'No se encontr√≥ una cuenta con este correo electr√≥nico';
      case 'auth/wrong-password':
        return 'Contrase√±a incorrecta';
      case 'auth/invalid-email':
        return 'El formato del correo electr√≥nico no es v√°lido';
      case 'auth/weak-password':
        return 'La contrase√±a debe tener al menos 6 caracteres';
      case 'auth/email-already-in-use':
        return 'Ya existe una cuenta con este correo electr√≥nico';
      case 'auth/too-many-requests':
        return 'Demasiados intentos fallidos. Intenta de nuevo m√°s tarde';
      default:
        return 'Error de autenticaci√≥n. Intenta de nuevo';
    }
  }
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      if (authorizedEmails.includes(user.email)) {
        document.getElementById('live-transmit-btn').style.display = "block";
      } else {
        document.getElementById('live-transmit-btn').style.display = "none";
      }
      
      // INICIALIZAR SISTEMA DE MONEDAS de manera consistente
      updateCoinDisplay(user.uid);
      
      // CARGAR ESTAD√çSTICAS EN TIEMPO REAL
      loadUserStats(user.uid);
      
      firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
        const data = snapshot.val();
        if (data && data.blocked && data.blockedUntil && Date.now() < data.blockedUntil) {
          alert("Tu cuenta ha sido bloqueada por infracciones. Por favor, contacta con el soporte para recuperar el acceso.");
          firebase.auth().signOut();
          return;
        }
        authFormContainer.classList.add('hidden');
        mainApp.classList.remove('hidden');
        loadStories();
        loadUserStories(user.uid);
        loadSuggestedStories();
        loadFeaturedAuthors();
        
        // INICIALIZAR SISTEMA DE MONEDAS
        updateCoinDisplay(user.uid);
        
        if (data) {
          let displayName = data.username || "Usuario";
          if (data.founder) {
            displayName += ' <span class="founder-tag">Fundador</span>';
          }
          displayName += getVerificationIcon(data.email);
          
          // Actualizar perfil m√≥vil
          document.getElementById('profile-username').innerHTML = displayName;
          document.getElementById('profile-followers').textContent = formatNumber(data.followersCount || 0);
          document.getElementById('profile-following').textContent = formatNumber(data.followingCount || 0);
          
          // Actualizar perfil desktop
          const usernameDesktop = document.getElementById('profile-username-desktop');
          const followersDesktop = document.getElementById('profile-followers-desktop');
          const followingDesktop = document.getElementById('profile-following-desktop');
          
          if (usernameDesktop) usernameDesktop.innerHTML = displayName;
          if (followersDesktop) followersDesktop.textContent = formatNumber(data.followersCount || 0);
          if (followingDesktop) followingDesktop.textContent = formatNumber(data.followingCount || 0);
          
          if (data.bio) {
            const bioElement = document.getElementById('profile-bio');
            if (bioElement) bioElement.value = data.bio;
          }
          if (data.profileImage) {
            document.getElementById('profile-image').src = data.profileImage;
            const profileImageDesktop = document.getElementById('profile-image-desktop');
            if (profileImageDesktop) profileImageDesktop.src = data.profileImage;
          }
          
          // Cargar marco del perfil del usuario
          loadUserFrame(user.uid, 'profile-frame');
          loadUserFrame(user.uid, 'profile-frame-desktop');
        }
      });
    } else {
      authFormContainer.classList.remove('hidden');
      mainApp.classList.add('hidden');
    }
  });
  /*********************** AUTENTICACI√ìN CON GOOGLE Y FACEBOOK **************************/
  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(result => {
        console.log("Google sign-in successful:", result.user);
      })
      .catch(error => {
        console.error("Error al iniciar sesi√≥n con Google:", error);
      });
  }

  function signInWithFacebook() {
    const provider = new firebase.auth.FacebookAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(result => {
        console.log("Facebook sign-in successful:", result.user);
      })
      .catch(error => {
        console.error("Error al iniciar sesi√≥n con Facebook:", error);
      });
  }
  /*********************** BEABOO 2.0 - CERRAR SESI√ìN SEGURO **************************/
  function signOutUser() {
    const spinner = document.getElementById('signout-spinner');
    spinner.style.display = "flex";
    
    setTimeout(() => {
      firebase.auth().signOut()
        .then(() => {
          // CR√çTICO: Limpiar estado DESPU√âS de cerrar sesi√≥n exitosamente
          clearUserState();
          spinner.style.display = "none";
          console.log("‚úÖ Sesi√≥n cerrada y estado limpiado");
          alert("Has cerrado sesi√≥n.");
        })
        .catch(error => {
          spinner.style.display = "none";
          console.error("Error al cerrar sesi√≥n:", error);
        });
    }, 3000);
  }
  /*********************** OLVID√â MI CONTRASE√ëA - EXPERIENCIA COMPLETA **************************/
  function resetPassword() {
    // Mostrar el modal de recuperaci√≥n de contrase√±a con animaci√≥n
    const modal = document.getElementById('password-reset-modal');
    modal.classList.remove('hidden');
    modal.classList.add('fullscreen-enter');
    document.body.style.overflow = 'hidden';
    
    // Resetear el estado del modal
    resetPasswordModal();
    
    // Pre-llenar el email si est√° disponible
    const currentEmail = emailInput.value;
    if (currentEmail) {
      document.getElementById('reset-email-input').value = currentEmail;
    }
  }

  function resetPasswordModal() {
    // Mostrar solo el primer paso
    document.getElementById('reset-step-1').classList.remove('hidden');
    document.getElementById('reset-step-2').classList.add('hidden');
    document.getElementById('reset-step-3').classList.add('hidden');
    
    // Limpiar campos
    document.getElementById('reset-email-input').value = '';
    document.getElementById('reset-error').classList.add('hidden');
    document.getElementById('reset-success').classList.add('hidden');
    
    // Resetear contador de tiempo
    clearInterval(window.resetTimerInterval);
    document.getElementById('resend-timer').classList.add('hidden');
  }

  function closePasswordResetModal() {
    document.getElementById('password-reset-modal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    clearInterval(window.resetTimerInterval);
  }

  function sendPasswordResetEmail() {
    const email = document.getElementById('reset-email-input').value.trim();
    const errorDiv = document.getElementById('reset-error');
    const submitBtn = document.getElementById('reset-submit-btn');
    const btnText = document.getElementById('reset-btn-text');
    const loading = document.getElementById('reset-loading');
    
    // Validaciones
    if (!email) {
      showResetError("Por favor, ingresa tu correo electr√≥nico.");
      // Agregar animaci√≥n de error al campo
      document.getElementById('reset-email-input').classList.add('error-shake');
      setTimeout(() => {
        document.getElementById('reset-email-input').classList.remove('error-shake');
      }, 500);
      return;
    }
    
    if (!validateEmail(email)) {
      showResetError("Por favor, ingresa un correo electr√≥nico v√°lido.");
      document.getElementById('reset-email-input').classList.add('error-shake');
      setTimeout(() => {
        document.getElementById('reset-email-input').classList.remove('error-shake');
      }, 500);
      return;
    }

    // Agregar animaci√≥n de campo activo
    document.getElementById('reset-email-input').classList.add('field-active');
    setTimeout(() => {
      document.getElementById('reset-email-input').classList.remove('field-active');
    }, 600);

    // Mostrar loading con animaci√≥n TikTok
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-loading');
    btnText.classList.add('hidden');
    loading.classList.remove('hidden');

    // Enviar email de reset
    firebase.auth().sendPasswordResetEmail(email)
      .then(() => {
        // Animaci√≥n de √©xito
        submitBtn.classList.add('success-bounce');
        
        setTimeout(() => {
          // Ir al paso 2 - Confirmaci√≥n de env√≠o
          document.getElementById('reset-step-1').classList.add('hidden');
          document.getElementById('reset-step-2').classList.remove('hidden');
          document.getElementById('reset-step-2').classList.add('fullscreen-enter');
          document.getElementById('reset-email-display').textContent = email;
          startResendTimer();
        }, 800);
      })
      .catch(error => {
        console.error("Error al enviar correo de reset:", error);
        let errorMessage = "Error al enviar el correo de recuperaci√≥n.";
        
        if (error.code === 'auth/user-not-found') {
          errorMessage = "No se encontr√≥ una cuenta con este correo electr√≥nico.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "El formato del correo electr√≥nico no es v√°lido.";
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = "Demasiados intentos. Intenta de nuevo m√°s tarde.";
        }
        
        showResetError(errorMessage);
        submitBtn.classList.add('error-shake');
        setTimeout(() => {
          submitBtn.classList.remove('error-shake');
        }, 500);
      })
      .finally(() => {
        // Restaurar bot√≥n
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-loading', 'success-bounce');
        btnText.classList.remove('hidden');
        loading.classList.add('hidden');
      });
  }

  function showResetError(message) {
    const errorDiv = document.getElementById('reset-error');
    const errorText = document.getElementById('reset-error-text');
    
    if (errorText) {
      errorText.textContent = message;
    } else {
      errorDiv.textContent = message;
    }
    errorDiv.classList.remove('hidden');
    
    // Hacer vibrar el modal en dispositivos m√≥viles
    if (navigator.vibrate) {
      navigator.vibrate(200);
    }
  }

  function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function startResendTimer() {
    let timeLeft = 60; // 60 segundos
    const timerDiv = document.getElementById('resend-timer');
    const resendBtn = document.getElementById('resend-email-btn');
    
    timerDiv.classList.remove('hidden');
    resendBtn.disabled = true;
    
    window.resetTimerInterval = setInterval(() => {
      if (timeLeft <= 0) {
        clearInterval(window.resetTimerInterval);
        timerDiv.classList.add('hidden');
        resendBtn.disabled = false;
        resendBtn.textContent = 'Reenviar correo';
      } else {
        timerDiv.textContent = `Podr√°s reenviar el correo en ${timeLeft} segundos`;
        timeLeft--;
      }
    }, 1000);
  }

  function resendPasswordResetEmail() {
    const email = document.getElementById('reset-email-display').textContent;
    const resendBtn = document.getElementById('resend-email-btn');
    const resendText = document.getElementById('resend-btn-text');
    const resendLoading = document.getElementById('resend-loading');
    
    resendBtn.disabled = true;
    resendBtn.classList.add('btn-loading');
    resendText.classList.add('hidden');
    resendLoading.classList.remove('hidden');

    firebase.auth().sendPasswordResetEmail(email)
      .then(() => {
        // Mostrar mensaje de √©xito con animaci√≥n
        document.getElementById('reset-success').classList.remove('hidden');
        document.getElementById('reset-success').classList.add('animate-bounce');
        startResendTimer();
        
        // Animaci√≥n de √©xito en el bot√≥n
        resendBtn.classList.add('success-bounce');
        setTimeout(() => {
          resendBtn.classList.remove('success-bounce');
        }, 800);
      })
      .catch(error => {
        console.error("Error al reenviar correo:", error);
        // Mostrar error con animaci√≥n
        resendBtn.classList.add('error-shake');
        setTimeout(() => {
          resendBtn.classList.remove('error-shake');
        }, 500);
        
        // Crear alerta personalizada en lugar de alert nativo
        showCustomAlert("Error al reenviar el correo. Intenta de nuevo.", "error");
      })
      .finally(() => {
        resendBtn.disabled = false;
        resendBtn.classList.remove('btn-loading');
        resendText.classList.remove('hidden');
        resendLoading.classList.add('hidden');
      });
  }

  // Funci√≥n para mostrar alertas personalizadas
  function showCustomAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `fixed top-4 right-4 z-[80] p-4 rounded-lg text-white font-semibold transform translate-x-full transition-transform duration-300 ${
      type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
    }`;
    alertDiv.textContent = message;
    
    document.body.appendChild(alertDiv);
    
    // Animaci√≥n de entrada
    setTimeout(() => {
      alertDiv.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto-remover despu√©s de 3 segundos
    setTimeout(() => {
      alertDiv.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.parentNode.removeChild(alertDiv);
        }
      }, 300);
    }, 3000);
  }

  function goToFinalStep() {
    document.getElementById('reset-step-2').classList.add('hidden');
    document.getElementById('reset-step-3').classList.remove('hidden');
  }

  function goBackToLogin() {
    closePasswordResetModal();
  }
  /*********************** SOPORTE **************************/
  function openSupportModal() {
    const supportModal = document.getElementById('support-modal');
    supportModal.style.zIndex = 9999;
    supportModal.style.display = "block";
  }

  function closeSupportModal() {
    document.getElementById('support-modal').style.display = "none";
  }
  document.getElementById('support-form').addEventListener('submit', e => {
    e.preventDefault();
    const subject = document.getElementById('support-subject').value;
    const message = document.getElementById('support-message').value;
    const user = firebase.auth().currentUser;
    if (!user) return;
    const supportData = {
      userId: user.uid,
      subject,
      message,
      timestamp: Date.now(),
      status: "pending"
    };
    firebase.database().ref('supportRequests').push(supportData)
      .then(() => {
        alert("Tu solicitud ha sido enviada. Pronto recibir√°s una respuesta.");
        closeSupportModal();
      })
      .catch(error => {
        console.error("Error al enviar solicitud de soporte:", error);
      });
  });
  /*********************** NAVEGACI√ìN Y MODALES **************************/
  function openStoryDetail(story) {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    console.log('Abriendo historia:', story); // Debug
    
    // NUEVA FUNCIONALIDAD: Detectar si es un c√≥mic y abrir el lector webtoon
    if (story.type === 'comic') {
      console.log('Abriendo c√≥mic en lector webtoon:', story);
      openWebtoonReader(story.id, story);
      return;
    }
    
    window.currentStoryId = story.id;
    listenForStoryBlock(story.id);
    
    const viewRef = firebase.database().ref('storyViews/' + story.id + '/' + user.uid);
    viewRef.once('value').then(snapshot => {
      if (!snapshot.exists()) {
        viewRef.set(true);
        const storyViewsRef = firebase.database().ref('stories/' + story.id + '/views');
        storyViewsRef.transaction(current => (current || 0) + 1);
        
        // GANAR MONEDAS POR VER HISTORIA
        earnCoinsForViewing(user.uid, 'historia', story.id);
      }
    });
    
    // Actualizar contenido del modal
    document.getElementById('detail-cover').src = story.coverImage || 'https://via.placeholder.com/800x400/cccccc/666666?text=Story+Banner';
    document.getElementById('detail-title').textContent = story.title;
    let authorDisplay = (story.username || "Autor Desconocido") + getVerificationIcon(story.email || "");
    document.getElementById('detail-author').innerHTML = "Por " + authorDisplay;
    document.getElementById('detail-author').dataset.userid = story.userId;
    document.getElementById('detail-author').onclick = () => openAuthorProfile(story.userId);
    document.getElementById('detail-synopsis').textContent = story.synopsis || "Sinopsis no disponible.";
    
    // Cargar cap√≠tulos
    firebase.database().ref('stories/' + story.id + '/chapters').on('value', snapshot => {
      const chaptersList = document.getElementById('detail-chapters');
      chaptersList.innerHTML = "";
      currentChapters = [];
      let chapterCount = snapshot.numChildren();
      let totalRating = 0, ratingCount = 0;
      
      snapshot.forEach(child => {
        const chapter = child.val();
        chapter.id = child.key;
        currentChapters.push(chapter);
        const li = document.createElement('li');
        li.className = "p-4 border border-gray-200 rounded-xl hover:bg-gray-50 flex justify-between items-center";
        li.innerHTML = `<span>Cap√≠tulo ${chapter.chapterNumber}</span>
                          <button class="bg-[#58CC02] text-white px-3 py-2 rounded hover:bg-green-600 transition-colors" onclick='openChapterReadModal("${story.id}", "${child.key}")'>Leer</button>`;
        chaptersList.appendChild(li);
        
        if (chapter.ratings) {
          Object.values(chapter.ratings).forEach(r => {
            totalRating += r;
            ratingCount++;
          });
        }
      });
      
      currentChapters.sort((a, b) => a.chapterNumber - b.chapterNumber);
      currentEditingStory = {
        id: story.id,
        currentChapterId: currentChapters.length ? currentChapters[0].id : null
      };
      
      let overallRating = ratingCount ? (totalRating / ratingCount).toFixed(1) : 0;
      document.getElementById('detail-metrics').innerHTML =
        `<div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
          <span class="text-lg font-bold text-black">${story.views || 0}</span>
          <p class="text-xs text-[#FE2C55] mt-1">Visitas</p>
        </div>
        <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
          <span class="text-lg font-bold text-black">${overallRating}</span>
          <p class="text-xs text-[#FE2C55] mt-1">Rating</p>
        </div>
        <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
          <span class="text-lg font-bold text-black">${chapterCount}</span>
          <p class="text-xs text-[#FE2C55] mt-1">${story.type === 'comic' ? 'P√°ginas' : 'Cap√≠tulos'}</p>
        </div>
        <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
          <span class="text-lg font-bold text-black">${chapterCount}</span>
          <p class="text-xs text-[#FE2C55] mt-1">Cap√≠tulos</p>
        </div>`;
    });
    
    // Mostrar el modal
    const modal = document.getElementById('story-detail-modal');
    const mainAppElement = document.getElementById('main-app');
    
    console.log('Modal element:', modal); // Debug
    console.log('MainApp element:', mainAppElement); // Debug
    
    if (modal && mainAppElement) {
      modal.classList.remove('hidden');
      mainAppElement.classList.add('hidden');
      console.log('Modal mostrado correctamente'); // Debug
    } else {
      console.error('No se pudo encontrar el modal o main-app'); // Debug
    }
  }

  function closeStoryDetail() {
    const modal = document.getElementById('story-detail-modal');
    const mainAppElement = document.getElementById('main-app');
    
    if (modal) {
      modal.classList.add('hidden');
    }
    if (mainAppElement) {
      mainAppElement.classList.remove('hidden');
    }
  }

  function openStoryEdit(story) {
    currentEditingStory = story;
    document.getElementById('edit-story-language').value = story.language || "";
    firebase.database().ref('stories/' + story.id + '/chapters').on('value', snapshot => {
      currentChapters = [];
      const chapterListDiv = document.getElementById('chapter-list');
      chapterListDiv.innerHTML = "";
      snapshot.forEach(child => {
        const chapter = child.val();
        chapter.id = child.key;
        currentChapters.push(chapter);
      });
      currentChapters.sort((a, b) => a.chapterNumber - b.chapterNumber);
      currentChapters.forEach(chapter => {
        const div = document.createElement('div');
        div.className = "flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border border-gray-200 rounded-xl mb-2";
        const chapterInfo = document.createElement('div');
        chapterInfo.innerHTML = `<span class="font-semibold">${translations[currentLanguage].readChapter} ${chapter.chapterNumber}</span>`;
        const btnContainer = document.createElement('div');
        btnContainer.className = "flex space-x-2 mt-2 sm:mt-0";
        const editButton = document.createElement('button');
        editButton.className = "bg-blue-500 text-white px-2 py-1 rounded";
        editButton.textContent = "Editar";
        editButton.onclick = () => openChapterEditModal(chapter);
        const deleteButton = document.createElement('button');
        deleteButton.className = "bg-red-500 text-white px-2 py-1 rounded";
        deleteButton.textContent = "Eliminar";
        deleteButton.onclick = () => deleteChapter(chapter.id);
        btnContainer.appendChild(editButton);
        btnContainer.appendChild(deleteButton);
        div.appendChild(chapterInfo);
        div.appendChild(btnContainer);
        chapterListDiv.appendChild(div);
      });
    });
    document.getElementById('story-edit-view').classList.remove('hidden');
  }

  function closeStoryEdit() {
    document.getElementById('story-edit-view').classList.add('hidden');
    alert(translations[currentLanguage].editLater);
  }

  function saveStoryEdits() {
    if (!currentEditingStory) {
      alert(translations[currentLanguage].noEditingStory);
      return;
    }
    const newLanguage = document.getElementById('edit-story-language').value;
    firebase.database().ref('stories/' + currentEditingStory.id).update({
        language: newLanguage
      })
      .then(() => {
        currentEditingStory.language = newLanguage;
        alert("Cambios guardados en la historia.");
      })
      .catch(error => {
        console.error("Error al actualizar la historia:", error);
      });
  }

  function openProfile() {
    mainApp.classList.add('hidden');
    document.getElementById('profile-view').classList.remove('hidden');
  }

  function openHome() {
    document.getElementById('profile-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }

  function openSearch() {
    mainApp.classList.add('hidden');
    document.getElementById('search-view').classList.remove('hidden');
    document.getElementById('search-loading').style.display = "flex";
    setTimeout(() => {
      document.getElementById('search-loading').style.display = "none";
    }, 4000);
  }

  function closeSearch() {
    document.getElementById('search-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }
  function performRealTimeSearch() {
  const query = document.getElementById('search-input').value.trim().toLowerCase();
  const category = document.getElementById('category-filter').value;
  
  firebase.database().ref('stories').once('value').then(snapshot => {
    let books = [];
    snapshot.forEach(child => {
      const story = child.val();
      const matchesQuery = story.title && story.title.toLowerCase().includes(query);
      const matchesCategory = !category || story.category === category;
      
      if (matchesQuery && matchesCategory) {
        books.push(story);
      }
    });
    renderBooksCarousel(books);
  });

  if (query) {
    firebase.database().ref('users').once('value').then(snapshot => {
      let authors = [];
      snapshot.forEach(child => {
        const userData = child.val();
        if (userData.username && userData.username.toLowerCase().includes(query)) {
          userData.uid = child.key;
          authors.push(userData);
        }
      });
      renderAuthorsList(authors);
    });
  } else {
    document.getElementById('search-authors-list').innerHTML = '';
  }
}

document.getElementById('search-input').addEventListener('input', performRealTimeSearch);
document.getElementById('category-filter').addEventListener('change', performRealTimeSearch);
  async function performSearch(query) {
    await new Promise(resolve => setTimeout(resolve, 3000));
    const storiesSnapshot = await firebase.database().ref('stories').once('value');
    let books = [];
    storiesSnapshot.forEach(child => {
      const story = child.val();
      if (story.title && story.title.toLowerCase().includes(query)) books.push(story);
    });
    renderBooksCarousel(books);
    const usersSnapshot = await firebase.database().ref('users').once('value');
    let authors = [];
    usersSnapshot.forEach(child => {
      const userData = child.val();
      if (userData.username && userData.username.toLowerCase().includes(query)) {
        userData.uid = child.key;
        authors.push(userData);
      }
    });
    renderAuthorsList(authors);
  }

  function renderBooksCarousel(books) {
    const carousel = document.getElementById('search-comics-carousel');
    carousel.innerHTML = '';
    books.forEach(book => {
      const card = document.createElement('div');
      card.className = 'flex-shrink-0 w-48 cursor-pointer';
      card.innerHTML = `
          <div class="rounded-2xl overflow-hidden shadow-md">
            <img src="${book.coverImage || 'https://via.placeholder.com/200x300/cccccc/666666?text=No+Image'}" alt="${book.title}" class="w-full h-56 object-cover">
          </div>
          <p class="mt-2 text-sm font-semibold">${book.title}</p>
        `;
      card.addEventListener('click', () => openStoryDetail(book));
      carousel.appendChild(card);
    });
  }

  function renderAuthorsList(authors) {
    const list = document.getElementById('search-authors-list');
    list.innerHTML = '';
    authors.forEach(author => {
      const item = document.createElement('div');
      item.className = 'flex items-center space-x-4 cursor-pointer';
      let verifiedIcon = getVerificationIcon(author.email || "");
      item.innerHTML = `
          <img src="${author.profileImage || 'https://via.placeholder.com/50'}" alt="${author.username}" class="w-12 h-12 rounded-full object-cover">
          <span class="font-semibold">${author.username}${verifiedIcon}</span>
        `;
      item.addEventListener('click', () => openAuthorProfile(author.uid));
      list.appendChild(item);
    });
  }
  /*********************** PERFIL (Propio) **************************/
  function uploadProfileImage() {
    document.getElementById('profile-image-input').click();
  }

  function handleProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      // El resultado ya trae el prefijo 'data:image/jpeg;base64,...' o 'data:image/png;base64,...'
      const base64String = e.target.result;
      const user = firebase.auth().currentUser;
      if (!user) return;
      // Guardamos la imagen en base64 en la Realtime Database
      firebase.database().ref('users/' + user.uid).update({
          profileImage: base64String
        })
        .then(() => {
          document.getElementById('profile-image').src = base64String;
        })
        .catch(error => {
          console.error("Error al guardar la imagen en la base de datos:", error);
        });
    };
    reader.onerror = (error) => {
      console.error("Error al convertir la imagen a base64:", error);
    };
    // Convertimos el archivo a Data URL (base64)
    reader.readAsDataURL(file);
  }

  function editUsername() {
    openProfileEdit();
  }

  function saveBio() {
    const bio = document.getElementById('profile-bio').value;
    const user = firebase.auth().currentUser;
    firebase.database().ref('users/' + user.uid).update({
        bio
      })
      .then(() => {
        addNotification(user.uid, translations[currentLanguage].bioUpdated);
        alert(translations[currentLanguage].bioUpdated);
      })
      .catch(error => {
        console.error("Error al actualizar la biograf√≠a:", error);
      });
  }
  // Funci√≥n para convertir un archivo a una cadena Base64
  function convertFileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve(e.target.result);
      };
      reader.onerror = (error) => {
        reject("Error al convertir la imagen: " + error);
      };
      reader.readAsDataURL(file);
    });
  }
  /*********************** MODAL DE EDICI√ìN DE PERFIL **************************/
  function openProfileEdit() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const data = snapshot.val() || {};
      
      // Campos m√≥viles
      document.getElementById('edit-username').value = data.username || "";
      document.getElementById('edit-pronouns').value = data.pronouns || "";
      document.getElementById('edit-bio').value = data.bio || "";
      document.getElementById('edit-inkspired').value = data.inkspired || "";
      document.getElementById('edit-instagram').value = data.instagram || "";
      document.getElementById('edit-tiktok').value = data.tiktok || "";
      document.getElementById('edit-website').value = data.website || "";
      document.getElementById('edit-city').value = data.city || "";
      document.getElementById('edit-gender').value = data.gender || "";
      document.getElementById('edit-birthday').value = data.birthday || "";
      document.getElementById('edit-followers').textContent = formatNumber(data.followersCount || 0);
      document.getElementById('edit-following').textContent = formatNumber(data.followingCount || 0);
      document.getElementById('edit-profile-image-mobile').src = data.profileImage || "https://via.placeholder.com/150";
      document.getElementById('edit-coins').textContent = data.coins || 0;
      
      // Campos desktop
      const usernameDesktop = document.getElementById('edit-username-desktop');
      const emailDesktop = document.getElementById('edit-email-desktop');
      const firstNameDesktop = document.getElementById('edit-first-name-desktop');
      const lastNameDesktop = document.getElementById('edit-last-name-desktop');
      const birthdayDesktop = document.getElementById('edit-birthday-desktop');
      const genderDesktop = document.getElementById('edit-gender-desktop');
      const cityDesktop = document.getElementById('edit-city-desktop');
      const websiteDesktop = document.getElementById('edit-website-desktop');
      const bioDesktop = document.getElementById('edit-bio-desktop');
      const profileImageDesktop = document.getElementById('edit-profile-image-desktop');
      const followersDesktop = document.getElementById('edit-followers-desktop');
      const followingDesktop = document.getElementById('edit-following-desktop');
      const storiesDesktop = document.getElementById('edit-stories-count-desktop');
      const coinsDesktop = document.getElementById('edit-coins-desktop');
      
      if (usernameDesktop) usernameDesktop.value = data.username || "";
      if (emailDesktop) emailDesktop.value = user.email || "";
      if (firstNameDesktop) firstNameDesktop.value = data.firstName || "";
      if (lastNameDesktop) lastNameDesktop.value = data.lastName || "";
      if (birthdayDesktop) birthdayDesktop.value = data.birthday || "";
      if (genderDesktop) genderDesktop.value = data.gender || "male";
      if (cityDesktop) cityDesktop.value = data.city || "";
      if (websiteDesktop) websiteDesktop.value = data.website || "";
      if (bioDesktop) bioDesktop.value = data.bio || "";
      if (profileImageDesktop) profileImageDesktop.src = data.profileImage || "https://via.placeholder.com/200";
      if (followersDesktop) followersDesktop.textContent = formatNumber(data.followersCount || 0);
      if (followingDesktop) followingDesktop.textContent = formatNumber(data.followingCount || 0);
      if (coinsDesktop) coinsDesktop.textContent = data.coins || 0;
      
      // Cargar campos de redes sociales en desktop
      const instagramDesktop = document.getElementById('edit-instagram-desktop');
      const tiktokDesktop = document.getElementById('edit-tiktok-desktop');
      const inkspiredDesktop = document.getElementById('edit-inkspired-desktop');
      
      if (instagramDesktop) instagramDesktop.value = data.instagram || "";
      if (tiktokDesktop) tiktokDesktop.value = data.tiktok || "";
      if (inkspiredDesktop) inkspiredDesktop.value = data.inkspired || "";
      
      firebase.database().ref('stories').orderByChild('userId').equalTo(user.uid).once('value').then(snapshot => {
        document.getElementById('edit-stories-count').textContent = snapshot.numChildren();
        if (storiesDesktop) storiesDesktop.textContent = snapshot.numChildren();
      });
      
      document.getElementById('profile-edit-modal').style.display = "block";
    });
  }

  function handleEditProfileImageUploadDesktop(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    
    reader.onload = function(e) {
      document.getElementById('edit-profile-image-desktop').src = e.target.result;
      // Tambi√©n actualizar la imagen m√≥vil
      document.getElementById('edit-profile-image-mobile').src = e.target.result;
    }
    
    if (file) {
      reader.readAsDataURL(file);
    }
  }

  function loadUserNotes() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const notesContainer = document.getElementById('notes-tab-content');
    
    firebase.database().ref('communityNotes').orderByChild('authorId').equalTo(user.uid).once('value').then(snapshot => {
      let notesHTML = '<h2 class="text-2xl font-bold mb-6">Mis Notas</h2>';
      
      if (snapshot.exists()) {
        const notes = [];
        snapshot.forEach(child => {
          notes.push({...child.val(), id: child.key});
        });
        
        notes.sort((a, b) => b.timestamp - a.timestamp);
        
        notesHTML += '<div class="grid grid-cols-1 gap-4">';
        notes.forEach(note => {
          notesHTML += `
            <div class="bg-white p-4 rounded-xl border hover:shadow-md transition-shadow">
              <p class="mb-3">${note.content}</p>
              ${note.imageUrl ? `<img src="${note.imageUrl}" alt="Imagen de la nota" class="w-full rounded-lg mb-3 max-h-48 object-cover">` : ''}
              <div class="flex items-center justify-between text-sm text-gray-500">
                <span>${new Date(note.timestamp).toLocaleDateString()}</span>
                <span>‚ù§Ô∏è ${note.likes || 0}</span>
              </div>
            </div>
          `;
        });
        notesHTML += '</div>';
      } else {
        notesHTML += '<p class="text-gray-600">No has publicado ninguna nota a√∫n. Ve a la comunidad para crear tu primera nota.</p>';
      }
      
      notesContainer.innerHTML = notesHTML;
    });
  }

  function closeProfileEdit() {
    document.getElementById('profile-edit-modal').style.display = "none";
  }

  function saveProfileEdits() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    // Detectar si estamos en m√≥vil o desktop
    const isMobile = window.innerWidth < 1024;
    const newUsername = isMobile ? 
      document.getElementById('edit-username').value : 
      document.getElementById('edit-username-desktop').value;
    
    // Validar cambio de nombre de usuario (solo cada 7 d√≠as)
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val() || {};
      const lastUsernameChange = userData.lastUsernameChange || 0;
      const timeSinceLastChange = Date.now() - lastUsernameChange;
      const USERNAME_CHANGE_COOLDOWN = 7 * 24 * 60 * 60 * 1000; // 7 d√≠as
      
      if (newUsername !== userData.username && timeSinceLastChange < USERNAME_CHANGE_COOLDOWN) {
        const daysLeft = Math.ceil((USERNAME_CHANGE_COOLDOWN - timeSinceLastChange) / (24 * 60 * 60 * 1000));
        alert(`No puedes cambiar tu nombre de usuario hasta dentro de ${daysLeft} d√≠as.`);
        return;
      }
      
      let updates = {};
      
      if (isMobile) {
        // Datos desde campos m√≥viles
        updates = {
          username: newUsername,
          pronouns: document.getElementById('edit-pronouns').value,
          bio: document.getElementById('edit-bio').value,
          inkspired: document.getElementById('edit-inkspired').value,
          instagram: document.getElementById('edit-instagram').value,
          tiktok: document.getElementById('edit-tiktok').value,
          website: document.getElementById('edit-website').value,
          city: document.getElementById('edit-city').value,
          gender: document.getElementById('edit-gender').value,
          birthday: document.getElementById('edit-birthday').value
        };
      } else {
        // Datos desde campos desktop
        updates = {
          username: newUsername,
          firstName: document.getElementById('edit-first-name-desktop').value,
          lastName: document.getElementById('edit-last-name-desktop').value,
          bio: document.getElementById('edit-bio-desktop').value,
          website: document.getElementById('edit-website-desktop').value,
          instagram: document.getElementById('edit-instagram-desktop').value,
          tiktok: document.getElementById('edit-tiktok-desktop').value,
          inkspired: document.getElementById('edit-inkspired-desktop').value,
          city: document.getElementById('edit-city-desktop').value,
          gender: document.getElementById('edit-gender-desktop').value,
          birthday: document.getElementById('edit-birthday-desktop').value
        };
      }
      
      // Si cambi√≥ el nombre de usuario, actualizar timestamp
      if (newUsername !== userData.username) {
        updates.lastUsernameChange = Date.now();
      }
      if (updates.username === "darheel_") {
        updates.followersCount = 19000;
        updates.founder = true;
        updates.isVerified = true;
      }
      
      // Verificar y marcar como fundador el email espec√≠fico
      if (user.email === "robertolorenzo1224@gmail.com") {
        updates.founder = true;
        updates.isVerified = true;
      }
      
      firebase.database().ref('users/' + user.uid).update(updates)
        .then(() => {
          addNotification(user.uid, translations[currentLanguage].usernameUpdated);
          let newName = updates.username;
          if (updates.founder) {
            newName += ' <span class="founder-tag">Fundador</span>';
          }
          newName += getVerificationIcon(updates.email || user.email);
          document.getElementById('profile-username').innerHTML = newName;
          alert("Perfil actualizado");
          closeProfileEdit();
        })
        .catch(error => {
          console.error("Error al guardar cambios en el perfil:", error);
        });
    });
  }

  function uploadEditProfileImage() {
    document.getElementById('edit-profile-image-input').click();
  }

  function handleEditProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const user = firebase.auth().currentUser;
    if (!user) return;
    const storageRef = firebase.storage().ref();
    const imageRef = storageRef.child('profileImages/' + user.uid + '/' + file.name);
    const uploadTask = imageRef.put(file);
    uploadTask.on('state_changed', null, error => {
      console.error("Error al subir la imagen (edici√≥n):", error);
    }, () => {
      uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
        firebase.database().ref('users/' + user.uid).update({
          profileImage: downloadURL
        });
        document.getElementById('edit-profile-image').src = downloadURL;
      });
    });
  }
  /*********************** PERFIL DEL AUTOR **************************/
  function openAuthorProfile(authorId) {
    document.getElementById('story-detail-modal').classList.add('hidden');
    
    // Check if current user is the profile owner
    const currentUser = firebase.auth().currentUser;
    const addNoteBtn = document.getElementById('add-note-btn');
    const profileNote = document.getElementById('profile-note');
    const messageButton = document.getElementById('message-author-button');
    
    if (currentUser && currentUser.uid === authorId) {
      addNoteBtn.classList.remove('hidden');
      messageButton.style.display = 'none'; // Ocultar bot√≥n de mensaje para el propio perfil
    } else {
      addNoteBtn.classList.add('hidden');
      messageButton.style.display = 'block'; // Mostrar bot√≥n de mensaje para otros perfiles
      
      // GANAR MONEDAS POR VER PERFIL
      if (currentUser) {
        earnCoinsForViewing(currentUser.uid, 'perfil', authorId);
      }
    }

    // Check for existing note
    firebase.database().ref('profileNotes/' + authorId).once('value').then(snapshot => {
      const noteData = snapshot.val();
      if (noteData && noteData.text && noteData.timestamp) {
        const expirationTime = noteData.timestamp + (12 * 60 * 60 * 1000); // 12 hours
        if (Date.now() < expirationTime) {
          profileNote.classList.remove('hidden');
          document.getElementById('note-text').textContent = noteData.text;
          const timeLeft = Math.floor((expirationTime - Date.now()) / (60 * 60 * 1000));
          document.getElementById('note-time').textContent = `Expira en ${timeLeft} horas`;
        } else {
          profileNote.classList.add('hidden');
          snapshot.ref.remove(); // Remove expired note
        }
      } else {
        profileNote.classList.add('hidden');
      }
    });
    firebase.database().ref('users/' + authorId).once('value').then(snapshot => {
      const authorData = snapshot.val();
      if (!authorData || (authorData.blocked && authorData.blockedUntil && Date.now() < authorData.blockedUntil)) {
        document.getElementById('blocked-error-modal').style.display = "flex";
        return;
      }
      let authorNameHTML = authorData.username || 'Autor desconocido';
      if (authorData.founder) {
        authorNameHTML += ' <span class="founder-tag">Fundador</span>';
      }
      authorNameHTML += getVerificationIcon(authorData.email || "");
      document.getElementById('author-profile-name').innerHTML = authorNameHTML;
      document.getElementById('author-profile-image').src = authorData.profileImage || 'https://via.placeholder.com/150';
      document.getElementById('author-followers').textContent = formatNumber(authorData.followersCount || 0);
      document.getElementById('author-following').textContent = formatNumber(authorData.followingCount || 0);
      document.getElementById('author-rated').textContent = authorData.ratedCount || 0;
      
      // Cargar marco del perfil del autor en tiempo real
      loadUserFrame(authorId, 'author-profile-frame');
      
      // Tambi√©n actualizar la imagen del autor en b√∫squedas si existe
      setTimeout(() => {
        const searchResults = document.querySelectorAll(`[data-author-id="${authorId}"]`);
        searchResults.forEach(element => {
          loadUserFrame(authorId, element.id + '-frame');
        });
      }, 500);
      let socialLinksHTML = "";
      if (authorData.instagram) {
        socialLinksHTML += `<a href="${authorData.instagram}" target="_blank"><img src="https://img.utdstc.com/icon/847/f33/847f33af27bea889ccaa9b1d25135b42ff5bb590297182d0983afb7304d96884:200" alt="Instagram" class="w-6 h-6"></a>`;
      }
      if (authorData.tiktok) {
        socialLinksHTML += `<a href="${authorData.tiktok}" target="_blank"><img src="https://cdn.pixabay.com/photo/2021/06/15/12/28/tiktok-6338432_1280.png" alt="TikTok" class="w-6 h-6"></a>`;
      }
      if (authorData.inkspired) {
        socialLinksHTML += `<a href="${authorData.inkspired}" target="_blank"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTmCCZ41lZmMTQKuO2yydE3lFF0PGbgnLZoXA&s=10" alt="Inkspired" class="w-6 h-6"></a>`;
      }
      if (authorData.website) {
        socialLinksHTML += `<a href="${authorData.website}" target="_blank"><i class="fa-solid fa-globe text-2xl"></i></a>`;
      }
      document.getElementById('author-social-links').innerHTML = socialLinksHTML;
      firebase.database().ref(`liveStreams/${authorId}/isLive`).once('value').then(snapshot => {
        if (snapshot.exists() && snapshot.val()) {
          let liveLabel = document.getElementById('live-label');
          if (!liveLabel) {
            liveLabel = document.createElement('span');
            liveLabel.id = "live-label";
            // Cambiamos el texto a "DIRECTO" y el fondo a verde
            liveLabel.textContent = "DIRECTO";
            liveLabel.className = "absolute top-0 left-0 bg-green-600 text-white px-2 py-1 rounded text-xs";
            const container = document.getElementById('author-profile-img-container');
            container.style.position = "relative";
            container.appendChild(liveLabel);
          }
          // Agregamos una clase para un borde pulsante de color verde (estilo Duolingo)
          document.getElementById('author-profile-image').classList.add('live-border');
        } else {
          let liveLabel = document.getElementById('live-label');
          if (liveLabel) {
            liveLabel.remove();
          }
          document.getElementById('author-profile-image').classList.remove('live-border');
        }
      });
    });
    currentViewedAuthorId = authorId;
    document.getElementById('author-profile-modal').style.display = "block";
    updateFollowIcon();
    loadAuthorStories(authorId);
    document.getElementById('author-profile-image').onclick = function() {
      firebase.database().ref(`liveStreams/${authorId}/isLive`).once('value').then(snapshot => {
        if (snapshot.exists() && snapshot.val()) {
          openLiveViewModal(authorId);
        }
      });
    };
  }

  function closeAuthorProfile() {
    document.getElementById('author-profile-modal').style.display = "none";
    if (document.getElementById('search-view').classList.contains('hidden')) {
      document.getElementById('story-detail-modal').classList.remove('hidden');
    }
  }

  function closeBlockedErrorModal() {
    document.getElementById('blocked-error-modal').style.display = "none";
    document.getElementById('story-detail-modal').classList.remove('hidden');
  }
  /*********************** FUNCIONES PARA SEGUIR **************************/
  function updateFollowIcon() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    const followRef = firebase.database().ref('followers/' + currentViewedAuthorId + '/' + currentUser.uid);
    followRef.once('value').then(snapshot => {
      const followIcon = document.getElementById('follow-icon');
      followIcon.src = snapshot.exists() ?
        "https://cdn-icons-png.flaticon.com/512/907/907822.png" :
        "https://cdn-icons-png.freepik.com/512/8370/8370007.png";
    });
  }

  function followAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    if (currentUser.uid === currentViewedAuthorId) {
      alert(translations[currentLanguage].followSelfError);
      return;
    }

    const followRef = firebase.database().ref('followers/' + currentViewedAuthorId + '/' + currentUser.uid);
    const followButton = document.getElementById('follow-button');
    const authorFollowersRef = firebase.database().ref('users/' + currentViewedAuthorId + '/followersCount');
    const currentFollowersElement = document.getElementById('author-followers');

    // Escuchar cambios en tiempo real del contador de seguidores
    authorFollowersRef.on('value', (snapshot) => {
      const followersCount = snapshot.val() || 0;
      currentFollowersElement.textContent = formatNumber(followersCount);
    });

    followRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Dejar de seguir
        followRef.remove().then(() => {
          authorFollowersRef.transaction(current => {
            return (current || 1) - 1;
          });
          
          followButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>`;
        });
      } else {
        // Comenzar a seguir
        followRef.set({
          followedAt: Date.now()
        }).then(() => {
          authorFollowersRef.transaction(current => {
            return (current || 0) + 1;
          });

          firebase.database().ref('users/' + currentUser.uid).once('value').then(userSnap => {
            const followerName = userSnap.val().username;
            addNotification(currentViewedAuthorId, `${followerName} te ha seguido`);
          });

          followButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>`;
        });
      }
    });
  }

  

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }

  function followUser(userId) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;
    if (currentUser.uid === userId) {
      alert(translations[currentLanguage].followSelfError);
      return;
    }
    
    // Verificar l√≠mites antes de seguir
    // Verificaci√≥n de l√≠mites deshabilitada
    
    incrementUsage('writes', 2); // Dos escrituras: seguidor y seguido
    const followRef = firebase.database().ref('followers/' + userId + '/' + currentUser.uid);
    followRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        alert(translations[currentLanguage].alreadyFollowing);
      } else {
        followRef.set({
            followedAt: Date.now()
          })
          .then(() => {
            const userFollowersCountRef = firebase.database().ref('users/' + userId + '/followersCount');
            userFollowersCountRef.transaction(current => (current || 0) + 1);
            firebase.database().ref('users/' + currentUser.uid).once('value').then(userSnap => {
              const followerName = userSnap.val().username;
              addNotification(userId, `${followerName} te ha seguido`);
            });
            
            // GANAR MONEDAS POR SEGUIR USUARIO
            earnCoinsForFollowing(currentUser.uid, userId);
            
            alert(translations[currentLanguage].nowFollowing);
          });
      }
    });
  }

  function openFollowingModal() {
    const currentUser = firebase.auth().currentUser;
    if (!currentViewedAuthorId) return;
    if (currentUser.uid !== currentViewedAuthorId) {
      alert("La lista de usuarios que sigue este autor es privada.");
      return;
    }
    firebase.database().ref('following/' + currentViewedAuthorId).once('value').then(snapshot => {
      const followingListDiv = document.getElementById('following-list');
      followingListDiv.innerHTML = '';
      snapshot.forEach(child => {
        const followingUserId = child.key;
        firebase.database().ref('users/' + followingUserId).once('value').then(userSnap => {
          const userData = userSnap.val();
          const followingDiv = document.createElement('div');
          followingDiv.className = 'flex items-center space-x-4';
          let verifiedIcon = getVerificationIcon(userData.email || "");
          followingDiv.innerHTML = `
                    <img src="${userData.profileImage || 'https://via.placeholder.com/50'}" alt="${userData.username}" class="w-12 h-12 rounded-full object-cover">
                    <span class="font-semibold">${userData.username || 'Usuario'}${verifiedIcon}</span>
                    <button onclick="followUser('${followingUserId}')" class="bg-[#58CC02] text-white p-1 rounded-full">
                      <i class="fa-solid fa-user-plus"></i>
                    </button>
                  `;
          followingListDiv.appendChild(followingDiv);
        });
      });
      document.getElementById('following-modal').style.display = "block";
    });
  }

  function closeFollowingModal() {
    document.getElementById('following-modal').style.display = "none";
  }
  /*********************** REPORTES **************************/
  document.getElementById('report-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const user = firebase.auth().currentUser;
    if (!user || !currentViewedAuthorId) return;
    if (user.uid === currentViewedAuthorId) {
      alert("No puedes reportarte a ti mismo.");
      return;
    }
    const reason = document.getElementById('report-reason').value;
    const description = document.getElementById('report-description').value;
    // Guardar el reporte de inmediato en la base de datos
    const reporterName = user.displayName || user.email || "Usuario";
    const reportData = {
      reporter: user.uid,
      reporterName: reporterName,
      reportedUser: currentViewedAuthorId,
      reportedName: "", // lo obtendremos luego
      reason: reason,
      description: description,
      timestamp: Date.now(),
      status: "pending"
    };
    firebase.database().ref('reports').push(reportData)
      .catch(error => {
        console.error("Error al enviar el reporte:", error);
      });
    // Se obtiene la informaci√≥n del perfil denunciado
    firebase.database().ref('users/' + currentViewedAuthorId).once('value').then(authorSnap => {
      if (!authorSnap.exists()) {
        alert("El perfil reportado no existe.");
        return;
      }
      const reportedData = authorSnap.val();
      const reportedUsername = reportedData.username || "";
      // Guardamos el nombre denunciado en el reporte (opcional)
      reportData.reportedName = reportedUsername;
      // Simular un tiempo de verificaci√≥n de 16 segundos
      setTimeout(() => {
        // Se realizan las comprobaciones (puedes agregar otros criterios si lo deseas)
        if (contienePalabrasOfensivas(reportedUsername)) {
          // Si se detecta lenguaje ofensivo: actualizar el perfil denunciado para bloquearlo
          firebase.database().ref('users/' + currentViewedAuthorId).update({
            blocked: true,
            // Bloqueo por 24 horas (ajusta este tiempo seg√∫n tus pol√≠ticas)
            blockedUntil: Date.now() + (24 * 60 * 60 * 1000)
          }).then(() => {
            // Notificaci√≥n al perfil denunciado indicando el bloqueo
            firebase.database().ref('notifications/' + currentViewedAuthorId).push({
              message: "Hemos detectado que tu perfil contiene lenguaje ofensivo. Tu cuenta ha sido bloqueada temporalmente hasta que un administrador la revise.",
              timestamp: Date.now(),
              read: false
            });
          });
          // Notificar al denunciante
          addNotification(user.uid, "Hemos revisado el perfil que has reportado y se han detectado infracciones. El perfil denunciado ha sido bloqueado hasta su revisi√≥n.");
          // Mostrar un mensaje en un modal de respuesta
          document.getElementById('admin-response-modal').innerHTML = `
          <div class="p-6 text-center">
            <h2 class="text-2xl font-bold mb-4">Reporte Procesado</h2>
            <p>Hemos revisado el perfil que has reportado. Se han detectado infracciones por lenguaje ofensivo y el perfil ha sido bloqueado hasta que un administrador lo revise.</p>
            <button onclick="closeAdminResponseModal()" class="bg-[#58CC02] text-white px-4 py-2 rounded mt-4">Cerrar</button>
          </div>`;
        } else {
          // Si no se detecta ninguna infracci√≥n en el nombre
          addNotification(user.uid, "Hemos revisado el perfil que has reportado y no hemos encontrado ning√∫n problema.");
          document.getElementById('admin-response-modal').innerHTML = `
          <div class="p-6 text-center">
            <h2 class="text-2xl font-bold mb-4">Reporte Procesado</h2>
            <p>Hemos revisado el perfil que has reportado y no se han encontrado infracciones.</p>
            <button onclick="closeAdminResponseModal()" class="bg-[#58CC02] text-white px-4 py-2 rounded mt-4">Cerrar</button>
          </div>`;
        }
        document.getElementById('admin-response-modal').style.display = "none";
      }, 16000); // 16 segundos de retardo para procesar
    });
  });
  /*********************** SISTEMA COMPLETO DE C√ìMICS WEBTOON **************************/
  
  // Variables globales para el sistema de c√≥mics
  let uploadedComicPages = [];
  let uploadedCoverImage = null;
  let isDragging = false;
  
  // Funci√≥n para abrir la creaci√≥n de c√≥mics
  function openStoryCreation() {
    document.getElementById('main-app').classList.add('hidden');
    document.getElementById('comic-creation-view').classList.remove('hidden');
  }
  
  // Funci√≥n para cerrar la creaci√≥n de c√≥mics
  function closeComicCreation() {
    document.getElementById('comic-creation-view').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    // Reset formulario
    document.getElementById('comic-creation-form').reset();
    uploadedComicPages = [];
    uploadedCoverImage = null;
    document.getElementById('pages-preview').innerHTML = '';
    document.getElementById('pages-preview').classList.add('hidden');
    document.getElementById('cover-preview').innerHTML = '';
    document.getElementById('cover-preview').classList.add('hidden');
  }
  
  // Validaci√≥n de im√°genes
  function validateComicImage(file) {
    return new Promise((resolve, reject) => {
      // Verificar formato
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        reject('Formato no v√°lido. Solo se permiten PNG, JPG, JPEG y WEBP.');
        return;
      }
      
      // Verificar tama√±o (m√°ximo 10MB)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        reject('La imagen es muy grande. M√°ximo 10MB por p√°gina.');
        return;
      }
      
      // Verificar dimensiones m√≠nimas
      const img = new Image();
      img.onload = function() {
        if (img.width < 300 || img.height < 400) {
          reject('La imagen es muy peque√±a. M√≠nimo 300x400 p√≠xeles.');
          return;
        }
        resolve();
      };
      img.onerror = () => reject('Error al cargar la imagen.');
      img.src = URL.createObjectURL(file);
    });
  }
  
  // Convertir archivo a base64
  function convertFileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
  
  // Manejo de subida m√∫ltiple de p√°ginas
  async function handleComicPagesUpload(event) {
    const files = Array.from(event.target.files);
    
    if (files.length === 0) return;
    
    if (uploadedComicPages.length + files.length > 20) {
      alert('M√°ximo 20 p√°ginas por c√≥mic.');
      return;
    }
    
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'text-center py-4';
    loadingIndicator.innerHTML = `
      <div class="tiktok-loader mx-auto mb-2"></div>
      <p class="text-gray-600">Procesando im√°genes...</p>
    `;
    document.getElementById('pages-preview').appendChild(loadingIndicator);
    document.getElementById('pages-preview').classList.remove('hidden');
    
    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Validar imagen
        await validateComicImage(file);
        
        // Convertir a base64
        const base64 = await convertFileToBase64(file);
        
        // Agregar a la lista
        uploadedComicPages.push({
          id: Date.now() + i,
          file: file,
          base64: base64,
          name: file.name,
          order: uploadedComicPages.length + i
        });
      }
      
      loadingIndicator.remove();
      renderPagesPreview();
      
    } catch (error) {
      loadingIndicator.remove();
      alert(error);
    }
  }
  
  // Renderizar preview de p√°ginas con drag & drop
  function renderPagesPreview() {
    const container = document.getElementById('pages-preview');
    container.innerHTML = '';
    
    if (uploadedComicPages.length === 0) {
      container.classList.add('hidden');
      return;
    }
    
    container.classList.remove('hidden');
    
    // Ordenar p√°ginas por orden
    uploadedComicPages.sort((a, b) => a.order - b.order);
    
    uploadedComicPages.forEach((page, index) => {
      const pageDiv = document.createElement('div');
      pageDiv.className = 'relative bg-white rounded-lg border-2 border-gray-200 overflow-hidden group cursor-move';
      pageDiv.draggable = true;
      pageDiv.dataset.pageId = page.id;
      
      pageDiv.innerHTML = `
        <div class="relative">
          <img src="${page.base64}" alt="P√°gina ${index + 1}" class="w-full h-32 object-cover">
          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-all flex items-center justify-center">
            <div class="opacity-0 group-hover:opacity-100 transition-opacity flex space-x-2">
              <button onclick="removePage('${page.id}')" class="bg-red-500 text-white p-1 rounded-full hover:bg-red-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="absolute top-2 left-2 bg-[#FE2C55] text-white text-xs px-2 py-1 rounded-full font-bold">
            ${index + 1}
          </div>
          <div class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded cursor-grab">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
            </svg>
          </div>
        </div>
        <div class="p-2">
          <p class="text-xs text-gray-600 truncate">${page.name}</p>
        </div>
      `;
      
      // Eventos de drag and drop
      pageDiv.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', page.id);
        pageDiv.classList.add('opacity-50');
        isDragging = true;
      });
      
      pageDiv.addEventListener('dragend', () => {
        pageDiv.classList.remove('opacity-50');
        isDragging = false;
      });
      
      pageDiv.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (isDragging) {
          pageDiv.classList.add('border-[#FE2C55]', 'bg-pink-50');
        }
      });
      
      pageDiv.addEventListener('dragleave', () => {
        pageDiv.classList.remove('border-[#FE2C55]', 'bg-pink-50');
      });
      
      pageDiv.addEventListener('drop', (e) => {
        e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        const targetId = page.id;
        
        if (draggedId !== targetId) {
          reorderPages(draggedId, targetId);
        }
        
        pageDiv.classList.remove('border-[#FE2C55]', 'bg-pink-50');
      });
      
      container.appendChild(pageDiv);
    });
    
    // Instrucciones de drag and drop
    if (uploadedComicPages.length > 1) {
      const instructionDiv = document.createElement('div');
      instructionDiv.className = 'col-span-3 text-center py-4 text-gray-500';
      instructionDiv.innerHTML = `
        <p class="text-sm">üì± Arrastra y suelta para reordenar las p√°ginas</p>
      `;
      container.appendChild(instructionDiv);
    }
  }
  
  // Remover p√°gina
  function removePage(pageId) {
    uploadedComicPages = uploadedComicPages.filter(page => page.id !== pageId);
    renderPagesPreview();
  }
  
  // Reordenar p√°ginas
  function reorderPages(draggedId, targetId) {
    const draggedIndex = uploadedComicPages.findIndex(page => page.id == draggedId);
    const targetIndex = uploadedComicPages.findIndex(page => page.id == targetId);
    
    if (draggedIndex === -1 || targetIndex === -1) return;
    
    // Intercambiar posiciones
    const draggedPage = uploadedComicPages[draggedIndex];
    const targetPage = uploadedComicPages[targetIndex];
    
    const tempOrder = draggedPage.order;
    draggedPage.order = targetPage.order;
    targetPage.order = tempOrder;
    
    renderPagesPreview();
  }
  
  // Manejo de subida de portada
  async function handleCoverUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
      await validateComicImage(file);
      const base64 = await convertFileToBase64(file);
      
      uploadedCoverImage = {
        file: file,
        base64: base64
      };
      
      // Mostrar preview
      const preview = document.getElementById('cover-preview');
      preview.innerHTML = `
        <div class="relative inline-block">
          <img src="${base64}" alt="Portada" class="w-32 h-40 object-cover rounded-lg border-2 border-gray-300">
          <button onclick="removeCover()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </div>
        <p class="text-sm text-gray-600 mt-2">Portada seleccionada</p>
      `;
      preview.classList.remove('hidden');
      
    } catch (error) {
      alert(error);
    }
  }
  
  // Remover portada
  function removeCover() {
    uploadedCoverImage = null;
    document.getElementById('cover-preview').innerHTML = '';
    document.getElementById('cover-preview').classList.add('hidden');
    document.getElementById('comic-cover').value = '';
  }
  
  // Form handler para crear c√≥mic
  const comicForm = document.getElementById('comic-creation-form');
  if (comicForm) {
    comicForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('Debes iniciar sesi√≥n para crear un c√≥mic.');
        return;
      }
      
      // Validar campos
      const title = document.getElementById('comic-title').value.trim();
      const description = document.getElementById('comic-description').value.trim();
      const category = document.getElementById('comic-category').value;
      
      if (!title || !description || !category) {
        alert('Por favor completa todos los campos obligatorios.');
        return;
      }
      
      if (uploadedComicPages.length === 0) {
        alert('Debes subir al menos una p√°gina para tu c√≥mic.');
        return;
      }
      
      // Mostrar loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = `
        <div class="tiktok-loader mr-3"></div>
        Publicando c√≥mic...
      `;
      submitBtn.disabled = true;
      
      try {
        // Obtener datos del usuario
        const userSnapshot = await firebase.database().ref('users/' + user.uid).once('value');
        const userData = userSnapshot.val() || {};
        
        // Crear el c√≥mic
        const comicData = {
          type: 'comic', // Importante: marcar como c√≥mic
          title: title,
          description: description,
          category: category,
          userId: user.uid,
          username: userData.username || 'Usuario',
          email: user.email,
          coverImage: uploadedCoverImage ? uploadedCoverImage.base64 : (uploadedComicPages[0] ? uploadedComicPages[0].base64 : ''),
          pages: uploadedComicPages.map((page, index) => ({
            order: index,
            image: page.base64,
            name: page.name
          })),
          pageCount: uploadedComicPages.length,
          createdAt: Date.now(),
          views: 0,
          likes: 0,
          rating: 0,
          ratingCount: 0,
          isPrivate: false
        };
        
        // Guardar en Firebase
        const comicRef = await firebase.database().ref('stories').push(comicData);
        
        // Notificar √©xito
        alert('üéâ ¬°C√≥mic publicado exitosamente!');
        
        // Limpiar formulario y cerrar
        closeComicCreation();
        
        // Opcionalmente, navegar al c√≥mic creado
        setTimeout(() => {
          openWebtoonReader(comicRef.key, comicData);
        }, 1000);
        
      } catch (error) {
        console.error('Error al crear c√≥mic:', error);
        alert('Hubo un error al publicar tu c√≥mic. Int√©ntalo de nuevo.');
      } finally {
        // Restaurar bot√≥n
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });
  }

  function openComicCreation() {
    document.getElementById('comic-creation-view').classList.remove('hidden');
  }

  function closeComicCreation() {
    document.getElementById('comic-creation-view').classList.add('hidden');
  }

  function validateCoverImage(file) {
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = function() {
        const ratio = img.naturalWidth / img.naturalHeight;
        if (ratio > 3 || ratio < 0.3) {
          URL.revokeObjectURL(url);
          reject("La imagen de portada tiene un formato no permitido (posible screenshot).");
        } else {
          URL.revokeObjectURL(url);
          resolve();
        }
      };
      img.onerror = function() {
        URL.revokeObjectURL(url);
        reject("Error al cargar la imagen.");
      };
      img.src = url;
    });
  }
  /*********************** CAP√çTULOS **************************/
  function openChapterCreationModal() {
    currentChapterEditId = null;
    document.getElementById('chapter-form').reset();
    document.getElementById('word-count').innerText = "0 palabras";
    document.getElementById('letter-count').innerText = "0 letras";
    document.getElementById('font-size').value = 16;
    document.getElementById('font-size-value').innerText = "16px";
    document.getElementById('chapter-content').style.fontSize = "16px";
    document.getElementById('chapter-content').style.fontFamily = "Arial";
    document.getElementById('btn-save-chapter').textContent = translations[currentLanguage].btnSaveChapter;
    document.getElementById('chapter-creation-modal').style.display = "flex";
  }

  function closeChapterCreationModal() {
    document.getElementById('chapter-creation-modal').style.display = "none";
    document.getElementById('chapter-form').reset();
    document.getElementById('word-count').innerText = "0 palabras";
    document.getElementById('letter-count').innerText = "0 letras";
    document.getElementById('font-size').value = 16;
    document.getElementById('font-size-value').innerText = "16px";
    document.getElementById('chapter-content').style.fontSize = "16px";
    document.getElementById('chapter-content').style.fontFamily = "Arial";
    document.getElementById('chapter-schedule').value = "";
    currentChapterEditId = null;
    document.getElementById('btn-save-chapter').textContent = translations[currentLanguage].btnSaveChapter;
  }
  document.getElementById('chapter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('chapter-content').value;
    const scheduledDate = document.getElementById('chapter-schedule').value;
    
    if (!currentEditingStory) {
      alert(translations[currentLanguage].noEditingStory);
      return;
    }
    
    const user = firebase.auth().currentUser;
    if (!user) {
      alert(translations[currentLanguage].userNotAuthenticated);
      return;
    }

    if (currentChapterEditId) {
      const chapterRef = firebase.database().ref('stories/' + currentEditingStory.id + '/chapters/' + currentChapterEditId);
      chapterRef.update({
          content: content
        })
        .then(() => {
          closeChapterCreationModal();
          alert("Cap√≠tulo actualizado correctamente.");
        })
        .catch(error => {
          console.error("Error al actualizar cap√≠tulo:", error);
        });
    } else {
      const chapterNumber = currentChapters.length + 1;
      const newChapter = {
        chapterNumber,
        content,
        createdAt: Date.now(),
        status: scheduledDate ? 'scheduled' : 'published'
      };

      const chapterRef = firebase.database().ref('stories/' + currentEditingStory.id + '/chapters').push();
      newChapter.id = chapterRef.key;
      
      if (scheduledDate) {
        // Guardar en cap√≠tulos programados
        firebase.database().ref('scheduledChapters/' + chapterRef.key).set({
          storyId: currentEditingStory.id,
          publishDate: new Date(scheduledDate).getTime(),
          status: 'pending'
        });
        
        // Guardar el cap√≠tulo con estado programado
        chapterRef.set(newChapter)
          .then(() => {
            closeChapterCreationModal();
            alert("Cap√≠tulo programado para publicaci√≥n el " + new Date(scheduledDate).toLocaleDateString());
          })
          .catch(error => {
            console.error("Error al programar cap√≠tulo:", error);
          });
      } else {
        // Publicaci√≥n inmediata
        chapterRef.set(newChapter)
          .then(() => {
            closeChapterCreationModal();
            alert(translations[currentLanguage].chapterAdded);
          })
          .catch(error => {
            console.error("Error al agregar cap√≠tulo:", error);
          });
      }
    }
  });

  function openChapterEditModal(chapter) {
    currentChapterEditId = chapter.id;
    document.getElementById('chapter-content').value = chapter.content;
    document.getElementById('btn-save-chapter').textContent = "Guardar Cambios";
    document.getElementById('chapter-creation-modal').style.display = "flex";
  }

  function deleteChapter(chapterId) {
    if (confirm("¬øEst√°s seguro de eliminar este cap√≠tulo?")) {
      firebase.database().ref('stories/' + currentEditingStory.id + '/chapters/' + chapterId).remove()
        .then(() => {
          alert("Cap√≠tulo eliminado correctamente.");
        })
        .catch(error => {
          console.error("Error al eliminar cap√≠tulo:", error);
        });
    }
  }

  function openChapterReadModal(storyId, chapterId) {
    console.log('Abriendo cap√≠tulo:', storyId, chapterId); // Debug
    
    // Ocultar el modal de detalle de historia
    const storyDetailModal = document.getElementById('story-detail-modal');
    if (storyDetailModal && !storyDetailModal.classList.contains('hidden')) {
      storyDetailModal.classList.add('hidden');
    }
    
    // Ocultar la app principal si est√° visible
    const mainApp = document.getElementById('main-app');
    if (mainApp && !mainApp.classList.contains('hidden')) {
      mainApp.classList.add('hidden');
    }
    
    firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId).once('value').then(snapshot => {
      const chapter = snapshot.val();
      console.log('Datos del cap√≠tulo:', chapter); // Debug
      
      if (chapter) {
        document.getElementById('read-chapter-number').textContent = "Cap√≠tulo " + chapter.chapterNumber;
        document.getElementById('read-chapter-text').innerHTML = chapter.content.replace(/\n/g, '<br>');
        setupStarRating(storyId, chapterId);
        
        if (!currentEditingStory) {
          currentEditingStory = {
            id: storyId,
            currentChapterId: chapterId
          };
        } else {
          currentEditingStory.currentChapterId = chapterId;
        }
        
        const user = firebase.auth().currentUser;
        if (user) {
          const chapterViewRef = firebase.database().ref('chapterViews/' + chapterId + '/' + user.uid);
          chapterViewRef.once('value').then(viewSnap => {
            if (!viewSnap.exists()) {
              chapterViewRef.set(true);
              const chapterViewsRef = firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId + '/views');
              chapterViewsRef.transaction(current => (current || 0) + 1);
              
              // GANAR MONEDAS POR LEER CAP√çTULO
              earnCoinsForReading(user.uid, chapterId);
            }
          });
        }
        
        // Mostrar el modal de lectura
        const chapterReadModal = document.getElementById('chapter-read-modal');
        console.log('Modal de lectura:', chapterReadModal); // Debug
        
        if (chapterReadModal) {
          chapterReadModal.classList.remove('hidden');
          console.log('Modal mostrado correctamente'); // Debug
        } else {
          console.error('No se encontr√≥ el modal de lectura'); // Debug
          alert('Error: No se pudo abrir el cap√≠tulo');
        }
      } else {
        alert('Cap√≠tulo no encontrado');
      }
    }).catch(error => {
      console.error('Error al cargar cap√≠tulo:', error);
      alert('Error al cargar el cap√≠tulo');
    });
  }

  function closeChapterReadModal() {
    const chapterReadModal = document.getElementById('chapter-read-modal');
    const storyDetailModal = document.getElementById('story-detail-modal');
    const mainApp = document.getElementById('main-app');
    
    if (chapterReadModal) {
      chapterReadModal.classList.add('hidden');
    }
    
    // Si hay un modal de detalle, mostrarlo, sino mostrar la app principal
    if (storyDetailModal && window.currentStoryId) {
      storyDetailModal.classList.remove('hidden');
    } else if (mainApp) {
      mainApp.classList.remove('hidden');
    }
  }

  function prevChapter() {
    if (!currentEditingStory || !currentEditingStory.currentChapterId) return;
    const index = currentChapters.findIndex(ch => ch.id === currentEditingStory.currentChapterId);
    if (index > 0) {
      openChapterReadModal(currentEditingStory.id, currentChapters[index - 1].id);
    } else {
      alert(translations[currentLanguage].firstChapter);
    }
  }

  function nextChapter() {
    if (!currentEditingStory || !currentEditingStory.currentChapterId) return;
    const index = currentChapters.findIndex(ch => ch.id === currentEditingStory.currentChapterId);
    if (index < currentChapters.length - 1) {
      openChapterReadModal(currentEditingStory.id, currentChapters[index + 1].id);
    } else {
      alert(translations[currentLanguage].lastChapter);
    }
  }

  function setupStarRating(storyId, chapterId) {
    const stars = document.querySelectorAll("#star-rating .star");
    stars.forEach(star => {
      star.classList.remove("selected");
    });
    const user = firebase.auth().currentUser;
    if (!user) return;
    const ratingRef = firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId + '/ratings/' + user.uid);
    ratingRef.once('value').then(snapshot => {
      const rating = snapshot.val();
      if (rating) {
        stars.forEach(star => {
          if (parseInt(star.getAttribute('data-value')) <= rating) {
            star.classList.add("selected");
          }
        });
      }
    });
    stars.forEach(star => {
      star.onclick = function() {
        const value = parseInt(this.getAttribute('data-value'));
        ratingRef.set(value)
          .then(() => {
            stars.forEach(s => {
              if (parseInt(s.getAttribute('data-value')) <= value) {
                s.classList.add("selected");
              } else {
                s.classList.remove("selected");
              }
            });
            alert(translations[currentLanguage].chapterRated.replace("{value}", value));
          })
          .catch(error => {
            console.error("Error al guardar calificaci√≥n:", error);
          });
      };
    });
  }
  /*********************** EFECTO SKELETON **************************/
  function applySkeletonEffect() {
    document.getElementById('profile-image').classList.add('skeleton');
    document.getElementById('profile-username').classList.add('skeleton');
    document.getElementById('profile-bio').classList.add('skeleton');
    const userStories = document.getElementById('user-stories');
    if (userStories) {
      userStories.classList.add('skeleton');
    }
  }

  function removeSkeletonEffect() {
    document.getElementById('profile-image').classList.remove('skeleton');
    document.getElementById('profile-username').classList.remove('skeleton');
    document.getElementById('profile-bio').classList.remove('skeleton');
    const userStories = document.getElementById('user-stories');
    if (userStories) {
      userStories.classList.remove('skeleton');
    }
  }
  if (!navigator.onLine) {
    applySkeletonEffect();
  }
  window.addEventListener('offline', applySkeletonEffect);
  window.addEventListener('online', removeSkeletonEffect);
  /*********************** CARGA DE HISTORIAS **************************/
  function loadStories() {
    firebase.database().ref('stories').on('value', snapshot => {
      let stories = [];
      snapshot.forEach(child => {
        stories.push(child.val());
      });
      let newReleases = stories.sort((a, b) => b.createdAt - a.createdAt);
      renderStories(newReleases, 'new-releases', false);
      let top10 = stories.sort((a, b) => b.views - a.views).slice(0, 10);
      renderStories(top10, 'top10', false);
      let popular = stories.sort((a, b) => b.views - a.views);
      renderStories(popular, 'popular', false);
      let terrorStories = stories.filter(story => story.category === 'terror');
      renderStories(terrorStories, 'terror-stories', false);
    });
  }

  function renderStories(stories, elementId, editMode) {
    const container = document.getElementById(elementId);
    container.innerHTML = '';
    stories.forEach(story => {
      if (story.blocked) return;
      const storyCard = document.createElement('div');
      storyCard.className = 'story-card cursor-pointer relative';
      storyCard.onclick = editMode ? () => openStoryEdit(story) : () => openStoryDetail(story);
      storyCard.innerHTML = `
          <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
            <div class="story-cover-container">
              <img src="${story.coverImage || 'https://via.placeholder.com/200x300/cccccc/666666?text=No+Image'}" alt="${story.title}" class="story-cover-image">
            </div>
          </div>
          <div class="mt-2">
            <h3 class="font-semibold text-sm">${story.title}</h3>
          </div>
        `;
      const languageDiv = document.createElement('div');
      languageDiv.className = "mt-1 flex items-center space-x-2";
      languageDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
      if (story.rating === "18plus") {
        languageDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
      }
      storyCard.appendChild(languageDiv);
      container.appendChild(storyCard);
    });
  }
  /*********************** CARGA DE HISTORIAS DEL USUARIO **************************/
  function loadUserStories(userId) {
    const userStoriesRef = firebase.database().ref('stories').orderByChild('userId').equalTo(userId);
    userStoriesRef.on('value', snapshot => {
      const container = document.getElementById('user-stories');
      container.innerHTML = "";
      snapshot.forEach(child => {
        const story = child.val();
        if (story.blocked) return;
        const card = document.createElement('div');
        card.className = "cursor-pointer";
        card.onclick = () => openStoryEdit(story);
        card.innerHTML = `
            <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
              <img src="${story.coverImage || 'https://via.placeholder.com/200x300/cccccc/666666?text=No+Image'}" alt="${story.title}" class="w-full h-40 object-cover">
            </div>
            <div class="mt-2">
              <h3 class="font-semibold text-sm">${story.title}</h3>
            </div>
          `;
        const langDiv = document.createElement('div');
        langDiv.className = "mt-1 flex items-center space-x-2";
        langDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
        if (story.rating === "18plus") {
          langDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
        }
        card.appendChild(langDiv);
        container.appendChild(card);
      });
    });
  }
  /*********************** NUEVAS FUNCIONES: SUGERENCIAS Y AUTORES DESTACADOS **************************/
  function loadSuggestedStories() {
    firebase.database().ref('stories').once('value').then(snapshot => {
      let stories = [];
      snapshot.forEach(child => {
        let story = child.val();
        story.id = child.key;
        stories.push(story);
      });
      stories.sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0));
      let suggested = stories.slice(0, 10);
      const container = document.getElementById('suggested-stories');
      container.innerHTML = '';
      suggested.forEach(story => {
        const card = document.createElement('div');
        card.className = 'story-card cursor-pointer';
        card.onclick = () => openStoryDetail(story);
        card.innerHTML = `
              <div class="rounded-2xl overflow-hidden shadow-md">
                <div class="story-cover-container">
                  <img src="${story.coverImage || 'https://via.placeholder.com/200x300/cccccc/666666?text=No+Image'}" alt="${story.title}" class="story-cover-image">
                </div>
              </div>
              <div class="mt-2">
                <h3 class="font-semibold text-sm">${story.title}</h3>
              </div>
            `;
        container.appendChild(card);
      });
    });
  }

  function loadFeaturedAuthors() {
    firebase.database().ref('stories').once('value').then(snapshot => {
      let authorCounts = {};
      snapshot.forEach(child => {
        let story = child.val();
        if (story && story.userId) {
          if (!authorCounts[story.userId]) authorCounts[story.userId] = 0;
          authorCounts[story.userId]++;
        }
      });
      let authorsArray = [];
      for (let uid in authorCounts) {
        authorsArray.push({
          uid: uid,
          count: authorCounts[uid]
        });
      }
      authorsArray.sort((a, b) => b.count - a.count);
      let topAuthors = authorsArray.slice(0, 10);
      const container = document.getElementById('featured-authors');
      container.innerHTML = '';
      topAuthors.forEach(author => {
        firebase.database().ref('users/' + author.uid).once('value').then(userSnap => {
          const userData = userSnap.val();
          const card = document.createElement('div');
          card.className = 'story-card cursor-pointer';
          card.onclick = () => openAuthorProfile(author.uid);
          card.innerHTML = `
                <div class="rounded-2xl overflow-hidden shadow-md">
                  <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" alt="${userData.username}" class="w-full h-40 object-cover">
                </div>
                <div class="mt-2">
                  <h3 class="font-semibold text-sm">${userData.username}</h3>
                </div>
              `;
          container.appendChild(card);
        });
      });
    });
  }
  /*********************** CARGA DE HISTORIAS DEL AUTOR **************************/
  function loadAuthorStories(authorId) {
    const authorStoriesRef = firebase.database().ref('stories').orderByChild('userId').equalTo(authorId);
    authorStoriesRef.on('value', snapshot => {
      const container = document.getElementById('author-stories');
      container.innerHTML = "";
      snapshot.forEach(child => {
        const story = child.val();
        if (story.blocked) return;
        const card = document.createElement('div');
        card.className = "cursor-pointer";
        card.onclick = () => openStoryDetail(story);
        card.innerHTML = `
            <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
              <img src="${story.coverImage || 'https://via.placeholder.com/200x300/cccccc/666666?text=No+Image'}" alt="${story.title}" class="w-full h-40 object-cover">
            </div>
            <div class="mt-2">
              <h3 class="font-semibold text-sm">${story.title}</h3>
            </div>
          `;
        const langDiv = document.createElement('div');
        langDiv.className = "mt-1 flex items-center space-x-2";
        langDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
        if (story.rating === "18plus") {
          langDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
        }
        card.appendChild(langDiv);
        container.appendChild(card);
      });
    });
  }
  /*********************** NUEVAS FUNCIONES: DESCARGAR HISTORIA COMPLETA PARA LECTURA OFFLINE **************************/
  function downloadStory() {
    if (!window.currentStoryId) {
      alert("No se ha seleccionado una historia.");
      return;
    }
    const storyId = window.currentStoryId;
    const btn = document.getElementById('download-story-btn');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    firebase.database().ref('stories/' + storyId).once('value')
      .then(storySnap => {
        const storyData = storySnap.val();
        if (!storyData) {
          throw new Error("Historia no encontrada");
        }
        return firebase.database().ref('stories/' + storyId + '/chapters').once('value')
          .then(chaptersSnap => {
            let chaptersHTML = '';
            chaptersSnap.forEach(child => {
              const chapter = child.val();
              chapter.id = child.key;
              // Se crea un bloque para cada cap√≠tulo con t√≠tulo y contenido completo
              chaptersHTML += `<div class="chapter" style="margin-bottom:20px;">
                  <h3 style="margin-bottom:10px;">Cap√≠tulo ${chapter.chapterNumber}</h3>
                  <p style="text-align:justify; white-space: pre-wrap;">${chapter.content}</p>
                </div>`;
            });
            storyData.chaptersHTML = chaptersHTML;
            return storyData;
          });
      })
      .then(storyData => {
        const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>${storyData.title}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .cover { max-width: 100%; height: auto; }
    .chapter { margin-top: 20px; margin-bottom: 20px; }
    .chapter h3 { margin-bottom: 10px; }
    .chapter p { text-align: justify; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>${storyData.title}</h1>
  <img src="${storyData.coverImage}" alt="Portada" class="cover">
  <div class="chapters">
    ${storyData.chaptersHTML}
  </div>
</body>
</html>`;
        const blob = new Blob([htmlContent], {
          type: 'text/html'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = storyData.title.replace(/\s+/g, '_') + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        icon.classList.remove('fa-spin');
        icon.classList.remove('fa-download');
        icon.classList.add('fa-check');
        alert("Historia descargada para lectura offline.");
        setTimeout(() => {
          icon.classList.remove('fa-check');
          icon.classList.add('fa-download');
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        alert("Error al descargar la historia: " + err.message);
        icon.classList.remove('fa-spin');
      });
  }
  /*********************** LIVE STREAMING **************************/
  let liveLocalStream = null;
  let livePeerConnection = null;
  let liveBroadcasting = false;
  let currentBroadcasterId = null;
  let giftListenerRef = null;

  function giftListenerCallback(snapshot) {
    let gift = snapshot.val();
    let giftUrl = "";
    if (gift.giftType === "mariposas") {
      giftUrl = "https://i.pinimg.com/originals/7c/29/36/7c2936db7563085ef7470d50fd06e4e3.gif";
    } else if (gift.giftType === "ballena") {
      giftUrl = "https://i.pinimg.com/originals/86/31/83/863183316ed35cfeda7baf9ee1de0596.gif";
    } else if (gift.giftType === "corazon_coreano") {
      giftUrl = "https://cdn.pixabay.com/animation/2022/09/17/16/20/16-20-08-700_512.gif";
    } else if (gift.giftType === "Globo") {
      giftUrl = "https://i.pinimg.com/originals/2d/f8/97/2df897364f655a0b14070a9e2f95d602.gif";
    } else if (gift.giftType === "ciudad_dese√±cionada") {
      giftUrl = "https://i.pinimg.com/originals/6a/9a/74/6a9a7425e736575ee78816254227d1a8.gif";
    } else if (gift.giftType === "diamante") {
      giftUrl = "https://i.pinimg.com/originals/79/a5/49/79a54992591652b1595c6c61c49170fb.gif";
    } else if (gift.giftType === "oso_beaboo") {
      giftUrl = "https://www.icegif.com/wp-content/uploads/2021/11/icegif-346.gif";
    } else if (gift.giftType === "oso_saltarin") {
      giftUrl = "https://www.icegif.com/wp-content/uploads/2021/11/icegif-347.gif";
    } else if (gift.giftType === "besboos_carinosos") {
      giftUrl = "https://i.pinimg.com/originals/3b/d4/d9/3bd4d9778b5e0a11ab141cb7b545ab10.gif";
    } else if (gift.giftType === "besboos_leyendo") {
      giftUrl = "https://i.pinimg.com/originals/c6/41/ba/c641babc376ffe10f65ee472a646c6e1.gif";
    } else if (gift.giftType === "estrella") {
      giftUrl = "https://media3.giphy.com/media/svpuvuc70ht48WU6dj/giphy.gif?cid=6c09b952logfyfctuhi46ekgb2g7tmi345ycn9atumxwz7an&ep=v1_internal_gif_by_id&rid=giphy.gif&ct=s";
    } else if (gift.giftType === "unicornio") {
      giftUrl = "https://cdn.pixabay.com/animation/2024/12/02/02/56/02-56-03-27_512.gif";
    } else if (gift.giftType === "arcoiris") {
      giftUrl = "https://i.pinimg.com/originals/17/9c/e7/179ce7068a3c543261505ea69398b714.gif";
    } else if (gift.giftType === "pastel") {
      giftUrl = "https://i.gifer.com/3EcT.gif";
    } else if (gift.giftType === "baile") {
      giftUrl = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0_aNKZP5QwCAtf0QD5SBK4JulDqNJr6UDg8w4R-E_12arxSsP_HBQhksCL-7xfipx_uVmYbagEFjE8tZGBX-AO40PwMJvIOpr49e_sedIGjCWkUqkrUJZGR4vwr4ygNUrR1hreOsTgc4/s1600/BkM47.gif";
    } else if (gift.giftType === "musica") {
      giftUrl = "https://i.pinimg.com/originals/68/fc/a0/68fca09b36725b767735abef8c7e1117.gif";
    } else if (gift.giftType === "sol") {
      giftUrl = "https://cdn.pixabay.com/animation/2024/03/08/13/17/13-17-23-34_512.gif";
    } else if (gift.giftType === "nube") {
      giftUrl = "https://cdn.pixabay.com/animation/2022/09/17/16/20/16-20-08-700_512.gif";
    } else if (gift.giftType === "globo") {
      giftUrl = "https://images.emojiterra.com/google/noto-emoji/animated-emoji/1f388.gif";
    } else if (gift.giftType === "caramelo") {
      giftUrl = "https://i.pinimg.com/originals/e2/9c/7b/e29c7bc3faadc09dfcddb6ca11243c6d.gif";
    } else if (gift.giftType === "delfin") {
      giftUrl = "https://media.tenor.com/TyrY0krJG3kAAAAj/milk-and-mocha.gif";
    } else if (gift.giftType === "fuego") {
      giftUrl = "https://i.pinimg.com/originals/af/8a/27/af8a27bf984e189f6a6bd7a6922075c1.gif";
    }
    if (giftUrl !== "") {
      showGiftAnimation(giftUrl, gift.senderName);
    }
    snapshot.ref.remove();
  }

  // Funci√≥n callback para manejar los regalos recibidos
  function giftListenerCallback(snapshot) {
    const gift = snapshot.val();
    if (!gift) return;
    
    let giftUrl = "";
    if (gift.giftType === "corazon") {
      giftUrl = "https://cdn.pixabay.com/animation/2022/09/17/16/20/16-20-08-700_512.gif";
    } else if (gift.giftType === "globo") {
      giftUrl = "https://images.emojiterra.com/google/noto-emoji/animated-emoji/1f388.gif";
    } else if (gift.giftType === "caramelo") {
      giftUrl = "https://i.pinimg.com/originals/e2/9c/7b/e29c7bc3faadc09dfcddb6ca11243c6d.gif";
    } else {
      giftUrl = "https://cdn.pixabay.com/animation/2022/09/17/16/20/16-20-08-700_512.gif";
    }
    
    showGiftAnimation(giftUrl, gift.senderName);
    snapshot.ref.remove();
  }

  function listenForGifts() {
    if (!currentBroadcasterId) return;
    giftListenerRef = firebase.database().ref(`liveStreams/${currentBroadcasterId}/gifts`);
    giftListenerRef.on('child_added', giftListenerCallback);
  }

  function stopListeningForGifts() {
    if (giftListenerRef) {
      giftListenerRef.off('child_added', giftListenerCallback);
      giftListenerRef = null;
    }
  }

  function listenForComments(broadcasterId) {
    const commentsRef = firebase.database().ref(`liveStreams/${broadcasterId}/comments`);
    commentsRef.on('child_added', snapshot => {
      const comment = snapshot.val();
      const commentElem = document.createElement('div');
      commentElem.className = 'comment-bubble';
      commentElem.textContent = comment.senderName + ": " + comment.text;
      if (document.getElementById('commentsContainerLive')) {
        document.getElementById('commentsContainerLive').appendChild(commentElem);
        setTimeout(() => {
          commentElem.remove();
        }, 3000);
      }
      if (firebase.auth().currentUser && firebase.auth().currentUser.uid === broadcasterId) {
        const bcContainer = document.getElementById('broadcasterCommentsContainer');
        if (bcContainer) {
          const clone = commentElem.cloneNode(true);
          bcContainer.appendChild(clone);
          bcContainer.scrollTop = bcContainer.scrollHeight;
        }
      }
    });
  }

  function openLiveStreamModal() {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert("Debes estar autenticado para transmitir en vivo.");
      return;
    }
    
    // Verificaci√≥n adicional de seguridad para evitar errores null
    if (!user.uid) {
      alert("Error de autenticaci√≥n. Inicia sesi√≥n nuevamente.");
      return;
    }
    
    // Todos los usuarios pueden transmitir en vivo
    if (!user.email) {
      alert("Por favor verifica tu correo electr√≥nico para transmitir en vivo.");
      return;
    }
    currentBroadcasterId = user.uid;
    let useCamera = confirm("¬øDesea transmitir en vivo usando su c√°mara? Presione OK para c√°mara, Cancelar para video pregrabado.");
    if (useCamera) {
      document.getElementById('live-stream-modal').classList.remove('hidden');
      navigator.mediaDevices.getUserMedia({
          video: true,
          audio: {
            echoCancellation: true
          }
        })
        .then(stream => {
          liveLocalStream = stream;
          document.getElementById('live-localVideo').srcObject = stream;
          setTimeout(() => {
            document.getElementById('live-spinner').style.display = "none";
          }, 3000);
        })
        .catch(err => {
          alert("Error al acceder a la c√°mara: " + err);
        });
    } else {
      document.getElementById('live-video-input').click();
    }
    const profileImg = document.getElementById('profile-image');
    if (profileImg) {
      profileImg.classList.add('live-border');
    }
    document.getElementById('live-spinner').style.display = "flex";
    listenForComments(currentBroadcasterId);
    listenForGifts();
  }

  function handleLiveVideoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const videoElement = document.createElement('video');
    videoElement.src = URL.createObjectURL(file);
    videoElement.autoplay = true;
    videoElement.loop = true;
    videoElement.controls = true;
    videoElement.play();
    videoElement.onloadedmetadata = function() {
      const canvas = document.createElement('canvas');
      canvas.width = videoElement.videoWidth;
      canvas.height = videoElement.videoHeight;
      const ctx = canvas.getContext('2d');
      let promotionText = prompt("Ingrese informaci√≥n de promoci√≥n (opcional):");

      function drawFrame() {
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        ctx.font = "30px sans-serif";
        ctx.fillStyle = "rgba(88,204,2,0.7)";
        ctx.textAlign = "right";
        ctx.fillText("BeaBoo", canvas.width - 10, canvas.height - 10);
        if (promotionText) {
          ctx.font = "24px sans-serif";
          ctx.fillStyle = "rgba(255,255,255,0.8)";
          ctx.textAlign = "left";
          ctx.fillText(promotionText, 10, 30);
        }
        requestAnimationFrame(drawFrame);
      }
      drawFrame();
      let canvasStream = canvas.captureStream(30);
      let chosenAudioPromise;
      let chosenLanguage = prompt("Ingrese el idioma de audio a transmitir: 'es' para espa√±ol, 'en' para ingl√©s. Deje en blanco para usar el audio original.");
      if (chosenLanguage === "es") {
        const audioFileInput = document.getElementById('live-audio-es');
        if (audioFileInput.files.length > 0) {
          const audioFile = audioFileInput.files[0];
          let audioElement = document.createElement('audio');
          audioElement.src = URL.createObjectURL(audioFile);
          audioElement.play();
          chosenAudioPromise = new Promise(resolve => {
            audioElement.onloadedmetadata = function() {
              resolve(audioElement.captureStream().getAudioTracks()[0]);
            }
          });
        }
      } else if (chosenLanguage === "en") {
        const audioFileInput = document.getElementById('live-audio-en');
        if (audioFileInput.files.length > 0) {
          let audioElement = document.createElement('audio');
          audioElement.src = URL.createObjectURL(audioFileInput.files[0]);
          audioElement.play();
          chosenAudioPromise = new Promise(resolve => {
            audioElement.onloadedmetadata = function() {
              resolve(audioElement.captureStream().getAudioTracks()[0]);
            }
          });
        }
      }
      if (!chosenAudioPromise) {
        let videoStream = videoElement.captureStream();
        chosenAudioPromise = Promise.resolve(videoStream.getAudioTracks()[0]);
      }
      chosenAudioPromise.then(audioTrack => {
        if (audioTrack) {
          canvasStream.addTrack(audioTrack);
        }
        liveLocalStream = canvasStream;
        document.getElementById('live-stream-modal').classList.remove('hidden');
        document.getElementById('live-localVideo').srcObject = liveLocalStream;
        setTimeout(() => {
          document.getElementById('live-spinner').style.display = "none";
        }, 3000);
      });
    };
  }

  function closeLiveStreamModal() {
    document.getElementById('live-stream-modal').classList.add('hidden');
    if (liveLocalStream) {
      liveLocalStream.getTracks().forEach(track => track.stop());
      liveLocalStream = null;
    }
    if (liveBroadcasting) {
      endLiveStream();
    }
    const profileImg = document.getElementById('profile-image');
    if (profileImg) {
      profileImg.classList.remove('live-border');
    }
    stopListeningForGifts();
  }

  function startLiveCountdown(duration, callback) {
    let remaining = duration;
    const countdownEl = document.getElementById('live-countdown');
    countdownEl.textContent = remaining;
    const interval = setInterval(() => {
      remaining--;
      if (remaining > 0) {
        countdownEl.textContent = remaining;
      } else {
        clearInterval(interval);
        countdownEl.textContent = "";
        callback();
      }
    }, 1000);
  }
  document.getElementById('live-startBtn').addEventListener('click', () => {
    startLiveCountdown(10, () => {
      document.getElementById('live-indicator').classList.remove('hidden');
      document.getElementById('live-startBtn').classList.add('hidden');
      document.getElementById('live-endBtn').classList.remove('hidden');
      startBroadcasting();
    });
  });

  function startBroadcasting() {
    livePeerConnection = new RTCPeerConnection();
    liveLocalStream.getTracks().forEach(track => {
      livePeerConnection.addTrack(track, liveLocalStream);
    });
    livePeerConnection.onicecandidate = event => {
      if (event.candidate) {
        firebase.database().ref(`liveStreams/${currentBroadcasterId}/candidates`).push(event.candidate.toJSON());
      }
    };
    livePeerConnection.createOffer().then(offer => {
      return livePeerConnection.setLocalDescription(offer).then(() => offer);
    }).then(offer => {
      firebase.database().ref(`liveStreams/${currentBroadcasterId}`).set({
        isLive: true,
        offer: offer,
        views: 0,
        streamerName: firebase.auth().currentUser.displayName || firebase.auth().currentUser.email || "Usuario",
        timestamp: Date.now()
      });
      liveBroadcasting = true;
      
      // Notificar a todos los seguidores que la transmisi√≥n ha comenzado
      notifyFollowersOfLiveStream();
      firebase.database().ref(`liveStreams/${currentBroadcasterId}/views`).on('value', snapshot => {
        const views = snapshot.val() || 0;
        document.getElementById('live-viewCount').textContent = views + " vistas";
      });
      listenForComments(currentBroadcasterId);
    });
  }

  // Funci√≥n para notificar a seguidores sobre transmisi√≥n en vivo
  function notifyFollowersOfLiveStream() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;
    
    firebase.database().ref('followers').once('value').then(snapshot => {
      snapshot.forEach(followerSnap => {
        const followerData = followerSnap.val();
        if (followerData.followedUserId === currentUser.uid) {
          const followerId = followerData.followerId;
          const streamerName = currentUser.displayName || currentUser.email || "Un usuario";
          addNotification(followerId, `${streamerName} est√° transmitiendo en vivo ahora. ¬°√önete a la transmisi√≥n!`, 'live_stream');
        }
      });
    });
  }

  function endLiveStream() {
    if (livePeerConnection) {
      livePeerConnection.close();
      livePeerConnection = null;
    }
    firebase.database().ref(`liveStreams/${currentBroadcasterId}`).remove();
    liveBroadcasting = false;
    const profileImg = document.getElementById('profile-image');
    if (profileImg) {
      profileImg.classList.remove('live-border');
    }
    setTimeout(() => {
      closeLiveStreamModal();
    }, 3000);
  }
  document.getElementById('live-endBtn').addEventListener('click', () => {
    endLiveStream();
  });

  function openLiveViewModal(broadcasterId) {
    liveBroadcasterId = broadcasterId;
    firebase.database().ref('users/' + broadcasterId).once('value').then(snapshot => {
      const data = snapshot.val();
      if (data && data.username) {
        document.getElementById('streamerName').innerText = data.username;
      }
    });
    document.getElementById('live-view-modal').classList.remove('hidden');
    firebase.database().ref(`liveStreams/${broadcasterId}/views`).on('value', snapshot => {
      const views = snapshot.val() || 0;
      document.getElementById('viewerCountLive').textContent = views;
    });
    firebase.database().ref(`liveStreams/${broadcasterId}/views`).transaction(current => (current || 0) + 1);
    const viewerPC = new RTCPeerConnection();
    viewerPC.onicecandidate = event => {
      if (event.candidate) {
        firebase.database().ref(`liveStreams/${broadcasterId}/viewerCandidates`).push(event.candidate.toJSON());
      }
    };
    viewerPC.ontrack = event => {
      document.getElementById('live-remoteVideo').srcObject = event.streams[0];
    };
    firebase.database().ref(`liveStreams/${broadcasterId}/offer`).once('value').then(snapshot => {
      const offer = snapshot.val();
      if (!offer) {
        alert("El autor no est√° transmitiendo.");
        closeLiveViewModal();
        return;
      }
      viewerPC.setRemoteDescription(new RTCSessionDescription(offer))
        .then(() => viewerPC.createAnswer())
        .then(answer => viewerPC.setLocalDescription(answer).then(() => answer))
        .then(answer => {
          firebase.database().ref(`liveStreams/${broadcasterId}/answer`).set(answer);
        });
    });
    firebase.database().ref(`liveStreams/${broadcasterId}`).on('value', snapshot => {
      if (!snapshot.exists()) {
        document.getElementById('live-endedMessage') && document.getElementById('live-endedMessage').classList.remove('hidden');
        setTimeout(closeLiveViewModal, 3000);
      }
    });
    listenForComments(broadcasterId);
    window.currentViewerPC = viewerPC;
  }

  function closeLiveViewModal() {
    document.getElementById('live-view-modal').classList.add('hidden');
    document.getElementById('live-endedMessage') && document.getElementById('live-endedMessage').classList.add('hidden');
    if (window.currentViewerPC) {
      window.currentViewerPC.close();
      window.currentViewerPC = null;
    }
  }
  document.getElementById('gift-btn') && document.getElementById('gift-btn').addEventListener('click', () => {
    document.getElementById('gift-drawer').classList.add('open');
  });

  function closeGiftDrawer() {
    document.getElementById('gift-drawer').classList.remove('open');
  }

  function sendGift(giftType) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || currentUser.uid === liveBroadcasterId) {
      alert("No puedes enviar regalos a ti mismo.");
      return;
    }
    firebase.database().ref('users/' + liveBroadcasterId).transaction(userData => {
      if (userData) {
        userData.coins = (userData.coins || 0) + 5;
      }
      return userData;
    }).then(() => {
      let giftData = {
        giftType: giftType,
        senderName: currentUser.displayName || currentUser.email || "Alguien",
        timestamp: Date.now()
      };
      firebase.database().ref(`liveStreams/${liveBroadcasterId}/gifts`).push(giftData);
      closeGiftDrawer();
    }).catch(error => {
      console.error("Error al enviar regalo:", error);
    });
  }

  function showGiftAnimation(giftUrl, senderName) {
    const transmitBtn = document.getElementById('live-startBtn');
    if (transmitBtn) transmitBtn.style.display = 'none';
    const animContainer = document.getElementById('gift-animation');
    animContainer.innerHTML = `
        <div class="text-center">
          <p class="text-white mb-1">${senderName} ha enviado un regalo</p>
          <img src="${giftUrl}" alt="Regalo" class="mx-auto" style="max-width: 80%; max-height: 80%;">
        </div>`;
    animContainer.classList.add('show');
    setTimeout(() => {
      animContainer.classList.remove('show');
    }, 4000);
  }
  /*********************** REPORTAR HISTORIA Y BLOQUEO **************************/
  let lastX = null,
    lastY = null,
    lastZ = null;
  let shakeThreshold = 15;
  let shakeTimeout = null;

  function deviceMotionHandler(event) {
    const acceleration = event.accelerationIncludingGravity;
    if (!acceleration) return;
    const {
      x,
      y,
      z
    } = acceleration;
    if (lastX === null) {
      lastX = x;
      lastY = y;
      lastZ = z;
      return;
    }
    const deltaX = Math.abs(x - lastX);
    const deltaY = Math.abs(y - lastY);
    const deltaZ = Math.abs(z - lastZ);
    if (deltaX + deltaY + deltaZ > shakeThreshold) {
      if (!shakeTimeout) {
        triggerReportModal();
        shakeTimeout = setTimeout(() => {
          shakeTimeout = null;
        }, 1000);
      }
    }
    lastX = x;
    lastY = y;
    lastZ = z;
  }

  function initShakeDetection() {
    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', deviceMotionHandler, false);
    } else {
      console.log("DeviceMotionEvent no est√° soportado");
    }
  }

  function triggerReportModal() {
    const storyDetailModal = document.getElementById('story-detail-modal');
    if (storyDetailModal && !storyDetailModal.classList.contains('hidden')) {
      openReportStoryModal();
    }
  }

  function openReportStoryModal() {
    const reportModal = document.getElementById('report-story-modal');
    if (reportModal) {
      reportModal.style.display = 'block';
      setTimeout(() => {
        reportModal.style.transform = 'translateY(0)';
      }, 10);
    }
  }

  function closeReportStoryModal() {
    const reportModal = document.getElementById('report-story-modal');
    if (reportModal) {
      reportModal.style.transform = 'translateY(100%)';
      setTimeout(() => {
        reportModal.style.display = 'none';
      }, 300);
    }
  }
  document.getElementById('report-story-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const reason = formData.get('reportReason');
    const description = document.getElementById('report-story-description').value;
    if (!window.currentStoryId) {
      alert("No se ha seleccionado una historia.");
      return;
    }
    const user = firebase.auth().currentUser;
    if (!user) {
      alert("Debes estar autenticado para reportar.");
      return;
    }
    const reportData = {
      reporter: user.uid,
      reporterName: user.displayName || user.email,
      storyId: window.currentStoryId,
      reason: reason,
      description: description,
      timestamp: Date.now(),
      status: "pending"
    };
    firebase.database().ref('storyReports').push(reportData)
      .then(() => {
        alert("Reporte enviado.");
        closeReportStoryModal();
      })
      .catch(error => {
        console.error("Error al enviar reporte:", error);
      });
  });

  function listenForStoryBlock(storyId) {
    firebase.database().ref('stories/' + storyId + '/blocked').on('value', snapshot => {
      if (snapshot.exists() && snapshot.val() === true) {
        openStoryBlockedModal();
      }
    });
  }

  function openStoryBlockedModal() {
    const modal = document.getElementById('story-blocked-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
  }
  let blockedStartX = null;
  const storyBlockedModal = document.getElementById('story-blocked-modal');
  if (storyBlockedModal) {
    storyBlockedModal.addEventListener('touchstart', function(e) {
      blockedStartX = e.touches[0].clientX;
    });
    storyBlockedModal.addEventListener('touchmove', function(e) {
      if (blockedStartX === null) return;
      const diffX = blockedStartX - e.touches[0].clientX;
      if (diffX > 100) {
        triggerBlockedAnimation();
        blockedStartX = null;
      }
    });
  }

  function triggerBlockedAnimation() {
    const dot1 = document.createElement('div');
    const dot2 = document.createElement('div');
    [dot1, dot2].forEach(dot => {
      dot.style.position = 'absolute';
      dot.style.width = '20px';
      dot.style.height = '20px';
      dot.style.backgroundColor = '#58CC02';
      dot.style.borderRadius = '50%';
      dot.style.transition = 'all 0.5s ease-in-out';
    });
    dot1.style.top = '50%';
    dot1.style.left = '10%';
    dot2.style.top = '50%';
    dot2.style.left = '80%';
    storyBlockedModal.appendChild(dot1);
    storyBlockedModal.appendChild(dot2);
    setTimeout(() => {
      dot1.style.left = '45%';
      dot2.style.left = '55%';
    }, 100);
    setTimeout(() => {
      storyBlockedModal.style.display = 'none';
      dot1.remove();
      dot2.remove();
    }, 1000);
  }
  window.addEventListener('load', initShakeDetection);
  /*********************** MODAL DE CREACI√ìN DE CAP√çTULO **************************/
  document.getElementById('font-family').addEventListener('change', function() {
    document.getElementById('chapter-content').style.fontFamily = this.value;
  });
  document.getElementById('font-size').addEventListener('input', function() {
    var size = this.value;
    document.getElementById('chapter-content').style.fontSize = size + "px";
    document.getElementById('font-size-value').innerText = size + "px";
  });
  document.getElementById('chapter-content').addEventListener('input', function() {
    var text = this.value;
    var words = text.trim().split(/\s+/).filter(word => word.length > 0);
    document.getElementById('word-count').innerText = words.length + " palabras";
    document.getElementById('letter-count').innerText = text.replace(/\s/g, "").length + " letras";
  });
  /*********************** NUEVAS FUNCIONES: SUGERENCIAS Y AUTORES DESTACADOS **************************/
  function loadSuggestedStories() {
    firebase.database().ref('stories').once('value').then(snapshot => {
      let stories = [];
      snapshot.forEach(child => {
        let story = child.val();
        story.id = child.key;
        stories.push(story);
      });
      stories.sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0));
      let suggested = stories.slice(0, 10);
      const container = document.getElementById('suggested-stories');
      container.innerHTML = '';
      suggested.forEach(story => {
        const card = document.createElement('div');
        card.className = 'story-card cursor-pointer';
        card.onclick = () => openStoryDetail(story);
        card.innerHTML = `
              <div class="rounded-2xl overflow-hidden shadow-md">
                <div class="story-cover-container">
                  <img src="${story.coverImage || 'https://via.placeholder.com/200x300/cccccc/666666?text=No+Image'}" alt="${story.title}" class="story-cover-image">
                </div>
              </div>
              <div class="mt-2">
                <h3 class="font-semibold text-sm">${story.title}</h3>
              </div>
            `;
        container.appendChild(card);
      });
    });
  }

  function loadFeaturedAuthors() {
    firebase.database().ref('stories').once('value').then(snapshot => {
      let authorCounts = {};
      snapshot.forEach(child => {
        let story = child.val();
        if (story && story.userId) {
          if (!authorCounts[story.userId]) authorCounts[story.userId] = 0;
          authorCounts[story.userId]++;
        }
      });
      let authorsArray = [];
      for (let uid in authorCounts) {
        authorsArray.push({
          uid: uid,
          count: authorCounts[uid]
        });
      }
      authorsArray.sort((a, b) => b.count - a.count);
      let topAuthors = authorsArray.slice(0, 10);
      const container = document.getElementById('featured-authors');
      container.innerHTML = '';
      topAuthors.forEach(author => {
        firebase.database().ref('users/' + author.uid).once('value').then(userSnap => {
          const userData = userSnap.val();
          const card = document.createElement('div');
          card.className = 'story-card cursor-pointer';
          card.onclick = () => openAuthorProfile(author.uid);
          card.innerHTML = `
                <div class="rounded-2xl overflow-hidden shadow-md">
                  <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" alt="${userData.username}" class="w-full h-40 object-cover">
                </div>
                <div class="mt-2">
                  <h3 class="font-semibold text-sm">${userData.username}</h3>
                </div>
              `;
          container.appendChild(card);
        });
      });
    });
  }
  /*************** FIN NUEVAS FUNCIONES **************************/

  /*********************** SISTEMA DE MENSAJER√çA EN TIEMPO REAL **************************/
  let currentChatUserId = null;
  let selectedAuthorForMessage = null;
  let typingTimeout = null;
  let isTyping = false;
  let voiceRecordingActive = false;

  function openMessages() {
    document.getElementById('main-app').classList.add('hidden');
    document.getElementById('chat-view').classList.remove('hidden');
    showConversationsView();
    loadConversations();
    listenForUnreadMessages();
    loadCurrentUserInfo();
  }

  function closeChat() {
    document.getElementById('chat-view').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    currentChatUserId = null;
    // Limpiar listeners en tiempo real
    clearTypingListeners();
  }

  function showConversationsView() {
    document.getElementById('conversations-view').classList.remove('hidden');
    document.getElementById('individual-chat-view').classList.add('hidden');
  }

  function showIndividualChatView() {
    document.getElementById('conversations-view').classList.add('hidden');
    document.getElementById('individual-chat-view').classList.remove('hidden');
  }

  function backToConversations() {
    showConversationsView();
    currentChatUserId = null;
    clearTypingListeners();
  }

  function loadCurrentUserInfo() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('users/' + user.uid).once('value', snapshot => {
      const userData = snapshot.val();
      if (userData && userData.profileImage) {
        document.getElementById('current-user-avatar').src = userData.profileImage;
      }
    });
  }

  function loadConversations() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid).on('value', snapshot => {
      const conversationsContainer = document.getElementById('conversations-container');
      conversationsContainer.innerHTML = '';

      if (!snapshot.exists()) {
        document.getElementById('no-conversations').classList.remove('hidden');
        return;
      }

      document.getElementById('no-conversations').classList.add('hidden');

      const conversations = [];
      snapshot.forEach(child => {
        conversations.push({
          userId: child.key,
          data: child.val()
        });
      });

      // Ordenar por √∫ltima actividad
      conversations.sort((a, b) => (b.data.lastMessageTime || 0) - (a.data.lastMessageTime || 0));

      conversations.forEach(conv => {
        const otherUserId = conv.userId;
        const conversation = conv.data;
        
        // Obtener informaci√≥n del otro usuario
        firebase.database().ref('users/' + otherUserId).once('value', userSnap => {
          const userData = userSnap.val();
          if (!userData) return;

          const conversationDiv = document.createElement('div');
          conversationDiv.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors active:bg-gray-100';
          conversationDiv.onclick = () => openChat(otherUserId);

          const hasUnread = conversation.unreadCount > 0;
          const isOnline = Math.random() > 0.5; // Simulado, implementar l√≥gica real de estado

          conversationDiv.innerHTML = `
            <div class="flex items-center space-x-3">
              <div class="relative">
                <img src="${userData.profileImage || 'https://via.placeholder.com/50'}" 
                     alt="${userData.username}" class="w-14 h-14 rounded-full object-cover">
                ${isOnline ? '<div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>' : ''}
                ${hasUnread ? '<div class="absolute -top-1 -left-1 w-5 h-5 bg-[#FE2C55] rounded-full flex items-center justify-center"><span class="text-xs text-white font-bold">' + (conversation.unreadCount > 9 ? '9+' : conversation.unreadCount) + '</span></div>' : ''}
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex justify-between items-start mb-1">
                  <h4 class="font-semibold truncate ${hasUnread ? 'text-black' : 'text-gray-800'}">${userData.username}</h4>
                  <span class="text-xs text-gray-500 flex-shrink-0">${formatTime(conversation.lastMessageTime)}</span>
                </div>
                <div class="flex justify-between items-center">
                  <p class="text-sm text-gray-600 truncate ${hasUnread ? 'font-medium' : ''}">${conversation.lastMessage || 'Sin mensajes'}</p>
                  ${conversation.lastMessageType === 'file' ? '<svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4z"/></svg>' : ''}
                </div>
              </div>
            </div>
          `;
          
          conversationsContainer.appendChild(conversationDiv);
        });
      });
    });
  }

  function searchConversations(query) {
    const conversations = document.querySelectorAll('#conversations-container > div');
    conversations.forEach(conv => {
      const username = conv.querySelector('h4').textContent.toLowerCase();
      const lastMessage = conv.querySelector('p').textContent.toLowerCase();
      
      if (username.includes(query.toLowerCase()) || lastMessage.includes(query.toLowerCase())) {
        conv.style.display = 'block';
      } else {
        conv.style.display = 'none';
      }
    });
  }

  function toggleChatOptions() {
    const menu = document.getElementById('chat-options-menu');
    menu.classList.toggle('hidden');
  }

  function markAllAsRead() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid).once('value', snapshot => {
      const updates = {};
      snapshot.forEach(child => {
        updates[child.key + '/unreadCount'] = 0;
      });
      firebase.database().ref('conversations/' + user.uid).update(updates);
    });
    
    document.getElementById('chat-options-menu').classList.add('hidden');
  }

  function clearAllChats() {
    if (!confirm('¬øEst√°s seguro de que quieres limpiar todos los chats? Esta acci√≥n no se puede deshacer.')) return;
    
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid).remove();
    document.getElementById('chat-options-menu').classList.add('hidden');
  }

  function openChat(userId) {
    currentChatUserId = userId;
    const user = firebase.auth().currentUser;
    if (!user) return;

    showIndividualChatView();

    // Cargar informaci√≥n del usuario
    firebase.database().ref('users/' + userId).once('value', snapshot => {
      const userData = snapshot.val();
      document.getElementById('chat-user-avatar').src = userData.profileImage || 'https://via.placeholder.com/50';
      document.getElementById('chat-user-name').textContent = userData.username || 'Usuario';
      
      // Simular estado en l√≠nea (implementar l√≥gica real)
      const isOnline = Math.random() > 0.3;
      if (isOnline) {
        document.getElementById('chat-user-online-indicator').classList.remove('hidden');
        document.getElementById('chat-user-status').textContent = 'En l√≠nea';
        document.getElementById('chat-user-status').className = 'text-sm text-green-200';
      } else {
        document.getElementById('chat-user-online-indicator').classList.add('hidden');
        document.getElementById('chat-user-status').textContent = '√öltima vez hace ' + Math.floor(Math.random() * 60) + ' min';
        document.getElementById('chat-user-status').className = 'text-sm text-red-100';
      }
    });

    // Marcar conversaci√≥n como le√≠da
    firebase.database().ref('conversations/' + user.uid + '/' + userId).update({
      unreadCount: 0
    });

    // Cargar mensajes
    loadMessages(userId);
    
    // Configurar listeners de escritura en tiempo real
    setupTypingListeners(userId);
    
    // Limpiar el input
    document.getElementById('message-input').value = '';
    updateSendButton();
  }

  function setupTypingListeners(userId) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const conversationId = [user.uid, userId].sort().join('_');
    
    // Escuchar cuando el otro usuario est√° escribiendo
    firebase.database().ref('typing/' + conversationId + '/' + userId).on('value', snapshot => {
      if (snapshot.exists() && snapshot.val() === true) {
        showTypingIndicator(userId);
      } else {
        hideTypingIndicator();
      }
    });
  }

  function clearTypingListeners() {
    if (currentChatUserId) {
      const user = firebase.auth().currentUser;
      if (user) {
        const conversationId = [user.uid, currentChatUserId].sort().join('_');
        firebase.database().ref('typing/' + conversationId + '/' + currentChatUserId).off();
        
        // Limpiar nuestro estado de escritura
        firebase.database().ref('typing/' + conversationId + '/' + user.uid).remove();
      }
    }
  }

  function showTypingIndicator(userId) {
    firebase.database().ref('users/' + userId).once('value', snapshot => {
      const userData = snapshot.val();
      document.getElementById('typing-user-name').textContent = userData.username || 'Usuario';
      document.getElementById('typing-indicator').classList.remove('hidden');
    });
  }

  function hideTypingIndicator() {
    document.getElementById('typing-indicator').classList.add('hidden');
  }

  function handleMessageInput(textarea) {
    // Auto-resize textarea
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
    
    // Update send button state
    updateSendButton();
    
    // Handle typing indicator
    handleTypingIndicator(textarea.value.trim().length > 0);
  }

  function handleTypingIndicator(isTyping) {
    const user = firebase.auth().currentUser;
    if (!user || !currentChatUserId) return;

    const conversationId = [user.uid, currentChatUserId].sort().join('_');
    
    if (isTyping && !window.isTyping) {
      window.isTyping = true;
      firebase.database().ref('typing/' + conversationId + '/' + user.uid).set(true);
      
      // Limpiar despu√©s de 3 segundos
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        window.isTyping = false;
        firebase.database().ref('typing/' + conversationId + '/' + user.uid).remove();
      }, 3000);
    } else if (!isTyping && window.isTyping) {
      window.isTyping = false;
      firebase.database().ref('typing/' + conversationId + '/' + user.uid).remove();
      clearTimeout(typingTimeout);
    }
  }

  function updateSendButton() {
    const input = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    
    if (input.value.trim().length > 0) {
      sendButton.disabled = false;
      sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      sendButton.disabled = true;
      sendButton.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }

  function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  }

  function toggleChatMenu() {
    document.getElementById('chat-menu').classList.toggle('hidden');
  }

  function clearCurrentChat() {
    if (!confirm('¬øEst√°s seguro de que quieres limpiar este chat?')) return;
    
    const user = firebase.auth().currentUser;
    if (!user || !currentChatUserId) return;

    const conversationId = [user.uid, currentChatUserId].sort().join('_');
    firebase.database().ref('messages/' + conversationId).remove().then(() => {
      document.getElementById('messages-container').innerHTML = '';
      document.getElementById('chat-menu').classList.add('hidden');
    });
  }

  function makeVoiceCall(userId) {
    // Implementar llamadas de voz (placeholder)
    alert('Funci√≥n de llamadas pr√≥ximamente disponible');
  }

  function toggleVoiceMessage() {
    if (!voiceRecordingActive) {
      startVoiceRecording();
    } else {
      stopVoiceRecording();
    }
  }

  function loadMessages(userId) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.innerHTML = '';

    // Crear ID √∫nico para la conversaci√≥n
    const conversationId = [user.uid, userId].sort().join('_');

    firebase.database().ref('messages/' + conversationId).orderByChild('timestamp').on('value', snapshot => {
      messagesContainer.innerHTML = '';
      
      let lastMessageDate = null;
      
      snapshot.forEach(child => {
        const message = child.val();
        const messageDate = new Date(message.timestamp).toDateString();
        
        // Agregar separador de fecha si es necesario
        if (lastMessageDate !== messageDate) {
          const dateSeparator = document.createElement('div');
          dateSeparator.className = 'flex justify-center my-4';
          dateSeparator.innerHTML = `
            <span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs">
              ${formatDateSeparator(message.timestamp)}
            </span>
          `;
          messagesContainer.appendChild(dateSeparator);
          lastMessageDate = messageDate;
        }
        
        const messageDiv = document.createElement('div');
        const isOwnMessage = message.senderId === user.uid;
        
        messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-3 group`;

        let messageContent = '';
        
        if (message.type === 'file') {
          const fileType = getFileType(message.fileName);
          messageContent = `
            <div class="bg-gray-100 p-3 rounded-lg mb-2 border border-gray-200">
              <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center">
                  <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4z"/>
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate">${message.fileName}</p>
                  <p class="text-xs text-gray-500">${fileType}</p>
                </div>
              </div>
              <a href="${message.fileUrl}" download="${message.fileName}" class="inline-block mt-2 text-blue-600 hover:text-blue-800 text-sm">
                Descargar archivo
              </a>
            </div>
          `;
        } else if (message.type === 'voice') {
          messageContent = `
            <div class="flex items-center space-x-2 p-2">
              <button onclick="playVoiceMessage('${message.voiceUrl}')" class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 5v10l7-5-7-5z"/>
                </svg>
              </button>
              <div class="flex-1 bg-gray-300 h-1 rounded">
                <div class="bg-blue-500 h-1 rounded" style="width: 0%"></div>
              </div>
              <span class="text-xs text-gray-500">${message.duration || '0:00'}</span>
            </div>
          `;
        } else {
          // Detectar enlaces y convertirlos a clickeable
          messageContent = linkifyText(message.text);
        }

        messageDiv.innerHTML = `
          <div class="max-w-xs lg:max-w-md relative">
            <div class="px-4 py-3 rounded-2xl ${isOwnMessage ? 'bg-[#FE2C55] text-white rounded-br-md' : 'bg-white text-black border border-gray-200 rounded-bl-md'} shadow-sm">
              ${messageContent}
            </div>
            <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mt-1 px-2">
              <span class="text-xs text-gray-500">
                ${formatTime(message.timestamp)}
                ${isOwnMessage ? (message.read ? ' <span class="text-blue-500">‚úì‚úì</span>' : ' <span class="text-gray-400">‚úì</span>') : ''}
              </span>
            </div>
            
            <!-- Men√∫ contextual del mensaje -->
            <div class="hidden group-hover:block absolute top-0 ${isOwnMessage ? 'left-0 -translate-x-full' : 'right-0 translate-x-full'} p-2">
              <div class="bg-white border border-gray-200 rounded-lg shadow-lg py-1">
                <button onclick="replyToMessage('${child.key}', '${message.text}')" class="w-full px-3 py-1 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                  </svg>
                  Responder
                </button>
                ${isOwnMessage ? `
                  <button onclick="deleteMessage('${child.key}')" class="w-full px-3 py-1 text-sm text-red-600 hover:bg-gray-100 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Eliminar
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;

        messagesContainer.appendChild(messageDiv);
      });

      // Scroll al final con animaci√≥n suave
      setTimeout(() => {
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);

      // Marcar mensajes como le√≠dos
      if (currentChatUserId === userId) {
        snapshot.forEach(child => {
          const message = child.val();
          if (message.senderId !== user.uid && !message.read) {
            child.ref.update({ read: true });
          }
        });
      }
    });
  }

  function linkifyText(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank" class="underline">$1</a>');
  }

  function getFileType(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();
    const types = {
      'pdf': 'Documento PDF',
      'doc': 'Documento Word',
      'docx': 'Documento Word',
      'txt': 'Archivo de texto',
      'jpg': 'Imagen JPEG',
      'jpeg': 'Imagen JPEG',
      'png': 'Imagen PNG',
      'gif': 'Imagen GIF',
      'mp4': 'Video MP4',
      'mp3': 'Audio MP3'
    };
    return types[extension] || 'Archivo';
  }

  function formatDateSeparator(timestamp) {
    const date = new Date(timestamp);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (date.toDateString() === today.toDateString()) {
      return 'Hoy';
    } else if (date.toDateString() === yesterday.toDateString()) {
      return 'Ayer';
    } else {
      return date.toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
  }

  function replyToMessage(messageId, originalText) {
    const input = document.getElementById('message-input');
    input.value = `> ${originalText.substring(0, 50)}${originalText.length > 50 ? '...' : ''}\n\n`;
    input.focus();
    updateSendButton();
  }

  function deleteMessage(messageId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar este mensaje?')) return;
    
    const user = firebase.auth().currentUser;
    if (!user || !currentChatUserId) return;

    const conversationId = [user.uid, currentChatUserId].sort().join('_');
    firebase.database().ref('messages/' + conversationId + '/' + messageId).remove();
  }

  function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();
    
    if (!messageText || !currentChatUserId) return;

    const user = firebase.auth().currentUser;
    if (!user) return;

    // ‚ú® DETECTAR MENSAJES SECRETOS ‚ú®
    checkForSecretMessage(messageText);

    const conversationId = [user.uid, currentChatUserId].sort().join('_');
    const messageData = {
      senderId: user.uid,
      receiverId: currentChatUserId,
      text: messageText,
      timestamp: Date.now(),
      read: false,
      type: 'text'
    };

    // Limpiar estado de escritura
    window.isTyping = false;
    firebase.database().ref('typing/' + conversationId + '/' + user.uid).remove();
    clearTimeout(typingTimeout);

    // Guardar mensaje
    firebase.database().ref('messages/' + conversationId).push(messageData);

    // Actualizar conversaciones
    const conversationUpdate = {
      lastMessage: messageText,
      lastMessageTime: Date.now(),
      lastMessageType: 'text'
    };

    firebase.database().ref('conversations/' + user.uid + '/' + currentChatUserId).update(conversationUpdate);
    firebase.database().ref('conversations/' + currentChatUserId + '/' + user.uid).update({
      ...conversationUpdate,
      unreadCount: firebase.database.ServerValue.increment(1)
    });

    // Enviar notificaci√≥n
    firebase.database().ref('users/' + user.uid).once('value', senderSnap => {
      const senderData = senderSnap.val();
      addNotification(currentChatUserId, `${senderData.username} te ha enviado un mensaje: ${messageText}`, 'message');
    });

    // Limpiar input y reset UI
    messageInput.value = '';
    messageInput.style.height = 'auto';
    updateSendButton();

    // Scroll inmediato al final
    const messagesContainer = document.getElementById('messages-container');
    setTimeout(() => {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    }, 50);
  }

  function openNewMessage() {
    const modal = document.getElementById('new-message-modal');
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevenir scroll del fondo
  }

  function closeNewMessage() {
    const modal = document.getElementById('new-message-modal');
    modal.classList.add('hidden');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restaurar scroll del fondo
    document.getElementById('author-search').value = '';
    document.getElementById('new-message-text').value = '';
    document.getElementById('authors-results').classList.add('hidden');
    selectedAuthorForMessage = null;
  }

  function searchAuthors(query) {
    if (!query.trim()) {
      document.getElementById('authors-results').classList.add('hidden');
      return;
    }

    firebase.database().ref('users').once('value', snapshot => {
      const resultsContainer = document.getElementById('authors-results');
      resultsContainer.innerHTML = '';
      resultsContainer.classList.remove('hidden');

      let hasResults = false;
      snapshot.forEach(child => {
        const userData = child.val();
        if (userData.username && userData.username.toLowerCase().includes(query.toLowerCase())) {
          hasResults = true;
          const authorDiv = document.createElement('div');
          authorDiv.className = 'p-3 hover:bg-gray-100 cursor-pointer flex items-center space-x-3';
          authorDiv.onclick = () => selectAuthor(child.key, userData);
          
          authorDiv.innerHTML = `
            <img src="${userData.profileImage || 'https://via.placeholder.com/40'}" 
                 alt="${userData.username}" class="w-10 h-10 rounded-full object-cover">
            <div>
              <h4 class="font-semibold">${userData.username}</h4>
              <p class="text-sm text-gray-500">${userData.bio || 'Autor'}</p>
            </div>
          `;
          
          resultsContainer.appendChild(authorDiv);
        }
      });

      if (!hasResults) {
        resultsContainer.innerHTML = '<div class="p-3 text-gray-500 text-center">No se encontraron autores</div>';
      }
    });
  }

  function selectAuthor(userId, userData) {
    selectedAuthorForMessage = userId;
    document.getElementById('author-search').value = userData.username;
    document.getElementById('authors-results').classList.add('hidden');
  }

  function sendNewMessage() {
    const messageText = document.getElementById('new-message-text').value.trim();
    
    if (!messageText || !selectedAuthorForMessage) {
      alert('Por favor selecciona un autor y escribe un mensaje');
      return;
    }

    const user = firebase.auth().currentUser;
    if (!user) return;

    const conversationId = [user.uid, selectedAuthorForMessage].sort().join('_');
    const messageData = {
      senderId: user.uid,
      receiverId: selectedAuthorForMessage,
      text: messageText,
      timestamp: Date.now(),
      read: false,
      type: 'text'
    };

    // Guardar mensaje
    firebase.database().ref('messages/' + conversationId).push(messageData);

    // Crear/actualizar conversaciones
    const conversationUpdate = {
      lastMessage: messageText,
      lastMessageTime: Date.now()
    };

    firebase.database().ref('conversations/' + user.uid + '/' + selectedAuthorForMessage).update(conversationUpdate);
    firebase.database().ref('conversations/' + selectedAuthorForMessage + '/' + user.uid).update({
      ...conversationUpdate,
      unreadCount: 1
    });

    // Enviar notificaci√≥n
    firebase.database().ref('users/' + user.uid).once('value', senderSnap => {
      const senderData = senderSnap.val();
      addNotification(selectedAuthorForMessage, `${senderData.username} te ha enviado un mensaje: ${messageText}`, 'message');
    });

    closeNewMessage();
    alert('Mensaje enviado correctamente');
  }

  function deleteConversation(userId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta conversaci√≥n?')) return;

    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid + '/' + userId).remove();
    
    // Volver a la vista sin chat seleccionado
    document.getElementById('chat-header').classList.add('hidden');
    document.getElementById('messages-container').classList.add('hidden');
    document.getElementById('message-input-container').classList.add('hidden');
    document.getElementById('no-chat-selected').classList.remove('hidden');
    
    currentChatUserId = null;
  }

  function listenForUnreadMessages() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid).on('value', snapshot => {
      let totalUnread = 0;
      snapshot.forEach(child => {
        const conversation = child.val();
        totalUnread += conversation.unreadCount || 0;
      });

      const unreadBadge = document.getElementById('unread-messages-count');
      if (totalUnread > 0) {
        unreadBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
        unreadBadge.classList.remove('hidden');
      } else {
        unreadBadge.classList.add('hidden');
      }
    });
  }

  function attachFile() {
    document.getElementById('file-input').click();
  }

  function handleFileAttachment(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) { // 5MB l√≠mite
      alert('El archivo es muy grande. M√°ximo 5MB.');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const user = firebase.auth().currentUser;
      const conversationId = [user.uid, currentChatUserId].sort().join('_');
      
      const messageData = {
        senderId: user.uid,
        receiverId: currentChatUserId,
        type: 'file',
        fileName: file.name,
        fileUrl: e.target.result,
        timestamp: Date.now(),
        read: false
      };

      firebase.database().ref('messages/' + conversationId).push(messageData);

      // Actualizar conversaciones
      const conversationUpdate = {
        lastMessage: `üìé ${file.name}`,
        lastMessageTime: Date.now()
      };

      firebase.database().ref('conversations/' + user.uid + '/' + currentChatUserId).update(conversationUpdate);
      firebase.database().ref('conversations/' + currentChatUserId + '/' + user.uid).update({
        ...conversationUpdate,
        unreadCount: firebase.database.ServerValue.increment(1)
      });
    };
    
    reader.readAsDataURL(file);
  }

  function toggleEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.classList.toggle('hidden');
  }

  function insertEmoji(emoji) {
    const input = document.getElementById('message-input');
    input.value += emoji;
    document.getElementById('emoji-picker').classList.add('hidden');
    input.focus();
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffInHours = (now - date) / (1000 * 60 * 60);

    if (diffInHours < 1) {
      return 'Ahora';
    } else if (diffInHours < 24) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    } else if (diffInHours < 168) { // Una semana
      return date.toLocaleDateString('es-ES', { weekday: 'short' });
    } else {
      return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
    }
  }

  // Funci√≥n para abrir perfil de usuario desde el chat
  function openUserProfile(userId) {
    if (userId) {
      closeMessages();
      openAuthorProfile(userId);
    }
  }

  // Funci√≥n mejorada para agregar el bot√≥n de mensaje en perfiles de autor
  function addMessageButtonToProfile(authorId) {
    const user = firebase.auth().currentUser;
    if (!user || user.uid === authorId) return;

    const messageButton = document.createElement('button');
    messageButton.className = 'bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center hover:bg-blue-600 transition';
    messageButton.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      Mensaje
    `;
    messageButton.onclick = () => startConversationWithAuthor(authorId);

    const actionsContainer = document.querySelector('#author-profile-modal .flex.items-center.justify-center.w-full.mt-4.space-x-2');
    if (actionsContainer) {
      actionsContainer.appendChild(messageButton);
    }
  }

  function startConversationWithAuthor(authorId) {
    document.getElementById('author-profile-modal').style.display = 'none';
    selectedAuthorForMessage = authorId;
    
    firebase.database().ref('users/' + authorId).once('value', snapshot => {
      const userData = snapshot.val();
      document.getElementById('author-search').value = userData.username;
      openNewMessage();
    });
  }

  /*************** FIN SISTEMA DE MENSAJER√çA **************************/
</script>
<!-- NUEVO SCRIPT: Funci√≥n para descargar la historia completa y almacenarla offline -->
<script>
  function downloadStory() {
    if (!window.currentStoryId) {
      alert("No se ha seleccionado una historia.");
      return;
    }
    const storyId = window.currentStoryId;
    const btn = document.getElementById('download-story-btn');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    firebase.database().ref('stories/' + storyId).once('value')
      .then(storySnap => {
        const storyData = storySnap.val();
        if (!storyData) {
          throw new Error("Historia no encontrada");
        }
        return firebase.database().ref('stories/' + storyId + '/chapters').once('value')
          .then(chaptersSnap => {
            let chaptersHTML = '';
            chaptersSnap.forEach(child => {
              const chapter = child.val();
              chapter.id = child.key;
              // Se crea un bloque para cada cap√≠tulo con t√≠tulo y contenido completo
              chaptersHTML += `<div class="chapter" style="margin-bottom:20px;">
                  <h3 style="margin-bottom:10px;">Cap√≠tulo ${chapter.chapterNumber}</h3>
                  <p style="text-align:justify; white-space: pre-wrap;">${chapter.content}</p>
                </div>`;
            });
            storyData.chaptersHTML = chaptersHTML;
            return storyData;
          });
      })
      .then(storyData => {
        const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>${storyData.title}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .cover { max-width: 100%; height: auto; }
    .chapter { margin-top: 20px; margin-bottom: 20px; }
    .chapter h3 { margin-bottom: 10px; }
    .chapter p { text-align: justify; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>${storyData.title}</h1>
  <img src="${storyData.coverImage}" alt="Portada" class="cover">
  <div class="chapters">
    ${storyData.chaptersHTML}
  </div>
</body>
</html>`;
        const blob = new Blob([htmlContent], {
          type: 'text/html'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = storyData.title.replace(/\s+/g, '_') + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        icon.classList.remove('fa-spin');
        icon.classList.remove('fa-download');
        icon.classList.add('fa-check');
        alert("Historia descargada para lectura offline.");
        setTimeout(() => {
          icon.classList.remove('fa-check');
          icon.classList.add('fa-download');
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        alert("Error al descargar la historia: " + err.message);
        icon.classList.remove('fa-spin');
      });
  }
</script>
<!-- BEABOO STUDIO SECTION -->
<div id="beaboo-studio-modal" class="fixed inset-0 z-50 hidden bg-white overflow-y-auto">
  <div class="p-4">
    <!-- Bot√≥n Volver -->
    <button onclick="closeBeabooStudio()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>

    <h2 class="text-2xl font-bold mb-6">BeaBoo Studio</h2>

    <!-- Selector de Fechas -->
    <div class="mb-6 flex items-center space-x-4">
      <select id="date-range" class="p-2 border rounded-lg">
        <option value="7">√öltimos 7 d√≠as</option>
        <option value="30">√öltimos 30 d√≠as</option>
        <option value="90">√öltimos 3 meses</option>
        <option value="365">√öltimo a√±o</option>
      </select>
      <div class="flex items-center space-x-2">
        <input type="date" id="date-start" class="p-2 border rounded-lg">
        <span>hasta</span>
        <input type="date" id="date-end" class="p-2 border rounded-lg">
      </div>
      <button onclick="updateStudioStats()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg">
        Actualizar
      </button>
    </div>

    <!-- Panel de Estad√≠sticas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Total Historias</h3>
        <p id="total-stories" class="text-2xl font-bold">0</p>
        <p id="stories-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Total Vistas</h3>
        <p id="total-views" class="text-2xl font-bold">0</p>
        <p id="views-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Seguidores</h3>
        <p id="total-followers" class="text-2xl font-bold">0</p>
        <p id="followers-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Calificaci√≥n</h3>
        <p id="average-rating" class="text-2xl font-bold">0.0</p>
        <p id="rating-trend" class="text-sm text-green-500">+0%</p>
      </div>
    </div>

    <!-- Gr√°ficos de Tendencias -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-lg font-bold mb-4">Tendencias de Lectura</h3>
        <canvas id="reading-trends" class="w-full h-64"></canvas>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-lg font-bold mb-4">Interacci√≥n por Hora</h3>
        <canvas id="hourly-engagement" class="w-full h-64"></canvas>
      </div>
    </div>

    <!-- Gesti√≥n de Historias -->
    <div class="bg-white rounded-xl shadow p-4 mb-8">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Mis Historias</h3>
        <div class="flex space-x-4">
          <button onclick="openStoryCreation()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Nueva Historia
          </button>
          <button onclick="analyzeAccount()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Analizar Cuenta
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-4 text-left">Historia</th>
              <th class="p-4 text-left">Cap√≠tulos</th>
              <th class="p-4 text-left">Vistas</th>
              <th class="p-4 text-left">Rating</th>
              <th class="p-4 text-left">Estado</th>
              <th class="p-4 text-left">Acciones</th>
            </tr>
          </thead>
          <tbody id="stories-table" class="divide-y divide-gray-200">
            <!-- Las historias se cargar√°n aqu√≠ din√°micamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Insights y Recomendaciones -->
    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="text-lg font-bold mb-4">Insights</h3>
      <div id="insights" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="font-bold text-blue-700">Mejor hora para publicar</h4>
          <p id="best-time" class="mt-2">Analizando datos...</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <h4 class="font-bold text-green-700">Contenido m√°s exitoso</h4>
          <p id="best-content" class="mt-2">Analizando datos...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CALENDARIO -->
<div id="calendar-modal" class="fixed inset-0 z-50 hidden bg-white">
  <div class="p-4">
    <!-- Bot√≥n Volver -->
    <button onclick="closeCalendar()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span></span>
    </button>

    <h2 class="text-2xl font-bold mb-4">Pr√≥ximas Publicaciones</h2>
    <div id="scheduled-content" class="space-y-4">
      <!-- Aqu√≠ se mostrar√°n los cap√≠tulos programados -->
    </div>
  </div>
</div>

<script>
function openDisneyModal() {
  const modal = document.getElementById('disney-modal');
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeDisneyModal() {
  const modal = document.getElementById('disney-modal');
  modal.classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function openCalendar() {
  const modal = document.getElementById('calendar-modal');
  modal.classList.remove('hidden');
  
  // Cargar cap√≠tulos programados
  firebase.database().ref('scheduledChapters').once('value').then(snapshot => {
    const container = document.getElementById('scheduled-content');
    container.innerHTML = '';
    
    snapshot.forEach(child => {
      const scheduled = child.val();
      const storyId = scheduled.storyId;
      const releaseDate = new Date(scheduled.publishDate);
      const now = new Date();
      const daysUntil = Math.ceil((releaseDate - now) / (1000 * 60 * 60 * 24));
      const isAvailable = now >= releaseDate;
      
      // Obtener informaci√≥n de la historia
      firebase.database().ref('stories/' + storyId).once('value').then(storySnap => {
        const story = storySnap.val();
        const isNew = (now - new Date(story.createdAt)) < 7 * 24 * 60 * 60 * 1000; // 7 d√≠as
        
        const div = document.createElement('div');
        div.className = 'bg-gray-100 p-4 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center space-x-4">
            <img src="${story.coverImage || 'https://via.placeholder.com/100x150/cccccc/666666?text=Story'}" alt="${story.title}" class="w-20 h-30 object-cover rounded">
            <div class="flex-1">
              <div class="flex items-center">
                <h3 class="font-bold">${story.title}</h3>
                ${isNew ? '<span class="ml-2 bg-[#FE2C55] text-white px-2 py-1 rounded text-xs">ESTRENO</span>' : ''}
              </div>
              <p class="text-gray-600">Cap√≠tulo ${scheduled.chapterNumber}</p>
              ${isAvailable ? 
                `<button onclick="openChapterReadModal('${storyId}', '${child.key}')" 
                  class="bg-[#58CC02] text-white px-3 py-1 rounded-full text-sm">
                  Leer ahora
                </button>` : 
                `<p class="text-gray-600">Se publicar√° en ${daysUntil} d√≠as</p>
                 <p class="text-gray-600">Fecha: ${releaseDate.toLocaleDateString()}</p>`
              }
            </div>
            ${isNew ? `
  <div class="flex flex-wrap items-center gap-2">
    <span class="bg-[#FE2C55] text-white px-2 py-1 rounded text-xs">ESTRENO</span>
    <button 
      onclick="toggleNotification(event, '${storyId}', '${child.key}', '${story.title}', ${scheduled.publishDate})"
      class="notification-bell-btn inline-flex items-center px-2 py-1 text-gray-600 hover:text-[#FE2C55] transition-colors"
    >
      <i class="fas fa-bell notification-bell text-sm"></i>
      <span class="ml-1 text-xs">Avisarme</span>
    </button>
  </div>
` : ''}
          </div>
        `;
        
        container.appendChild(div);

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
          .notification-bell {
            transform-origin: top;
          }
          
          .notification-bell.active {
            color: #FE2C55;
            animation: bellRing 1s ease-in-out;
          }
          
          @keyframes bellRing {
            0%, 100% { transform: rotate(0); }
            20%, 60% { transform: rotate(25deg); }
            40%, 80% { transform: rotate(-25deg); }
          }
        `;
        document.head.appendChild(style);
        
        // Programar notificaci√≥n
        const user = firebase.auth().currentUser;
        if (user) {
          const notificationTime = new Date(scheduled.publishDate);
          const currentTime = new Date();
          
          if (notificationTime > currentTime) {
            const timeUntilNotification = notificationTime.getTime() - currentTime.getTime();
            
            setTimeout(() => {
              addNotification(user.uid, `¬°Tu cap√≠tulo programado de "${story.title}" ha sido publicado!`, 'chapter_published');
              
              // Solo actualizar cuando llegue la fecha de publicaci√≥n
              if (new Date() >= notificationTime) {
                firebase.database().ref('stories/' + storyId + '/chapters/' + child.key).update({
                  status: 'published'
                });
              }
              
              // Eliminar de cap√≠tulos programados
              firebase.database().ref('scheduledChapters/' + child.key).remove();
            }, timeUntilNotification);
          }
        }
      });
    });
  });
}

function closeCalendar() {
  document.getElementById('calendar-modal').classList.add('hidden');
}

function toggleNotification(event, storyId, chapterId, storyTitle, publishDate) {
  event.stopPropagation();
  const user = firebase.auth().currentUser;
  if (!user) return;

  const bell = event.currentTarget.querySelector('.notification-bell');
  bell.classList.add('active');
  
  // Toggle notification in database
  const notificationRef = firebase.database().ref(`userNotifications/${user.uid}/${chapterId}`);
  
  notificationRef.once('value').then(snapshot => {
    if (snapshot.exists()) {
      // Remove notification
      notificationRef.remove();
      bell.style.color = '#666';
      alert('Notificaci√≥n cancelada');
    } else {
      // Add notification
      notificationRef.set({
        storyId,
        storyTitle,
        publishDate,
        status: 'pending'
      });
      bell.style.color = '#FE2C55';
      alert('¬°Te avisaremos cuando se publique el cap√≠tulo!');

      // Schedule notification
      const notificationTime = new Date(publishDate);
      const currentTime = new Date();
      
      if (notificationTime > currentTime) {
        const timeUntilNotification = notificationTime.getTime() - currentTime.getTime();
        
        setTimeout(() => {
          addNotification(
            user.uid, 
            `¬°El nuevo cap√≠tulo de "${storyTitle}" ya est√° disponible!`,
            'chapter_release'
          );
        }, timeUntilNotification);
      }
    }
  });

  setTimeout(() => {
    bell.classList.remove('active');
  }, 1000);
}

function openBeabooStudio() {
  const user = firebase.auth().currentUser;
  if (!user) return;
  
  document.getElementById('beaboo-studio-modal').classList.remove('hidden');
  
  // Establecer fechas por defecto
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - 7);
  document.getElementById('date-start').value = start.toISOString().split('T')[0];
  document.getElementById('date-end').value = end.toISOString().split('T')[0];
  
  updateStudioStats();
}

function updateStudioStats() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const startDate = new Date(document.getElementById('date-start').value);
  const endDate = new Date(document.getElementById('date-end').value);
  
  firebase.database().ref('stories').orderByChild('userId').equalTo(user.uid).once('value')
    .then(snapshot => {
      let totalStories = 0;
      let totalViews = 0;
      let totalRating = 0;
      let ratingCount = 0;
      let viewsData = {};
      let hourlyData = new Array(24).fill(0);
      
      // Procesar datos
      snapshot.forEach(child => {
        const story = child.val();
        const storyDate = new Date(story.createdAt);
        
        if (storyDate >= startDate && storyDate <= endDate) {
          totalStories++;
          totalViews += story.views || 0;
          
          // Datos por hora
          const hour = storyDate.getHours();
          hourlyData[hour] += story.views || 0;
          
          // Datos para gr√°fico de tendencias
          const dateStr = storyDate.toLocaleDateString();
          viewsData[dateStr] = (viewsData[dateStr] || 0) + (story.views || 0);
          
          if (story.ratings) {
            Object.values(story.ratings).forEach(rating => {
              totalRating += rating;
              ratingCount++;
            });
          }
        }
        
        // Actualizar tabla de historias
        updateStoriesTable(story);
      });
      
      // Actualizar estad√≠sticas
      updateStatistics(totalStories, totalViews, totalRating, ratingCount);
      
      // Actualizar gr√°ficos
      updateCharts(viewsData, hourlyData);
      
      // Calcular y mostrar insights
      calculateInsights(hourlyData, viewsData);
    });
}

function updateStoriesTable(story) {
  const tbody = document.getElementById('stories-table');
  const row = document.createElement('tr');
  row.className = 'hover:bg-gray-50';
  
  const status = story.status || 'published';
  const statusColors = {
    'published': 'bg-green-100 text-green-800',
    'draft': 'bg-gray-100 text-gray-800',
    'scheduled': 'bg-blue-100 text-blue-800'
  };
  
  row.innerHTML = `
    <td class="p-4">
      <div class="flex items-center space-x-3">
        <img src="${story.coverImage || 'https://via.placeholder.com/50x75/cccccc/666666?text=Cover'}" class="w-12 h-16 object-cover rounded" alt="${story.title}">
        <div>
          <h4 class="font-bold">${story.title}</h4>
          <p class="text-sm text-gray-600">${new Date(story.createdAt).toLocaleDateString()}</p>
        </div>
      </div>
    </td>
    <td class="p-4">${(story.chapters || []).length}</td>
    <td class="p-4">${story.views || 0}</td>
    <td class="p-4">${calculateAverageRating(story.ratings)}</td>
    <td class="p-4">
      <span class="px-2 py-1 rounded-full text-xs ${statusColors[status]}">
        ${status.charAt(0).toUpperCase() + status.slice(1)}
      </span>
    </td>
    <td class="p-4">
      <div class="flex space-x-2">
        <button onclick="openStoryEdit(${JSON.stringify(story)})" class="text-blue-600 hover:text-blue-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        </button>
        <button onclick="openChapterCreationModal()" class="text-green-600 hover:text-green-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>
    </td>
  `;
  
  tbody.appendChild(row);
}

function updateStatistics(totalStories, totalViews, totalRating, ratingCount) {
  document.getElementById('total-stories').textContent = totalStories;
  document.getElementById('total-views').textContent = totalViews;
  document.getElementById('average-rating').textContent = 
    ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : "0.0";
  
  // Actualizar tendencias (ejemplo)
  document.getElementById('stories-trend').textContent = '+5%';
  document.getElementById('views-trend').textContent = '+12%';
  document.getElementById('rating-trend').textContent = '+2%';
}

function updateCharts(viewsData, hourlyData) {
  // Gr√°fico de tendencias
  const trendCtx = document.getElementById('reading-trends').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: Object.keys(viewsData),
      datasets: [{
        label: 'Vistas',
        data: Object.values(viewsData),
        borderColor: '#FE2C55',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
  
  // Gr√°fico de actividad por hora
  const hourlyCtx = document.getElementById('hourly-engagement').getContext('2d');
  new Chart(hourlyCtx, {
    type: 'bar',
    data: {
      labels: Array.from({length: 24}, (_, i) => `${i}:00`),
      datasets: [{
        label: 'Actividad',
        data: hourlyData,
        backgroundColor: '#FE2C55'
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function calculateInsights(hourlyData, viewsData) {
  // Calcular mejor hora para publicar
  const bestHour = hourlyData.indexOf(Math.max(...hourlyData));
  document.getElementById('best-time').textContent = 
    `La mejor hora para publicar es a las ${bestHour}:00, donde tienes mayor engagement.`;
  
  // Calcular contenido m√°s exitoso
  const bestDate = Object.entries(viewsData)
    .reduce((a, b) => (b[1] > a[1] ? b : a))[0];
  document.getElementById('best-content').textContent = 
    `Tu contenido m√°s exitoso fue publicado el ${bestDate}.`;
}

function calculateAverageRating(ratings) {
  if (!ratings) return "0.0";
  const values = Object.values(ratings);
  return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
}

function analyzeAccount() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  // Show analysis modal
  const analysisModal = document.createElement('div');
  analysisModal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[60]';
  analysisModal.innerHTML = `
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
      <div id="analysis-loading" class="text-center">
        <div class="spinner-ring mb-4">
          <div></div><div></div><div></div><div></div>
        </div>
        <h3 class="text-xl font-bold mb-2">Analizando cuenta</h3>
        <p id="analysis-status" class="text-gray-600">Recopilando datos...</p>
      </div>
      <div id="analysis-results" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">Resultados del an√°lisis</h3>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="analysis-metrics" class="space-y-4"></div>
      </div>
    </div>
  `;

  document.body.appendChild(analysisModal);

  // Add spinner styles
  const style = document.createElement('style');
  style.textContent = `
    .spinner-ring {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }
    .spinner-ring div {
      box-sizing: border-box;
      display: block;
      position: absolute;
      width: 64px;
      height: 64px;
      margin: 8px;
      border: 8px solid #FE2C55;
      border-radius: 50%;
      animation: spinner-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
      border-color: #FE2C55 transparent transparent transparent;
    }
    .spinner-ring div:nth-child(1) { animation-delay: -0.45s; }
    .spinner-ring div:nth-child(2) { animation-delay: -0.3s; }
    .spinner-ring div:nth-child(3) { animation-delay: -0.15s; }
    @keyframes spinner-ring {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);

  // Start analysis
  let statusText = document.getElementById('analysis-status');
  let analysisData = {
    followers: 0,
    following: 0,
    posts: 0,
    warnings: [],
    suspiciousActivity: []
  };

  // Simulate analysis steps
  setTimeout(() => {
    statusText.textContent = "Analizando seguidores...";
    firebase.database().ref('followers/' + user.uid).once('value', snapshot => {
      analysisData.followers = snapshot.numChildren() || 0;
    });
  }, 5000);

  setTimeout(() => {
    statusText.textContent = "Analizando seguidos...";
    firebase.database().ref('following/' + user.uid).once('value', snapshot => {
      analysisData.following = snapshot.numChildren() || 0;
    });
  }, 10000);

  setTimeout(() => {
    statusText.textContent = "Verificando historial...";
    firebase.database().ref('userWarnings/' + user.uid).once('value', snapshot => {
      if (snapshot.exists()) {
        snapshot.forEach(child => {
          analysisData.warnings.push(child.val());
        });
      }
    });
  }, 15000);

  // Show results after 20 seconds
  setTimeout(() => {
    const loading = document.getElementById('analysis-loading');
    const results = document.getElementById('analysis-results');
    const metrics = document.getElementById('analysis-metrics');

    loading.classList.add('hidden');
    results.classList.remove('hidden');

    // Calculate account status
    let accountStatus = analysisData.warnings.length === 0 ? 
      { text: 'Cuenta en buen estado', color: 'bg-green-100 text-green-800' } :
      analysisData.warnings.length <= 2 ?
      { text: 'Advertencias activas', color: 'bg-yellow-100 text-yellow-800' } :
      { text: 'Cuenta en riesgo', color: 'bg-red-100 text-red-800' };

    metrics.innerHTML = `
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.followers}</div>
          <div class="text-sm text-gray-600">Seguidores</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.following}</div>
          <div class="text-sm text-gray-600">Seguidos</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.posts}</div>
          <div class="text-sm text-gray-600">Publicaciones</div>
        </div>
      </div>
      
      <div class="space-y-4">
        <div class="p-4 rounded-xl ${accountStatus.color}">
          <div class="font-bold">${accountStatus.text}</div>
        </div>
        
        ${analysisData.warnings.length > 0 ? `
          <div class="p-4 rounded-xl bg-gray-50">
            <div class="font-bold mb-2">Advertencias:</div>
            <ul class="list-disc list-inside space-y-1">
              ${analysisData.warnings.map(w => `<li>${w}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
    `;
  }, 20000);
}

function closeBeabooStudio() {
  document.getElementById('beaboo-studio-modal').classList.add('hidden');
  document.getElementById('story-stats').innerHTML = '';
}
</script>

<!-- Script para la vista de Live (Duolingo Live Style) -->
<script>
  const liveContainer = document.getElementById('liveContainer');
  const heartButton = document.getElementById('heartButton');
  const heartButtonViewer = document.getElementById('heartButtonViewer');
  const likeCountLive = document.getElementById('likeCountLive');
  let likesLive = 0;

  function createHeart(x, y) {
    const heart = document.createElement('img');
    heart.src = "https://cdn-0.emojis.wiki/emoji-pics/twitter/green-heart-twitter.png";
    heart.className = 'floating-heart';
    heart.style.position = 'absolute';
    heart.style.left = `${x - 12}px`;
    heart.style.top = `${y - 12}px`;
    liveContainer.appendChild(heart);
    setTimeout(() => {
      heart.remove();
    }, 1500);
  }

  function updateLikeCountLive() {
    likesLive++;
    if (likesLive >= 1000) {
      likeCountLive.textContent = (likesLive / 1000).toFixed(1) + 'K';
    } else {
      likeCountLive.textContent = likesLive;
    }
  }
  if (heartButton) {
    heartButton.addEventListener('click', () => {
      const rect = heartButton.getBoundingClientRect();
      createHeart(rect.left + rect.width / 2, rect.top + rect.height / 2);
      updateLikeCountLive();
    });
  }
</script>

<!-- (El modal de compra de monedas ha sido removido) -->

<!-- Aqu√≠ se agregan las funciones para reportar perfil -->
<script>
  // ===== BEABOO 2.0 - FUNCIONES DE MODAL DE REPORTES PANTALLA COMPLETA =====
  function openReportModal() {
    const modal = document.getElementById('report-modal');
    const modalContent = modal.querySelector('div');
    
    // Bloquear scroll del body
    document.body.style.overflow = 'hidden';
    
    // Mostrar modal
    modal.classList.remove('hidden');
    
    // Animaci√≥n de entrada
    requestAnimationFrame(() => {
      modal.classList.remove('opacity-0');
      modalContent.classList.remove('scale-95');
    });
    
    // Configurar radio buttons para animaci√≥n
    setupReportRadioButtons();
  }

  function closeReportModal() {
    const modal = document.getElementById('report-modal');
    const modalContent = modal.querySelector('div');
    
    // Animaci√≥n de salida
    modal.classList.add('opacity-0');
    modalContent.classList.add('scale-95');
    
    setTimeout(() => {
      modal.classList.add('hidden');
      document.body.style.overflow = ''; // Restaurar scroll
      
      // Limpiar formulario
      document.getElementById('report-form').reset();
      document.querySelectorAll('input[name="report-reason"]').forEach(radio => {
        radio.closest('label').querySelector('.w-2').style.opacity = '0';
      });
    }, 300);
  }

  // Funci√≥n para configurar animaciones de radio buttons
  function setupReportRadioButtons() {
    document.querySelectorAll('input[name="report-reason"]').forEach(radio => {
      radio.addEventListener('change', function() {
        // Desmarcar todos
        document.querySelectorAll('input[name="report-reason"]').forEach(r => {
          r.closest('label').querySelector('.w-2').style.opacity = '0';
        });
        
        // Marcar el seleccionado
        if (this.checked) {
          this.closest('label').querySelector('.w-2').style.opacity = '1';
        }
      });
    });
  }

  // Funci√≥n para procesar env√≠o de reporte con animaci√≥n
  function processReportSubmission() {
    const selectedReason = document.querySelector('input[name="report-reason"]:checked');
    const description = document.getElementById('report-description').value;
    
    if (!selectedReason) {
      alert('Por favor selecciona un motivo para el reporte');
      return;
    }
    
    // Mostrar animaci√≥n de env√≠o
    showReportSubmissionAnimation(selectedReason.value, description);
  }

  function showReportSubmissionAnimation(reason, description) {
    // Crear modal de animaci√≥n
    const animationModal = document.createElement('div');
    animationModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-60';
    animationModal.innerHTML = `
      <div class="bg-white rounded-xl p-8 max-w-sm w-full mx-4 text-center transform scale-95 transition-transform duration-300">
        <div id="loading-stage" class="mb-6">
          <div class="w-16 h-16 mx-auto mb-4">
            <div class="animate-spin w-16 h-16 border-4 border-[#FE2C55] border-t-transparent rounded-full"></div>
          </div>
          <h3 class="text-xl font-bold mb-2">Enviando reporte...</h3>
          <p class="text-gray-600">Procesando tu solicitud</p>
        </div>
        
        <div id="success-stage" class="hidden">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h3 class="text-xl font-bold mb-2 text-green-600">¬°Reporte enviado!</h3>
          <p class="text-gray-600 mb-4">Gracias por ayudarnos a mantener la comunidad segura. Revisaremos tu reporte pronto.</p>
          <button onclick="this.closest('.fixed').remove(); closeReportModal();" class="w-full bg-[#FE2C55] text-white py-3 rounded-lg font-medium hover:bg-red-600 transition-colors">
            Continuar
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(animationModal);
    
    // Animaci√≥n de entrada
    requestAnimationFrame(() => {
      animationModal.querySelector('div').classList.remove('scale-95');
    });
    
    // Simular env√≠o de reporte a Firebase
    setTimeout(() => {
      const user = firebase.auth().currentUser;
      if (user) {
        const reportData = {
          reporterId: user.uid,
          reporterEmail: user.email,
          reason: reason,
          description: description,
          timestamp: Date.now(),
          status: 'pending'
        };
        
        // Aqu√≠ se enviar√≠a a Firebase - simulado
        console.log('Reporte enviado:', reportData);
      }
      
      // Mostrar √©xito
      document.getElementById('loading-stage').classList.add('hidden');
      document.getElementById('success-stage').classList.remove('hidden');
    }, 2500);
  }
</script>
<script>
  const translations = {
    es: {
      appName: "BeaBoo",
      tagline: "Tu portal de historias inolvidables",
      authTitle: "BeaBoo",
      emailPlaceholder: "Correo electr√≥nico",
      passwordPlaceholder: "Contrase√±a",
      btnIniciarSesion: "Iniciar Sesi√≥n",
      btnToggleAuth: "¬øNo tienes cuenta? Reg√≠strate",
      btnVolver: "Volver",
      newReleases: "Nuevos Lanzamientos",
      top10: "Top 10",
      popular: "M√°s Populares",
      terror: "Historias de Terror Destacadas",
      searchPlaceholder: "Buscar historias o autores",
      searchResults: "Resultados de b√∫squeda",
      searchBooks: "C√≥mic",
      searchAuthors: "Autores",
      profileStories: "Mis Historias",
      editProfile: "Editar nombre",
      saveBio: "Guardar biograf√≠a",
      createStory: "Crear Historia",
      storyTitlePlaceholder: "T√≠tulo de la historia",
      selectCategory: "Selecciona una categor√≠a",
      btnCreateStory: "Crear Historia",
      editStory: "Editar Historia",
      addChapter: "Agregar Cap√≠tulo",
      deleteStory: "Eliminar Historia",
      makePrivate: "Hacer privada",
      chapterCreationTitle: "Agregar Nuevo Cap√≠tulo",
      chapterPlaceholder: "Escribe el contenido del cap√≠tulo aqu√≠...",
      btnSaveChapter: "Guardar Cap√≠tulo",
      readChapter: "Cap√≠tulo",
      btnPrevChapter: "Anterior",
      btnNextChapter: "Siguiente",
      rateChapter: "Califica:",
      authorProfile: "Por",
      reportProfile: "Reportar Perfil",
      reportInstructions: "Selecciona un motivo o describe el problema:",
      btnSendReport: "Enviar Reporte",
      reportSuccess: "Reporte enviado con √©xito. En breve recibir√°s una respuesta.",
      noInfraccion: "No se detectaron infracciones en este perfil.",
      followers: "Seguidores",
      following: "Siguiendo",
      ratings: "Calificaciones",
      languageModalTitle: "Selecciona tu idioma",
      editUsernamePrompt: "Introduce tu nuevo nombre de usuario:",
      usernameUpdated: "Nombre de usuario actualizado.",
      bioUpdated: "Biograf√≠a actualizada.",
      chapterAdded: "Cap√≠tulo agregado.",
      noEditingStory: "No hay historia en edici√≥n.",
      userNotAuthenticated: "Usuario no autenticado.",
      chapterNotFound: "Cap√≠tulo no encontrado.",
      firstChapter: "Este es el primer cap√≠tulo.",
      lastChapter: "Este es el √∫ltimo cap√≠tulo.",
      chapterRated: "Cap√≠tulo calificado con {value} estrella(s).",
      followSelfError: "No puedes seguirte a ti mismo.",
      nowFollowing: "Ahora sigues a este autor.",
      stoppedFollowing: "Has dejado de seguir a este autor.",
      alreadyFollowing: "Ya sigues a este usuario.",
      storyDeleted: "Historia eliminada.",
      editLater: "Puedes editar tu historia m√°s tarde desde tu perfil."
    },
    en: {
      appName: "BeaBoo",
      editLater: "You can edit your story later from your profile."
    },
    pt: {
      appName: "BeaBoo",
      tagline: "Seu portal para hist√≥rias inesquec√≠veis",
      editLater: "Voc√™ pode editar sua hist√≥ria mais tarde em seu perfil."
    }
  };
  // Funci√≥n que actualiza los textos de la interfaz seg√∫n currentLanguage
  function updateTranslations() {
    // Ejemplo: Actualizamos el t√≠tulo de la aplicaci√≥n y el tagline
    document.getElementById('app-name').innerText = translations[currentLanguage].appName;
    document.getElementById('tagline').innerText = translations[currentLanguage].tagline;
    // ... (contin√∫a actualizando todos los elementos que dependan de traducciones)
  }
  // Funci√≥n para establecer el idioma y guardar la selecci√≥n
  function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem("selectedLanguage", lang);
    const langOverlay = document.getElementById('lang-loading-overlay');
    if (langOverlay) langOverlay.style.display = "flex";
    setTimeout(() => {
      updateTranslations();
      if (langOverlay) langOverlay.style.display = "none";
      const langModal = document.getElementById('language-modal');
      if (langModal) langModal.style.display = "none";
    }, 1000);
  }

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }

  // ============ FUNCIONES PARA ANIMACIONES SECRETAS ============
  
  function checkForSecretMessage(messageText) {
    const text = messageText.toLowerCase();
    const secretTriggers = [
      'i love you',
      'te amo',
      'te quiero',
      'i love u',
      'love you',
      'te adoro',
      'eres mi vida',
      'eres mi mundo',
      'mi amor',
      'mi coraz√≥n',
      'my heart',
      'my love',
      'be mine',
      's√© m√≠o',
      's√© m√≠a',
      'forever',
      'para siempre',
      '‚ù§Ô∏è',
      'üíï',
      'üíñ',
      'üíó',
      'üíò',
      'üíù',
      'üíû'
    ];

    // Verificar si el mensaje contiene alg√∫n trigger secreto
    const hasSecretMessage = secretTriggers.some(trigger => text.includes(trigger));
    
    if (hasSecretMessage) {
      setTimeout(() => {
        triggerLoveAnimation(messageText);
      }, 500); // Peque√±o delay para que se env√≠e el mensaje primero
    }
  }

  function triggerLoveAnimation(originalMessage) {
    const overlay = document.getElementById('secret-animation-overlay');
    overlay.style.display = 'block';
    overlay.innerHTML = '';

    // Crear coraz√≥n gigante central
    const bigHeart = document.createElement('div');
    bigHeart.className = 'big-heart';
    bigHeart.innerHTML = 'üíñ';
    overlay.appendChild(bigHeart);

    // Crear mensaje de amor flotante
    const loveMessage = document.createElement('div');
    loveMessage.className = 'love-message';
    loveMessage.innerHTML = getRandomLoveMessage();
    overlay.appendChild(loveMessage);

    // Crear lluvia de corazones
    createHeartRain(overlay);

    // Crear part√≠culas de amor
    createLoveParticles(overlay);

    // Vibraci√≥n si est√° disponible
    if (navigator.vibrate) {
      navigator.vibrate([200, 100, 200, 100, 200]);
    }

    // Ocultar la animaci√≥n despu√©s de 4 segundos
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 4000);
  }

  function createHeartRain(container) {
    const heartEmojis = ['üíñ', 'üíï', 'üíó', 'üíò', 'üíù', 'üíû', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú'];
    
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        const heart = document.createElement('div');
        heart.className = 'heart-rain';
        heart.innerHTML = heartEmojis[Math.floor(Math.random() * heartEmojis.length)];
        heart.style.left = Math.random() * 100 + '%';
        heart.style.animationDuration = (Math.random() * 3 + 2) + 's';
        heart.style.animationDelay = Math.random() * 2 + 's';
        container.appendChild(heart);

        // Remover el coraz√≥n despu√©s de la animaci√≥n
        setTimeout(() => {
          if (heart.parentNode) {
            heart.parentNode.removeChild(heart);
          }
        }, 5000);
      }, i * 200);
    }
  }

  function createLoveParticles(container) {
    for (let i = 0; i < 15; i++) {
      setTimeout(() => {
        const particle = document.createElement('div');
        particle.className = 'love-particle';
        particle.style.left = (Math.random() * 80 + 10) + '%';
        particle.style.top = (Math.random() * 80 + 10) + '%';
        particle.style.animationDelay = Math.random() * 1 + 's';
        container.appendChild(particle);

        // Remover part√≠cula despu√©s de la animaci√≥n
        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        }, 3000);
      }, i * 100);
    }
  }

  function getRandomLoveMessage() {
    const messages = [
      'üíñ ¬°Qu√© dulce! üíñ',
      '‚ú® El amor est√° en el aire ‚ú®',
      'üíï Mensaje de amor detectado üíï',
      'üåπ Que rom√°ntico üåπ',
      'üíò Love is everywhere üíò',
      'ü•∞ ¬°Awww! ü•∞',
      'üíó Sweet love message üíó',
      'üå∏ Amor verdadero üå∏',
      'üíñ So cute! üíñ',
      '‚ú® Magical love ‚ú®'
    ];
    return messages[Math.floor(Math.random() * messages.length)];
  }

  /*********************** LECTOR WEBTOON VERTICAL COMPLETO **************************/
  
  let currentComic = null;
  let currentComicId = null;
  let isReaderSettingsOpen = false;
  let autoScrollInterval = null;
  let loadedPages = new Set();
  let observerInstance = null;
  
  // Abrir el lector webtoon
  function openWebtoonReader(comicId, comicData) {
    currentComicId = comicId;
    currentComic = comicData;
    
    // Mostrar el lector
    document.getElementById('webtoon-reader').classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevenir scroll del fondo
    
    // Configurar header
    document.getElementById('comic-title-header').textContent = comicData.title || 'C√≥mic sin t√≠tulo';
    document.getElementById('comic-episode-info').textContent = `${comicData.pageCount || 0} p√°ginas`;
    
    // Renderizar p√°ginas
    renderWebtoonPages(comicData.pages || []);
    
    // Configurar scroll tracking
    setupScrollTracking();
    
    // Configurar lazy loading
    setupLazyLoading();
    
    // Configurar controles
    setupReaderControls();
    
    // Registrar vista
    if (comicId) {
      firebase.database().ref(`stories/${comicId}/views`).transaction(views => (views || 0) + 1);
    }
  }
  
  // Cerrar el lector webtoon
  function closeWebtoonReader() {
    document.getElementById('webtoon-reader').classList.add('hidden');
    document.body.style.overflow = ''; // Restaurar scroll
    
    // Limpiar intervalos y observers
    if (autoScrollInterval) {
      clearInterval(autoScrollInterval);
      autoScrollInterval = null;
    }
    
    if (observerInstance) {
      observerInstance.disconnect();
      observerInstance = null;
    }
    
    // Reset variables
    currentComic = null;
    currentComicId = null;
    loadedPages.clear();
    isReaderSettingsOpen = false;
    
    // Reset configuraci√≥n del lector
    document.getElementById('reader-settings').classList.add('translate-x-full');
  }
  
  // Renderizar p√°ginas del webtoon
  function renderWebtoonPages(pages) {
    const container = document.getElementById('webtoon-pages-container');
    container.innerHTML = '';
    
    if (!pages || pages.length === 0) {
      container.innerHTML = `
        <div class="w-full max-w-2xl mx-auto flex items-center justify-center min-h-screen text-white">
          <div class="text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="text-xl font-semibold mb-2">No hay p√°ginas disponibles</h3>
            <p class="text-gray-400">Este c√≥mic a√∫n no tiene p√°ginas para mostrar.</p>
          </div>
        </div>
      `;
      return;
    }
    
    // Ordenar p√°ginas por orden
    const sortedPages = [...pages].sort((a, b) => (a.order || 0) - (b.order || 0));
    
    // Crear container principal
    const mainContainer = document.createElement('div');
    mainContainer.className = 'w-full max-w-2xl mx-auto';
    
    sortedPages.forEach((page, index) => {
      const pageDiv = document.createElement('div');
      pageDiv.className = 'comic-page w-full mb-2 relative';
      pageDiv.dataset.pageIndex = index;
      
      // Crear shimmer placeholder
      const placeholder = createShimmerPlaceholder();
      
      // Crear imagen con lazy loading
      const img = document.createElement('img');
      img.className = 'w-full h-auto block opacity-0 transition-opacity duration-300';
      img.alt = `P√°gina ${index + 1}`;
      img.dataset.src = page.image; // Lazy loading: usar data-src en lugar de src
      img.loading = 'lazy';
      
      // Eventos de carga de imagen
      img.onload = function() {
        this.style.opacity = '1';
        placeholder.style.display = 'none';
        loadedPages.add(index);
        updateReadingProgress();
      };
      
      img.onerror = function() {
        placeholder.innerHTML = `
          <div class="flex items-center justify-center h-64 bg-gray-800 text-white">
            <div class="text-center">
              <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <p class="text-sm text-gray-400">Error al cargar la p√°gina ${index + 1}</p>
              <button onclick="retryLoadImage(${index})" class="mt-2 px-3 py-1 bg-[#FE2C55] text-white text-xs rounded hover:bg-red-600 transition-colors">Reintentar</button>
            </div>
          </div>
        `;
      };
      
      pageDiv.appendChild(placeholder);
      pageDiv.appendChild(img);
      
      mainContainer.appendChild(pageDiv);
    });
    
    container.appendChild(mainContainer);
  }
  
  // Crear placeholder shimmer
  function createShimmerPlaceholder() {
    const placeholder = document.createElement('div');
    placeholder.className = 'shimmer-placeholder w-full h-96 bg-gradient-to-r from-gray-800 via-gray-700 to-gray-800 animate-pulse relative overflow-hidden';
    
    // Crear efecto shimmer animado
    const shimmer = document.createElement('div');
    shimmer.className = 'absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent transform -skew-x-12 animate-shimmer';
    placeholder.appendChild(shimmer);
    
    // Agregar texto de carga
    const loadingText = document.createElement('div');
    loadingText.className = 'absolute inset-0 flex items-center justify-center text-white text-sm';
    loadingText.innerHTML = `
      <div class="text-center">
        <div class="tiktok-loader mb-2 mx-auto"></div>
        <p>Cargando p√°gina...</p>
      </div>
    `;
    placeholder.appendChild(loadingText);
    
    return placeholder;
  }
  
  // Configurar lazy loading con Intersection Observer
  function setupLazyLoading() {
    if (observerInstance) {
      observerInstance.disconnect();
    }
    
    const options = {
      root: document.getElementById('webtoon-scroll-container'),
      rootMargin: '200px 0px', // Cargar im√°genes 200px antes de que sean visibles
      threshold: 0
    };
    
    observerInstance = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target.querySelector('img[data-src]');
          if (img && img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
            observerInstance.unobserve(entry.target);
          }
        }
      });
    }, options);
    
    // Observar todas las p√°ginas
    document.querySelectorAll('.comic-page').forEach(page => {
      observerInstance.observe(page);
    });
  }
  
  // Configurar tracking del scroll
  function setupScrollTracking() {
    const scrollContainer = document.getElementById('webtoon-scroll-container');
    let scrollTimeout;
    
    scrollContainer.addEventListener('scroll', () => {
      updateReadingProgress();
      
      // Mostrar controles temporalmente
      const controls = document.getElementById('navigation-controls');
      controls.style.opacity = '1';
      
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        controls.style.opacity = '0';
      }, 2000);
    });
  }
  
  // Actualizar progreso de lectura
  function updateReadingProgress() {
    const scrollContainer = document.getElementById('webtoon-scroll-container');
    const scrollTop = scrollContainer.scrollTop;
    const scrollHeight = scrollContainer.scrollHeight - scrollContainer.clientHeight;
    
    const progress = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
    document.getElementById('reading-progress').textContent = progress + '%';
  }
  
  // Configurar controles del lector
  function setupReaderControls() {
    const scrollContainer = document.getElementById('webtoon-scroll-container');
    
    // Doble tap para mostrar/ocultar controles
    let tapTimeout;
    let tapCount = 0;
    
    scrollContainer.addEventListener('touchend', (e) => {
      tapCount++;
      
      if (tapCount === 1) {
        tapTimeout = setTimeout(() => {
          tapCount = 0;
        }, 300);
      } else if (tapCount === 2) {
        clearTimeout(tapTimeout);
        tapCount = 0;
        toggleNavigationControls();
      }
    });
    
    // Click para mostrar/ocultar controles en desktop
    scrollContainer.addEventListener('click', (e) => {
      if (e.target === scrollContainer || e.target.closest('.comic-page img')) {
        toggleNavigationControls();
      }
    });
  }
  
  // Toggle controles de navegaci√≥n
  function toggleNavigationControls() {
    const controls = document.getElementById('navigation-controls');
    const isVisible = controls.style.opacity === '1';
    controls.style.opacity = isVisible ? '0' : '1';
  }
  
  // Toggle configuraci√≥n del lector
  function toggleReaderSettings() {
    const settings = document.getElementById('reader-settings');
    isReaderSettingsOpen = !isReaderSettingsOpen;
    
    if (isReaderSettingsOpen) {
      settings.classList.remove('translate-x-full');
    } else {
      settings.classList.add('translate-x-full');
    }
  }
  
  // Ajustar brillo
  function adjustBrightness(value) {
    const container = document.getElementById('webtoon-pages-container');
    container.style.filter = `brightness(${value}%)`;
  }
  
  // Toggle me gusta del c√≥mic
  function toggleComicLike() {
    if (!currentComicId || !firebase.auth().currentUser) {
      alert('Inicia sesi√≥n para dar me gusta');
      return;
    }
    
    const user = firebase.auth().currentUser;
    const likeRef = firebase.database().ref(`stories/${currentComicId}/likes/${user.uid}`);
    
    likeRef.once('value', (snapshot) => {
      if (snapshot.exists()) {
        // Quitar me gusta
        likeRef.remove();
        firebase.database().ref(`stories/${currentComicId}/likeCount`).transaction(count => Math.max((count || 0) - 1, 0));
      } else {
        // Dar me gusta
        likeRef.set(true);
        firebase.database().ref(`stories/${currentComicId}/likeCount`).transaction(count => (count || 0) + 1);
      }
    });
  }
  
  // Reintentar cargar imagen
  function retryLoadImage(pageIndex) {
    const pageDiv = document.querySelector(`[data-page-index="${pageIndex}"]`);
    if (!pageDiv) return;
    
    const img = pageDiv.querySelector('img');
    const placeholder = pageDiv.querySelector('.shimmer-placeholder');
    
    if (img && img.dataset.src) {
      placeholder.innerHTML = `
        <div class="absolute inset-0 flex items-center justify-center text-white text-sm">
          <div class="text-center">
            <div class="tiktok-loader mb-2 mx-auto"></div>
            <p>Reintentando...</p>
          </div>
        </div>
      `;
      placeholder.style.display = 'block';
      img.style.opacity = '0';
      img.src = img.dataset.src;
    }
  }
  
  // Navegaci√≥n entre episodios (placeholder)
  function previousEpisode() {
    // TODO: Implementar navegaci√≥n a episodio anterior si hay m√∫ltiples episodios
    alert('Funci√≥n de episodio anterior pendiente de implementar');
  }
  
  function nextEpisode() {
    // TODO: Implementar navegaci√≥n a siguiente episodio si hay m√∫ltiples episodios
    alert('Funci√≥n de siguiente episodio pendiente de implementar');
  }
  
  // Auto-scroll - configurar event listener
  document.addEventListener('DOMContentLoaded', function() {
    const autoScrollCheckbox = document.getElementById('auto-scroll');
    if (autoScrollCheckbox) {
      autoScrollCheckbox.addEventListener('change', function() {
        if (this.checked) {
          document.getElementById('auto-scroll-settings').classList.remove('hidden');
          startAutoScroll();
        } else {
          document.getElementById('auto-scroll-settings').classList.add('hidden');
          stopAutoScroll();
        }
      });
    }
  });
  
  function startAutoScroll() {
    const speed = document.getElementById('scroll-speed').value;
    const scrollContainer = document.getElementById('webtoon-scroll-container');
    
    autoScrollInterval = setInterval(() => {
      scrollContainer.scrollBy(0, speed * 2);
      
      // Detener al llegar al final
      if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 10) {
        stopAutoScroll();
        document.getElementById('auto-scroll').checked = false;
        document.getElementById('auto-scroll-settings').classList.add('hidden');
      }
    }, 50);
  }
  
  function stopAutoScroll() {
    if (autoScrollInterval) {
      clearInterval(autoScrollInterval);
      autoScrollInterval = null;
    }
  }
  
  // Agregar CSS para animaci√≥n shimmer
  const shimmerStyle = document.createElement('style');
  shimmerStyle.textContent = `
    @keyframes shimmer {
      0% { transform: translateX(-100%) skewX(-12deg); }
      100% { transform: translateX(200%) skewX(-12deg); }
    }
    .animate-shimmer {
      animation: shimmer 2s infinite;
    }
  `;
  document.head.appendChild(shimmerStyle);

</script>

<!-- Overlay para animaciones secretas de mensajes -->
<div id="secret-animation-overlay"></div>

</body>
