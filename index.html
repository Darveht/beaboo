<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BeaBoo</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4653147807800151" crossorigin="anonymous"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pap6t+K2bD6xIxQqkQ3sM8e+RXw7C3DyrgXV++o2aL/88+/9kS/l+SmpD8zZR1oN40Nq3QfT7HigDYfFW1zZAQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    /* ESTILOS BASE ADAPTADOS */
body {
  font-family: 'Roboto', sans-serif;
  background: white;
  color: #000;
}

/* Ocultar título "Capítulos" y tagline en la pantalla de inicio */
#detail-chapters-title,
#tagline {
  display: none;
}

/* Línea divisoria */
.section-divider {
  border-bottom: 2px solid #FE2C55;
  margin: 20px 0;
}


/* Estilo para las estrellas seleccionadas */
.star.selected {
  color: #FE2C55;
  transition: color 0.3s ease-in-out;
  text-shadow: 0 0 10px rgba(254,44,85,0.5);
}

/* Margen para la lista de capítulos */
#detail-chapters {
  margin-top: 10px;
}

/* Notificaciones */
.notification-item {
  padding: 10px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-bottom: 8px;
  background: #f9f9f9;
  color: #000;
}

.notification-time {
  font-size: 0.8em;
  color: #FE2C55;
  margin-top: 4px;
}

/* Etiqueta de fundador */
.founder-tag {
  font-size: 0.8rem;
  color: #FE2C55;
  background-color: rgba(254,44,85,0.15);
  border-radius: 4px;
  padding: 2px 4px;
  margin-left: 4px;
}

/* Barra inferior con efecto difuminado */
#bottom-nav {
  background-color: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: background-color 0.3s ease-in-out;
  border-top: 1px solid rgba(254,44,85,0.3);
}

/* --- MODALES CON Z-INDEX ALTO --- */
#report-modal,
#followers-modal,
#following-modal,
#admin-response-modal {
  z-index: 9999 !important;
}

/* Modal Reporte a pantalla completa */
#report-modal {
  position: fixed;
  inset: 0;
  display: none;
  background-color: rgba(255,255,255,0.8);
  justify-content: center;
  align-items: center;
}

#report-modal .modal-content {
  background: #fff;
  border-radius: 1rem;
  padding: 1.5rem;
  width: 100%;
  max-width: 500px;
  margin: 1rem;
  border: 1px solid #FE2C55;
  color: #000;
}

    /* MODAL DE ERROR PARA USUARIO BLOQUEADO */
#blocked-error-modal {
  position: fixed;
  inset: 0;
  display: none;
  background-color: white;
  align-items: center;
  justify-content: center;
}

#blocked-error-modal img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#blocked-error-modal button {
  display: none;
}

/* MODAL DE CREACIÓN DE CAPÍTULO FULL SCREEN MODERNIZADO */
#chapter-creation-modal {
  position: fixed;
  inset: 0;
  display: none;
  background-color: rgba(255, 255, 255, 0.8);
  justify-content: center;
  align-items: center;
  z-index: 50;
}

#chapter-creation-modal .modal-content {
  background: white;
  width: 100%;
  height: 100%;
  padding: 1.5rem;
  position: relative;
  overflow: auto;
  color: #000;
}

/* PORTADAS DE HISTORIAS ADAPTATIVAS */
.story-card {
  flex-shrink: 0;
  width: 100%;
  max-width: 250px;
}

@media (max-width: 640px) {
  .story-card {
    max-width: 160px;
  }
}

.story-cover-container {
  position: relative;
  width: 100%;
  padding-top: 133.33%;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.story-cover-image {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.rating-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background-color: #FE2C55;
  color: white;
  border-radius: 9999px;
  padding: 2px 6px;
  font-size: 0.75rem;
  font-weight: bold;
  z-index: 10;
}

/* ANIMACIÓN DE CARGA EN BÚSQUEDA */
#search-loading {
  position: relative;
  width: 50px;
  height: 50px;
}

#search-loading .dot {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 10px;
  height: 10px;
  background-color: #FE2C55;
  border-radius: 50%;
  animation: dotRotate 4s linear infinite;
}

#search-loading .dot:nth-child(2) {
  animation-delay: -2s;
}

@keyframes dotRotate {
  0% {
    transform: translate(-50%, -50%) rotate(0deg) translateX(20px) rotate(0deg);
  }
  25% {
    transform: translate(-50%, -50%) rotate(90deg) translateX(20px) rotate(-90deg);
  }
  50% {
    transform: translate(-50%, -50%) rotate(180deg) translateX(20px) rotate(-180deg);
  }
  75% {
    transform: translate(-50%, -50%) rotate(270deg) translateX(20px) rotate(-270deg);
  }
  100% {
    transform: translate(-50%, -50%) rotate(360deg) translateX(20px) rotate(-360deg);
  }
}

/* ANIMACIÓN PARA BORDE "LIVE" */
@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(254, 44, 85, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(254, 44, 85, 0);
  }
  100% {

function saveScheduledChapter(chapterId, publishDate) {
  firebase.database().ref('scheduledChapters/' + chapterId).set({
    publishDate: publishDate,
    status: 'pending'
  });
}

function checkScheduledChapters() {
  const now = new Date().getTime();
  firebase.database().ref('scheduledChapters').once('value', snapshot => {
    snapshot.forEach(child => {
      const scheduled = child.val();
      if (scheduled.status === 'pending' && new Date(scheduled.publishDate).getTime() <= now) {
        // Publicar el capítulo
        firebase.database().ref('stories/' + currentEditingStory.id + '/chapters/' + child.key).update({
          status: 'published'
        });
        // Actualizar estado del capítulo programado
        child.ref.update({ status: 'published' });
      }
    });
  });
}

// Verificar capítulos programados cada minuto
setInterval(checkScheduledChapters, 60000);

    box-shadow: 0 0 0 0 rgba(254, 44, 85, 0);
  }
}

.live-border {
  border: 4px solid #FE2C55;
  border-radius: 50%;
  position: relative;
  animation: pulse 2s infinite;
}

.live-border::after {
  content: "";
  position: absolute;
  top: -4px;
  left: -4px;
  width: calc(100% + 8px);
  height: calc(100% + 8px);
  border: 2px solid #FE2C55;
  border-radius: 50%;
  animation: pulse 2s infinite;
  pointer-events: none;
}
    /* ----------------- MODIFICACIONES AGREGADAS ----------------- */
    /* Botón de iniciar transmisión en vivo: forma circular y sin texto */
    #live-startBtn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #00c6ba, #0082c6);
      box-shadow: 0 4px 10px rgba(0, 198, 186, 0.4);
    }

    /* Ocultar la cruz en el transmisor (se mantiene oculta) */
    #live-closeBtn {
      display: none !important;
      /* Asegura que no se muestre */
    }

    /* Panel de estadísticas en edición */
    .stats-panel>div:not(:last-child) {
      border-right: 1px solid #1e4994;
    }

    /* Gift Drawer: modal de regalos que se desliza desde abajo */
    #gift-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0;
      background-color: #0d1935;
      overflow: hidden;
      transition: height 0.4s ease;
      z-index: 10000;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.5);
      border-top: 1px solid #1e4994;
    }

    #gift-drawer.open {
      height: 50vh;
      overflow-y: auto;
    }

    #gift-drawer .gift-container {
      padding: 20px;
    }

    #gift-drawer .gift-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      text-align: center;
    }

    #gift-drawer .gift-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #gift-drawer .gift-item span {
      font-size: 0.8rem;
      margin-top: 4px;
      display: block;
      color: #e6f0ff;
    }

    /* Animación del regalo (overlay) – ajustada para ocupar todo el ancho y centrarse */
    #gift-animation {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 50vh;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 11000;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.5s ease-out;
      font-size: 0.8rem;
      padding: 5px;
    }

    #gift-animation.show {
      opacity: 1;
      animation: slideUpGift 0.8s ease-out;
      /* Ajustamos la duración y el efecto */
    }

    @keyframes slideUpGift {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    /* Fondo del regalo para ocupar toda la pantalla */
    #gift-animation::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      /* Fondo semitransparente */
      pointer-events: none;
      z-index: -1;
    }

    /* Estilos para regalos fuertes */
    .gift-strong {
      width: 100%;
      /* Ocupa todo el ancho */
      max-width: 80%;
      /* Para que tenga un margen en pantallas pequeñas */
      background: linear-gradient(135deg, #ff57a8, #7659ff);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      font-size: 1.5rem;
      color: #fff;
      text-align: center;
    }

    #gift-animation::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);
      pointer-events: none;
    }

    /* Modales para reportar historia y bloqueo */
    #report-story-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #0d1935;
      padding: 1rem;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.5);
      display: none;
      max-height: 50vh;
      overflow-y: auto;
      transition: transform 0.3s ease-out;
      transform: translateY(100%);
      z-index: 10000;
      border-top: 1px solid #1e4994;
      color: #e6f0ff;
    }

    #story-blocked-modal {
      position: fixed;
      inset: 0;
      background-color: rgba(3, 10, 23, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    /* VISTA LIVE (iQiyi Style) */
    :root {
      --iqiyi-teal: #00C6B9;
      --iqiyi-blue: #2C7DFA;
      --iqiyi-purple: #7659FF;
      --iqiyi-pink: #FF57A8;
    }

    .live-container {
      position: relative;
      width: 100%;
      height: 100vh;
      background-color: #0d1117;
      overflow: hidden;
    }

    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      background: linear-gradient(to bottom, rgba(13, 17, 23, 0.8) 0%, transparent 100%);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: white;
    }

    .user-profile {
      display: flex;
      align-items: center;
      background-color: var(--iqiyi-teal);
      padding: 0.5rem 1rem;
      border-radius: 12px;
      gap: 0.5rem;
      color: white;
      font-weight: bold;
    }

    .viewer-count {
      background-color: var(--iqiyi-blue);
      padding: 0.5rem 1rem;
      border-radius: 12px;
      color: white;
      font-weight: bold;
    }

    .side-buttons {
      position: absolute;
      right: 1rem;
      bottom: 100px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      align-items: center;
    }

    .side-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      gap: 0.5rem;
    }

    /* En la vista del transmisor se ocultan los botones laterales y el contenedor de comentarios */
    #live-stream-modal .side-buttons,
    #live-stream-modal #broadcasterCommentsContainer,
    #live-stream-modal #live-indicator {
      display: none !important;
    }

    /* Se mantiene la eliminación de la bottom-bar (no hay input de comentarios) */
    .bottom-bar {
      display: none;
    }

    /* Botones laterales (teal, purple, pink) para la vista de espectador */
    .icon-button {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .icon-button:hover {
      transform: scale(1.1);
    }

    /* Botón teal: Heart */
    #heartButton,
    #heartButtonViewer {
      background-color: var(--iqiyi-teal);
    }

    #heartButton img,
    #heartButtonViewer img {
      width: 24px;
      height: 24px;
    }

    /* Botón purple: Gift */
    #giftButton,
    #giftButtonViewer {
      background-color: var(--iqiyi-purple);
    }

    #giftButton img,
    #giftButtonViewer img {
      width: 24px;
      height: 24px;
    }

    /* Botón pink: Share */
    #shareButton,
    #shareButtonViewer {
      background-color: var(--iqiyi-pink);
    }

    /* Animación de corazones */
    .floating-heart {
      position: absolute;
      animation: float-up 1.5s ease-out forwards;
      opacity: 0;
      width: 24px;
      height: 24px;
    }

    @keyframes float-up {
      0% {
        transform: translateY(0) scale(1) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(-100px) scale(0) rotate(45deg);
        opacity: 0;
      }
    }

    .comments-container {
      position: absolute;
      bottom: 80px;
      left: 0;
      right: 0;
      padding: 1rem;
      pointer-events: none;
    }

    .comment-bubble {
      background-color: var(--duolingo-green);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      margin-bottom: 0.5rem;
      max-width: 80%;
      animation: fade-in-out 3s forwards;
      font-weight: bold;
    }

    @keyframes fade-in-out {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }

      10% {
        opacity: 1;
        transform: translateY(0);
      }

      90% {
        opacity: 1;
        transform: translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    /* Contenedor para comentarios del transmisor (se oculta en este caso) */
    #broadcasterCommentsContainer {
      position: absolute;
      bottom: 80px;
      left: 0;
      right: 0;
      padding: 1rem;
      max-height: 40%;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      color: #111;
      z-index: 101;
    }

    /* ---------- NUEVA SECCIÓN: Estilos para Computadora ---------- */
    @media (min-width: 1024px) {
      body.desktop {
        background-color: #ffffff;
        font-family: 'Nunito', sans-serif;
      }

      #bottom-nav {
        background-color: rgba(255, 255, 255, 0.9);
      }
    }

    /* ----------------- NUEVA SECCIÓN: Banner ApkPure ----------------- */
    #apk-banner {
      position: relative;
      background: #f0f4f8;
      border: 2px solid #58CC02;
      border-radius: 8px;
      padding: 16px;
      margin: 24px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #apk-banner .floating-bubble {
      position: absolute;
      top: -20px;
      right: -20px;
      width: 60px;
      height: 60px;
      background: rgba(88, 204, 2, 0.2);
      border-radius: 50%;
      animation: float 5s infinite ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #58CC02;
    }

    @keyframes float {
      0% {
        transform: translate(0, 0);
      }

      50% {
        transform: translate(-10px, 10px);
      }

      100% {
        transform: translate(0, 0);
      }
    }

    /* NUEVA FUNCIÓN: Botón de descarga de historia para lectura offline */
    #download-story-btn {
      cursor: pointer;
    }
  </style>
  <script>
    /*********************** BLOQUEO DE ACCESO EN COMPUTADORAS (Móvil obligatorio) ***********************/
    function esDispositivoMovil() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    /*********************** MODO OFFLINE ***********************/
    window.addEventListener('offline', function() {
      document.body.innerHTML = `
        <div id="offline-modal">
          <img src="https://ideogram.ai/assets/image/lossless/response/ZL-_GzzNQdy7CzioYPtDHg" alt="Sin conexión">
        </div>`;
    });
    window.addEventListener('online', function() {
      location.reload();
    });
    /* FUNCIÓN PARA ESTABLECER EL TEMA GLOBAL (día/noche) Y COLOR DE FUENTE */
    function setThemeBasedOnTime() {
      const hour = new Date().getHours();
      let bg, fontColor;
      if (hour >= 6 && hour < 18) {
        bg = "#ffffff";
        fontColor = "#58CC02";
      } else {
        bg = "#0d1b2a";
        fontColor = "#58CC02";
      }
      document.body.style.backgroundColor = bg;
      document.body.style.color = fontColor;
      updateSectionThemes(bg, fontColor);
      const bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) {
        bottomNav.style.backgroundColor = (hour >= 6 && hour < 18) ?
          "rgba(255,255,255,0.8)" :
          "rgba(13,27,42,0.8)";
      }
    }

    function updateSectionThemes(bg, fontColor) {
      const sections = [
        "search-view",
        "profile-view",
        "story-detail-modal",
        "story-creation-view",
        "story-details-view",
        "story-edit-view",
        "profile-edit-modal",
        "author-profile-modal",
        "support-modal",
        "followers-modal",
        "following-modal",
        "notifications-modal",
        "report-modal",
        "report-response-modal",
        "admin-response-modal",
        "blocked-error-modal"
      ];
      sections.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
          el.style.backgroundColor = bg;
          el.style.color = fontColor;
        }
      });
    }
    window.addEventListener('load', setThemeBasedOnTime);
    window.addEventListener('load', function() {
      if (window.innerWidth >= 1024) {
        document.body.classList.add('desktop');
      }
    });

    function organizeCarousels() {
      const carouselIds = ['new-releases', 'top10', 'popular', 'terror-stories'];
      carouselIds.forEach(id => {
        const carousel = document.getElementById(id);
        if (carousel) {
          carousel.classList.remove('grid', 'grid-cols-2', 'md:grid-cols-4');
          carousel.classList.add('flex', 'space-x-4', 'overflow-x-auto');
        }
      });
    }
    window.addEventListener('load', organizeCarousels);
    document.addEventListener("DOMContentLoaded", function() {
      const savedLang = localStorage.getItem("selectedLanguage");
      if (savedLang) {
        currentLanguage = savedLang;
        updateTranslations();
      } else {
        document.getElementById("language-modal").style.display = "flex";
      }
    });

    function updateChapterUI() {
      const chapterSection = document.getElementById('chapter-section');
      if (!chapterSection) return;
      if (storyTypeSelected === 'cuento') {
        chapterSection.style.display = 'none';
      } else if (storyTypeSelected === 'historia_completa') {
        chapterSection.style.display = 'block';
        document.querySelectorAll('.chapter-label').forEach(label => {
          label.textContent = 'Capítulo';
        });
      } else if (storyTypeSelected === 'novela') {
        chapterSection.style.display = 'block';
        document.querySelectorAll('.chapter-label').forEach(label => {
          label.textContent = 'Saga';
        });
      }
    }

    function selectStoryType(type) {
      storyTypeSelected = type;
      document.getElementById('story-creation-view').classList.add('hidden');
      document.getElementById('story-details-view').classList.remove('hidden');
      updateChapterUI();
    }
    /*************** FUNCIONES PARA COMPRA DE MONEDAS (ELIMINADAS) ***************/
    // Se han removido las funciones openBuyCoinsModal(), closeBuyCoinsModal() y buyCoins()
    /*************** FIN FUNCIONES DE COMPRA DE MONEDAS ***************/
    /*********************** NUEVAS FUNCIONES PARA SUGERENCIAS Y AUTORES DESTACADOS ***********************/
    function loadSuggestedStories() {
      firebase.database().ref('stories').once('value').then(snapshot => {
        let stories = [];
        snapshot.forEach(child => {
          let story = child.val();
          story.id = child.key;
          stories.push(story);
        });
        stories.sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0));
        let suggested = stories.slice(0, 10);
        const container = document.getElementById('suggested-stories');
        container.innerHTML = '';
        suggested.forEach(story => {
          const card = document.createElement('div');
          card.className = 'story-card cursor-pointer';
          card.onclick = () => openStoryDetail(story);
          card.innerHTML = `
              <div class="rounded-2xl overflow-hidden shadow-md">
                <div class="story-cover-container">
                  <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="story-cover-image">
                </div>
              </div>
              <div class="mt-2">
                <h3 class="font-semibold text-sm">${story.title}</h3>
              </div>
            `;
          container.appendChild(card);
        });
      });
    }

    function loadFeaturedAuthors() {
      firebase.database().ref('stories').once('value').then(snapshot => {
        let authorCounts = {};
        snapshot.forEach(child => {
          let story = child.val();
          if (story && story.userId) {
            if (!authorCounts[story.userId]) authorCounts[story.userId] = 0;
            authorCounts[story.userId]++;
          }
        });
        let authorsArray = [];
        for (let uid in authorCounts) {
          authorsArray.push({
            uid: uid,
            count: authorCounts[uid]
          });
        }
        authorsArray.sort((a, b) => b.count - a.count);
        let topAuthors = authorsArray.slice(0, 10);
        const container = document.getElementById('featured-authors');
        container.innerHTML = '';
        topAuthors.forEach(author => {
          firebase.database().ref('users/' + author.uid).once('value').then(userSnap => {
            const userData = userSnap.val();
            const card = document.createElement('div');
            card.className = 'story-card cursor-pointer';
            card.onclick = () => openAuthorProfile(author.uid);
            card.innerHTML = `
                <div class="rounded-2xl overflow-hidden shadow-md">
                  <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" alt="${userData.username}" class="w-full h-40 object-cover">
                </div>
                <div class="mt-2">
                  <h3 class="font-semibold text-sm">${userData.username}</h3>
                </div>
              `;
            container.appendChild(card);
          });
        });
      });
    }
    /*************** FIN NUEVAS FUNCIONES ***********************/
  </script>
</head>

<!-- MODAL DE NOTIFICACIONES -->
<div id="notifications-modal" class="fixed inset-0 z-50 hidden">
  <div class="w-full h-full p-6 overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Bandeja de Entrada</h2>
      <button onclick="closeNotifications()" class="text-gray-500 text-2xl">&times;</button>
    </div>
    <div id="notifications-list" class="space-y-4"></div>
  </div>
</div>

<!-- MODAL DE REPORTAR PERFIL -->
<div id="report-modal" class="fixed inset-x-0 bottom-0 transform translate-y-full transition-transform duration-300 bg-white rounded-t-xl shadow-lg" style="height: 50vh; z-index: 9999;">
  <div class="p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 id="report-title" class="text-2xl font-bold text-[#58CC02]">Reportar Perfil</h2>
      <button onclick="closeReportModal()" class="text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p id="report-instructions" class="mb-4">Selecciona un motivo o describe el problema:</p>
    <form id="report-form" class="space-y-4">
      <select id="report-reason" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50">
        <option value="perfil_falso">Perfil falso: el autor está suplantando identidad</option>
        <option value="spam">Spam</option>
        <option value="infraccion_normas">Infracción a las normas</option>
        <option value="otro">Otro</option>
      </select>
      <textarea id="report-description" placeholder="Describe el problema (opcional)" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50" rows="4"></textarea>
      <button id="btn-enviar-report" type="submit" class="w-full bg-red-500 text-white p-3 rounded-xl">Enviar Reporte</button>
    </form>
  </div>
</div>

<!-- MODAL DE RESPUESTA AL REPORTE -->
<div id="report-response-modal" class="fixed inset-0 flex flex-col items-center justify-center z-50 hidden" style="z-index: 9999;">
  <div class="bg-white p-6 rounded-xl text-center">
    <div class="flex space-x-2 mb-4">
      <div class="dot" style="animation-duration: 1s;"></div>
      <div class="dot" style="animation-duration: 1.2s;"></div>
    </div>
    <p class="text-xl font-bold mb-2">Procesando tu reporte...</p>
    <p class="text-gray-600">Espera unos instantes.</p>
  </div>
</div>

<!-- MODAL DE RESPUESTA DEL ADMIN -->
<div id="admin-response-modal" class="fixed inset-0 flex flex-col items-center justify-center z-50 hidden" style="z-index: 9999;">
  <!-- Contenido asignado dinámicamente -->
</div>

<!-- MODAL DE ERROR PARA USUARIO BLOQUEADO -->
<div id="blocked-error-modal" class="fixed inset-0 z-50 hidden" style="z-index: 9999;">
  <button onclick="closeBlockedErrorModal()">Volver</button>
  <img src="https://ideogram.ai/assets/image/lossless/response/0-Re3lMzQ6mmstIxlRxb4Q" alt="Usuario bloqueado">
</div>

<!-- MODAL DE LISTA DE SEGUIDORES -->
<div id="followers-modal" class="fixed inset-0 overflow-y-auto z-50 hidden" style="z-index: 9999;">
  <div class="p-6">
    <button onclick="closeFollowersModal()" class="text-[#58CC02] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>
    <h2 class="text-2xl font-bold text-[#58CC02] mb-4">Seguidores</h2>
    <div id="followers-list" class="space-y-4"></div>
  </div>
</div>

<!-- MODAL DE LISTA DE SIGUIENDO -->
<div id="following-modal" class="fixed inset-0 overflow-y-auto z-50 hidden" style="z-index: 9999;">
  <div class="p-4">
    <button onclick="closeFollowingModal()" class="text-[#58CC02] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>
    <h2 class="text-2xl font-bold text-[#58CC02] mb-4">Siguiendo</h2>
    <div id="following-list" class="space-y-4"></div>
  </div>
</div>

<!-- MODAL DE SOPORTE -->
<div id="support-modal" class="fixed inset-0 overflow-y-auto z-50 hidden">
  <div class="p-6">
    <button onclick="closeSupportModal()" class="text-[#58CC02] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>
    <h2 class="text-2xl font-bold text-[#58CC02] mb-4 flex items-center justify-center">
      <i class="fas fa-headset mr-2"></i> Soporte
    </h2>
    <form id="support-form" class="space-y-4">
      <input id="support-subject" type="text" placeholder="Asunto" class="w-full p-3 border border-gray-200 rounded-xl" required>
      <textarea id="support-message" placeholder="Describe tu problema o consulta..." class="w-full p-3 border border-gray-200 rounded-xl" rows="4" required></textarea>
      <button id="btn-send-support" type="submit" class="w-full bg-blue-500 text-white p-3 rounded-xl">Enviar Solicitud</button>
    </form>
  </div>
</div>

<!-- SPINNER DE CERRAR SESIÓN -->
<div id="signout-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
  <i class="fas fa-spinner fa-spin text-4xl" style="color:#58CC02;"></i>
</div>

<!-- SPINNER PARA PUBLICAR HISTORIA -->
<div id="story-upload-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
  <i class="fas fa-spinner fa-spin text-4xl" style="color:#58CC02;"></i>
</div>

<!-- MODAL DE REPORTAR HISTORIA -->
<div id="report-story-modal">
  <h2 class="text-xl font-bold mb-4 text-[#58CC02]">Reportar Historia</h2>
  <form id="report-story-form">
    <label class="block mb-2">
      <input type="radio" name="reportReason" value="historia_falsa" required> Historia falsa
    </label>
    <label class="block mb-2">
      <input type="radio" name="reportReason" value="no_es_original" required> La historia no es original
    </label>
    <label class="block mb-2">
      <input type="radio" name="reportReason" value="contenido_inapropiado" required> Contenido inapropiado
    </label>
    <textarea id="report-story-description" class="w-full border border-gray-300 rounded p-2 mb-4" placeholder="Describe el problema (opcional)"></textarea>
    <button type="submit" class="w-full bg-red-500 text-white p-2 rounded">Enviar Reporte</button>
  </form>
</div>

<!-- MODAL DE HISTORIA BLOQUEADA -->
<div id="story-blocked-modal">
  <img src="https://ideogram.ai/g/hJJQb0VZSQicLDiADD7CZQ/3" alt="Historia Bloqueada" class="w-3/4 h-auto">
</div>

<!–– AUTENTICACIÓN A PANTALLA COMPLETA (ESTILO TIKTOK) ––>
<body class="bg-white font-sans text-[#161823]">
  <div id="auth-form" class="w-full h-screen flex flex-col justify-center p-6">
    <!-- Título centrado -->
    <h1 id="auth-title" class="text-4xl font-bold text-center mb-8">BeaBoo</h1>
    <!-- Formulario ocupa todo el ancho disponible -->
    <form id="authForm" class="w-full space-y-6 max-w-lg mx-auto">
      <input
        id="emailInput"
        type="email"
        placeholder="Correo electrónico"
        class="w-full p-4 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FE2C55] transition"
        required
      >
      <input
        id="passwordInput"
        type="password"
        placeholder="Contraseña"
        class="w-full p-4 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FE2C55] transition"
        required
      >
      <button
        id="submitButton"
        type="submit"
        class="w-full bg-[#FE2C55] text-white p-4 font-bold rounded-full transform hover:scale-105 transition"
      >
        Iniciar Sesión
      </button>
    </form>
    <!-- Links y toggle debajo del formulario -->
    <div class="mt-6 text-center space-y-4 max-w-lg mx-auto">
      <a
        href="#"
        onclick="resetPassword()"
        class="block text-sm text-gray-600 hover:text-[#FE2C55] transition"
      >
        ¿Olvidaste tu contraseña?
      </a>
      <button
        id="toggleAuth"
        class="block text-sm font-medium text-[#FE2C55] hover:text-[#25F4EE] transition"
      >
        ¿No tienes cuenta? Regístrate
      </button>
      <div id="authError" class="mt-4 text-red-500 hidden"></div>
    </div>
  </div>
</body>

<!-- APLICACIÓN PRINCIPAL ESTILO TIKTOK (MODO CLARO) -->
<div id="main-app" class="h-screen flex flex-col bg-white font-sans text-black">
  <!-- BARRA SUPERIOR CON NOMBRE + ICONOS -->
  <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 sticky top-0 z-50 bg-white">
    <h1 id="app-name" class="text-2xl font-bold text-[#161823]">BeaBoo</h1>
    <div class="flex items-center space-x-4">
      <button onclick="openSearch()" aria-label="Buscar" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8" stroke-linecap="round" stroke-linejoin="round" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
      <button onclick="openCalendar()" aria-label="Calendario" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg>
      </button>
      <button onclick="openLiveStreamModal()" aria-label="Transmitir en vivo" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M23 7l-7 5 7 5V7z"/>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
        </svg>
      </button>
      <button onclick="openNotifications()" aria-label="Notificaciones" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M13.73 21a2 2 0 01-3.46 0" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto pb-20 p-6" id="scrollable-content">
    <div class="text-center mb-6">
      <p id="tagline" class="mt-2 text-lg text-gray-700">Tu portal de historias inolvidables</p>
    </div>

    

    <!-- SECCIONES DE CONTENIDO -->
    <!-- Carrusel de historias de autores seguidos -->
<section id="stories-carousel" class="mb-6 overflow-x-auto">
  <div class="flex space-x-4 p-2">
    <div id="following-stories" class="flex space-x-4"></div>
  </div>
</section>



<section id="new-releases-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="new-releases-title" class="text-2xl font-bold text-[#FE2C55]">Nuevos Lanzamientos</h2>
      </div>
      <div id="new-releases" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
</section>

<script>
function loadFollowingStories() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  firebase.database().ref('following/' + user.uid).once('value').then(followingSnap => {
    const followingStoriesDiv = document.getElementById('following-stories');
    followingStoriesDiv.innerHTML = '';

    followingSnap.forEach(following => {
      const followedUserId = following.key;
      
      firebase.database().ref('users/' + followedUserId).once('value').then(userSnap => {
        const userData = userSnap.val();
        
        // Verificar actualizaciones recientes (últimas 24 horas)
        firebase.database().ref('stories').orderByChild('userId').equalTo(followedUserId).once('value').then(storiesSnap => {
          let hasNewContent = false;
          let latestStoryId = null;
          
          storiesSnap.forEach(storySnap => {
            const story = storySnap.val();
            const lastUpdate = story.lastUpdate || story.createdAt;
            if (Date.now() - lastUpdate < 24 * 60 * 60 * 1000) {
              hasNewContent = true;
              latestStoryId = storySnap.key;
            }
          });

          const storyDiv = document.createElement('div');
          storyDiv.className = 'flex flex-col items-center cursor-pointer';
          
          const imageContainer = document.createElement('div');
          imageContainer.className = `w-16 h-16 rounded-full overflow-hidden ${hasNewContent ? 'border-2 border-[#FE2C55]' : 'border border-gray-300'}`;
          
          if (hasNewContent) {
            imageContainer.classList.add('animate-pulse');
          }
          
          imageContainer.innerHTML = `
            <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" 
                 alt="${userData.username}" 
                 class="w-full h-full object-cover"
                 onclick="openLatestStory('${followedUserId}', '${latestStoryId}')">
          `;
          
          storyDiv.appendChild(imageContainer);
          
          const username = document.createElement('span');
          username.className = 'text-xs mt-1 truncate w-16 text-center';
          username.textContent = userData.username;
          storyDiv.appendChild(username);
          
          followingStoriesDiv.appendChild(storyDiv);
        });
      });
    });
  });
}

function openLatestStory(authorId, storyId) {
  if (storyId) {
    openStoryDetail({id: storyId});
  } else {
    openAuthorProfile(authorId);
  }
}

// Llamar a loadFollowingStories cuando se carga la página y cuando hay cambios
document.addEventListener('DOMContentLoaded', loadFollowingStories);
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadFollowingStories();
  }
});
</script>

<style>
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.animate-pulse {
  animation: pulse 2s infinite;
}

#stories-carousel {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

#stories-carousel::-webkit-scrollbar {
  display: none;
}
</style>

    <section id="top10-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="top10-title" class="text-2xl font-bold text-[#FE2C55]">Top 10</h2>
      </div>
      <div id="top10" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="popular-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="popular-title" class="text-2xl font-bold text-[#FE2C55]">Más Populares</h2>
      </div>
      <div id="popular" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="terror-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="terror-title" class="text-2xl font-bold text-[#FE2C55]">Historias de Terror Destacadas</h2>
      </div>
      <div id="terror-stories" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="suggested-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="suggested-title" class="text-2xl font-bold text-[#FE2C55]">Sugerencias basadas en ti</h2>
      </div>
      <div id="suggested-stories" class="flex space-x-4 overflow-x-auto"></div>
    </section>

    <section id="featured-authors-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="featured-authors-title" class="text-2xl font-bold text-[#FE2C55]">Autores Destacados</h2>
      </div>
      <div id="featured-authors" class="flex space-x-4 overflow-x-auto"></div>
    </section>

    <section id="suggested-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="suggested-title" class="text-2xl font-bold text-[#FE2C55]">Sugerencias basadas en ti</h2>
      </div>
      <div id="suggested-stories" class="flex space-x-4 overflow-x-auto"></div>
    </section>

    <section id="featured-authors-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="featured-authors-title" class="text-2xl font-bold text-[#FE2C55]">Autores Destacados</h2>
      </div>
      <div id="featured-authors" class="flex space-x-4 overflow-x-auto"></div>
    </section>
  </div>

  <!-- NAVEGACIÓN INFERIOR ESTILO TIKTOK -->
  <div id="bottom-nav" class="fixed bottom-0 left-0 right-0 border-t border-gray-200 bg-white transition-transform duration-300">
    <div class="flex justify-around p-3">
      <button onclick="openHome()" class="flex flex-col items-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2L2 8v10a1 1 0 001 1h5v-5h4v5h5a1 1 0 001-1V8l-8-6z" />
        </svg>
        <span class="text-xs">Inicio</span>
      </button>
      <button onclick="openCommunity()" class="flex flex-col items-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
          <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
        </svg>
        <span class="text-xs">Comunidad</span>
      </button>
      <div class="w-12"></div>
      <button onclick="openProfile()" class="flex flex-col items-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 10a4 4 0 100-8 4 4 0 000 8zM2 18a8 8 0 1116 0H2z" clip-rule="evenodd" />
        </svg>
        <span class="text-xs">Perfil</span>
      </button>
    </div>
    <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2">
      <button onclick="openStoryCreation()" class="relative bg-white p-4 rounded-full shadow-lg border-4 border-[#FE2C55] transition transform hover:scale-110">
        <svg class="w-6 h-6 text-[#FE2C55]" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" />
        </svg>
      </button>
    </div>
  </div>

  <style>
    .transition { transition: all 0.2s ease-in-out; }
    #bottom-nav.hide { transform: translateY(100%); }
  </style>

  <script>
    let lastScrollTop = 0;
    const bottomNav = document.getElementById("bottom-nav");
    const scrollArea = document.getElementById("scrollable-content");

    scrollArea.addEventListener("scroll", () => {
      const scrollTop = scrollArea.scrollTop;
      if (scrollTop > lastScrollTop) {
        bottomNav.classList.add("hide");
      } else {
        bottomNav.classList.remove("hide");
      }
      lastScrollTop = scrollTop;
    });
  </script>
</div>


<!-- VISTA DE COMUNIDAD -->
<div id="community-view" class="fixed inset-0 bg-white text-black overflow-y-auto hidden z-50">
  <div class="p-4">
    <!-- Botón Volver -->
    <button onclick="closeCommunity()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>

    <!-- Tabs de Navegación -->
    <div class="flex border-b border-gray-200 mb-4">
      <button onclick="switchCommunityTab('feed')" class="flex-1 py-2 text-center text-[#FE2C55] border-b-2 border-[#FE2C55]" id="feed-tab">
        Feed
      </button>
      <button onclick="switchCommunityTab('add')" class="flex-1 py-2 text-center text-gray-500" id="add-tab">
        Agregar Nota
      </button>
    </div>

    <!-- Feed de Notas -->
    <div id="notes-feed" class="space-y-4">
      <!-- Las notas se cargarán aquí dinámicamente -->
    </div>

    <!-- Formulario para Agregar Nota -->
    <div id="add-note-form" class="hidden">
      <textarea id="note-content" placeholder="¿Qué quieres compartir?" class="w-full p-4 border border-gray-200 rounded-xl resize-none h-32 focus:outline-none focus:ring-2 focus:ring-[#FE2C55]"></textarea>
      <div class="mt-4 flex items-center space-x-4">
        <label class="flex-1 cursor-pointer bg-gray-100 p-3 rounded-xl hover:bg-gray-200 transition text-center">
          <input type="file" id="note-image" accept="image/*" class="hidden" onchange="handleNoteImagePreview(event)">
          <i class="fas fa-camera mr-2"></i>Agregar Foto
        </label>
        <button onclick="publishNote()" class="flex-1 bg-[#FE2C55] text-white p-3 rounded-xl font-medium">
          Publicar Nota
        </button>
      </div>
      <div id="image-preview" class="mt-4 hidden">
        <img id="preview-img" class="max-h-40 rounded-lg mx-auto">
        <button onclick="removeImage()" class="mt-2 text-red-500 text-sm">
          <i class="fas fa-times mr-1"></i>Eliminar foto
        </button>
      </div>
    </div>
  </div>
</div>

<!-- VISTA DE BÚSQUEDA - ESTILO TIKTOK FULL -->
<div id="search-view" class="fixed inset-0 bg-white text-black overflow-y-auto hidden z-50">
  <div class="p-4">

    <!-- Botón Volver -->
    <button onclick="closeSearch()" class="text-gray-800 mb-4 flex items-center font-medium hover:text-[#FE2C55] transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span id="btn-volver-search">Volver</span>
    </button>

    <!-- Barra de búsqueda con filtro de categoría -->
    <div class="space-y-4 mb-6">
      <div class="relative">
        <input id="search-input" type="text" placeholder="Buscar historias o autores" class="w-full pl-12 pr-4 py-3 rounded-full bg-gray-100 text-black border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent text-base">
        <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>
      <select id="category-filter" class="w-full p-3 rounded-full bg-gray-100 text-black border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#FE2C55]">
        <option value="">Todas las categorías</option>
        <option value="aventura">Aventura</option>
        <option value="romance">Romance</option>
        <option value="misterio">Misterio</option>
        <option value="fantasia">Fantasía</option>
        <option value="terror">Terror</option>
      </select>
    </div>

    <!-- Resultados -->
    <h2 id="search-results-title" class="text-xl font-bold mb-4 text-black">Resultados de búsqueda</h2>
    <div class="flex justify-around border-b border-gray-200 mb-4">
      <button data-tab="books" class="tab-button py-2 w-1/2 text-center font-medium text-gray-500 hover:text-[#FE2C55] active">
        Libros
      </button>
      <button data-tab="authors" class="tab-button py-2 w-1/2 text-center font-medium text-gray-500 hover:text-[#FE2C55]">
        Autores
      </button>
    </div>

    <!-- Sección Libros -->
    <div id="books-section" class="block">
      <h3 id="search-books-title" class="text-base font-semibold mb-3 text-[#FE2C55]">Libros</h3>
      <div id="search-books-carousel" class="flex space-x-3 overflow-x-auto mb-6 p-1 scrollbar-hide">
        <!-- Aquí se cargarán los libros desde Firebase -->
      </div>
    </div>

    <!-- Sección Autores -->
    <div id="authors-section" class="hidden">
      <h3 id="search-authors-title" class="text-base font-semibold mb-3 text-[#FE2C55]">Autores</h3>
      <div id="search-authors-list" class="space-y-3">
        <!-- Aquí se cargarán los autores desde Firebase -->
      </div>
    </div>
  </div>
</div>

<script>
  // Script para cambiar entre tabs
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      // Remover active de todos los botones
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-gray-500');
        btn.classList.remove('text-[#FE2C55]');
      });
      
      // Agregar active al botón clickeado
      button.classList.add('active');
      button.classList.remove('text-gray-500');
      button.classList.add('text-[#FE2C55]');
      
      // Mostrar la sección correspondiente
      const tabName = button.getAttribute('data-tab');
      if (tabName === 'books') {
        document.getElementById('books-section').classList.remove('hidden');
        document.getElementById('books-section').classList.add('block');
        document.getElementById('authors-section').classList.add('hidden');
        document.getElementById('authors-section').classList.remove('block');
      } else {
        document.getElementById('authors-section').classList.remove('hidden');
        document.getElementById('authors-section').classList.add('block');
        document.getElementById('books-section').classList.add('hidden');
        document.getElementById('books-section').classList.remove('block');
      }
    });
  });

  // Simulación de apertura del micrófono
  document.getElementById('voice-search-btn').addEventListener('click', () => {
    document.getElementById('voice-animation-container').classList.remove('hidden');
  });

  document.getElementById('cancel-voice').addEventListener('click', () => {
    document.getElementById('voice-animation-container').classList.add('hidden');
  });

  // Lógica de seguir autores (simulación)
  function toggleFollow(authorId) {
    const followButton = document.getElementById('follow-' + authorId);
    if (followButton.classList.contains('bg-[#FE2C55]')) {
      followButton.classList.remove('bg-[#FE2C55]');
      followButton.classList.add('bg-gray-200');
      followButton.textContent = 'Seguir';
    } else {
      followButton.classList.remove('bg-gray-200');
      followButton.classList.add('bg-[#FE2C55]');
      followButton.textContent = 'Dejar de seguir';
    }
  }

  // Ejemplo de como cargar autores desde Firebase
  function loadAuthors(authors) {
    const authorsList = document.getElementById('search-authors-list');
    authors.forEach(author => {
      const authorItem = document.createElement('div');
      authorItem.classList.add('flex', 'items-center', 'justify-between', 'p-4', 'bg-gray-100', 'rounded-lg', 'shadow-sm');
      authorItem.innerHTML = `
        <div class="flex items-center">
          <img src="${author.photoUrl}" alt="${author.name}" class="h-12 w-12 rounded-full mr-4">
          <span class="font-semibold text-black">${author.name}</span>
        </div>
        <button id="follow-${author.id}" class="px-4 py-2 bg-gray-200 text-black rounded-full font-medium hover:bg-[#FE2C55] transition-all" onclick="toggleFollow('${author.id}')">
          Seguir
        </button>
      `;
      authorsList.appendChild(authorItem);
    });
  }

  // Simulación de autores cargados (reemplaza con Firebase)
  loadAuthors([
    { id: '1', name: 'Autor A', photoUrl: 'https://via.placeholder.com/150' },
    { id: '2', name: 'Autor B', photoUrl: 'https://via.placeholder.com/150' },
    { id: '3', name: 'Autor C', photoUrl: 'https://via.placeholder.com/150' },
  ]);
</script>

<style>
  /* Estilos TikTok */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }

  body {
    background-color: #fff;
  }

  .tab-button.active {
    color: #FE2C55;
    border-bottom: 2px solid #FE2C55;
    font-weight: 500;
  }

  /* Estilos del autor */
  .author-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background-color: #f0f0f0;
    border-radius: 10px;
    margin-bottom: 12px;
  }

  .author-item img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    margin-right: 16px;
  }

  /* Ocultar scrollbar pero mantener funcionalidad */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  .scrollbar-hide {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
</style>

<!-- Script para cambiar entre libros y autores -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        var tab = button.getAttribute('data-tab');
        document.getElementById('books-section').classList.toggle('hidden', tab !== 'books');
        document.getElementById('authors-section').classList.toggle('hidden', tab !== 'authors');
        tabButtons.forEach(function(btn) {
          btn.classList.remove('text-white', 'border-b-2', 'border-[#ff0050]');
        });
        button.classList.add('text-white', 'border-b-2', 'border-[#ff0050]');
      });
    });
  });
</script>
<!-- PERFIL PROPIO CON SUBIDA DE FOTO EN TIEMPO REAL -->
<div id="profile-view" class="fixed inset-0 overflow-y-auto z-40 hidden bg-white text-black scrollbar-hide">
  <div class="p-4 max-w-md mx-auto">
    <!-- Botón Volver -->
    <button onclick="openHome()" class="text-[#FE2C55] mb-4 font-medium flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span id="btn-volver-profile">Volver</span>
    </button>

    <div class="flex flex-col items-center">
      <!-- Contenedor de imagen con label para activar input -->
      <label for="profile-image-input" class="relative cursor-pointer">
        <img id="profile-image" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55] hover:border-red-600 transition-all" alt="Foto de perfil">
        <!-- Overlay de subir imagen -->
        <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 hover:opacity-100 rounded-full transition-opacity">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 12v-8" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 8l4-4 4 4" />
          </svg>
        </div>
      </label>
      <input type="file" id="profile-image-input" accept="image/*" class="hidden" onchange="handleProfileImageUpload(event)">

      <!-- Nombre de usuario y acciones -->
      <div class="flex items-center mt-4">
        <h2 id="profile-username" class="text-xl font-semibold">@nombre_usuario</h2>
        <button onclick="openProfileEdit()" class="absolute top-4 right-4 text-[#FE2C55] hover:text-[#FE2C55] transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </div>

      <!-- Biografía -->
      <hr class="border-t border-gray-300 w-full my-4">
      <div class="w-full mt-2">
        <textarea id="profile-bio" placeholder="Escribe tu biografía..." class="w-full border border-gray-300 p-3 rounded-xl bg-[#f9f9f9] text-black resize-none" rows="3"></textarea>
        <button onclick="saveBio()" class="mt-2 bg-[#FE2C55] text-white px-4 py-2 rounded-xl font-medium w-full hover:bg-red-600 transition-all">Guardar</button>
      </div>

      <!-- Series del usuario -->
      <hr class="border-t border-gray-300 w-full my-4">
      <div class="mt-6 w-full">
        <h3 id="profile-stories-title" class="text-lg font-bold mb-2 text-[#FE2C55]">Mis Series</h3>
        <div id="user-stories" class="grid grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>
</div>

<!-- CSS específico para overlay de subida -->
<style>
  /* Ocultar scrollbar */
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { scrollbar-width: none; -ms-overflow-style: none; }
</style>

<!-- JS para previsualizar la imagen en tiempo real -->
<script>
  function handleProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('profile-image').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
</script>


<!-- MODAL DE EDICIÓN DE PERFIL -->
<div id="profile-edit-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-white text-black">
  <div class="p-6">
    <button onclick="closeProfileEdit()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>
    <div class="flex flex-col items-center">
      <div class="relative">
        <img id="edit-profile-image" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55]" alt="Foto de perfil">
        <button onclick="document.getElementById('edit-profile-image-input').click();" class="absolute bottom-0 right-0 bg-[#FE2C55] text-white rounded-full p-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v0" />
            <path d="M12 5a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2 2 2 0 0 1-2-2v0a2 2 0 0 1 2-2z" />
            <rect x="3" y="7" width="18" height="14" rx="2" ry="2" />
          </svg>
        </button>
        <input type="file" id="edit-profile-image-input" accept="image/*" class="hidden" onchange="handleEditProfileImageUpload(event)">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Nombre</label>
        <input id="edit-username" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Tu nombre">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Pronombres</label>
        <input id="edit-pronouns" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Ej. él/ella/elle">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Biografía</label>
        <textarea id="edit-bio" rows="3" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Escribe tu biografía..."></textarea>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Inkspired</label>
        <input id="edit-inkspired" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu perfil en Inkspired">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Instagram</label>
        <input id="edit-instagram" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu perfil en Instagram">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">TikTok</label>
        <input id="edit-tiktok" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu perfil en TikTok">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Página Web</label>
        <input id="edit-website" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu página web">
      </div>
      <!-- Nuevos campos agregados: Ciudad, Género y Cumpleaños -->
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Ciudad</label>
        <input id="edit-city" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Ingresa tu ciudad">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Género</label>
        <input id="edit-gender" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Ingresa tu género">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Cumpleaños</label>
        <input id="edit-birthday" type="date" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black">
      </div>
      <!-- Panel de estadísticas -->
      <div class="mt-6 w-full flex stats-panel p-4 bg-[#f9f9f9] rounded-xl">
        <div class="flex-1 text-center">
          <p class="font-bold text-[#FE2C55]">Seguidores</p>
          <p id="edit-followers" class="text-black">0</p>
        </div>
        <div class="flex-1 text-center">
          <p class="font-bold text-[#FE2C55]">Siguiendo</p>
          <p id="edit-following" class="text-black">0</p>
        </div>
        <div class="flex-1 text-center">
          <p class="font-bold text-[#FE2C55]">Series</p>
          <p id="edit-stories-count" class="text-black">0</p>
        </div>
        <div class="flex-1 text-center">
          <p class="font-bold text-[#FE2C55]">VIP</p>
          <p id="edit-coins" class="text-black">0</p>
        </div>
      </div>
      <button onclick="saveProfileEdits()" class="mt-6 w-full bg-[#FE2C55] text-white p-3 rounded-lg">Guardar Cambios</button>
      <button onclick="signOutUser()" class="mt-4 w-full bg-[#f9f9f9] text-black p-3 rounded-lg border border-[#FE2C55]">Cerrar Sesión</button>
      <button onclick="openBeabooStudio()" class="mt-4 w-full bg-[#FE2C55] text-white p-3 rounded-lg flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
        </svg>
        BeaBoo Studio
      </button>

      <button onclick="openSupportModal()" class="mt-4 w-full bg-[#FE2C55] text-white p-3 rounded-lg flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
        </svg>
        Soporte
      </button>
      
      <button id="live-transmit-btn" onclick="openLiveStreamModal()" class="mt-4 w-full bg-[#FE2C55] text-white p-3 rounded-lg flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
        </svg>
        Transmitir en vivo
      </button>
    </div>
  </div>
</div>

<script>
  function handleEditProfileImageUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      document.getElementById('edit-profile-image').src = e.target.result;
    }
    
    if (file) {
      reader.readAsDataURL(file);
    }
  }
</script>

<!-- MODAL DE PERFIL DEL AUTOR -->
<div id="author-profile-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-4 relative">
    <!-- Botón de volver -->
    <button onclick="closeAuthorProfile()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span id="btn-volver-author">Volver</span>
    </button>
    <!-- Botón de opciones (3 puntos) -->
    <button id="options-button" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.75a.75.75 0 100-1.5.75.75 0 000 1.5zM12 13.25a.75.75 0 100-1.5.75.75 0 000 1.5zM12 19.75a.75.75 0 100-1.5.75.75 0 000 1.5z" />
      </svg>
    </button>
    <!-- Menú de opciones -->
    <div id="options-menu" class="absolute top-12 right-4 bg-white border border-gray-300 rounded-lg shadow-lg hidden">
      <ul class="divide-y">
        <li><button onclick="openReportModal()" class="w-full text-left px-4 py-2 hover:bg-gray-100">Reportar</button></li>
      </ul>
    </div>

    <div class="flex flex-col items-center mt-4" id="author-profile-content">
      <!-- Foto del autor -->
      <div id="author-profile-img-container" class="relative">
        <img id="author-profile-image" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55]" alt="Foto del autor">
        <!-- Note bubble -->
        <div id="profile-note" class="hidden absolute -top-16 left-1/2 transform -translate-x-1/2 bg-white p-3 rounded-lg shadow-lg w-48 text-center animate-float">
          <p id="note-text" class="text-sm"></p>
          <p id="note-time" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <style>
          @keyframes float {
            0%, 100% { transform: translate(-50%, 0px); }
            50% { transform: translate(-50%, -10px); }
          }
          .animate-float {
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
          }
        </style>
        <!-- Add note button (only visible for profile owner) -->
        <button id="add-note-btn" onclick="openNoteModal()" class="hidden absolute bottom-0 right-0 bg-[#FE2C55] text-white rounded-full p-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>

      <!-- Note Modal -->
      <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-4 rounded-lg w-80">
          <h3 class="text-lg font-bold mb-4">Agregar nota temporal</h3>
          <textarea id="note-input" class="w-full p-2 border rounded mb-4" placeholder="Escribe tu nota (máx. 100 caracteres)" maxlength="100"></textarea>
          <div class="flex justify-end space-x-2">
            <button onclick="closeNoteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
            <button onclick="saveNote()" class="px-4 py-2 bg-[#FE2C55] text-white rounded hover:bg-red-600">Guardar</button>
          </div>
        </div>
      </div>

<script>
function openNoteModal() {
  document.getElementById('note-modal').classList.remove('hidden');
}

function closeNoteModal() {
  document.getElementById('note-modal').classList.add('hidden');
  document.getElementById('note-input').value = '';
}

function saveNote() {
  const noteText = document.getElementById('note-input').value.trim();
  const currentUser = firebase.auth().currentUser;
  
  if (!noteText || !currentUser) return;
  
  firebase.database().ref('profileNotes/' + currentUser.uid).set({
    text: noteText,
    timestamp: Date.now()
  }).then(() => {
    closeNoteModal();
    const profileNote = document.getElementById('profile-note');
    profileNote.classList.remove('hidden');
    document.getElementById('note-text').textContent = noteText;
    document.getElementById('note-time').textContent = 'Expira en 12 horas';
  });
}
</script>
      <!-- Nombre de usuario -->
      <h2 id="author-profile-name" class="text-xl font-bold mt-2 text-black"></h2>
      <!-- Biografía -->
      <p id="author-bio" class="text-center text-gray-600 mt-2"></p>
      <!-- Redes sociales -->
      <div id="author-social-links" class="flex space-x-4 mt-4"></div>

      <!-- Estadísticas encima de botones -->
      <div class="flex space-x-8 mt-6">
        <div class="text-center">
          <span id="author-following" class="font-bold text-black">0</span>
          <p class="text-sm text-[#FE2C55]">Siguiendo</p>
        </div>
        <div class="text-center">
          <span id="author-followers" class="font-bold text-black">0</span>
          <p class="text-sm text-[#FE2C55]">Seguidores</p>
        </div>
      </div>

      <!-- Botones de acción: Seguir, Bloquear y Reportar -->
      <div class="flex items-center justify-center w-full mt-4 space-x-2">
        <button id="follow-button" onclick="followAuthor()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg hover:bg-red-600" title="Seguir/Dejar de seguir">
          <span id="follow-button-text">Seguir</span>
        </button>
        <button id="block-button" onclick="blockAuthor()" class="bg-[#f9f9f9] text-[#FE2C55] px-4 py-2 rounded-lg border border-[#FE2C55] hover:bg-gray-100" title="Bloquear/Desbloquear">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
          </svg>
          Bloquear
        </button>
        <button id="report-button" onclick="openReportModal()" class="flex items-center bg-[#f9f9f9] text-[#FE2C55] px-4 py-2 rounded-lg border border-[#FE2C55] hover:bg-gray-100" title="Reportar">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          Reportar
        </button>
      </div>

      <hr class="border-t border-gray-300 w-full my-4">

      <!-- Historias del autor -->
      <div class="mt-4 w-full">
        <h3 id="author-stories-title" class="text-lg font-bold mb-2 text-[#FE2C55]">Historias del autor</h3>
        <div id="author-stories" class="grid grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts para opciones y funcionalidad -->
<script>
  // Toggle menú de opciones
  document.getElementById('options-button').addEventListener('click', function() {
    const menu = document.getElementById('options-menu');
    menu.classList.toggle('hidden');
  });

  // Toggling de texto en botón de seguir
  function followAuthor() {
    const btn = document.getElementById('follow-button');
    const text = document.getElementById('follow-button-text');
    const isFollowing = text.textContent === 'Seguir';
    text.textContent = isFollowing ? 'Dejar de seguir' : 'Seguir';
    // Aquí iría lógica real de seguimiento.
  }
</script>



<!-- VISTA DE CREACIÓN DE HISTORIAS (Paso 1) con estilo TikTok -->
<div id="story-creation-view" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-6 max-w-md mx-auto bg-white rounded-2xl shadow-lg">
    <!-- Botón de volver -->
    <button onclick="closeStoryCreation()" class="mb-4 text-[#FE2C55] font-medium flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      <span>Volver</span>
    </button>
    <!-- Título -->
    <h2 id="story-type-title" class="text-2xl font-bold mb-8 text-black">¿Qué historia deseas contar?</h2>
    <div class="space-y-4">
      <button onclick="selectStoryType('cuento')" class="w-full flex items-center justify-between p-4 bg-[#f9f9f9] rounded-xl hover:bg-white transition-colors">
        <span>Cuento</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <button onclick="selectStoryType('historia_completa')" class="w-full flex items-center justify-between p-4 bg-[#f9f9f9] rounded-xl hover:bg-white transition-colors">
        <span>Historia Completa</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <button onclick="selectStoryType('novela')" class="w-full flex items-center justify-between p-4 bg-[#f9f9f9] rounded-xl hover:bg-white transition-colors">
        <span>Novela</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- VISTA DE DETALLES DE HISTORIA (Paso 2) con estilo TikTok -->
<div id="story-details-view" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-6 max-w-md mx-auto bg-white rounded-2xl shadow-lg">
    <!-- Botón de volver -->
    <button onclick="backToStoryType()" class="mb-4 text-[#FE2C55] font-medium flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      <span>Volver</span>
    </button>
    <!-- Título -->
    <h2 id="create-story-title" class="text-2xl font-bold mb-8 text-black">Crear Historia</h2>
    <form id="story-form" class="space-y-5">
      <div class="relative">
        <input id="story-title" type="text" placeholder="Título de la historia" class="w-full p-4 pl-10 bg-[#f9f9f9] rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55]" required>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
      </div>

      <label for="story-cover" class="w-full p-6 bg-[#f9f9f9] rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[#FE2C55] mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <span class="text-gray-600">Subir portada</span>
        <input id="story-cover" type="file" accept="image/*" class="hidden">
      </label>

      <div class="relative">
        <select id="story-category" class="w-full p-4 pl-10 bg-[#f9f9f9] rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] appearance-none" required>
          <option value="" disabled selected>Selecciona una categoría</option>
          <option value="aventura">Aventura</option>
          <option value="romance">Romance</option>
          <option value="misterio">Misterio</option>
          <option value="fantasia">Fantasía</option>
          <option value="terror">Terror</option>
        </select>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
        </svg>
      </div>

      <div class="relative">
        <label for="story-language" class="text-sm text-gray-600 ml-2 mb-1 block">Idioma de la historia</label>
        <select id="story-language" class="w-full p-4 pl-10 bg-[#f9f9f9] rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] appearance-none" required>
          <option value="" disabled selected>Selecciona un idioma</option>
          <option value="English">English</option>
          <option value="Spanish">Español</option>
        </select>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
        </svg>
      </div>

      <div class="relative">
        <select id="story-rating" class="w-full p-4 pl-10 bg-[#f9f9f9] rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] appearance-none" required>
          <option value="all">Apto para todo público</option>
          <option value="18plus">Mayores de 18</option>
          <option value="13minus">Menores de 13</option>
        </select>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>

      <div class="relative">
        <textarea id="story-synopsis" placeholder="Sinopsis de la historia" class="w-full p-4 pl-10 bg-[#f9f9f9] rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] resize-none placeholder-gray-600" rows="3"></textarea>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-6 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      </div>

      <!-- Botón Crear -->
      <button id="btn-create-story" type="submit" class="w-full py-4 rounded-xl font-medium shadow-lg flex items-center justify-center bg-gradient-to-r from-[#FE2C55] to-[#f97f97] hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <span class="text-white">Crear Historia</span>
      </button>
    </form>
  </div>
</div>

<script>
  // Funciones para cambiar vistas
  function selectStoryType(type) {
    document.getElementById('story-creation-view').classList.add('hidden');
    document.getElementById('story-details-view').classList.remove('hidden');
  }
</script>

<!-- MODAL DE EDICIÓN DE HISTORIAS (Paso 3) -->
<div id="story-edit-view" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-4 relative max-w-md mx-auto">
    <!-- Botón de cerrar -->
    <button onclick="closeStoryEdit()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      <span>Cerrar</span>
    </button>

    <!-- Título -->
    <h2 id="edit-story-title" class="text-2xl font-bold mb-6 text-black">Editar Historia</h2>

    <!-- Edición de idioma -->
    <div class="mb-5">
      <label for="edit-story-language" class="text-sm text-gray-600 ml-2 mb-1 block">Idioma de la historia</label>
      <div class="relative">
        <select id="edit-story-language" class="w-full p-3 pl-10 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] text-black appearance-none">
          <option value="">Selecciona un idioma</option>
          <option value="English">English</option>
          <option value="Spanish">Español</option>
        </select>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>

    <!-- Botón guardar -->
    <button onclick="saveStoryEdits()" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium mb-6 flex items-center justify-center hover:bg-red-600 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
      <span>Guardar Cambios</span>
    </button>

    <!-- Lista de capítulos -->
    <div id="chapter-section" class="mb-8">
      <h3 class="text-xl font-semibold mb-4 flex items-center text-[#FE2C55]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <span>Capítulos</span>
      </h3>
      <div id="chapter-list" class="space-y-3 mb-4 max-h-60 overflow-y-auto pr-2"></div>
      <button onclick="openChapterCreationModal()" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <span>Agregar Capítulo</span>
      </button>
    </div>

    <hr class="border-t border-gray-300 w-full my-4">

    <!-- Botones adicionales -->
    <button onclick="toggleStoryPrivacy()" class="w-full bg-[#f9f9f9] text-[#FE2C55] border border-[#FE2C55] p-3 rounded-lg font-medium mb-4 flex items-center justify-center hover:bg-gray-100 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
      <span>Hacer privada</span>
    </button>

    <button onclick="deleteStory(currentEditingStory.id)" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
      <span>Eliminar Historia</span>
    </button>
  </div>
</div>

<!-- MODAL DE CREACIÓN/EDICIÓN DE CAPÍTULO -->
<div id="chapter-creation-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
  <div class="modal-content bg-gradient-to-b from-white to-[#f9f9f9] text-black p-4 rounded-xl shadow-lg w-11/12 max-w-3xl">
    <div class="flex justify-between items-center mb-4">
      <h2 id="chapter-creation-title" class="text-2xl font-bold text-[#FE2C55]">Agregar Nuevo Capítulo</h2>
      <button onclick="closeChapterCreationModal()" class="text-gray-500 hover:text-black transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Barra de herramientas -->
    <div id="chapter-creation-toolbar" class="bg-white p-3 rounded-lg mb-4 flex flex-wrap gap-4 items-center">
      <div class="flex items-center">
        <label for="font-family" class="text-sm text-gray-600 mr-2">Fuente:</label>
        <select id="font-family" class="bg-white border border-gray-300 rounded-lg text-black text-sm p-1.5 focus:ring-2 focus:ring-[#FE2C55]">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
          <option value="Georgia">Georgia</option>
        </select>
      </div>

      <div class="flex items-center flex-1 min-w-[200px]">
        <label for="font-size" class="text-sm text-gray-600 mr-2">Tamaño:</label>
        <input type="range" id="font-size" min="12" max="36" value="16" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-[#FE2C55] mr-2">
        <span id="font-size-value" class="text-sm">16px</span>
      </div>

      <div class="bg-white py-1 px-3 rounded-lg text-sm text-gray-600">
        <span id="word-count">0 palabras</span> - <span id="letter-count">0 letras</span>
      </div>
    </div>

    <form id="chapter-form" class="space-y-4">
      <div class="flex items-center gap-4 mb-4">
        <input type="datetime-local" id="chapter-schedule" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55]">
        <label class="text-sm text-gray-600">Fecha de publicación (opcional)</label>
      </div>
      <textarea id="chapter-content" placeholder="Escribe el contenido del capítulo aquí..." class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] text-black placeholder-gray-500 resize-none" style="font-size:16px; font-family: Arial;" rows="12" required></textarea>

      <button id="btn-save-chapter" type="submit" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <span>Guardar Capítulo</span>
      </button>
    </form>
  </div>
</div>

<!-- MODAL DE LECTURA DE CAPÍTULO -->
<div id="chapter-read-modal" class="fixed inset-0 bg-[#0a0f1a] bg-opacity-95 flex flex-col z-50 hidden">
  <div class="bg-[#101730] dark:bg-[#0a0f1a] w-full h-screen flex flex-col">
    <button onclick="closeChapterReadModal()" class="absolute top-6 left-6 text-gray-400 dark:text-gray-300 hover:text-teal-400 dark:hover:text-teal-400 text-3xl z-10 transition-colors duration-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
    </button>
    <div class="flex-1 overflow-y-auto p-8 md:p-12 max-w-3xl mx-auto w-full">
      <h2 id="read-chapter-number" class="text-2xl md:text-3xl font-bold mb-8 mt-16 text-gray-100 dark:text-gray-100"></h2>
      <div id="read-chapter-text" class="text-lg leading-relaxed text-gray-300 dark:text-gray-200 font-serif"></div>
    </div>
    <div class="bg-[#132040] dark:bg-[#0d1220] border-t border-[#1e2c4a] dark:border-[#1e2c4a] p-4 flex justify-between items-center shadow-lg">
      <button id="prev-chapter-btn" class="bg-[#1e2c4a] dark:bg-[#1e2c4a] text-gray-300 dark:text-gray-200 px-5 py-3 rounded-lg shadow hover:shadow-md transition-shadow duration-200 focus:outline-none flex items-center gap-2 font-medium" onclick="prevChapter()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Anterior
      </button>
      <div id="rating-container" class="flex items-center space-x-3">
        <span class="text-gray-300 dark:text-gray-300 font-medium">Califica:</span>
        <div id="star-rating" class="flex">
          <span class="star cursor-pointer text-2xl text-gray-600 dark:text-gray-600 hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-150" data-value="1">★</span>
          <span class="star cursor-pointer text-2xl text-gray-600 dark:text-gray-600 hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-150" data-value="2">★</span>
          <span class="star cursor-pointer text-2xl text-gray-600 dark:text-gray-600 hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-150" data-value="3">★</span>
          <span class="star cursor-pointer text-2xl text-gray-600 dark:text-gray-600 hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-150" data-value="4">★</span>
          <span class="star cursor-pointer text-2xl text-gray-600 dark:text-gray-600 hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-150" data-value="5">★</span>
        </div>
      </div>
      <button id="next-chapter-btn" class="bg-teal-500 text-white px-5 py-3 rounded-lg shadow hover:shadow-md transition-shadow duration-200 focus:outline-none flex items-center gap-2 font-medium" onclick="nextChapter()">
        Siguiente
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE DETALLE DE HISTORIA -->
<div id="story-detail-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-6 relative max-w-4xl mx-auto bg-white rounded-2xl shadow-lg">

    <!-- Botón de volver -->
    <button onclick="closeStoryDetail()" class="text-[#FE2C55] mb-6 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>

    <!-- Sección principal: portada + título/autor -->
    <div class="flex items-start space-x-6 mb-8">
      <!-- Portada estilo Inkitt/Wattpad -->
      <img id="detail-cover" src="/api/placeholder/400/600" alt="Portada de la historia"
           class="w-40 sm:w-48 md:w-56 aspect-[2/3] object-cover rounded-2xl border-2 border-[#FE2C55] shadow-lg">
      
      <!-- Detalles de historia -->
      <div class="flex-1 flex flex-col">
        <h2 id="detail-title" class="text-2xl sm:text-3xl font-bold text-black mb-2">
          Título de la historia
        </h2>
        <p id="detail-author"
           class="text-gray-600 mb-4 cursor-pointer hover:text-[#FE2C55] transition-colors duration-200"
           onclick="openAuthorProfile(this.dataset.userid)">
          Nombre del autor
        </p>
      </div>
    </div>

    <!-- Lista de capítulos -->
    <div class="w-full mb-8">
      <h3 class="text-lg font-bold mb-2 text-[#FE2C55]">Capítulos</h3>
      <ul id="detail-chapters" class="space-y-3 divide-y divide-gray-200">
        <!-- Aquí insertar cada <li> de capítulo -->
      </ul>
    </div>

    <!-- Sinopsis -->
    <div class="w-full mb-6">
      <h3 class="text-lg font-semibold mb-2 text-[#FE2C55]">Sinopsis</h3>
      <p id="detail-synopsis" class="text-gray-600 leading-relaxed">
        Sinopsis de la historia...
      </p>
    </div>

    <!-- Métricas estilizadas debajo de sinopsis -->
    <div id="detail-metrics" class="flex justify-center gap-4">
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">3</span>
        <p class="text-xs text-[#FE2C55] mt-1">Visitas</p>
      </div>
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">4.5</span>
        <p class="text-xs text-[#FE2C55] mt-1">Calificación</p>
      </div>
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">12</span>
        <p class="text-xs text-[#FE2C55] mt-1">Capítulos</p>
      </div>
    </div>

  </div>
</div>






<!-- MODAL DE PERFIL DEL AUTOR -->
<div id="author-profile-modal" class="fixed inset-0 bg-[#0a0f1a] bg-opacity-90 flex items-center justify-center z-50 hidden backdrop-blur-sm">
  <div class="bg-[#101730] dark:bg-[#0a0f1a] w-full h-full md:h-auto md:max-h-[90vh] md:max-w-2xl mx-auto rounded-t-2xl md:rounded-2xl md:my-8 overflow-y-auto shadow-2xl">
    <div class="sticky top-0 z-10 p-4 bg-[#101730]/80 dark:bg-[#0a0f1a]/80 backdrop-blur-md">
      <button onclick="closeAuthorProfile()" class="text-gray-400 dark:text-gray-300 hover:text-teal-400 dark:hover:text-teal-400 flex items-center gap-2 font-medium transition-colors duration-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span id="btn-volver-author">Volver</span>
      </button>
    </div>

    <div class="p-6 pt-0 md:p-8" id="author-profile-content">
      <div class="flex flex-col items-center">
        <div id="author-profile-img-container" class="relative mb-4">
          <img id="author-profile-image" src="https://via.placeholder.com/150" class="w-28 h-28 rounded-full object-cover border-4 border-teal-900 dark:border-teal-900 shadow-md" alt="Foto del autor">
        </div>
        <h2 id="author-profile-name" class="text-2xl font-bold mb-2 text-gray-100 dark:text-gray-100"></h2>
        <p id="author-bio" class="text-center text-gray-400 dark:text-gray-400 mb-4 max-w-md"></p>

        <div id="author-social-links" class="flex space-x-4 mb-6"></div>

        

        <div class="w-full max-w-sm bg-[#1e2c4a] dark:bg-[#1e2c4a] rounded-lg p-4 mb-6">
          <div class="flex items-center justify-around w-full">
            <div class="flex-1 flex items-center justify-center">
              <button id="follow-button" onclick="followAuthor()" class="p-3 rounded-full bg-[#132040] dark:bg-[#132040] shadow hover:shadow-md transition-shadow duration-200" title="Seguir/Dejar de seguir">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-400 dark:text-teal-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
              </button>
            </div>
            <div class="w-px h-12 bg-[#283a5e] dark:bg-[#283a5e] mx-4"></div>
            <div class="flex-1 flex items-center justify-center">
              <button id="block-button" onclick="blockAuthor()" class="mx-2 flex items-center bg-[#f9f9f9] text-[#FE2C55] px-4 py-2 rounded-lg border border-[#FE2C55] hover:bg-gray-100" title="Bloquear/Desbloquear">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                Bloquear
              </button>
              <button id="report-button" onclick="openReportModal()" class="p-3 rounded-full bg-[#132040] dark:bg-[#132040] shadow hover:shadow-md transition-shadow duration-200" title="Reportar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="flex w-full max-w-sm justify-around mb-6 bg-[#1e2c4a] dark:bg-[#1e2c4a] rounded-lg p-4">
          <div class="text-center">
            <button onclick="openFollowersModal()" class="focus:outline-none hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-200">
              <span id="author-followers" class="font-bold text-xl text-gray-100 dark:text-gray-100">0</span>
              <p class="text-sm text-gray-400 dark:text-gray-400">Seguidores</p>
            </button>
          </div>
          <div class="text-center">
            <button onclick="openFollowingModal()" class="focus:outline-none hover:text-teal-400 dark:hover:text-teal-400 transition-colors duration-200">
              <span id="author-following" class="font-bold text-xl text-gray-100 dark:text-gray-100">0</span>
              <p class="text-sm text-gray-400 dark:text-gray-400">Siguiendo</p>
            </button>
          </div>
          <div class="text-center">
            <span id="author-rated" class="font-bold text-xl text-gray-100 dark:text-gray-100">0</span>
            <p class="text-sm text-gray-400 dark:text-gray-400">Calificaciones</p>
          </div>
        </div>

        <div class="w-full">
          <h3 id="author-stories-title" class="text-xl font-bold mb-4 text-gray-100 dark:text-gray-100">Historias del autor</h3>
          <div id="author-stories" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--
  Código Completo de Transmisión en Vivo (Transmisor y Espectador)
  ----------------------------------------------------------------------------
  Funcionalidades:
    • Vista de transmisión en vivo para el transmisor y el espectador.
    • Panel de ajustes del transmisor se muestra a pantalla completa.
         - Opciones: Notificaciones, Mostrar estado, Comentarios, Filtro de contenido.
         - Detector de rostro (simulación: se aplica un filtro de brillo/contraste para "aclarar" la imagen).
         - Opción para ocultar la barra de vistas.
    • Gestos swipe:
         - En la vista del transmisor: deslizar a la izquierda oculta todos los controles y a la derecha los muestra.
         - En la vista del espectador: deslizar a la izquierda oculta funciones (regalos, likes, etc.) y a la derecha las muestra.
    • Otras funcionalidades originales: envío de corazones (taps), cuenta regresiva, reporte, gift drawer, etc.
    • En la vista del espectador se muestra el ícono de vistas proporcionado.
    • En el banner expandido se elimina el botón “Activar LIVE” y se reemplaza por una animación infinita de “hilos” subiendo.
    • En el Gift Drawer, algunos regalos se muestran en formato video (moderno) en lugar de solo GIF.
-->

<!-- VISTA DE TRANSMISIÓN EN VIVO (Transmisor) -->
<div id="live-stream-modal" class="fixed inset-0 bg-gradient-to-b from-[#171F30] to-[#273852] z-50 hidden">
  <div class="relative w-full h-full">
    <!-- Contador de vistas -->
    <div id="live-viewCount" class="absolute top-4 right-4 text-xl bg-black/30 backdrop-blur-sm px-3 py-1 rounded-full text-[#00D6C9]">
      0 vistas
    </div>
    <!-- Contador de taps/corazones -->
    <div id="live-tapCount" class="absolute top-4 left-1/2 transform -translate-x-1/2 text-xl bg-black/30 backdrop-blur-sm px-3 py-1 rounded-full text-[#00D6C9]">
      0 ❤️
    </div>
    <!-- Video local -->
    <video id="live-localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
    <!-- Overlay con cuenta regresiva -->
    <div id="live-overlay" class="absolute inset-0 flex flex-col items-center justify-center">
      <div id="live-countdown" class="text-6xl font-bold text-[#00D6C9]"></div>
      <div id="live-indicator" class="hidden"></div>
    </div>
    <!-- Botón de ajustes (abre la pantalla completa de ajustes) -->
    <button id="live-settingsBtn" class="absolute top-4 left-4 bg-black/30 backdrop-blur-sm text-white text-lg rounded-full h-12 w-12 flex items-center justify-center" onclick="openSettingsFullscreen()">
      <img src="https://img.icons8.com/ios11/512/40C057/settings.png" alt="Ajustes" class="w-6 h-6">
    </button>
    <!-- Botón para iniciar transmisión -->
    <button id="live-startBtn" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-[#00D6C9] to-[#00A0B0] text-white text-2xl rounded-full p-6 shadow-lg"></button>

    <!-- Botón para cerrar el modal de transmisión -->
    <button id="live-closeBtn" onclick="closeLiveStreamModal()" class="absolute top-20 left-4 bg-black/50 text-white text-lg rounded-full h-10 w-10 flex items-center justify-center">
      X
    </button>
    <!-- Spinner -->
    <div id="live-spinner" class="absolute inset-0 flex items-center justify-center">
      <i class="fas fa-spinner fa-spin text-6xl" style="color:#00D6C9;"></i>
    </div>
  </div>
</div>
<!-- Modal de Bloqueo para Transmisión (por red y operador) -->
<div id="transmission-block-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" style="background: rgba(0,0,0,0.8);">
  <div class="bg-white p-6 rounded-xl text-center max-w-md mx-4">
    <!-- Spinner animado (usamos Font Awesome para el spinner) -->
    <div class="spinner mb-4">
      <i class="fas fa-spinner fa-spin fa-3x" style="color:#00D6C9;"></i>
    </div>
    <p class="text-lg font-bold mb-2">Función no disponible</p>
    <p class="text-sm">
      Por motivos de privacidad, esta función estará inhabilitada hasta nuevo aviso.<br><br>
      Estamos trabajando para resolver este asunto lo antes posible. Mientras tanto, puedes seguir usando las demás funciones increíbles de la plataforma.<br><br>
      ¡Gracias por tu comprensión!
    </p>
  </div>
</div>

<!-- Estilos para el spinner -->
<style>
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>

<!-- Funciones y detecciones para bloqueos y ajustes de transmisión -->
<script>
  // Función para detectar restricciones basadas en país y operador
  function checkTransmissionAvailability() {
    return true;
  }
  // Función para aplicar la vista "cinematográfica" (YouTube) al video
  function setLiveStreamYouTubeView() {
    const video = document.getElementById('live-localVideo');
    if (video) {
      // Se muestra el video completo sin recortes (similar a letterboxing)
      video.style.objectFit = 'contain';
      video.style.width = '100vw';
      video.style.height = 'auto';
      // Se puede ajustar el contenedor para que tenga fondo negro
      const container = video.parentElement;
      if (container) {
        container.style.backgroundColor = 'black';
        container.style.display = 'flex';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';
      }
    }
  }
  // Interceptar el clic en el botón de transmisión
  document.getElementById('live-startBtn').addEventListener('click', function(e) {
    e.preventDefault();
    // Se remueve la verificación de restricciones:
    document.getElementById('transmission-block-modal').classList.add('hidden');
    document.getElementById('live-stream-modal').classList.remove('hidden');
    setLiveStreamYouTubeView();
    // Inicia la transmisión (llamada a la función correspondiente)
  });
</script>

<!-- MODAL DE VISUALIZACIÓN EN VIVO (Espectador) -->
<div id="live-view-modal" class="fixed inset-0 z-50 hidden">
  <div class="live-container bg-gradient-to-b from-[#171F30] to-[#273852]" id="liveContainer">
    <!-- Top Bar -->
    <div class="top-bar bg-black/30 backdrop-blur-sm px-4 py-3">
      <div class="user-info">
        <i class="fas fa-arrow-left" style="color: white; font-size: 1.5rem; cursor:pointer;" onclick="closeLiveViewModal()"></i>
        <div class="user-profile">
          <i class="fas fa-user" style="background: linear-gradient(to right, #00D6C9, #00A0B0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
          <span id="streamerName" class="text-white font-medium">Broadcast Name</span>
        </div>
      </div>
      <div class="viewer-count bg-black/40 px-3 py-1 rounded-full">
        <span id="viewerCountLive" class="text-[#00D6C9]">0</span>
        <img src="https://cdn-icons-png.freepik.com/512/10985/10985667.png" alt="Views" class="w-5 h-5 inline-block">
      </div>
    </div>

    <!-- Banner promocional pequeño (estilo TikTok) -->
    <div id="promo-banner" class="absolute bottom-24 left-4 right-4 bg-black/30 backdrop-blur-sm rounded-lg p-2 flex items-center cursor-pointer" onclick="expandPromoBanner()">
      <div class="flex-shrink-0 mr-2">
        <i class="fas fa-broadcast-tower" style="color: #00D6C9; font-size: 20px;"></i>
      </div>
      <div class="flex-grow">
        <p class="text-white text-sm">Descubre funciones LIVE exclusivas</p>
      </div>
      <div class="flex-shrink-0">
        <i class="fas fa-chevron-up text-white"></i>
      </div>
    </div>

    <!-- Banner expandido -->
    <div id="expanded-banner" class="fixed inset-x-0 bottom-0 h-1/2 bg-black/80 backdrop-blur-md z-60 rounded-t-xl transition-transform duration-300 transform translate-y-full">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-[#00D6C9] text-xl font-bold">Funciones LIVE</h3>
          <button onclick="closeExpandedBanner()" class="text-white">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-white/10 p-3 rounded-lg">
            <i class="fas fa-heart text-pink-500 text-2xl mb-2"></i>
            <h4 class="text-white font-medium mb-1">Doble tap</h4>
            <p class="text-gray-300 text-sm">Toca dos veces para enviar corazones</p>
          </div>
          <div class="bg-white/10 p-3 rounded-lg">
            <i class="fas fa-gift text-[#00D6C9] text-2xl mb-2"></i>
            <h4 class="text-white font-medium mb-1">Regalos</h4>
            <p class="text-gray-300 text-sm">Envía regalos y sorprende al creador</p>
          </div>
          <div class="bg-white/10 p-3 rounded-lg">
            <i class="fas fa-star text-yellow-500 text-2xl mb-2"></i>
            <h4 class="text-white font-medium mb-1">Monetización</h4>
            <p class="text-gray-300 text-sm">Gana por tus transmisiones</p>
          </div>
          <div class="bg-white/10 p-3 rounded-lg">
            <i class="fas fa-users text-blue-500 text-2xl mb-2"></i>
            <h4 class="text-white font-medium mb-1">Comunidad</h4>
            <p class="text-gray-300 text-sm">Conecta con tus seguidores en vivo</p>
          </div>
        </div>
        <!-- Animación moderna de hilos subiendo de forma infinita -->
        <div id="animated-lines">
          <div class="line" style="left: 10%; animation-delay: 0s;"></div>
          <div class="line" style="left: 30%; animation-delay: 0.5s;"></div>
          <div class="line" style="left: 50%; animation-delay: 1s;"></div>
          <div class="line" style="left: 70%; animation-delay: 1.5s;"></div>
          <div class="line" style="left: 90%; animation-delay: 2s;"></div>
        </div>
      </div>
    </div>

    <!-- Contador de taps/corazones para el espectador -->
    <div id="viewer-tapCount" class="absolute top-16 right-4 text-lg bg-black/30 backdrop-blur-sm px-3 py-1 rounded-full text-[#00D6C9]">
      0 ❤️
    </div>

    <!-- Video Element -->
    <video id="live-remoteVideo" autoplay playsinline class="w-full h-full object-cover" ondblclick="handleDoubleTap(event)"></video>

    <!-- Contenedor para corazones animados -->
    <div id="hearts-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>

    <!-- Botones laterales estilo TikTok para espectador -->
    <div class="side-buttons absolute bottom-24 right-4 flex flex-col items-center space-y-6">
      <div class="side-button flex flex-col items-center">
        <div class="icon-button bg-black/30 backdrop-blur-sm w-12 h-12 rounded-full flex items-center justify-center" id="heartButtonViewer" onclick="sendHeart()">
          <img src="https://cdn-0.emojis.wiki/emoji-pics/twitter/green-heart-twitter.png" alt="Heart" style="width:24px; height:24px;">
        </div>
        <span id="likeCountLiveViewer" class="text-[#00D6C9] text-sm mt-1">0</span>
      </div>
      <div class="side-button flex flex-col items-center">
        <div class="icon-button bg-black/30 backdrop-blur-sm w-12 h-12 rounded-full flex items-center justify-center" id="giftButtonViewer" onclick="document.getElementById('gift-drawer').classList.add('open');">
          <img src="https://cdn-icons-png.flaticon.com/512/5899/5899678.png" alt="Gift" style="width:24px; height:24px;">
        </div>
        <span class="text-white text-sm mt-1">Regalo</span>
      </div>
      <div class="side-button flex flex-col items-center">
        <div class="icon-button bg-black/30 backdrop-blur-sm w-12 h-12 rounded-full flex items-center justify-center" id="reportButtonViewer" onclick="showReportModal()">
          <i class="fas fa-flag" style="color: #f44336; font-size:20px;"></i>
        </div>
        <span class="text-white text-sm mt-1">Reportar</span>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE GIFT DRAWER -->
<div id="gift-drawer" class="bg-gradient-to-b from-[#1A2235] to-[#273852]">
  <div class="gift-container">
    <h2 class="text-xl font-bold mb-4 text-center text-white">Enviar Regalo</h2>
    <div class="gift-grid">
      <!-- Ítems originales (algunos se muestran como GIF y otros en video para un look moderno) -->
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('cupido')">
        <img src="https://i.pinimg.com/originals/2d/f8/97/2df897364f655a0b14070a9e2f95d602.gif" alt="Cupido">
        <span class="text-[#00D6C9]">Cupido</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('diamante')">
        <img src="https://i.pinimg.com/originals/79/a5/49/79a54992591652b1595c6c61c49170fb.gif" alt="Diamante">
        <span class="text-[#00D6C9]">Diamante</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('oso_beaboo')">
        <img src="https://www.icegif.com/wp-content/uploads/2021/11/icegif-346.gif" alt="oso Beaboo">
        <span class="text-[#00D6C9]">oso Beaboo</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('oso_saltarin')">
        <img src="https://www.icegif.com/wp-content/uploads/2021/11/icegif-347.gif" alt="oso saltarín">
        <span class="text-[#00D6C9]">oso saltarín</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('besboos_carinosos')">
        <img src="https://i.pinimg.com/originals/3b/d4/d9/3bd4d9778b5e0a11ab141cb7b545ab10.gif" alt="Besboos cariñosos">
        <span class="text-[#00D6C9]">Besboos cariñosos</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('besboos_leyendo')">
        <img src="https://i.pinimg.com/originals/c6/41/ba/c641babc376ffe10f65ee472a646c6e1.gif" alt="besboos leyendo">
        <span class="text-[#00D6C9]">besboos leyendo</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('Selecciona a Harry')">
        <img src="https://media2.giphy.com/media/9EnuwMN4qxFoDfnJam/200w.gif" alt="Selecciona a Harry">
        <span class="text-[#00D6C9]">Selecciona a Harry</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('Galaxia Blanca')">
        <img src="https://64.media.tumblr.com/632f8d471cdef6eb0a5018d125ce6475/tumblr_mv4rb608vh1s5jjtzo1_400.gif" alt="Galaxia Blanca">
        <span class="text-[#00D6C9]">Galaxia Blanca</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('baile')">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0_aNKZP5QwCAtf0QD5SBK4JulDqNJr6UDg8w4R-E_12arxSsP_HBQhksCL-7xfipx_uVmYbagEFjE8tZGBX-AO40PwMJvIOpr49e_sedIGjCWkUqkrUJZGR4vwr4ygNUrR1hreOsTgc4/s1600/BkM47.gif" alt="baile">
        <span class="text-[#00D6C9]">baile</span>
      </div>

      <!-- Nuevos regalos -->
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('arcoiris')">
        <img src="https://i.pinimg.com/originals/17/9c/e7/179ce7068a3c543261505ea69398b714.gif" alt="Arcoiris">
        <span class="text-[#00D6C9]">Arcoiris</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('Love Max')">
        <img src="https://i.pinimg.com/originals/28/89/15/28891591a6c88725b46c3e9774c3aefc.gif" alt="Love Max">
        <span class="text-[#00D6C9]">Love Max</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('pastel')">
        <img src="https://i.gifer.com/3EcT.gif" alt="Pastel">
        <span class="text-[#00D6C9]">Pastel</span>
      </div>
      <!-- Se omite "baile" ya que ya está incluido arriba -->
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('musica')">
        <img src="https://i.pinimg.com/originals/68/fc/a0/68fca09b36725b767735abef8c7e1117.gif" alt="Música">
        <span class="text-[#00D6C9]">Música</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('sol')">
        <img src="https://cdn.pixabay.com/animation/2024/03/08/13/17/13-17-23-34_512.gif" alt="Sol">
        <span class="text-[#00D6C9]">Sol</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('nube')">
        <img src="https://cdn.pixabay.com/animation/2022/09/17/16/20/16-20-08-700_512.gif" alt="Nube">
        <span class="text-[#00D6C9]">Nube</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('globo')">
        <img src="https://images.emojiterra.com/google/noto-emoji/animated-emoji/1f388.gif" alt="Globo">
        <span class="text-[#00D6C9]">Globo</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('caramelo')">
        <img src="https://i.pinimg.com/originals/e2/9c/7b/e29c7bc3faadc09dfcddb6ca11243c6d.gif" alt="Caramelo">
        <span class="text-[#00D6C9]">Caramelo</span>
      </div>
      <div class="gift-item bg-black/20 backdrop-blur-sm rounded-lg" onclick="sendGift('fuego')">
        <img src="https://media.tenor.com/qxyNYoXRT6wAAAAj/fuego.gif" alt="fuego">
        <span class="text-[#00D6C9]">fuego</span>
      </div>
    </div>
    <button onclick="closeGiftDrawer()" class="mt-4 bg-gradient-to-r from-[#00D6C9] to-[#00A0B0] text-white p-2 rounded-full w-full">
      Cancelar
    </button>
  </div>
</div>

<!-- MODAL DE REPORTE (Estilo TikTok) -->
<div id="report-modal" class="fixed inset-0 bg-black/50 flex items-end justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="w-full max-w-lg bg-white rounded-t-2xl p-6 transform translate-y-full transition-transform duration-300 ease-out">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-[#FE2C55] text-xl font-bold">Reportar transmisión</h3>
      <button onclick="closeReportModal()" class="text-gray-400 hover:text-[#FE2C55] transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <p class="text-gray-600 mb-4">Selecciona el motivo del reporte:</p>
    <div class="space-y-3 mb-6">
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-sexual" class="mr-3 accent-[#FE2C55]">
        <label for="reason-sexual" class="text-gray-800">Contenido sexual</label>
      </div>
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-violence" class="mr-3 accent-[#FE2C55]">
        <label for="reason-violence" class="text-gray-800">Violencia o acoso</label>
      </div>
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-spam" class="mr-3 accent-[#FE2C55]">
        <label for="reason-spam" class="text-gray-800">Spam o engaño</label>
      </div>
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-rights" class="mr-3 accent-[#FE2C55]">
        <label for="reason-rights" class="text-gray-800">Infracción de derechos</label>
      </div>
      <div class="bg-gray-50 hover:bg-gray-100 transition-colors p-4 rounded-xl flex items-center cursor-pointer">
        <input type="radio" name="report-reason" id="reason-other" class="mr-3 accent-[#FE2C55]">
        <label for="reason-other" class="text-gray-800">Otro motivo</label>
      </div>
    </div>
    <button onclick="submitReport()" class="w-full bg-[#FE2C55] hover:bg-[#ef2950] text-white py-4 rounded-full font-medium transition-colors shadow-lg">
      Enviar reporte
    </button>
  </div>
</div>

<!-- ANIMACIÓN DE REPORTE ENVIADO -->
<div id="report-success" class="fixed inset-0 bg-black/70 backdrop-blur-md z-70 hidden flex items-center justify-center">
  <div class="text-center">
    <div class="verification-animation">
      <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
      </svg>
    </div>
    <h3 class="text-white text-xl font-bold mt-4">¡Reporte enviado!</h3>
    <p class="text-gray-300 mt-2">Gracias por ayudarnos a mantener la comunidad segura</p>
    <button onclick="closeReportSuccess()" class="mt-6 bg-gradient-to-r from-[#00D6C9] to-[#00A0B0] text-white py-2 px-6 rounded-full font-medium">
      Continuar
    </button>
  </div>
</div>

<!-- CONTENEDOR PARA LA ANIMACIÓN DEL REGALO -->
<div id="gift-animation"></div>

<!-- INPUTS ocultos para video pregrabado y audio -->
<input type="file" id="live-video-input" accept="video/*" class="hidden" onchange="handleLiveVideoUpload(event)">
<input type="file" id="live-audio-es" accept="audio/*" class="hidden">
<input type="file" id="live-audio-en" accept="audio/*" class="hidden">

<!-- PANEL DE AJUSTES A PANTALLA COMPLETA -->
<div id="settings-fullscreen" class="fixed inset-0 bg-black/80 z-50 hidden">
  <div class="w-full h-full flex flex-col">
    <!-- Encabezado -->
    <header class="p-4 bg-gradient-to-r from-[#00D6C9] to-[#00A0B0] flex justify-between items-center">
      <h2 class="text-white text-xl">Ajustes de Transmisión</h2>
      <button onclick="closeSettingsFullscreen()" class="text-white text-2xl">&times;</button>
    </header>
    <!-- Contenido de ajustes -->
    <div class="flex-1 overflow-y-auto p-4 bg-[#171F30]">
      <!-- Opciones originales -->
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <span class="text-white">Notificaciones</span>
          <label class="switch">
            <input type="checkbox" id="notifications-toggle" checked>
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white">Mostrar estado</span>
          <label class="switch">
            <input type="checkbox" id="status-toggle" checked>
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white">Comentarios</span>
          <label class="switch">
            <input type="checkbox" id="comments-toggle" checked>
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white">Filtro de contenido</span>
          <label class="switch">
            <input type="checkbox" id="filter-toggle">
            <span class="slider round"></span>
          </label>
        </div>
        <!-- Nuevas opciones de ajustes -->
        <div class="flex items-center justify-between">
          <span class="text-white">Detector de rostro (efecto belleza)</span>
          <label class="switch">
            <input type="checkbox" id="face-detection-toggle">
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white">Ocultar barra de vistas</span>
          <label class="switch">
            <input type="checkbox" id="hide-viewbar-toggle">
            <span class="slider round"></span>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estilos adicionales -->
<style>
  /* Estilos para los botones laterales */
  .side-buttons {
    z-index: 20;
  }

  /* Estilo para el gift drawer (abrir desde abajo) */
  #gift-drawer {
    position: fixed;
    bottom: -100%;
    left: 0;
    right: 0;
    height: 70%;
    z-index: 60;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    transition: bottom 0.3s ease-in-out;
    overflow-y: auto;
  }

  #gift-drawer.open {
    bottom: 0;
  }

  /* Estilo para corazones animados */
  .heart {
    position: absolute;
    font-size: 25px;
    color: #00D6C9;
    animation: float-up 2s ease-out forwards;
    opacity: 0.8;
    z-index: 10;
    pointer-events: none;
  }

  @keyframes float-up {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0.8;
    }

    100% {
      transform: translateY(-100px) scale(1.5);
      opacity: 0;
    }
  }

  /* Estilo para switch toggle */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
  }

  input:checked+.slider {
    background-color: #00D6C9;
  }

  input:focus+.slider {
    box-shadow: 0 0 1px #00D6C9;
  }

  input:checked+.slider:before {
    transform: translateX(26px);
  }

  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }

  /* Animación de verificación */
  .verification-animation {
    display: inline-block;
    margin: 0 auto;
  }

  .checkmark {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: #00D6C9;
    stroke-miterlimit: 10;
    box-shadow: inset 0px 0px 0px #00D6C9;
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
  }

  .checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #00D6C9;
    fill: none;
    animation: stroke .6s cubic-bezier(0.650, 0.000, 0.450, 1.000) forwards;
  }

  .checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke .3s cubic-bezier(0.650, 0.000, 0.450, 1.000) .8s forwards;
  }

  @keyframes stroke {
    100% {
      stroke-dashoffset: 0;
    }
  }

  @keyframes scale {

    0%,
    100% {
      transform: none;
    }

    50% {
      transform: scale3d(1.1, 1.1, 1);
    }
  }

  @keyframes fill {
    100% {
      box-shadow: inset 0px 0px 0px 30px #00D6C9;
    }
  }

  /* Animación de hilos subiendo en el banner expandido */
  #animated-lines {
    position: relative;
    width: 100%;
    height: 50px;
    overflow: hidden;
    margin-top: 20px;
  }

  .line {
    position: absolute;
    width: 2px;
    height: 100%;
    background: linear-gradient(to top, transparent, #00D6C9);
    animation: rise 3s linear infinite;
    opacity: 0.7;
  }

  @keyframes rise {
    0% {
      top: 100%;
      opacity: 0;
    }

    50% {
      opacity: 1;
    }

    100% {
      top: -50px;
      opacity: 0;
    }
  }
</style>

<!-- JavaScript: Funcionalidades y Gestos -->
<script>
  // FUNCIONES DE COMUNIDAD
  function openCommunity() {
    document.getElementById('community-view').classList.remove('hidden');
    mainApp.classList.add('hidden');
    loadNotes();
  }

  function closeCommunity() {
    document.getElementById('community-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }

  function switchCommunityTab(tab) {
    const feedTab = document.getElementById('feed-tab');
    const addTab = document.getElementById('add-tab');
    const notesFeed = document.getElementById('notes-feed');
    const addNoteForm = document.getElementById('add-note-form');

    if (tab === 'feed') {
      feedTab.classList.add('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      addTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      notesFeed.classList.remove('hidden');
      addNoteForm.classList.add('hidden');
      loadNotes();
    } else {
      addTab.classList.add('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      feedTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      notesFeed.classList.add('hidden');
      addNoteForm.classList.remove('hidden');
    }
  }

  function handleNoteImagePreview(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview-img').src = e.target.result;
      document.getElementById('image-preview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }

  function removeImage() {
    document.getElementById('note-image').value = '';
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('preview-img').src = '';
  }

  function publishNote() {
    const content = document.getElementById('note-content').value.trim();
    const imageInput = document.getElementById('note-image');
    if (!content && !imageInput.files.length) return;

    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesión para publicar notas');
      return;
    }

    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val();
      const note = {
        content: content,
        authorId: user.uid,
        authorName: userData.username || 'Usuario',
        authorImage: userData.profileImage || 'https://via.placeholder.com/150',
        timestamp: Date.now(),
        likes: 0
      };

      if (imageInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = function(e) {
          note.imageUrl = e.target.result;
          publishNoteToDatabase(note);
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        publishNoteToDatabase(note);
      }
    });
  }

  function publishNoteToDatabase(note) {
    firebase.database().ref('communityNotes').push(note).then(() => {
      document.getElementById('note-content').value = '';
      document.getElementById('note-image').value = '';
      document.getElementById('image-preview').classList.add('hidden');
      switchCommunityTab('feed');
    });
  }

  function loadNotes() {
    const feedContainer = document.getElementById('notes-feed');
    feedContainer.innerHTML = '';

    firebase.database().ref('communityNotes').orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
      const notes = [];
      snapshot.forEach(child => {
        notes.unshift({...child.val(), id: child.key});
      });

      notes.forEach(note => {
        const noteElement = document.createElement('div');
        noteElement.className = 'bg-white p-4 rounded-xl shadow';
        noteElement.innerHTML = `
          <div class="flex items-center mb-3">
            <img src="${note.authorImage}" alt="${note.authorName}" class="w-10 h-10 rounded-full mr-3">
            <div>
              <h3 class="font-bold">${note.authorName}</h3>
              <p class="text-sm text-gray-500">${new Date(note.timestamp).toLocaleString()}</p>
            </div>
          </div>
          <p class="mb-3">${note.content}</p>
          ${note.imageUrl ? `<img src="${note.imageUrl}" alt="Imagen de la nota" class="w-full rounded-lg mb-3 max-h-96 object-cover">` : ''}
          <div class="flex items-center space-x-4">
            <button onclick="likeNote('${note.id}')" class="flex items-center text-[#FE2C55]">
              <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />
              </svg>
              <span>${note.likes || 0}</span>
            </button>
            ${note.authorId === firebase.auth().currentUser?.uid ? 
              `<button onclick="deleteNote('${note.id}')" class="text-red-500 hover:text-red-700">
                <i class="fas fa-trash"></i>
              </button>` : 
              `<button onclick="reportNote('${note.id}')" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-flag"></i>
              </button>`
            }
          </div>
        `;
        feedContainer.appendChild(noteElement);
      });
    });
  }

  function contienePalabrasOfensivas(texto) {
  const palabrasOfensivas = [
    "idiota", "estúpido", "imbécil", "tonto", "pendejo",
    "maldito", "puta", "mierda", "carajo", "joder",
    "perra", "zorra", "maricón", "puto", "cabrón",
    "bastardo", "maldición", "verga", "coño", "culo"
  ];
  
  const textoNormalizado = texto.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
  
  return palabrasOfensivas.some(palabra => 
    textoNormalizado.includes(palabra.toLowerCase()));
}

function contieneContenidoInapropiado(texto) {
  const patronesInapropiados = [
    /\b(?:porn|xxx)\b/i,
    /\b(?:kill|murder)\b/i,
    /\b(?:suicide|death)\b/i,
    /\b(?:cocaine|heroin|drugs)\b/i,
    /\b(?:terrorist|bomb)\b/i
  ];
  
  return patronesInapropiados.some(patron => patron.test(texto));
}

function moderarNota(noteId, content) {
  const loadingDiv = document.createElement('div');
  loadingDiv.innerHTML = `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-[#FE2C55] mx-auto mb-4"></div>
        <p>Analizando contenido...</p>
      </div>
    </div>
  `;
  document.body.appendChild(loadingDiv);

  setTimeout(() => {
    document.body.removeChild(loadingDiv);
    
    if (contienePalabrasOfensivas(content)) {
      firebase.database().ref('communityNotes/' + noteId).remove();
      alert('La nota ha sido eliminada por contener lenguaje ofensivo.');
    } else if (contieneContenidoInapropiado(content)) {
      firebase.database().ref('communityNotes/' + noteId).update({
        blocked: true,
        blockReason: 'Contenido inapropiado detectado'
      });
      alert('La nota ha sido bloqueada por posible contenido inapropiado.');
    }
  }, 5000);
}

function deleteNote(noteId) {
  if (!confirm('¿Estás seguro de que quieres eliminar esta nota?')) return;
  
  firebase.database().ref('communityNotes/' + noteId).remove()
    .then(() => {
      alert('Nota eliminada correctamente');
    })
    .catch(error => {
      console.error('Error al eliminar la nota:', error);
      alert('Error al eliminar la nota');
    });
}

function reportNote(noteId) {
  const noteRef = firebase.database().ref('communityNotes/' + noteId);
  noteRef.once('value').then(snapshot => {
    const note = snapshot.val();
    if (note) {
      moderarNota(noteId, note.content);
    }
  });
}

function likeNote(noteId) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const userLikeRef = firebase.database().ref('userLikes/' + user.uid + '/' + noteId);
    
    userLikeRef.once('value').then(snapshot => {
      if (!snapshot.exists()) {
        userLikeRef.set(true);
        const noteRef = firebase.database().ref('communityNotes/' + noteId);
        noteRef.transaction(note => {
          if (note) {
            note.likes = (note.likes || 0) + 1;
          }
          return note;
        });
      }
    });
}

  // VARIABLES GLOBALES
  let tapCount = 0,
    lastTap = 0,
    heartCount = 0;
  let touchstartX = 0,
    touchendX = 0; // Para detección de swipe
  // -------------------------------
  // Funciones para Corazones (Taps)
  // -------------------------------
  function handleDoubleTap(event) {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    if (tapLength < 300 && tapLength > 0) {
      createHeart(event.clientX, event.clientY);
      incrementHeartCount();
      lastTap = 0;
    } else {
      lastTap = currentTime;
    }
  }

  function createHeart(x, y) {
    const heart = document.createElement('div');
    heart.classList.add('heart');
    heart.style.left = (x - 12) + 'px';
    heart.style.top = (y - 12) + 'px';
    heart.innerHTML = '❤️';
    document.getElementById('hearts-container').appendChild(heart);
    setTimeout(() => {
      heart.remove();
    }, 2000);
  }

  function incrementHeartCount() {
    heartCount++;
    document.getElementById('live-tapCount').textContent = heartCount + " ❤️";
    document.getElementById('viewer-tapCount').textContent = heartCount + " ❤️";
    document.getElementById('likeCountLiveViewer').textContent = heartCount;
  }

  function sendHeart() {
    const video = document.getElementById('live-remoteVideo');
    const rect = video.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top + rect.height / 2;
    createHeart(x, y);
    incrementHeartCount();
  }
  // -------------------------------
  // Funciones de Ajustes y Modales
  // -------------------------------
  function openSettingsFullscreen() {
    document.getElementById("settings-fullscreen").classList.remove("hidden");
  }

  function closeSettingsFullscreen() {
    document.getElementById("settings-fullscreen").classList.add("hidden");
  }

  function closeLiveStreamModal() {
    document.getElementById('live-stream-modal').classList.add('hidden');
  }

  function closeLiveViewModal() {
    document.getElementById('live-view-modal').classList.add('hidden');
  }

  function expandPromoBanner() {
    document.getElementById('expanded-banner').classList.remove('translate-y-full');
  }

  function closeExpandedBanner() {
    document.getElementById('expanded-banner').classList.add('translate-y-full');
  }

  function sendGift(giftName) {
    alert("Enviado regalo: " + giftName);
    closeGiftDrawer();
  }

  function closeGiftDrawer() {
    document.getElementById('gift-drawer').classList.remove('open');
  }

  function showReportModal() {
    document.getElementById('report-modal').classList.remove('translate-y-full');
  }

  function closeReportModal() {
    document.getElementById('report-modal').classList.add('translate-y-full');
  }

  function submitReport() {
    closeReportModal();
    document.getElementById('report-success').classList.remove('hidden');
    setTimeout(closeReportSuccess, 3000);
  }

  function closeReportSuccess() {
    document.getElementById('report-success').classList.add('hidden');
  }

  function handleLiveVideoUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const video = document.getElementById('live-localVideo');
      video.src = URL.createObjectURL(file);
      video.play();
    }
  }
  document.getElementById('live-startBtn').addEventListener('click', function() {
    document.getElementById('live-spinner').classList.remove('hidden');
    this.classList.add('hidden');
    setTimeout(function() {
      document.getElementById('live-spinner').classList.add('hidden');
      document.getElementById('live-endBtn').classList.remove('hidden');
      document.getElementById('live-overlay').classList.add('hidden');
    }, 2000);
  });
  document.getElementById('live-endBtn').addEventListener('click', function() {
    closeLiveStreamModal();
  });

  function startCountdown() {
    let countdownElement = document.getElementById('live-countdown');
    let count = 3;
    countdownElement.textContent = count;
    let interval = setInterval(() => {
      count--;
      if (count > 0) {
        countdownElement.textContent = count;
      } else {
        clearInterval(interval);
        countdownElement.textContent = "¡En vivo!";
        setTimeout(() => {
          document.getElementById('live-overlay').classList.add('hidden');
        }, 1000);
      }
    }, 1000);
  }
  // -------------------------------
  // Nuevas Funcionalidades en Ajustes
  // -------------------------------
  // Detector de rostro (simulación: se aplica filtro de brillo/contraste)
  function startFaceDetection() {
    console.log("Detección de rostro activada - aplicando efecto belleza");
    document.getElementById("live-localVideo").style.filter = "brightness(1.2) contrast(1.1)";
  }

  function stopFaceDetection() {
    console.log("Detección de rostro desactivada - quitando efecto");
    document.getElementById("live-localVideo").style.filter = "";
  }
  document.getElementById('face-detection-toggle').addEventListener('change', function() {
    if (this.checked) {
      startFaceDetection();
    } else {
      stopFaceDetection();
    }
  });
  // Ocultar barra de vistas según el ajuste
  document.getElementById('hide-viewbar-toggle').addEventListener('change', function() {
    const viewBar = document.getElementById('live-viewCount');
    if (this.checked) {
      viewBar.classList.add('hidden');
    } else {
      viewBar.classList.remove('hidden');
    }
  });
  // -------------------------------
  // Detección de Swipe (Deslizar a la izquierda/derecha)
  // -------------------------------
  // Para vista del Transmisor: ocultar/mostrar todos los controles
  const transmitterModal = document.getElementById("live-stream-modal");
  transmitterModal.addEventListener("touchstart", function(e) {
    touchstartX = e.changedTouches[0].screenX;

function openNoteModal() {
  document.getElementById('note-modal').classList.remove('hidden');
}

function closeNoteModal() {
  document.getElementById('note-modal').classList.add('hidden');
  document.getElementById('note-input').value = '';
}

function saveNote() {
  const noteText = document.getElementById('note-input').value.trim();
  const currentUser = firebase.auth().currentUser;
  
  if (!noteText || !currentUser) return;
  
  firebase.database().ref('profileNotes/' + currentUser.uid).set({
    text: noteText,
    timestamp: Date.now()
  }).then(() => {
    closeNoteModal();
    const profileNote = document.getElementById('profile-note');
    profileNote.classList.remove('hidden');
    document.getElementById('note-text').textContent = noteText;
    document.getElementById('note-time').textContent = 'Expira en 12 horas';
  });
}

  }, false);
  transmitterModal.addEventListener("touchend", function(e) {
    touchendX = e.changedTouches[0].screenX;
    handleTransmitterSwipe();
  }, false);

  function handleTransmitterSwipe() {
    if (touchstartX - touchendX > 50) {
      hideTransmitterFunctions();
    } else if (touchendX - touchstartX > 50) {
      showTransmitterFunctions();
    }
  }

  function hideTransmitterFunctions() {
    document.getElementById("live-settingsBtn").classList.add("hidden");
    document.getElementById("live-viewCount").classList.add("hidden");
    document.getElementById("live-tapCount").classList.add("hidden");
  }

  function showTransmitterFunctions() {
    document.getElementById("live-settingsBtn").classList.remove("hidden");
    if (!document.getElementById('hide-viewbar-toggle').checked) {
      document.getElementById("live-viewCount").classList.remove("hidden");
    }
    document.getElementById("live-tapCount").classList.remove("hidden");
  }
  // Para vista del Espectador: ocultar/mostrar funciones (regalos, likes)
  const viewerModal = document.getElementById("live-view-modal");
  viewerModal.addEventListener("touchstart", function(e) {
    touchstartX = e.changedTouches[0].screenX;
  }, false);
  viewerModal.addEventListener("touchend", function(e) {
    touchendX = e.changedTouches[0].screenX;
    handleViewerSwipe();
  }, false);

  function handleViewerSwipe() {
    if (touchstartX - touchendX > 50) {
      hideViewerFunctions();
    } else if (touchendX - touchstartX > 50) {
      showViewerFunctions();
    }
  }

  function hideViewerFunctions() {
    const sideButtons = document.querySelector(".side-buttons");
    if (sideButtons) {
      sideButtons.classList.add("hidden");
    }
    document.getElementById("viewer-tapCount").classList.add("hidden");
    document.getElementById("likeCountLiveViewer").classList.add("hidden");
  }

  function showViewerFunctions() {
    const sideButtons = document.querySelector(".side-buttons");
    if (sideButtons) {
      sideButtons.classList.remove("hidden");
    }
    document.getElementById("viewer-tapCount").classList.remove("hidden");
    document.getElementById("likeCountLiveViewer").classList.remove("hidden");
  }
</script>
</script>

<!-- JAVASCRIPT -->
<script>
  /*********************** CONFIGURACIÓN DE FIREBASE **************************/
  const firebaseConfig = {
    apiKey: "AIzaSyBWBr3sud1_lDPmtLJI42pCBZnco5_vyCc",
    authDomain: "noble-amp-458106-g0.firebaseapp.com",
    databaseURL: "https://noble-amp-458106-g0-default-rtdb.firebaseio.com",
    projectId: "noble-amp-458106-g0",
    storageBucket: "noble-amp-458106-g0.firebasestorage.app",
    messagingSenderId: "744574411059",
    appId: "1:744574411059:web:72a70955f1400df6645e46",
    measurementId: "G-XEQ1J354HM"
  };
  firebase.initializeApp(firebaseConfig);
  // Todos los usuarios están autorizados para transmitir en vivo
  const authorizedEmails = [];
  /*********************** FUNCIONES ADICIONALES **************************/
  function contienePalabrasOfensivas(texto) {
    // Lista de 20 palabras ofensivas en español (ejemplo; ajústala según tus necesidades)
    const listaOfensiva = [
      "imbécil", "idiota", "estúpido", "tarado", "pendejo",
      "capullo", "gilipollas", "subnormal", "malparido", "bobo",
      "tonto", "inútil", "cretino", "estúpida", "pendeja",
      "zorra", "perra", "mierda", "cabrón", "merda"
    ];
    // Normalizamos el texto: quitamos acentos y lo convertimos a minúsculas
    const textoNormalizado = texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    // Se busca cada término usando delimitadores para coincidir palabras completas
    return listaOfensiva.some(palabra => {
      const regex = new RegExp("\\b" + palabra + "\\b", "i");
      return regex.test(textoNormalizado);
    });
  }
  /*********************** VARIABLES Y ELEMENTOS DEL DOM **************************/
  const authForm = document.getElementById('authForm');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const submitButton = document.getElementById('submitButton');
  const toggleAuth = document.getElementById('toggleAuth');
  const authError = document.getElementById('authError');
  const authFormContainer = document.getElementById('auth-form');
  const mainApp = document.getElementById('main-app');
  let isLogin = true;
  let storyTypeSelected = "";
  let currentEditingStory = null;
  let currentChapters = [];
  let currentViewedAuthorId = null;
  let liveBroadcasterId = null;
  let currentChapterEditId = null;
  let currentLanguage = 'es';
  const translations = {
    es: {
      appName: "BeaBoo",
      tagline: "Tu portal de historias inolvidables",
      authTitle: "BeaBoo",
      emailPlaceholder: "Correo electrónico",
      passwordPlaceholder: "Contraseña",
      btnIniciarSesion: "Iniciar Sesión",
      btnToggleAuth: "¿No tienes cuenta? Regístrate",
      btnVolver: "Volver",
      newReleases: "Nuevos Lanzamientos",
      top10: "Top 10",
      popular: "Más Populares",
      terror: "Historias de Terror Destacadas",
      searchPlaceholder: "Buscar historias o autores",
      searchResults: "Resultados de búsqueda",
      searchBooks: "Libros",
      searchAuthors: "Autores",
      profileStories: "Mis Historias",
      editProfile: "Editar nombre",
      saveBio: "Guardar biografía",
      createStory: "Crear Historia",
      storyTitlePlaceholder: "Título de la historia",
      selectCategory: "Selecciona una categoría",
      btnCreateStory: "Crear Historia",
      editStory: "Editar Historia",
      addChapter: "Agregar Capítulo",
      deleteStory: "Eliminar Historia",
      makePrivate: "Hacer privada",
      chapterCreationTitle: "Agregar Nuevo Capítulo",
      chapterPlaceholder: "Escribe el contenido del capítulo aquí...",
      btnSaveChapter: "Guardar Capítulo",
      readChapter: "Capítulo",
      btnPrevChapter: "Anterior",
      btnNextChapter: "Siguiente",
      rateChapter: "Califica:",
      authorProfile: "Por",
      reportProfile: "Reportar Perfil",
      reportInstructions: "Selecciona un motivo o describe el problema:",
      btnSendReport: "Enviar Reporte",
      reportSuccess: "Reporte enviado con éxito. En breve recibirás una respuesta.",
      noInfraccion: "No se detectaron infracciones en este perfil.",
      followers: "Seguidores",
      following: "Siguiendo",
      ratings: "Calificaciones",
      languageModalTitle: "Selecciona tu idioma",
      editUsernamePrompt: "Introduce tu nuevo nombre de usuario:",
      usernameUpdated: "Nombre de usuario actualizado.",
      bioUpdated: "Biografía actualizada.",
      chapterAdded: "Capítulo agregado.",
      noEditingStory: "No hay historia en edición.",
      userNotAuthenticated: "Usuario no autenticado.",
      chapterNotFound: "Capítulo no encontrado.",
      firstChapter: "Este es el primer capítulo.",
      lastChapter: "Este es el último capítulo.",
      chapterRated: "Capítulo calificado con {value} estrella(s).",
      followSelfError: "No puedes seguirte a ti mismo.",
      nowFollowing: "Ahora sigues a este autor.",
      stoppedFollowing: "Has dejado de seguir a este autor.",
      alreadyFollowing: "Ya sigues a este usuario.",
      storyDeleted: "Historia eliminada.",
      editLater: "Puedes editar tu historia más tarde desde tu perfil."
    },
    en: {
      /* Traducciones en inglés */ },
    pt: {
      /* Traducciones en portugués */ }
  };

  function getVerificationIcon(email) {
    // Si el correo es uno de los que deben estar verificados,
    // se mostrará el icono nuevo.
    if (email === "darelvega6@icloud.com" || email === "glamworksappstv@gmail.com" || email === "linapaolaromero99@gmail.com") {
      return '<img src="https://static.vecteezy.com/system/resources/previews/028/084/106/original/verified-check-mark-icon-png.png" alt="Verificado" class="inline-block w-4 h-4 ml-1">';
    }
    return "";
  }

  function updateTranslations() {
    document.getElementById('app-name').innerText = translations[currentLanguage].appName;
    document.getElementById('tagline').innerText = translations[currentLanguage].tagline;
    document.getElementById('auth-title').innerText = translations[currentLanguage].authTitle;
    emailInput.placeholder = translations[currentLanguage].emailPlaceholder;
    passwordInput.placeholder = translations[currentLanguage].passwordPlaceholder;
    submitButton.innerText = translations[currentLanguage].btnIniciarSesion;
    toggleAuth.innerText = translations[currentLanguage].btnToggleAuth;
    document.getElementById('btn-volver-search').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('btn-volver-profile').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('btn-volver-author').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('new-releases-title').innerText = translations[currentLanguage].newReleases;
    document.getElementById('top10-title').innerText = translations[currentLanguage].top10;
    document.getElementById('popular-title').innerText = translations[currentLanguage].popular;
    document.getElementById('terror-title').innerText = translations[currentLanguage].terror;
    document.getElementById('search-input').placeholder = translations[currentLanguage].searchPlaceholder;
    document.getElementById('search-results-title').innerText = translations[currentLanguage].searchResults;
    document.getElementById('search-books-title').innerText = translations[currentLanguage].searchBooks;
    document.getElementById('search-authors-title').innerText = translations[currentLanguage].searchAuthors;
    document.getElementById('profile-stories-title').innerText = translations[currentLanguage].profileStories;
    document.getElementById('story-type-title').innerText = translations[currentLanguage].createStory;
    document.getElementById('create-story-title').innerText = translations[currentLanguage].createStory;
    document.getElementById('story-title').placeholder = translations[currentLanguage].storyTitlePlaceholder;
    document.getElementById('story-category').options[0].text = translations[currentLanguage].selectCategory;
    document.getElementById('btn-create-story').innerText = translations[currentLanguage].btnCreateStory;
    document.getElementById('edit-story-title').innerText = translations[currentLanguage].editStory;
    document.getElementById('chapter-creation-title').innerText = translations[currentLanguage].chapterCreationTitle;
    document.getElementById('chapter-content').placeholder = translations[currentLanguage].chapterPlaceholder;
    document.getElementById('btn-save-chapter').innerText = translations[currentLanguage].btnSaveChapter;
    document.getElementById('prev-chapter-btn').innerText = translations[currentLanguage].btnPrevChapter;
    document.getElementById('next-chapter-btn').innerText = translations[currentLanguage].btnNextChapter;
    document.getElementById('detail-synopsis').innerText = "Sinopsis de la historia...";
    document.getElementById('detail-metrics').innerHTML =
      `<span><strong>0</strong> Visitas</span>
         <span><strong>0</strong> ${translations[currentLanguage].ratings}</span>
         <span><strong>0</strong> Capítulos</span>`;
    document.getElementById('report-title').innerText = translations[currentLanguage].reportProfile;
    document.getElementById('report-instructions').innerText = translations[currentLanguage].reportInstructions;
    document.getElementById('btn-enviar-report').innerText = translations[currentLanguage].btnSendReport;
    document.getElementById('lang-modal-title').innerText = translations[currentLanguage].languageModalTitle;
  }

  function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem("selectedLanguage", lang);
    const langOverlay = document.getElementById('lang-loading-overlay');
    langOverlay.style.display = "flex";
    setTimeout(() => {
      updateTranslations();
      langOverlay.style.display = "none";
      document.getElementById('language-modal').style.display = "none";
    }, 1000);
  }
  window.addEventListener('load', () => {
    setTimeout(() => {
      const splash = document.getElementById('splash-screen');
      splash.style.opacity = '0';
      setTimeout(() => {
        splash.style.display = 'none';
      }, 1000);
    }, 3000);
  });
  /*********************** NOTIFICACIONES **************************/
  async function addNotification(userId, message, type = 'info') {
    const notificationsRef = firebase.database().ref('notifications/' + userId);
    const newNotificationRef = notificationsRef.push();
    newNotificationRef.set({
      message: message,
      timestamp: Date.now(),
      read: false,
      type: type,
      notificationId: newNotificationRef.key
    });
    
    // Play sound based on notification type
    const audio = new Audio();
    switch(type) {
      case 'follow':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/213/213.wav';
        break;
      case 'like':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/208/208.wav';
        break;
      case 'comment':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/221/221.wav';
        break;
      default:
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/206/206.wav';
    }
    audio.play().catch(e => console.log('Audio play failed:', e));
    
    // Handle notifications for both mobile and desktop
    if ('Notification' in window) {
      if (Notification.permission === "granted") {
        new Notification("BeaBoo", {
          body: message,
          icon: "https://cdn-icons-png.flaticon.com/512/907/907822.png",
          vibrate: [200, 100, 200]
        });
      } else if (Notification.permission !== "denied") {
        // Request permission on mobile
        try {
          const permission = await Notification.requestPermission();
          if (permission === "granted") {
            new Notification("BeaBoo", {
              body: message,
              icon: "https://cdn-icons-png.flaticon.com/512/907/907822.png",
              vibrate: [200, 100, 200]
            });
          }
        } catch (error) {
          console.log('Notification permission error:', error);
        }
      }
    }
    
    // Fallback vibration for mobile devices
    if (navigator.vibrate) {
      navigator.vibrate([200, 100, 200]);
    }
}

  function openNotifications() {
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    }
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;
    
    // Request notification permission if not granted
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    
    document.getElementById('notifications-modal').classList.remove('hidden');
    const notificationsRef = firebase.database().ref('notifications/' + currentUser.uid);
    notificationsRef.on('value', snapshot => {
      const notificationsList = document.getElementById('notifications-list');
      notificationsList.innerHTML = "";
      snapshot.forEach(child => {
        const notification = child.val();
        const div = document.createElement('div');
        div.className = `notification-item ${notification.type || 'info'}`;
        
        // Icon based on notification type
        const iconMap = {
          follow: 'user-plus',
          like: 'heart',
          comment: 'comment',
          info: 'info-circle'
        };
        
        div.innerHTML = `
          <div class="flex items-center gap-2">
            <i class="fas fa-${iconMap[notification.type || 'info']} ${notification.type}-icon"></i>
            <div class="flex-1">
              <div class="notification-message">${notification.message}</div>
              <div class="notification-time">${new Date(notification.timestamp).toLocaleString()}</div>
            </div>
            ${!notification.read ? '<span class="unread-dot"></span>' : ''}
          </div>
        `;
        
        // Mark as read when clicked
        div.onclick = () => {
          if (!notification.read) {
            firebase.database().ref('notifications/' + currentUser.uid + '/' + child.key).update({
              read: true
            });
          }
        };
        
        notificationsList.appendChild(div);
      });
    });
  }

  function closeNotifications() {
    document.getElementById('notifications-modal').classList.add('hidden');
  }
  /*********************** AUTENTICACIÓN **************************/
  toggleAuth.addEventListener('click', () => {
    isLogin = !isLogin;
    submitButton.textContent = isLogin ? translations[currentLanguage].btnIniciarSesion : 'Registrarse';
    toggleAuth.textContent = isLogin ? translations[currentLanguage].btnToggleAuth : '¿Ya tienes cuenta? Inicia sesión';
  });
  authForm.addEventListener('submit', e => {
    e.preventDefault();
    authError.classList.add('hidden');
    const email = emailInput.value;
    const password = passwordInput.value;
    if (isLogin) {
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Usuario autenticado:", userCredential.user);
        })
        .catch(error => {
          console.error(error);
          authError.textContent = error.message;
          authError.classList.remove('hidden');
        });
    } else {
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          const user = userCredential.user;
          const userCountRef = firebase.database().ref('userCount');
          userCountRef.transaction(count => (count || 0) + 1).then(result => {
            const newCount = result.snapshot.val();
            const isVerified = newCount <= 100;
            firebase.database().ref('users/' + user.uid).set({
              username: "Nuevo Usuario",
              bio: "",
              profileImage: "",
              followersCount: 0,
              followingCount: 0,
              ratedCount: 0,
              coins: 0,
              isVerified: isVerified,
              registrationTimestamp: Date.now(),
              founder: false,
              email: user.email
            });
          });
        })
        .catch(error => {
          console.error(error);
          authError.textContent = error.message;
          authError.classList.remove('hidden');
        });
    }
  });
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      if (authorizedEmails.includes(user.email)) {
        document.getElementById('live-transmit-btn').style.display = "block";
      } else {
        document.getElementById('live-transmit-btn').style.display = "none";
      }
      firebase.database().ref('users/' + user.uid + '/coins').on('value', snapshot => {
        document.getElementById('edit-coins').textContent = snapshot.val() || 0;
      });
      firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
        const data = snapshot.val();
        if (data && data.blocked && data.blockedUntil && Date.now() < data.blockedUntil) {
          alert("Tu cuenta ha sido bloqueada por infracciones. Por favor, contacta con el soporte para recuperar el acceso.");
          firebase.auth().signOut();
          return;
        }
        authFormContainer.classList.add('hidden');
        mainApp.classList.remove('hidden');
        loadStories();
        loadUserStories(user.uid);
        loadSuggestedStories();
        loadFeaturedAuthors();
        loadSuggestedStories();
        loadFeaturedAuthors();
        if (data) {
          let displayName = data.username;
          if (data.founder) {
            displayName += ' <span class="founder-tag">Fundador</span>';
          }
          displayName += getVerificationIcon(data.email);
          document.getElementById('profile-username').innerHTML = displayName;
          if (data.bio) {
            document.getElementById('profile-bio').value = data.bio;
          }
          if (data.profileImage) {
            document.getElementById('profile-image').src = data.profileImage;
          }
        }
      });
    } else {
      authFormContainer.classList.remove('hidden');
      mainApp.classList.add('hidden');
    }
  });
  /*********************** AUTENTICACIÓN CON GOOGLE Y FACEBOOK **************************/
  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(result => {
        console.log("Google sign-in successful:", result.user);
      })
      .catch(error => {
        console.error("Error al iniciar sesión con Google:", error);
      });
  }

  function signInWithFacebook() {
    const provider = new firebase.auth.FacebookAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(result => {
        console.log("Facebook sign-in successful:", result.user);
      })
      .catch(error => {
        console.error("Error al iniciar sesión con Facebook:", error);
      });
  }
  /*********************** CERRAR SESIÓN CON SPINNER **************************/
  function signOutUser() {
    const spinner = document.getElementById('signout-spinner');
    spinner.style.display = "flex";
    setTimeout(() => {
      firebase.auth().signOut()
        .then(() => {
          spinner.style.display = "none";
          alert("Has cerrado sesión.");
        })
        .catch(error => {
          spinner.style.display = "none";
          console.error("Error al cerrar sesión:", error);
        });
    }, 3000);
  }
  /*********************** OLVIDÉ MI CONTRASEÑA **************************/
  function resetPassword() {
    const email = emailInput.value;
    if (!email) {
      alert("Por favor, ingresa tu correo electrónico para restablecer la contraseña.");
      return;
    }
    firebase.auth().sendPasswordResetEmail(email)
      .then(() => {
        alert("Se ha enviado un correo para restablecer tu contraseña.");
      })
      .catch(error => {
        alert("Error al enviar el correo: " + error.message);
      });
  }
  /*********************** SOPORTE **************************/
  function openSupportModal() {
    const supportModal = document.getElementById('support-modal');
    supportModal.style.zIndex = 9999;
    supportModal.style.display = "block";
  }

  function closeSupportModal() {
    document.getElementById('support-modal').style.display = "none";
  }
  document.getElementById('support-form').addEventListener('submit', e => {
    e.preventDefault();
    const subject = document.getElementById('support-subject').value;
    const message = document.getElementById('support-message').value;
    const user = firebase.auth().currentUser;
    if (!user) return;
    const supportData = {
      userId: user.uid,
      subject,
      message,
      timestamp: Date.now(),
      status: "pending"
    };
    firebase.database().ref('supportRequests').push(supportData)
      .then(() => {
        alert("Tu solicitud ha sido enviada. Pronto recibirás una respuesta.");
        closeSupportModal();
      })
      .catch(error => {
        console.error("Error al enviar solicitud de soporte:", error);
      });
  });
  /*********************** NAVEGACIÓN Y MODALES **************************/
  function openStoryDetail(story) {
    const user = firebase.auth().currentUser;
    if (!user) return;
    window.currentStoryId = story.id;
    listenForStoryBlock(story.id);
    const viewRef = firebase.database().ref('storyViews/' + story.id + '/' + user.uid);
    viewRef.once('value').then(snapshot => {
      if (!snapshot.exists()) {
        viewRef.set(true);
        const storyViewsRef = firebase.database().ref('stories/' + story.id + '/views');
        storyViewsRef.transaction(current => (current || 0) + 1);
      }
    });
    document.getElementById('detail-cover').src = story.coverImage || '/api/placeholder/800/400';
    document.getElementById('detail-title').textContent = story.title;
    let authorDisplay = (story.username || "Autor Desconocido") + getVerificationIcon(story.email || "");
    document.getElementById('detail-author').innerHTML = translations[currentLanguage].authorProfile + " " + authorDisplay;
    document.getElementById('detail-author').dataset.userid = story.userId;
    document.getElementById('detail-author').onclick = () => openAuthorProfile(story.userId);
    document.getElementById('detail-synopsis').textContent = story.synopsis || "Sinopsis no disponible.";
    firebase.database().ref('stories/' + story.id + '/chapters').on('value', snapshot => {
      const chaptersList = document.getElementById('detail-chapters');
      chaptersList.innerHTML = "";
      currentChapters = [];
      let chapterCount = snapshot.numChildren();
      let totalRating = 0,
        ratingCount = 0;
      snapshot.forEach(child => {
        const chapter = child.val();
        chapter.id = child.key;
        currentChapters.push(chapter);
        const li = document.createElement('li');
        li.className = "p-4 border border-gray-200 rounded-xl hover:bg-gray-50 flex justify-between items-center";
        li.innerHTML = `<span>${translations[currentLanguage].readChapter} ${chapter.chapterNumber}</span>
                          <button class="bg-[#58CC02] text-white px-2 py-1 rounded" onclick='openChapterReadModal("${story.id}", "${child.key}")'>Leer</button>`;
        chaptersList.appendChild(li);
        if (chapter.ratings) {
          Object.values(chapter.ratings).forEach(r => {
            totalRating += r;
            ratingCount++;
          });
        }
      });
      currentChapters.sort((a, b) => a.chapterNumber - b.chapterNumber);
      currentEditingStory = {
        id: story.id,
        currentChapterId: currentChapters.length ? currentChapters[0].id : null
      };
      let overallRating = ratingCount ? (totalRating / ratingCount).toFixed(1) : 0;
      document.getElementById('detail-metrics').innerHTML =
        `<span><strong>${story.views || 0}</strong> Visitas</span>
           <span><strong>${overallRating}</strong> ${translations[currentLanguage].ratings}</span>
           <span><strong>${chapterCount}</strong> Capítulos</span>`;
    });
    document.getElementById('story-detail-modal').classList.remove('hidden');
    mainApp.classList.add('hidden');
  }

  function closeStoryDetail() {
    document.getElementById('story-detail-modal').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }

  function openStoryEdit(story) {
    currentEditingStory = story;
    document.getElementById('edit-story-language').value = story.language || "";
    firebase.database().ref('stories/' + story.id + '/chapters').on('value', snapshot => {
      currentChapters = [];
      const chapterListDiv = document.getElementById('chapter-list');
      chapterListDiv.innerHTML = "";
      snapshot.forEach(child => {
        const chapter = child.val();
        chapter.id = child.key;
        currentChapters.push(chapter);
      });
      currentChapters.sort((a, b) => a.chapterNumber - b.chapterNumber);
      currentChapters.forEach(chapter => {
        const div = document.createElement('div');
        div.className = "flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border border-gray-200 rounded-xl mb-2";
        const chapterInfo = document.createElement('div');
        chapterInfo.innerHTML = `<span class="font-semibold">${translations[currentLanguage].readChapter} ${chapter.chapterNumber}</span>`;
        const btnContainer = document.createElement('div');
        btnContainer.className = "flex space-x-2 mt-2 sm:mt-0";
        const editButton = document.createElement('button');
        editButton.className = "bg-blue-500 text-white px-2 py-1 rounded";
        editButton.textContent = "Editar";
        editButton.onclick = () => openChapterEditModal(chapter);
        const deleteButton = document.createElement('button');
        deleteButton.className = "bg-red-500 text-white px-2 py-1 rounded";
        deleteButton.textContent = "Eliminar";
        deleteButton.onclick = () => deleteChapter(chapter.id);
        btnContainer.appendChild(editButton);
        btnContainer.appendChild(deleteButton);
        div.appendChild(chapterInfo);
        div.appendChild(btnContainer);
        chapterListDiv.appendChild(div);
      });
    });
    document.getElementById('story-edit-view').classList.remove('hidden');
  }

  function closeStoryEdit() {
    document.getElementById('story-edit-view').classList.add('hidden');
    alert(translations[currentLanguage].editLater);
  }

  function saveStoryEdits() {
    if (!currentEditingStory) {
      alert(translations[currentLanguage].noEditingStory);
      return;
    }
    const newLanguage = document.getElementById('edit-story-language').value;
    firebase.database().ref('stories/' + currentEditingStory.id).update({
        language: newLanguage
      })
      .then(() => {
        currentEditingStory.language = newLanguage;
        alert("Cambios guardados en la historia.");
      })
      .catch(error => {
        console.error("Error al actualizar la historia:", error);
      });
  }

  function openProfile() {
    mainApp.classList.add('hidden');
    document.getElementById('profile-view').classList.remove('hidden');
  }

  function openHome() {
    document.getElementById('profile-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }

  function openSearch() {
    mainApp.classList.add('hidden');
    document.getElementById('search-view').classList.remove('hidden');
    document.getElementById('search-loading').style.display = "flex";
    setTimeout(() => {
      document.getElementById('search-loading').style.display = "none";
    }, 4000);
  }

  function closeSearch() {
    document.getElementById('search-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }
  function performRealTimeSearch() {
  const query = document.getElementById('search-input').value.trim().toLowerCase();
  const category = document.getElementById('category-filter').value;
  
  firebase.database().ref('stories').once('value').then(snapshot => {
    let books = [];
    snapshot.forEach(child => {
      const story = child.val();
      const matchesQuery = story.title && story.title.toLowerCase().includes(query);
      const matchesCategory = !category || story.category === category;
      
      if (matchesQuery && matchesCategory) {
        books.push(story);
      }
    });
    renderBooksCarousel(books);
  });

  if (query) {
    firebase.database().ref('users').once('value').then(snapshot => {
      let authors = [];
      snapshot.forEach(child => {
        const userData = child.val();
        if (userData.username && userData.username.toLowerCase().includes(query)) {
          userData.uid = child.key;
          authors.push(userData);
        }
      });
      renderAuthorsList(authors);
    });
  } else {
    document.getElementById('search-authors-list').innerHTML = '';
  }
}

document.getElementById('search-input').addEventListener('input', performRealTimeSearch);
document.getElementById('category-filter').addEventListener('change', performRealTimeSearch);
  async function performSearch(query) {
    await new Promise(resolve => setTimeout(resolve, 3000));
    const storiesSnapshot = await firebase.database().ref('stories').once('value');
    let books = [];
    storiesSnapshot.forEach(child => {
      const story = child.val();
      if (story.title && story.title.toLowerCase().includes(query)) books.push(story);
    });
    renderBooksCarousel(books);
    const usersSnapshot = await firebase.database().ref('users').once('value');
    let authors = [];
    usersSnapshot.forEach(child => {
      const userData = child.val();
      if (userData.username && userData.username.toLowerCase().includes(query)) {
        userData.uid = child.key;
        authors.push(userData);
      }
    });
    renderAuthorsList(authors);
  }

  function renderBooksCarousel(books) {
    const carousel = document.getElementById('search-books-carousel');
    carousel.innerHTML = '';
    books.forEach(book => {
      const card = document.createElement('div');
      card.className = 'flex-shrink-0 w-48 cursor-pointer';
      card.innerHTML = `
          <div class="rounded-2xl overflow-hidden shadow-md">
            <img src="${book.coverImage || '/api/placeholder/200/300'}" alt="${book.title}" class="w-full h-56 object-cover">
          </div>
          <p class="mt-2 text-sm font-semibold">${book.title}</p>
        `;
      card.addEventListener('click', () => openStoryDetail(book));
      carousel.appendChild(card);
    });
  }

  function renderAuthorsList(authors) {
    const list = document.getElementById('search-authors-list');
    list.innerHTML = '';
    authors.forEach(author => {
      const item = document.createElement('div');
      item.className = 'flex items-center space-x-4 cursor-pointer';
      let verifiedIcon = getVerificationIcon(author.email || "");
      item.innerHTML = `
          <img src="${author.profileImage || 'https://via.placeholder.com/50'}" alt="${author.username}" class="w-12 h-12 rounded-full object-cover">
          <span class="font-semibold">${author.username}${verifiedIcon}</span>
        `;
      item.addEventListener('click', () => openAuthorProfile(author.uid));
      list.appendChild(item);
    });
  }
  /*********************** PERFIL (Propio) **************************/
  function uploadProfileImage() {
    document.getElementById('profile-image-input').click();
  }

  function handleProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      // El resultado ya trae el prefijo 'data:image/jpeg;base64,...' o 'data:image/png;base64,...'
      const base64String = e.target.result;
      const user = firebase.auth().currentUser;
      if (!user) return;
      // Guardamos la imagen en base64 en la Realtime Database
      firebase.database().ref('users/' + user.uid).update({
          profileImage: base64String
        })
        .then(() => {
          document.getElementById('profile-image').src = base64String;
        })
        .catch(error => {
          console.error("Error al guardar la imagen en la base de datos:", error);
        });
    };
    reader.onerror = (error) => {
      console.error("Error al convertir la imagen a base64:", error);
    };
    // Convertimos el archivo a Data URL (base64)
    reader.readAsDataURL(file);
  }

  function editUsername() {
    openProfileEdit();
  }

  function saveBio() {
    const bio = document.getElementById('profile-bio').value;
    const user = firebase.auth().currentUser;
    firebase.database().ref('users/' + user.uid).update({
        bio
      })
      .then(() => {
        addNotification(user.uid, translations[currentLanguage].bioUpdated);
        alert(translations[currentLanguage].bioUpdated);
      })
      .catch(error => {
        console.error("Error al actualizar la biografía:", error);
      });
  }
  // Función para convertir un archivo a una cadena Base64
  function convertFileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve(e.target.result);
      };
      reader.onerror = (error) => {
        reject("Error al convertir la imagen: " + error);
      };
      reader.readAsDataURL(file);
    });
  }
  /*********************** MODAL DE EDICIÓN DE PERFIL **************************/
  function openProfileEdit() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const data = snapshot.val() || {};
      document.getElementById('edit-username').value = data.username || "";
      document.getElementById('edit-pronouns').value = data.pronouns || "";
      document.getElementById('edit-bio').value = data.bio || "";
      document.getElementById('edit-inkspired').value = data.inkspired || "";
      document.getElementById('edit-instagram').value = data.instagram || "";
      document.getElementById('edit-tiktok').value = data.tiktok || "";
      document.getElementById('edit-website').value = data.website || "";
      document.getElementById('edit-city').value = data.city || "";
      document.getElementById('edit-gender').value = data.gender || "";
      document.getElementById('edit-birthday').value = data.birthday || "";
      document.getElementById('edit-followers').textContent = (data.followersCount || 0);
      document.getElementById('edit-following').textContent = (data.followingCount || 0);
      firebase.database().ref('stories').orderByChild('userId').equalTo(user.uid).once('value').then(snapshot => {
        document.getElementById('edit-stories-count').textContent = snapshot.numChildren();
      });
      document.getElementById('edit-profile-image').src = data.profileImage || "https://via.placeholder.com/150";
      document.getElementById('edit-coins').textContent = data.coins || 0;
      document.getElementById('profile-edit-modal').style.display = "block";
    });
  }

  function closeProfileEdit() {
    document.getElementById('profile-edit-modal').style.display = "none";
  }

  function saveProfileEdits() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    const updates = {
      username: document.getElementById('edit-username').value,
      pronouns: document.getElementById('edit-pronouns').value,
      bio: document.getElementById('edit-bio').value,
      inkspired: document.getElementById('edit-inkspired').value,
      instagram: document.getElementById('edit-instagram').value,
      tiktok: document.getElementById('edit-tiktok').value,
      website: document.getElementById('edit-website').value,
      // Nuevos campos
      city: document.getElementById('edit-city').value,
      gender: document.getElementById('edit-gender').value,
      birthday: document.getElementById('edit-birthday').value
    };
    if (updates.username === "darheel_") {
      updates.followersCount = 19000;
      updates.founder = true;
      updates.isVerified = true;
    }
    firebase.database().ref('users/' + user.uid).update(updates)
      .then(() => {
        addNotification(user.uid, translations[currentLanguage].usernameUpdated);
        let newName = updates.username;
        if (updates.founder) {
          newName += ' <span class="founder-tag">Fundador</span>';
        }
        newName += getVerificationIcon(updates.email || user.email);
        document.getElementById('profile-username').innerHTML = newName;
        alert("Perfil actualizado");
        closeProfileEdit();
      })
      .catch(error => {
        console.error("Error al guardar cambios en el perfil:", error);
      });
  }

  function uploadEditProfileImage() {
    document.getElementById('edit-profile-image-input').click();
  }

  function handleEditProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const user = firebase.auth().currentUser;
    if (!user) return;
    const storageRef = firebase.storage().ref();
    const imageRef = storageRef.child('profileImages/' + user.uid + '/' + file.name);
    const uploadTask = imageRef.put(file);
    uploadTask.on('state_changed', null, error => {
      console.error("Error al subir la imagen (edición):", error);
    }, () => {
      uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
        firebase.database().ref('users/' + user.uid).update({
          profileImage: downloadURL
        });
        document.getElementById('edit-profile-image').src = downloadURL;
      });
    });
  }
  /*********************** PERFIL DEL AUTOR **************************/
  function openAuthorProfile(authorId) {
    document.getElementById('story-detail-modal').classList.add('hidden');
    
    // Check if current user is the profile owner
    const currentUser = firebase.auth().currentUser;
    const addNoteBtn = document.getElementById('add-note-btn');
    const profileNote = document.getElementById('profile-note');
    
    if (currentUser && currentUser.uid === authorId) {
      addNoteBtn.classList.remove('hidden');
    } else {
      addNoteBtn.classList.add('hidden');
    }

    // Check for existing note
    firebase.database().ref('profileNotes/' + authorId).once('value').then(snapshot => {
      const noteData = snapshot.val();
      if (noteData && noteData.text && noteData.timestamp) {
        const expirationTime = noteData.timestamp + (12 * 60 * 60 * 1000); // 12 hours
        if (Date.now() < expirationTime) {
          profileNote.classList.remove('hidden');
          document.getElementById('note-text').textContent = noteData.text;
          const timeLeft = Math.floor((expirationTime - Date.now()) / (60 * 60 * 1000));
          document.getElementById('note-time').textContent = `Expira en ${timeLeft} horas`;
        } else {
          profileNote.classList.add('hidden');
          snapshot.ref.remove(); // Remove expired note
        }
      } else {
        profileNote.classList.add('hidden');
      }
    });
    firebase.database().ref('users/' + authorId).once('value').then(snapshot => {
      const authorData = snapshot.val();
      if (!authorData || (authorData.blocked && authorData.blockedUntil && Date.now() < authorData.blockedUntil)) {
        document.getElementById('blocked-error-modal').style.display = "flex";
        return;
      }
      let authorNameHTML = authorData.username || 'Autor desconocido';
      if (authorData.founder) {
        authorNameHTML += ' <span class="founder-tag">Fundador</span>';
      }
      authorNameHTML += getVerificationIcon(authorData.email || "");
      document.getElementById('author-profile-name').innerHTML = authorNameHTML;
      document.getElementById('author-profile-image').src = authorData.profileImage || 'https://via.placeholder.com/150';
      document.getElementById('author-followers').textContent = formatFollowers(authorData.followersCount || 0);
      document.getElementById('author-following').textContent = formatFollowers(authorData.followingCount || 0);
      document.getElementById('author-rated').textContent = authorData.ratedCount || 0;
      let socialLinksHTML = "";
      if (authorData.instagram) {
        socialLinksHTML += `<a href="${authorData.instagram}" target="_blank"><img src="https://img.utdstc.com/icon/847/f33/847f33af27bea889ccaa9b1d25135b42ff5bb590297182d0983afb7304d96884:200" alt="Instagram" class="w-6 h-6"></a>`;
      }
      if (authorData.tiktok) {
        socialLinksHTML += `<a href="${authorData.tiktok}" target="_blank"><img src="https://cdn.pixabay.com/photo/2021/06/15/12/28/tiktok-6338432_1280.png" alt="TikTok" class="w-6 h-6"></a>`;
      }
      if (authorData.inkspired) {
        socialLinksHTML += `<a href="${authorData.inkspired}" target="_blank"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTmCCZ41lZmMTQKuO2yydE3lFF0PGbgnLZoXA&s=10" alt="Inkspired" class="w-6 h-6"></a>`;
      }
      if (authorData.website) {
        socialLinksHTML += `<a href="${authorData.website}" target="_blank"><i class="fa-solid fa-globe text-2xl"></i></a>`;
      }
      document.getElementById('author-social-links').innerHTML = socialLinksHTML;
      firebase.database().ref(`liveStreams/${authorId}/isLive`).once('value').then(snapshot => {
        if (snapshot.exists() && snapshot.val()) {
          let liveLabel = document.getElementById('live-label');
          if (!liveLabel) {
            liveLabel = document.createElement('span');
            liveLabel.id = "live-label";
            // Cambiamos el texto a "DIRECTO" y el fondo a verde
            liveLabel.textContent = "DIRECTO";
            liveLabel.className = "absolute top-0 left-0 bg-green-600 text-white px-2 py-1 rounded text-xs";
            const container = document.getElementById('author-profile-img-container');
            container.style.position = "relative";
            container.appendChild(liveLabel);
          }
          // Agregamos una clase para un borde pulsante de color verde (estilo Duolingo)
          document.getElementById('author-profile-image').classList.add('live-border');
        } else {
          let liveLabel = document.getElementById('live-label');
          if (liveLabel) {
            liveLabel.remove();
          }
          document.getElementById('author-profile-image').classList.remove('live-border');
        }
      });
    });
    currentViewedAuthorId = authorId;
    document.getElementById('author-profile-modal').style.display = "block";
    updateFollowIcon();
    loadAuthorStories(authorId);
    document.getElementById('author-profile-image').onclick = function() {
      firebase.database().ref(`liveStreams/${authorId}/isLive`).once('value').then(snapshot => {
        if (snapshot.exists() && snapshot.val()) {
          openLiveViewModal(authorId);
        }
      });
    };
  }

  function closeAuthorProfile() {
    document.getElementById('author-profile-modal').style.display = "none";
    if (document.getElementById('search-view').classList.contains('hidden')) {
      document.getElementById('story-detail-modal').classList.remove('hidden');
    }
  }

  function closeBlockedErrorModal() {
    document.getElementById('blocked-error-modal').style.display = "none";
    document.getElementById('story-detail-modal').classList.remove('hidden');
  }
  /*********************** FUNCIONES PARA SEGUIR **************************/
  function updateFollowIcon() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    const followRef = firebase.database().ref('followers/' + currentViewedAuthorId + '/' + currentUser.uid);
    followRef.once('value').then(snapshot => {
      const followIcon = document.getElementById('follow-icon');
      followIcon.src = snapshot.exists() ?
        "https://cdn-icons-png.flaticon.com/512/907/907822.png" :
        "https://cdn-icons-png.freepik.com/512/8370/8370007.png";
    });
  }

  function followAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    if (currentUser.uid === currentViewedAuthorId) {
      alert(translations[currentLanguage].followSelfError);
      return;
    }

    const followRef = firebase.database().ref('followers/' + currentViewedAuthorId + '/' + currentUser.uid);
    const followButton = document.getElementById('follow-button');
    const authorFollowersRef = firebase.database().ref('users/' + currentViewedAuthorId + '/followersCount');
    const currentFollowersElement = document.getElementById('author-followers');

    // Escuchar cambios en tiempo real del contador de seguidores
    authorFollowersRef.on('value', (snapshot) => {
      const followersCount = snapshot.val() || 0;
      currentFollowersElement.textContent = formatFollowers(followersCount);
    });

    followRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Dejar de seguir
        followRef.remove().then(() => {
          authorFollowersRef.transaction(current => {
            return (current || 1) - 1;
          });
          
          followButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>`;
        });
      } else {
        // Comenzar a seguir
        followRef.set({
          followedAt: Date.now()
        }).then(() => {
          authorFollowersRef.transaction(current => {
            return (current || 0) + 1;
          });

          firebase.database().ref('users/' + currentUser.uid).once('value').then(userSnap => {
            const followerName = userSnap.val().username;
            addNotification(currentViewedAuthorId, `${followerName} te ha seguido`);
          });

          followButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>`;
        });
      }
    });
  }

  // Función auxiliar para formatear números grandes
  function formatFollowers(count) {
    if (count >= 1000000) {
      return (count / 1000000).toFixed(1) + 'M';
    } else if (count >= 1000) {
      return (count / 1000).toFixed(1) + 'K';
    }
    return count.toString();
  }

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }

  function followUser(userId) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;
    if (currentUser.uid === userId) {
      alert(translations[currentLanguage].followSelfError);
      return;
    }
    const followRef = firebase.database().ref('followers/' + userId + '/' + currentUser.uid);
    followRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        alert(translations[currentLanguage].alreadyFollowing);
      } else {
        followRef.set({
            followedAt: Date.now()
          })
          .then(() => {
            const userFollowersCountRef = firebase.database().ref('users/' + userId + '/followersCount');
            userFollowersCountRef.transaction(current => (current || 0) + 1);
            firebase.database().ref('users/' + currentUser.uid).once('value').then(userSnap => {
              const followerName = userSnap.val().username;
              addNotification(userId, `${followerName} te ha seguido`);
            });
            alert(translations[currentLanguage].nowFollowing);
          });
      }
    });
  }

  function openFollowingModal() {
    const currentUser = firebase.auth().currentUser;
    if (!currentViewedAuthorId) return;
    if (currentUser.uid !== currentViewedAuthorId) {
      alert("La lista de usuarios que sigue este autor es privada.");
      return;
    }
    firebase.database().ref('following/' + currentViewedAuthorId).once('value').then(snapshot => {
      const followingListDiv = document.getElementById('following-list');
      followingListDiv.innerHTML = '';
      snapshot.forEach(child => {
        const followingUserId = child.key;
        firebase.database().ref('users/' + followingUserId).once('value').then(userSnap => {
          const userData = userSnap.val();
          const followingDiv = document.createElement('div');
          followingDiv.className = 'flex items-center space-x-4';
          let verifiedIcon = getVerificationIcon(userData.email || "");
          followingDiv.innerHTML = `
                    <img src="${userData.profileImage || 'https://via.placeholder.com/50'}" alt="${userData.username}" class="w-12 h-12 rounded-full object-cover">
                    <span class="font-semibold">${userData.username || 'Usuario'}${verifiedIcon}</span>
                    <button onclick="followUser('${followingUserId}')" class="bg-[#58CC02] text-white p-1 rounded-full">
                      <i class="fa-solid fa-user-plus"></i>
                    </button>
                  `;
          followingListDiv.appendChild(followingDiv);
        });
      });
      document.getElementById('following-modal').style.display = "block";
    });
  }

  function closeFollowingModal() {
    document.getElementById('following-modal').style.display = "none";
  }
  /*********************** REPORTES **************************/
  document.getElementById('report-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const user = firebase.auth().currentUser;
    if (!user || !currentViewedAuthorId) return;
    if (user.uid === currentViewedAuthorId) {
      alert("No puedes reportarte a ti mismo.");
      return;
    }
    const reason = document.getElementById('report-reason').value;
    const description = document.getElementById('report-description').value;
    // Guardar el reporte de inmediato en la base de datos
    const reporterName = user.displayName || user.email || "Usuario";
    const reportData = {
      reporter: user.uid,
      reporterName: reporterName,
      reportedUser: currentViewedAuthorId,
      reportedName: "", // lo obtendremos luego
      reason: reason,
      description: description,
      timestamp: Date.now(),
      status: "pending"
    };
    firebase.database().ref('reports').push(reportData)
      .catch(error => {
        console.error("Error al enviar el reporte:", error);
      });
    // Se obtiene la información del perfil denunciado
    firebase.database().ref('users/' + currentViewedAuthorId).once('value').then(authorSnap => {
      if (!authorSnap.exists()) {
        alert("El perfil reportado no existe.");
        return;
      }
      const reportedData = authorSnap.val();
      const reportedUsername = reportedData.username || "";
      // Guardamos el nombre denunciado en el reporte (opcional)
      reportData.reportedName = reportedUsername;
      // Simular un tiempo de verificación de 16 segundos
      setTimeout(() => {
        // Se realizan las comprobaciones (puedes agregar otros criterios si lo deseas)
        if (contienePalabrasOfensivas(reportedUsername)) {
          // Si se detecta lenguaje ofensivo: actualizar el perfil denunciado para bloquearlo
          firebase.database().ref('users/' + currentViewedAuthorId).update({
            blocked: true,
            // Bloqueo por 24 horas (ajusta este tiempo según tus políticas)
            blockedUntil: Date.now() + (24 * 60 * 60 * 1000)
          }).then(() => {
            // Notificación al perfil denunciado indicando el bloqueo
            firebase.database().ref('notifications/' + currentViewedAuthorId).push({
              message: "Hemos detectado que tu perfil contiene lenguaje ofensivo. Tu cuenta ha sido bloqueada temporalmente hasta que un administrador la revise.",
              timestamp: Date.now(),
              read: false
            });
          });
          // Notificar al denunciante
          addNotification(user.uid, "Hemos revisado el perfil que has reportado y se han detectado infracciones. El perfil denunciado ha sido bloqueado hasta su revisión.");
          // Mostrar un mensaje en un modal de respuesta
          document.getElementById('admin-response-modal').innerHTML = `
          <div class="p-6 text-center">
            <h2 class="text-2xl font-bold mb-4">Reporte Procesado</h2>
            <p>Hemos revisado el perfil que has reportado. Se han detectado infracciones por lenguaje ofensivo y el perfil ha sido bloqueado hasta que un administrador lo revise.</p>
            <button onclick="closeAdminResponseModal()" class="bg-[#58CC02] text-white px-4 py-2 rounded mt-4">Cerrar</button>
          </div>`;
        } else {
          // Si no se detecta ninguna infracción en el nombre
          addNotification(user.uid, "Hemos revisado el perfil que has reportado y no hemos encontrado ningún problema.");
          document.getElementById('admin-response-modal').innerHTML = `
          <div class="p-6 text-center">
            <h2 class="text-2xl font-bold mb-4">Reporte Procesado</h2>
            <p>Hemos revisado el perfil que has reportado y no se han encontrado infracciones.</p>
            <button onclick="closeAdminResponseModal()" class="bg-[#58CC02] text-white px-4 py-2 rounded mt-4">Cerrar</button>
          </div>`;
        }
        document.getElementById('admin-response-modal').style.display = "none";
      }, 16000); // 16 segundos de retardo para procesar
    });
  });
  /*********************** CREACIÓN DE HISTORIAS **************************/
  document.getElementById('story-form').addEventListener('submit', function(e) {
    e.preventDefault();
    document.getElementById('story-upload-spinner').style.display = "flex";
    const title = document.getElementById('story-title').value;
    const category = document.getElementById('story-category').value;
    const synopsis = document.getElementById('story-synopsis').value || "";
    const language = document.getElementById('story-language').value;
    const rating = document.getElementById('story-rating').value;
    const coverInput = document.getElementById('story-cover');
    const user = firebase.auth().currentUser;
    if (!user) {
      alert(translations[currentLanguage].userNotAuthenticated);
      document.getElementById('story-upload-spinner').style.display = "none";
      return;
    }
    let newStory = {
      userId: user.uid,
      title,
      category,
      synopsis,
      language,
      type: storyTypeSelected,
      coverImage: "",
      createdAt: Date.now(),
      isPrivate: false,
      views: 0,
      rating: rating,
      email: user.email
    };
    if (storyTypeSelected === 'cuento') {
      newStory.content = document.getElementById('cuento-content') ? document.getElementById('cuento-content').value : "";
    }

    function saveStory(coverURL = "") {
      newStory.coverImage = coverURL;
      firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
        const userData = snapshot.val();
        newStory.username = userData && userData.username ? userData.username : "Autor Desconocido";
        newStory.email = userData.email || user.email;
        const storyRef = firebase.database().ref('stories').push();
        newStory.id = storyRef.key;
        storyRef.set(newStory)
          .then(() => {
            document.getElementById('story-upload-spinner').style.display = "none";
            setTimeout(() => {
              document.getElementById('story-details-view').classList.add('hidden');
              openStoryEdit(newStory);
            }, 3000);
          })
          .catch(error => {
            console.error("Error al guardar la historia:", error);
            document.getElementById('story-upload-spinner').style.display = "none";
          });
      });
    }
    if (coverInput.files.length > 0) {
      const file = coverInput.files[0];
      validateCoverImage(file)
        .then(() => {
          return convertFileToBase64(file);
        })
        .then((base64Image) => {
          saveStory(base64Image);
        })
        .catch(errMsg => {
          alert(errMsg);
          document.getElementById('story-upload-spinner').style.display = "none";
        });
    } else {
      saveStory();
    }
  });

  function openStoryCreation() {
    document.getElementById('story-creation-view').classList.remove('hidden');
    document.getElementById('story-details-view').classList.add('hidden');
    document.getElementById('story-edit-view').classList.add('hidden');
  }

  function closeStoryCreation() {
    document.getElementById('story-creation-view').classList.add('hidden');
  }

  function backToStoryType() {
    document.getElementById('story-details-view').classList.add('hidden');
    document.getElementById('story-creation-view').classList.remove('hidden');
  }

  function validateCoverImage(file) {
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = function() {
        const ratio = img.naturalWidth / img.naturalHeight;
        if (ratio > 3 || ratio < 0.3) {
          URL.revokeObjectURL(url);
          reject("La imagen de portada tiene un formato no permitido (posible screenshot).");
        } else {
          URL.revokeObjectURL(url);
          resolve();
        }
      };
      img.onerror = function() {
        URL.revokeObjectURL(url);
        reject("Error al cargar la imagen.");
      };
      img.src = url;
    });
  }
  /*********************** CAPÍTULOS **************************/
  function openChapterCreationModal() {
    currentChapterEditId = null;
    document.getElementById('chapter-form').reset();
    document.getElementById('word-count').innerText = "0 palabras";
    document.getElementById('letter-count').innerText = "0 letras";
    document.getElementById('font-size').value = 16;
    document.getElementById('font-size-value').innerText = "16px";
    document.getElementById('chapter-content').style.fontSize = "16px";
    document.getElementById('chapter-content').style.fontFamily = "Arial";
    document.getElementById('btn-save-chapter').textContent = translations[currentLanguage].btnSaveChapter;
    document.getElementById('chapter-creation-modal').style.display = "flex";
  }

  function closeChapterCreationModal() {
    document.getElementById('chapter-creation-modal').style.display = "none";
    document.getElementById('chapter-form').reset();
    document.getElementById('word-count').innerText = "0 palabras";
    document.getElementById('letter-count').innerText = "0 letras";
    document.getElementById('font-size').value = 16;
    document.getElementById('font-size-value').innerText = "16px";
    document.getElementById('chapter-content').style.fontSize = "16px";
    document.getElementById('chapter-content').style.fontFamily = "Arial";
    document.getElementById('chapter-schedule').value = "";
    currentChapterEditId = null;
    document.getElementById('btn-save-chapter').textContent = translations[currentLanguage].btnSaveChapter;
  }
  document.getElementById('chapter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('chapter-content').value;
    const scheduledDate = document.getElementById('chapter-schedule').value;
    
    if (!currentEditingStory) {
      alert(translations[currentLanguage].noEditingStory);
      return;
    }
    
    const user = firebase.auth().currentUser;
    if (!user) {
      alert(translations[currentLanguage].userNotAuthenticated);
      return;
    }

    if (currentChapterEditId) {
      const chapterRef = firebase.database().ref('stories/' + currentEditingStory.id + '/chapters/' + currentChapterEditId);
      chapterRef.update({
          content: content
        })
        .then(() => {
          closeChapterCreationModal();
          alert("Capítulo actualizado correctamente.");
        })
        .catch(error => {
          console.error("Error al actualizar capítulo:", error);
        });
    } else {
      const chapterNumber = currentChapters.length + 1;
      const newChapter = {
        chapterNumber,
        content,
        createdAt: Date.now(),
        status: scheduledDate ? 'scheduled' : 'published'
      };

      const chapterRef = firebase.database().ref('stories/' + currentEditingStory.id + '/chapters').push();
      newChapter.id = chapterRef.key;
      
      if (scheduledDate) {
        // Guardar en capítulos programados
        firebase.database().ref('scheduledChapters/' + chapterRef.key).set({
          storyId: currentEditingStory.id,
          publishDate: new Date(scheduledDate).getTime(),
          status: 'pending'
        });
        
        // Guardar el capítulo con estado programado
        chapterRef.set(newChapter)
          .then(() => {
            closeChapterCreationModal();
            alert("Capítulo programado para publicación el " + new Date(scheduledDate).toLocaleDateString());
          })
          .catch(error => {
            console.error("Error al programar capítulo:", error);
          });
      } else {
        // Publicación inmediata
        chapterRef.set(newChapter)
          .then(() => {
            closeChapterCreationModal();
            alert(translations[currentLanguage].chapterAdded);
          })
          .catch(error => {
            console.error("Error al agregar capítulo:", error);
          });
      }
    }
  });

  function openChapterEditModal(chapter) {
    currentChapterEditId = chapter.id;
    document.getElementById('chapter-content').value = chapter.content;
    document.getElementById('btn-save-chapter').textContent = "Guardar Cambios";
    document.getElementById('chapter-creation-modal').style.display = "flex";
  }

  function deleteChapter(chapterId) {
    if (confirm("¿Estás seguro de eliminar este capítulo?")) {
      firebase.database().ref('stories/' + currentEditingStory.id + '/chapters/' + chapterId).remove()
        .then(() => {
          alert("Capítulo eliminado correctamente.");
        })
        .catch(error => {
          console.error("Error al eliminar capítulo:", error);
        });
    }
  }

  function openChapterReadModal(storyId, chapterId) {
    const storyDetailModal = document.getElementById('story-detail-modal');
    if (!storyDetailModal.classList.contains('hidden')) {
      storyDetailModal.classList.add('hidden');
    }
    firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId).once('value').then(snapshot => {
      const chapter = snapshot.val();
      if (chapter) {
        document.getElementById('read-chapter-number').textContent = translations[currentLanguage].readChapter + " " + chapter.chapterNumber;
        document.getElementById('read-chapter-text').innerHTML = chapter.content.replace(/\n/g, '<br>');
        setupStarRating(storyId, chapterId);
        if (!currentEditingStory) {
          currentEditingStory = {
            id: storyId,
            currentChapterId: chapterId
          };
        } else {
          currentEditingStory.currentChapterId = chapterId;
        }
        const user = firebase.auth().currentUser;
        if (user) {
          const chapterViewRef = firebase.database().ref('chapterViews/' + chapterId + '/' + user.uid);
          chapterViewRef.once('value').then(viewSnap => {
            if (!viewSnap.exists()) {
              chapterViewRef.set(true);
              const chapterViewsRef = firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId + '/views');
              chapterViewsRef.transaction(current => (current || 0) + 1);
            }
          });
        }
        document.getElementById('chapter-read-modal').classList.remove('hidden');
      } else {
        alert(translations[currentLanguage].chapterNotFound);
      }
    });
  }

  function closeChapterReadModal() {
    document.getElementById('chapter-read-modal').classList.add('hidden');
    document.getElementById('story-detail-modal').classList.remove('hidden');
  }

  function prevChapter() {
    if (!currentEditingStory || !currentEditingStory.currentChapterId) return;
    const index = currentChapters.findIndex(ch => ch.id === currentEditingStory.currentChapterId);
    if (index > 0) {
      openChapterReadModal(currentEditingStory.id, currentChapters[index - 1].id);
    } else {
      alert(translations[currentLanguage].firstChapter);
    }
  }

  function nextChapter() {
    if (!currentEditingStory || !currentEditingStory.currentChapterId) return;
    const index = currentChapters.findIndex(ch => ch.id === currentEditingStory.currentChapterId);
    if (index < currentChapters.length - 1) {
      openChapterReadModal(currentEditingStory.id, currentChapters[index + 1].id);
    } else {
      alert(translations[currentLanguage].lastChapter);
    }
  }

  function setupStarRating(storyId, chapterId) {
    const stars = document.querySelectorAll("#star-rating .star");
    stars.forEach(star => {
      star.classList.remove("selected");
    });
    const user = firebase.auth().currentUser;
    if (!user) return;
    const ratingRef = firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId + '/ratings/' + user.uid);
    ratingRef.once('value').then(snapshot => {
      const rating = snapshot.val();
      if (rating) {
        stars.forEach(star => {
          if (parseInt(star.getAttribute('data-value')) <= rating) {
            star.classList.add("selected");
          }
        });
      }
    });
    stars.forEach(star => {
      star.onclick = function() {
        const value = parseInt(this.getAttribute('data-value'));
        ratingRef.set(value)
          .then(() => {
            stars.forEach(s => {
              if (parseInt(s.getAttribute('data-value')) <= value) {
                s.classList.add("selected");
              } else {
                s.classList.remove("selected");
              }
            });
            alert(translations[currentLanguage].chapterRated.replace("{value}", value));
          })
          .catch(error => {
            console.error("Error al guardar calificación:", error);
          });
      };
    });
  }
  /*********************** EFECTO SKELETON **************************/
  function applySkeletonEffect() {
    document.getElementById('profile-image').classList.add('skeleton');
    document.getElementById('profile-username').classList.add('skeleton');
    document.getElementById('profile-bio').classList.add('skeleton');
    const userStories = document.getElementById('user-stories');
    if (userStories) {
      userStories.classList.add('skeleton');
    }
  }

  function removeSkeletonEffect() {
    document.getElementById('profile-image').classList.remove('skeleton');
    document.getElementById('profile-username').classList.remove('skeleton');
    document.getElementById('profile-bio').classList.remove('skeleton');
    const userStories = document.getElementById('user-stories');
    if (userStories) {
      userStories.classList.remove('skeleton');
    }
  }
  if (!navigator.onLine) {
    applySkeletonEffect();
  }
  window.addEventListener('offline', applySkeletonEffect);
  window.addEventListener('online', removeSkeletonEffect);
  /*********************** CARGA DE HISTORIAS **************************/
  function loadStories() {
    firebase.database().ref('stories').on('value', snapshot => {
      let stories = [];
      snapshot.forEach(child => {
        stories.push(child.val());
      });
      let newReleases = stories.sort((a, b) => b.createdAt - a.createdAt);
      renderStories(newReleases, 'new-releases', false);
      let top10 = stories.sort((a, b) => b.views - a.views).slice(0, 10);
      renderStories(top10, 'top10', false);
      let popular = stories.sort((a, b) => b.views - a.views);
      renderStories(popular, 'popular', false);
      let terrorStories = stories.filter(story => story.category === 'terror');
      renderStories(terrorStories, 'terror-stories', false);
    });
  }

  function renderStories(stories, elementId, editMode) {
    const container = document.getElementById(elementId);
    container.innerHTML = '';
    stories.forEach(story => {
      if (story.blocked) return;
      const storyCard = document.createElement('div');
      storyCard.className = 'story-card cursor-pointer relative';
      storyCard.onclick = editMode ? () => openStoryEdit(story) : () => openStoryDetail(story);
      storyCard.innerHTML = `
          <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
            <div class="story-cover-container">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="story-cover-image">
            </div>
          </div>
          <div class="mt-2">
            <h3 class="font-semibold text-sm">${story.title}</h3>
          </div>
        `;
      const languageDiv = document.createElement('div');
      languageDiv.className = "mt-1 flex items-center space-x-2";
      languageDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
      if (story.rating === "18plus") {
        languageDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
      }
      storyCard.appendChild(languageDiv);
      container.appendChild(storyCard);
    });
  }
  /*********************** CARGA DE HISTORIAS DEL USUARIO **************************/
  function loadUserStories(userId) {
    const userStoriesRef = firebase.database().ref('stories').orderByChild('userId').equalTo(userId);
    userStoriesRef.on('value', snapshot => {
      const container = document.getElementById('user-stories');
      container.innerHTML = "";
      snapshot.forEach(child => {
        const story = child.val();
        if (story.blocked) return;
        const card = document.createElement('div');
        card.className = "cursor-pointer";
        card.onclick = () => openStoryEdit(story);
        card.innerHTML = `
            <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="w-full h-40 object-cover">
            </div>
            <div class="mt-2">
              <h3 class="font-semibold text-sm">${story.title}</h3>
            </div>
          `;
        const langDiv = document.createElement('div');
        langDiv.className = "mt-1 flex items-center space-x-2";
        langDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
        if (story.rating === "18plus") {
          langDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
        }
        card.appendChild(langDiv);
        container.appendChild(card);
      });
    });
  }
  /*********************** NUEVAS FUNCIONES: SUGERENCIAS Y AUTORES DESTACADOS **************************/
  function loadSuggestedStories() {
    firebase.database().ref('stories').once('value').then(snapshot => {
      let stories = [];
      snapshot.forEach(child => {
        let story = child.val();
        story.id = child.key;
        stories.push(story);
      });
      stories.sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0));
      let suggested = stories.slice(0, 10);
      const container = document.getElementById('suggested-stories');
      container.innerHTML = '';
      suggested.forEach(story => {
        const card = document.createElement('div');
        card.className = 'story-card cursor-pointer';
        card.onclick = () => openStoryDetail(story);
        card.innerHTML = `
              <div class="rounded-2xl overflow-hidden shadow-md">
                <div class="story-cover-container">
                  <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="story-cover-image">
                </div>
              </div>
              <div class="mt-2">
                <h3 class="font-semibold text-sm">${story.title}</h3>
              </div>
            `;
        container.appendChild(card);
      });
    });
  }

  function loadFeaturedAuthors() {
    firebase.database().ref('stories').once('value').then(snapshot => {
      let authorCounts = {};
      snapshot.forEach(child => {
        let story = child.val();
        if (story && story.userId) {
          if (!authorCounts[story.userId]) authorCounts[story.userId] = 0;
          authorCounts[story.userId]++;
        }
      });
      let authorsArray = [];
      for (let uid in authorCounts) {
        authorsArray.push({
          uid: uid,
          count: authorCounts[uid]
        });
      }
      authorsArray.sort((a, b) => b.count - a.count);
      let topAuthors = authorsArray.slice(0, 10);
      const container = document.getElementById('featured-authors');
      container.innerHTML = '';
      topAuthors.forEach(author => {
        firebase.database().ref('users/' + author.uid).once('value').then(userSnap => {
          const userData = userSnap.val();
          const card = document.createElement('div');
          card.className = 'story-card cursor-pointer';
          card.onclick = () => openAuthorProfile(author.uid);
          card.innerHTML = `
                <div class="rounded-2xl overflow-hidden shadow-md">
                  <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" alt="${userData.username}" class="w-full h-40 object-cover">
                </div>
                <div class="mt-2">
                  <h3 class="font-semibold text-sm">${userData.username}</h3>
                </div>
              `;
          container.appendChild(card);
        });
      });
    });
  }
  /*********************** CARGA DE HISTORIAS DEL AUTOR **************************/
  function loadAuthorStories(authorId) {
    const authorStoriesRef = firebase.database().ref('stories').orderByChild('userId').equalTo(authorId);
    authorStoriesRef.on('value', snapshot => {
      const container = document.getElementById('author-stories');
      container.innerHTML = "";
      snapshot.forEach(child => {
        const story = child.val();
        if (story.blocked) return;
        const card = document.createElement('div');
        card.className = "cursor-pointer";
        card.onclick = () => openStoryDetail(story);
        card.innerHTML = `
            <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="w-full h-40 object-cover">
            </div>
            <div class="mt-2">
              <h3 class="font-semibold text-sm">${story.title}</h3>
            </div>
          `;
        const langDiv = document.createElement('div');
        langDiv.className = "mt-1 flex items-center space-x-2";
        langDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
        if (story.rating === "18plus") {
          langDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
        }
        card.appendChild(langDiv);
        container.appendChild(card);
      });
    });
  }
  /*********************** NUEVAS FUNCIONES: DESCARGAR HISTORIA COMPLETA PARA LECTURA OFFLINE **************************/
  function downloadStory() {
    if (!window.currentStoryId) {
      alert("No se ha seleccionado una historia.");
      return;
    }
    const storyId = window.currentStoryId;
    const btn = document.getElementById('download-story-btn');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    firebase.database().ref('stories/' + storyId).once('value')
      .then(storySnap => {
        const storyData = storySnap.val();
        if (!storyData) {
          throw new Error("Historia no encontrada");
        }
        return firebase.database().ref('stories/' + storyId + '/chapters').once('value')
          .then(chaptersSnap => {
            let chaptersHTML = '';
            chaptersSnap.forEach(child => {
              const chapter = child.val();
              chapter.id = child.key;
              // Se crea un bloque para cada capítulo con título y contenido completo
              chaptersHTML += `<div class="chapter" style="margin-bottom:20px;">
                  <h3 style="margin-bottom:10px;">Capítulo ${chapter.chapterNumber}</h3>
                  <p style="text-align:justify; white-space: pre-wrap;">${chapter.content}</p>
                </div>`;
            });
            storyData.chaptersHTML = chaptersHTML;
            return storyData;
          });
      })
      .then(storyData => {
        const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>${storyData.title}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .cover { max-width: 100%; height: auto; }
    .chapter { margin-top: 20px; margin-bottom: 20px; }
    .chapter h3 { margin-bottom: 10px; }
    .chapter p { text-align: justify; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>${storyData.title}</h1>
  <img src="${storyData.coverImage}" alt="Portada" class="cover">
  <div class="chapters">
    ${storyData.chaptersHTML}
  </div>
</body>
</html>`;
        const blob = new Blob([htmlContent], {
          type: 'text/html'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = storyData.title.replace(/\s+/g, '_') + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        icon.classList.remove('fa-spin');
        icon.classList.remove('fa-download');
        icon.classList.add('fa-check');
        alert("Historia descargada para lectura offline.");
        setTimeout(() => {
          icon.classList.remove('fa-check');
          icon.classList.add('fa-download');
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        alert("Error al descargar la historia: " + err.message);
        icon.classList.remove('fa-spin');
      });
  }
  /*********************** LIVE STREAMING **************************/
  let liveLocalStream = null;
  let livePeerConnection = null;
  let liveBroadcasting = false;
  let currentBroadcasterId = null;
  let giftListenerRef = null;

  function giftListenerCallback(snapshot) {
    let gift = snapshot.val();
    let giftUrl = "";
    if (gift.giftType === "mariposas") {
      giftUrl = "https://i.pinimg.com/originals/7c/29/36/7c2936db7563085ef7470d50fd06e4e3.gif";
    } else if (gift.giftType === "ballena") {
      giftUrl = "https://i.pinimg.com/originals/86/31/83/863183316ed35cfeda7baf9ee1de0596.gif";
    } else if (gift.giftType === "corazon_coreano") {
      giftUrl = "https://cdn.pixabay.com/animation/2022/09/17/16/20/16-20-08-700_512.gif";
    } else if (gift.giftType === "Globo") {
      giftUrl = "https://i.pinimg.com/originals/2d/f8/97/2df897364f655a0b14070a9e2f95d602.gif";
    } else if (gift.giftType === "ciudad_deseñcionada") {
      giftUrl = "https://i.pinimg.com/originals/6a/9a/74/6a9a7425e736575ee78816254227d1a8.gif";
    } else if (gift.giftType === "diamante") {
      giftUrl = "https://i.pinimg.com/originals/79/a5/49/79a54992591652b1595c6c61c49170fb.gif";
    } else if (gift.giftType === "oso_beaboo") {
      giftUrl = "https://www.icegif.com/wp-content/uploads/2021/11/icegif-346.gif";
    } else if (gift.giftType === "oso_saltarin") {
      giftUrl = "https://www.icegif.com/wp-content/uploads/2021/11/icegif-347.gif";
    } else if (gift.giftType === "besboos_carinosos") {
      giftUrl = "https://i.pinimg.com/originals/3b/d4/d9/3bd4d9778b5e0a11ab141cb7b545ab10.gif";
    } else if (gift.giftType === "besboos_leyendo") {
      giftUrl = "https://i.pinimg.com/originals/c6/41/ba/c641babc376ffe10f65ee472a646c6e1.gif";
    } else if (gift.giftType === "estrella") {
      giftUrl = "https://media3.giphy.com/media/svpuvuc70ht48WU6dj/giphy.gif?cid=6c09b952logfyfctuhi46ekgb2g7tmi345ycn9atumxwz7an&ep=v1_internal_gif_by_id&rid=giphy.gif&ct=s";
    } else if (gift.giftType === "unicornio") {
      giftUrl = "https://cdn.pixabay.com/animation/2024/12/02/02/56/02-56-03-27_512.gif";
    } else if (gift.giftType === "arcoiris") {
      giftUrl = "https://i.pinimg.com/originals/17/9c/e7/179ce7068a3c543261505ea69398b714.gif";
    } else if (gift.giftType === "pastel") {
      giftUrl = "https://i.gifer.com/3EcT.gif";
    } else if (gift.giftType === "baile") {
      giftUrl = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0_aNKZP5QwCAtf0QD5SBK4JulDqNJr6UDg8w4R-E_12arxSsP_HBQhksCL-7xfipx_uVmYbagEFjE8tZGBX-AO40PwMJvIOpr49e_sedIGjCWkUqkrUJZGR4vwr4ygNUrR1hreOsTgc4/s1600/BkM47.gif";
    } else if (gift.giftType === "musica") {
      giftUrl = "https://i.pinimg.com/originals/68/fc/a0/68fca09b36725b767735abef8c7e1117.gif";
    } else if (gift.giftType === "sol") {
      giftUrl = "https://cdn.pixabay.com/animation/2024/03/08/13/17/13-17-23-34_512.gif";
    } else if (gift.giftType === "nube") {
      giftUrl = "https://cdn.pixabay.com/animation/2022/09/17/16/20/16-20-08-700_512.gif";
    } else if (gift.giftType === "globo") {
      giftUrl = "https://images.emojiterra.com/google/noto-emoji/animated-emoji/1f388.gif";
    } else if (gift.giftType === "caramelo") {
      giftUrl = "https://i.pinimg.com/originals/e2/9c/7b/e29c7bc3faadc09dfcddb6ca11243c6d.gif";
    } else if (gift.giftType === "delfin") {
      giftUrl = "https://media.tenor.com/TyrY0krJG3kAAAAj/milk-and-mocha.gif";
    } else if (gift.giftType === "fuego") {
      giftUrl = "https://i.pinimg.com/originals/af/8a/27/af8a27bf984e189f6a6bd7a6922075c1.gif";
    }
    if (giftUrl !== "") {
      showGiftAnimation(giftUrl, gift.senderName);
    }
    snapshot.ref.remove();
  }

  function listenForGifts() {
    if (!currentBroadcasterId) return;
    giftListenerRef = firebase.database().ref(`liveStreams/${currentBroadcasterId}/gifts`);
    giftListenerRef.on('child_added', giftListenerCallback);
  }

  function stopListeningForGifts() {
    if (giftListenerRef) {
      giftListenerRef.off('child_added', giftListenerCallback);
      giftListenerRef = null;
    }
  }

  function listenForComments(broadcasterId) {
    const commentsRef = firebase.database().ref(`liveStreams/${broadcasterId}/comments`);
    commentsRef.on('child_added', snapshot => {
      const comment = snapshot.val();
      const commentElem = document.createElement('div');
      commentElem.className = 'comment-bubble';
      commentElem.textContent = comment.senderName + ": " + comment.text;
      if (document.getElementById('commentsContainerLive')) {
        document.getElementById('commentsContainerLive').appendChild(commentElem);
        setTimeout(() => {
          commentElem.remove();
        }, 3000);
      }
      if (firebase.auth().currentUser && firebase.auth().currentUser.uid === broadcasterId) {
        const bcContainer = document.getElementById('broadcasterCommentsContainer');
        if (bcContainer) {
          const clone = commentElem.cloneNode(true);
          bcContainer.appendChild(clone);
          bcContainer.scrollTop = bcContainer.scrollHeight;
        }
      }
    });
  }

  function openLiveStreamModal() {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert("Debes estar autenticado para transmitir en vivo.");
      return;
    }
    // Todos los usuarios pueden transmitir en vivo
    if (!user.email) {
      alert("Por favor verifica tu correo electrónico para transmitir en vivo.");
      return;
    }
    currentBroadcasterId = user.uid;
    let useCamera = confirm("¿Desea transmitir en vivo usando su cámara? Presione OK para cámara, Cancelar para video pregrabado.");
    if (useCamera) {
      document.getElementById('live-stream-modal').classList.remove('hidden');
      navigator.mediaDevices.getUserMedia({
          video: true,
          audio: {
            echoCancellation: true
          }
        })
        .then(stream => {
          liveLocalStream = stream;
          document.getElementById('live-localVideo').srcObject = stream;
          setTimeout(() => {
            document.getElementById('live-spinner').style.display = "none";
          }, 3000);
        })
        .catch(err => {
          alert("Error al acceder a la cámara: " + err);
        });
    } else {
      document.getElementById('live-video-input').click();
    }
    const profileImg = document.getElementById('profile-image');
    if (profileImg) {
      profileImg.classList.add('live-border');
    }
    document.getElementById('live-spinner').style.display = "flex";
    listenForComments(currentBroadcasterId);
    listenForGifts();
  }

  function handleLiveVideoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const videoElement = document.createElement('video');
    videoElement.src = URL.createObjectURL(file);
    videoElement.autoplay = true;
    videoElement.loop = true;
    videoElement.controls = true;
    videoElement.play();
    videoElement.onloadedmetadata = function() {
      const canvas = document.createElement('canvas');
      canvas.width = videoElement.videoWidth;
      canvas.height = videoElement.videoHeight;
      const ctx = canvas.getContext('2d');
      let promotionText = prompt("Ingrese información de promoción (opcional):");

      function drawFrame() {
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        ctx.font = "30px sans-serif";
        ctx.fillStyle = "rgba(88,204,2,0.7)";
        ctx.textAlign = "right";
        ctx.fillText("BeaBoo", canvas.width - 10, canvas.height - 10);
        if (promotionText) {
          ctx.font = "24px sans-serif";
          ctx.fillStyle = "rgba(255,255,255,0.8)";
          ctx.textAlign = "left";
          ctx.fillText(promotionText, 10, 30);
        }
        requestAnimationFrame(drawFrame);
      }
      drawFrame();
      let canvasStream = canvas.captureStream(30);
      let chosenAudioPromise;
      let chosenLanguage = prompt("Ingrese el idioma de audio a transmitir: 'es' para español, 'en' para inglés. Deje en blanco para usar el audio original.");
      if (chosenLanguage === "es") {
        const audioFileInput = document.getElementById('live-audio-es');
        if (audioFileInput.files.length > 0) {
          const audioFile = audioFileInput.files[0];
          let audioElement = document.createElement('audio');
          audioElement.src = URL.createObjectURL(audioFile);
          audioElement.play();
          chosenAudioPromise = new Promise(resolve => {
            audioElement.onloadedmetadata = function() {
              resolve(audioElement.captureStream().getAudioTracks()[0]);
            }
          });
        }
      } else if (chosenLanguage === "en") {
        const audioFileInput = document.getElementById('live-audio-en');
        if (audioFileInput.files.length > 0) {
          let audioElement = document.createElement('audio');
          audioElement.src = URL.createObjectURL(audioFileInput.files[0]);
          audioElement.play();
          chosenAudioPromise = new Promise(resolve => {
            audioElement.onloadedmetadata = function() {
              resolve(audioElement.captureStream().getAudioTracks()[0]);
            }
          });
        }
      }
      if (!chosenAudioPromise) {
        let videoStream = videoElement.captureStream();
        chosenAudioPromise = Promise.resolve(videoStream.getAudioTracks()[0]);
      }
      chosenAudioPromise.then(audioTrack => {
        if (audioTrack) {
          canvasStream.addTrack(audioTrack);
        }
        liveLocalStream = canvasStream;
        document.getElementById('live-stream-modal').classList.remove('hidden');
        document.getElementById('live-localVideo').srcObject = liveLocalStream;
        setTimeout(() => {
          document.getElementById('live-spinner').style.display = "none";
        }, 3000);
      });
    };
  }

  function closeLiveStreamModal() {
    document.getElementById('live-stream-modal').classList.add('hidden');
    if (liveLocalStream) {
      liveLocalStream.getTracks().forEach(track => track.stop());
      liveLocalStream = null;
    }
    if (liveBroadcasting) {
      endLiveStream();
    }
    const profileImg = document.getElementById('profile-image');
    if (profileImg) {
      profileImg.classList.remove('live-border');
    }
    stopListeningForGifts();
  }

  function startLiveCountdown(duration, callback) {
    let remaining = duration;
    const countdownEl = document.getElementById('live-countdown');
    countdownEl.textContent = remaining;
    const interval = setInterval(() => {
      remaining--;
      if (remaining > 0) {
        countdownEl.textContent = remaining;
      } else {
        clearInterval(interval);
        countdownEl.textContent = "";
        callback();
      }
    }, 1000);
  }
  document.getElementById('live-startBtn').addEventListener('click', () => {
    startLiveCountdown(10, () => {
      document.getElementById('live-indicator').classList.remove('hidden');
      document.getElementById('live-startBtn').classList.add('hidden');
      document.getElementById('live-endBtn').classList.remove('hidden');
      startBroadcasting();
    });
  });

  function startBroadcasting() {
    livePeerConnection = new RTCPeerConnection();
    liveLocalStream.getTracks().forEach(track => {
      livePeerConnection.addTrack(track, liveLocalStream);
    });
    livePeerConnection.onicecandidate = event => {
      if (event.candidate) {
        firebase.database().ref(`liveStreams/${currentBroadcasterId}/candidates`).push(event.candidate.toJSON());
      }
    };
    livePeerConnection.createOffer().then(offer => {
      return livePeerConnection.setLocalDescription(offer).then(() => offer);
    }).then(offer => {
      firebase.database().ref(`liveStreams/${currentBroadcasterId}`).set({
        isLive: true,
        offer: offer,
        views: 0
      });
      liveBroadcasting = true;
      firebase.database().ref(`liveStreams/${currentBroadcasterId}/views`).on('value', snapshot => {
        const views = snapshot.val() || 0;
        document.getElementById('live-viewCount').textContent = views + " vistas";
      });
      listenForComments(currentBroadcasterId);
    });
  }

  function endLiveStream() {
    if (livePeerConnection) {
      livePeerConnection.close();
      livePeerConnection = null;
    }
    firebase.database().ref(`liveStreams/${currentBroadcasterId}`).remove();
    liveBroadcasting = false;
    const profileImg = document.getElementById('profile-image');
    if (profileImg) {
      profileImg.classList.remove('live-border');
    }
    setTimeout(() => {
      closeLiveStreamModal();
    }, 3000);
  }
  document.getElementById('live-endBtn').addEventListener('click', () => {
    endLiveStream();
  });

  function openLiveViewModal(broadcasterId) {
    liveBroadcasterId = broadcasterId;
    firebase.database().ref('users/' + broadcasterId).once('value').then(snapshot => {
      const data = snapshot.val();
      if (data && data.username) {
        document.getElementById('streamerName').innerText = data.username;
      }
    });
    document.getElementById('live-view-modal').classList.remove('hidden');
    firebase.database().ref(`liveStreams/${broadcasterId}/views`).on('value', snapshot => {
      const views = snapshot.val() || 0;
      document.getElementById('viewerCountLive').textContent = views;
    });
    firebase.database().ref(`liveStreams/${broadcasterId}/views`).transaction(current => (current || 0) + 1);
    const viewerPC = new RTCPeerConnection();
    viewerPC.onicecandidate = event => {
      if (event.candidate) {
        firebase.database().ref(`liveStreams/${broadcasterId}/viewerCandidates`).push(event.candidate.toJSON());
      }
    };
    viewerPC.ontrack = event => {
      document.getElementById('live-remoteVideo').srcObject = event.streams[0];
    };
    firebase.database().ref(`liveStreams/${broadcasterId}/offer`).once('value').then(snapshot => {
      const offer = snapshot.val();
      if (!offer) {
        alert("El autor no está transmitiendo.");
        closeLiveViewModal();
        return;
      }
      viewerPC.setRemoteDescription(new RTCSessionDescription(offer))
        .then(() => viewerPC.createAnswer())
        .then(answer => viewerPC.setLocalDescription(answer).then(() => answer))
        .then(answer => {
          firebase.database().ref(`liveStreams/${broadcasterId}/answer`).set(answer);
        });
    });
    firebase.database().ref(`liveStreams/${broadcasterId}`).on('value', snapshot => {
      if (!snapshot.exists()) {
        document.getElementById('live-endedMessage') && document.getElementById('live-endedMessage').classList.remove('hidden');
        setTimeout(closeLiveViewModal, 3000);
      }
    });
    listenForComments(broadcasterId);
    window.currentViewerPC = viewerPC;
  }

  function closeLiveViewModal() {
    document.getElementById('live-view-modal').classList.add('hidden');
    document.getElementById('live-endedMessage') && document.getElementById('live-endedMessage').classList.add('hidden');
    if (window.currentViewerPC) {
      window.currentViewerPC.close();
      window.currentViewerPC = null;
    }
  }
  document.getElementById('gift-btn') && document.getElementById('gift-btn').addEventListener('click', () => {
    document.getElementById('gift-drawer').classList.add('open');
  });

  function closeGiftDrawer() {
    document.getElementById('gift-drawer').classList.remove('open');
  }

  function sendGift(giftType) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || currentUser.uid === liveBroadcasterId) {
      alert("No puedes enviar regalos a ti mismo.");
      return;
    }
    firebase.database().ref('users/' + liveBroadcasterId).transaction(userData => {
      if (userData) {
        userData.coins = (userData.coins || 0) + 5;
      }
      return userData;
    }).then(() => {
      let giftData = {
        giftType: giftType,
        senderName: currentUser.displayName || currentUser.email || "Alguien",
        timestamp: Date.now()
      };
      firebase.database().ref(`liveStreams/${liveBroadcasterId}/gifts`).push(giftData);
      closeGiftDrawer();
    }).catch(error => {
      console.error("Error al enviar regalo:", error);
    });
  }

  function showGiftAnimation(giftUrl, senderName) {
    const transmitBtn = document.getElementById('live-startBtn');
    if (transmitBtn) transmitBtn.style.display = 'none';
    const animContainer = document.getElementById('gift-animation');
    animContainer.innerHTML = `
        <div class="text-center">
          <p class="text-white mb-1">${senderName} ha enviado un regalo</p>
          <img src="${giftUrl}" alt="Regalo" class="mx-auto" style="max-width: 80%; max-height: 80%;">
        </div>`;
    animContainer.classList.add('show');
    setTimeout(() => {
      animContainer.classList.remove('show');
    }, 4000);
  }
  /*********************** REPORTAR HISTORIA Y BLOQUEO **************************/
  let lastX = null,
    lastY = null,
    lastZ = null;
  let shakeThreshold = 15;
  let shakeTimeout = null;

  function deviceMotionHandler(event) {
    const acceleration = event.accelerationIncludingGravity;
    if (!acceleration) return;
    const {
      x,
      y,
      z
    } = acceleration;
    if (lastX === null) {
      lastX = x;
      lastY = y;
      lastZ = z;
      return;
    }
    const deltaX = Math.abs(x - lastX);
    const deltaY = Math.abs(y - lastY);
    const deltaZ = Math.abs(z - lastZ);
    if (deltaX + deltaY + deltaZ > shakeThreshold) {
      if (!shakeTimeout) {
        triggerReportModal();
        shakeTimeout = setTimeout(() => {
          shakeTimeout = null;
        }, 1000);
      }
    }
    lastX = x;
    lastY = y;
    lastZ = z;
  }

  function initShakeDetection() {
    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', deviceMotionHandler, false);
    } else {
      console.log("DeviceMotionEvent no está soportado");
    }
  }

  function triggerReportModal() {
    const storyDetailModal = document.getElementById('story-detail-modal');
    if (storyDetailModal && !storyDetailModal.classList.contains('hidden')) {
      openReportStoryModal();
    }
  }

  function openReportStoryModal() {
    const reportModal = document.getElementById('report-story-modal');
    if (reportModal) {
      reportModal.style.display = 'block';
      setTimeout(() => {
        reportModal.style.transform = 'translateY(0)';
      }, 10);
    }
  }

  function closeReportStoryModal() {
    const reportModal = document.getElementById('report-story-modal');
    if (reportModal) {
      reportModal.style.transform = 'translateY(100%)';
      setTimeout(() => {
        reportModal.style.display = 'none';
      }, 300);
    }
  }
  document.getElementById('report-story-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const reason = formData.get('reportReason');
    const description = document.getElementById('report-story-description').value;
    if (!window.currentStoryId) {
      alert("No se ha seleccionado una historia.");
      return;
    }
    const user = firebase.auth().currentUser;
    if (!user) {
      alert("Debes estar autenticado para reportar.");
      return;
    }
    const reportData = {
      reporter: user.uid,
      reporterName: user.displayName || user.email,
      storyId: window.currentStoryId,
      reason: reason,
      description: description,
      timestamp: Date.now(),
      status: "pending"
    };
    firebase.database().ref('storyReports').push(reportData)
      .then(() => {
        alert("Reporte enviado.");
        closeReportStoryModal();
      })
      .catch(error => {
        console.error("Error al enviar reporte:", error);
      });
  });

  function listenForStoryBlock(storyId) {
    firebase.database().ref('stories/' + storyId + '/blocked').on('value', snapshot => {
      if (snapshot.exists() && snapshot.val() === true) {
        openStoryBlockedModal();
      }
    });
  }

  function openStoryBlockedModal() {
    const modal = document.getElementById('story-blocked-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
  }
  let blockedStartX = null;
  const storyBlockedModal = document.getElementById('story-blocked-modal');
  if (storyBlockedModal) {
    storyBlockedModal.addEventListener('touchstart', function(e) {
      blockedStartX = e.touches[0].clientX;
    });
    storyBlockedModal.addEventListener('touchmove', function(e) {
      if (blockedStartX === null) return;
      const diffX = blockedStartX - e.touches[0].clientX;
      if (diffX > 100) {
        triggerBlockedAnimation();
        blockedStartX = null;
      }
    });
  }

  function triggerBlockedAnimation() {
    const dot1 = document.createElement('div');
    const dot2 = document.createElement('div');
    [dot1, dot2].forEach(dot => {
      dot.style.position = 'absolute';
      dot.style.width = '20px';
      dot.style.height = '20px';
      dot.style.backgroundColor = '#58CC02';
      dot.style.borderRadius = '50%';
      dot.style.transition = 'all 0.5s ease-in-out';
    });
    dot1.style.top = '50%';
    dot1.style.left = '10%';
    dot2.style.top = '50%';
    dot2.style.left = '80%';
    storyBlockedModal.appendChild(dot1);
    storyBlockedModal.appendChild(dot2);
    setTimeout(() => {
      dot1.style.left = '45%';
      dot2.style.left = '55%';
    }, 100);
    setTimeout(() => {
      storyBlockedModal.style.display = 'none';
      dot1.remove();
      dot2.remove();
    }, 1000);
  }
  window.addEventListener('load', initShakeDetection);
  /*********************** MODAL DE CREACIÓN DE CAPÍTULO **************************/
  document.getElementById('font-family').addEventListener('change', function() {
    document.getElementById('chapter-content').style.fontFamily = this.value;
  });
  document.getElementById('font-size').addEventListener('input', function() {
    var size = this.value;
    document.getElementById('chapter-content').style.fontSize = size + "px";
    document.getElementById('font-size-value').innerText = size + "px";
  });
  document.getElementById('chapter-content').addEventListener('input', function() {
    var text = this.value;
    var words = text.trim().split(/\s+/).filter(word => word.length > 0);
    document.getElementById('word-count').innerText = words.length + " palabras";
    document.getElementById('letter-count').innerText = text.replace(/\s/g, "").length + " letras";
  });
  /*********************** NUEVAS FUNCIONES: SUGERENCIAS Y AUTORES DESTACADOS **************************/
  function loadSuggestedStories() {
    firebase.database().ref('stories').once('value').then(snapshot => {
      let stories = [];
      snapshot.forEach(child => {
        let story = child.val();
        story.id = child.key;
        stories.push(story);
      });
      stories.sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0));
      let suggested = stories.slice(0, 10);
      const container = document.getElementById('suggested-stories');
      container.innerHTML = '';
      suggested.forEach(story => {
        const card = document.createElement('div');
        card.className = 'story-card cursor-pointer';
        card.onclick = () => openStoryDetail(story);
        card.innerHTML = `
              <div class="rounded-2xl overflow-hidden shadow-md">
                <div class="story-cover-container">
                  <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="story-cover-image">
                </div>
              </div>
              <div class="mt-2">
                <h3 class="font-semibold text-sm">${story.title}</h3>
              </div>
            `;
        container.appendChild(card);
      });
    });
  }

  function loadFeaturedAuthors() {
    firebase.database().ref('stories').once('value').then(snapshot => {
      let authorCounts = {};
      snapshot.forEach(child => {
        let story = child.val();
        if (story && story.userId) {
          if (!authorCounts[story.userId]) authorCounts[story.userId] = 0;
          authorCounts[story.userId]++;
        }
      });
      let authorsArray = [];
      for (let uid in authorCounts) {
        authorsArray.push({
          uid: uid,
          count: authorCounts[uid]
        });
      }
      authorsArray.sort((a, b) => b.count - a.count);
      let topAuthors = authorsArray.slice(0, 10);
      const container = document.getElementById('featured-authors');
      container.innerHTML = '';
      topAuthors.forEach(author => {
        firebase.database().ref('users/' + author.uid).once('value').then(userSnap => {
          const userData = userSnap.val();
          const card = document.createElement('div');
          card.className = 'story-card cursor-pointer';
          card.onclick = () => openAuthorProfile(author.uid);
          card.innerHTML = `
                <div class="rounded-2xl overflow-hidden shadow-md">
                  <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" alt="${userData.username}" class="w-full h-40 object-cover">
                </div>
                <div class="mt-2">
                  <h3 class="font-semibold text-sm">${userData.username}</h3>
                </div>
              `;
          container.appendChild(card);
        });
      });
    });
  }
  /*************** FIN NUEVAS FUNCIONES **************************/
</script>
<!-- NUEVO SCRIPT: Función para descargar la historia completa y almacenarla offline -->
<script>
  function downloadStory() {
    if (!window.currentStoryId) {
      alert("No se ha seleccionado una historia.");
      return;
    }
    const storyId = window.currentStoryId;
    const btn = document.getElementById('download-story-btn');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    firebase.database().ref('stories/' + storyId).once('value')
      .then(storySnap => {
        const storyData = storySnap.val();
        if (!storyData) {
          throw new Error("Historia no encontrada");
        }
        return firebase.database().ref('stories/' + storyId + '/chapters').once('value')
          .then(chaptersSnap => {
            let chaptersHTML = '';
            chaptersSnap.forEach(child => {
              const chapter = child.val();
              chapter.id = child.key;
              // Se crea un bloque para cada capítulo con título y contenido completo
              chaptersHTML += `<div class="chapter" style="margin-bottom:20px;">
                  <h3 style="margin-bottom:10px;">Capítulo ${chapter.chapterNumber}</h3>
                  <p style="text-align:justify; white-space: pre-wrap;">${chapter.content}</p>
                </div>`;
            });
            storyData.chaptersHTML = chaptersHTML;
            return storyData;
          });
      })
      .then(storyData => {
        const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>${storyData.title}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .cover { max-width: 100%; height: auto; }
    .chapter { margin-top: 20px; margin-bottom: 20px; }
    .chapter h3 { margin-bottom: 10px; }
    .chapter p { text-align: justify; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>${storyData.title}</h1>
  <img src="${storyData.coverImage}" alt="Portada" class="cover">
  <div class="chapters">
    ${storyData.chaptersHTML}
  </div>
</body>
</html>`;
        const blob = new Blob([htmlContent], {
          type: 'text/html'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = storyData.title.replace(/\s+/g, '_') + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        icon.classList.remove('fa-spin');
        icon.classList.remove('fa-download');
        icon.classList.add('fa-check');
        alert("Historia descargada para lectura offline.");
        setTimeout(() => {
          icon.classList.remove('fa-check');
          icon.classList.add('fa-download');
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        alert("Error al descargar la historia: " + err.message);
        icon.classList.remove('fa-spin');
      });
  }
</script>
<!-- BEABOO STUDIO SECTION -->
<div id="beaboo-studio-modal" class="fixed inset-0 z-50 hidden bg-white overflow-y-auto">
  <div class="p-4">
    <!-- Botón Volver -->
    <button onclick="closeBeabooStudio()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>

    <h2 class="text-2xl font-bold mb-6">BeaBoo Studio</h2>

    <!-- Selector de Fechas -->
    <div class="mb-6 flex items-center space-x-4">
      <select id="date-range" class="p-2 border rounded-lg">
        <option value="7">Últimos 7 días</option>
        <option value="30">Últimos 30 días</option>
        <option value="90">Últimos 3 meses</option>
        <option value="365">Último año</option>
      </select>
      <div class="flex items-center space-x-2">
        <input type="date" id="date-start" class="p-2 border rounded-lg">
        <span>hasta</span>
        <input type="date" id="date-end" class="p-2 border rounded-lg">
      </div>
      <button onclick="updateStudioStats()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg">
        Actualizar
      </button>
    </div>

    <!-- Panel de Estadísticas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Total Historias</h3>
        <p id="total-stories" class="text-2xl font-bold">0</p>
        <p id="stories-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Total Vistas</h3>
        <p id="total-views" class="text-2xl font-bold">0</p>
        <p id="views-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Seguidores</h3>
        <p id="total-followers" class="text-2xl font-bold">0</p>
        <p id="followers-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Calificación</h3>
        <p id="average-rating" class="text-2xl font-bold">0.0</p>
        <p id="rating-trend" class="text-sm text-green-500">+0%</p>
      </div>
    </div>

    <!-- Gráficos de Tendencias -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-lg font-bold mb-4">Tendencias de Lectura</h3>
        <canvas id="reading-trends" class="w-full h-64"></canvas>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-lg font-bold mb-4">Interacción por Hora</h3>
        <canvas id="hourly-engagement" class="w-full h-64"></canvas>
      </div>
    </div>

    <!-- Gestión de Historias -->
    <div class="bg-white rounded-xl shadow p-4 mb-8">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Mis Historias</h3>
        <div class="flex space-x-4">
          <button onclick="openStoryCreation()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Nueva Historia
          </button>
          <button onclick="analyzeAccount()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Analizar Cuenta
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-4 text-left">Historia</th>
              <th class="p-4 text-left">Capítulos</th>
              <th class="p-4 text-left">Vistas</th>
              <th class="p-4 text-left">Rating</th>
              <th class="p-4 text-left">Estado</th>
              <th class="p-4 text-left">Acciones</th>
            </tr>
          </thead>
          <tbody id="stories-table" class="divide-y divide-gray-200">
            <!-- Las historias se cargarán aquí dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Insights y Recomendaciones -->
    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="text-lg font-bold mb-4">Insights</h3>
      <div id="insights" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="font-bold text-blue-700">Mejor hora para publicar</h4>
          <p id="best-time" class="mt-2">Analizando datos...</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <h4 class="font-bold text-green-700">Contenido más exitoso</h4>
          <p id="best-content" class="mt-2">Analizando datos...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CALENDARIO -->
<div id="calendar-modal" class="fixed inset-0 z-50 hidden bg-white">
  <div class="p-4">
    <!-- Botón Volver -->
    <button onclick="closeCalendar()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>

    <h2 class="text-2xl font-bold mb-4">Próximas Publicaciones</h2>
    <div id="scheduled-content" class="space-y-4">
      <!-- Aquí se mostrarán los capítulos programados -->
    </div>
  </div>
</div>

<script>
function openDisneyModal() {
  const modal = document.getElementById('disney-modal');
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeDisneyModal() {
  const modal = document.getElementById('disney-modal');
  modal.classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function openCalendar() {
  const modal = document.getElementById('calendar-modal');
  modal.classList.remove('hidden');
  
  // Cargar capítulos programados
  firebase.database().ref('scheduledChapters').once('value').then(snapshot => {
    const container = document.getElementById('scheduled-content');
    container.innerHTML = '';
    
    snapshot.forEach(child => {
      const scheduled = child.val();
      const storyId = scheduled.storyId;
      const releaseDate = new Date(scheduled.publishDate);
      const now = new Date();
      const daysUntil = Math.ceil((releaseDate - now) / (1000 * 60 * 60 * 24));
      const isAvailable = now >= releaseDate;
      
      // Obtener información de la historia
      firebase.database().ref('stories/' + storyId).once('value').then(storySnap => {
        const story = storySnap.val();
        const isNew = (now - new Date(story.createdAt)) < 7 * 24 * 60 * 60 * 1000; // 7 días
        
        const div = document.createElement('div');
        div.className = 'bg-gray-100 p-4 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center space-x-4">
            <img src="${story.coverImage || '/api/placeholder/100/150'}" alt="${story.title}" class="w-20 h-30 object-cover rounded">
            <div class="flex-1">
              <div class="flex items-center">
                <h3 class="font-bold">${story.title}</h3>
                ${isNew ? '<span class="ml-2 bg-[#FE2C55] text-white px-2 py-1 rounded text-xs">ESTRENO</span>' : ''}
              </div>
              <p class="text-gray-600">Capítulo ${scheduled.chapterNumber}</p>
              ${isAvailable ? 
                `<button onclick="openChapterReadModal('${storyId}', '${child.key}')" 
                  class="bg-[#58CC02] text-white px-3 py-1 rounded-full text-sm">
                  Leer ahora
                </button>` : 
                `<p class="text-gray-600">Se publicará en ${daysUntil} días</p>
                 <p class="text-gray-600">Fecha: ${releaseDate.toLocaleDateString()}</p>`
              }
            </div>
            ${isNew ? `
  <div class="flex flex-wrap items-center gap-2">
    <span class="bg-[#FE2C55] text-white px-2 py-1 rounded text-xs">ESTRENO</span>
    <button 
      onclick="toggleNotification(event, '${storyId}', '${child.key}', '${story.title}', ${scheduled.publishDate})"
      class="notification-bell-btn inline-flex items-center px-2 py-1 text-gray-600 hover:text-[#FE2C55] transition-colors"
    >
      <i class="fas fa-bell notification-bell text-sm"></i>
      <span class="ml-1 text-xs">Avisarme</span>
    </button>
  </div>
` : ''}
          </div>
        `;
        
        container.appendChild(div);

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
          .notification-bell {
            transform-origin: top;
          }
          
          .notification-bell.active {
            color: #FE2C55;
            animation: bellRing 1s ease-in-out;
          }
          
          @keyframes bellRing {
            0%, 100% { transform: rotate(0); }
            20%, 60% { transform: rotate(25deg); }
            40%, 80% { transform: rotate(-25deg); }
          }
        `;
        document.head.appendChild(style);
        
        // Programar notificación
        const user = firebase.auth().currentUser;
        if (user) {
          const notificationTime = new Date(scheduled.publishDate);
          const currentTime = new Date();
          
          if (notificationTime > currentTime) {
            const timeUntilNotification = notificationTime.getTime() - currentTime.getTime();
            
            setTimeout(() => {
              addNotification(user.uid, `¡Tu capítulo programado de "${story.title}" ha sido publicado!`, 'chapter_published');
              
              // Solo actualizar cuando llegue la fecha de publicación
              if (new Date() >= notificationTime) {
                firebase.database().ref('stories/' + storyId + '/chapters/' + child.key).update({
                  status: 'published'
                });
              }
              
              // Eliminar de capítulos programados
              firebase.database().ref('scheduledChapters/' + child.key).remove();
            }, timeUntilNotification);
          }
        }
      });
    });
  });
}

function closeCalendar() {
  document.getElementById('calendar-modal').classList.add('hidden');
}

function toggleNotification(event, storyId, chapterId, storyTitle, publishDate) {
  event.stopPropagation();
  const user = firebase.auth().currentUser;
  if (!user) return;

  const bell = event.currentTarget.querySelector('.notification-bell');
  bell.classList.add('active');
  
  // Toggle notification in database
  const notificationRef = firebase.database().ref(`userNotifications/${user.uid}/${chapterId}`);
  
  notificationRef.once('value').then(snapshot => {
    if (snapshot.exists()) {
      // Remove notification
      notificationRef.remove();
      bell.style.color = '#666';
      alert('Notificación cancelada');
    } else {
      // Add notification
      notificationRef.set({
        storyId,
        storyTitle,
        publishDate,
        status: 'pending'
      });
      bell.style.color = '#FE2C55';
      alert('¡Te avisaremos cuando se publique el capítulo!');

      // Schedule notification
      const notificationTime = new Date(publishDate);
      const currentTime = new Date();
      
      if (notificationTime > currentTime) {
        const timeUntilNotification = notificationTime.getTime() - currentTime.getTime();
        
        setTimeout(() => {
          addNotification(
            user.uid, 
            `¡El nuevo capítulo de "${storyTitle}" ya está disponible!`,
            'chapter_release'
          );
        }, timeUntilNotification);
      }
    }
  });

  setTimeout(() => {
    bell.classList.remove('active');
  }, 1000);
}

function openBeabooStudio() {
  const user = firebase.auth().currentUser;
  if (!user) return;
  
  document.getElementById('beaboo-studio-modal').classList.remove('hidden');
  
  // Establecer fechas por defecto
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - 7);
  document.getElementById('date-start').value = start.toISOString().split('T')[0];
  document.getElementById('date-end').value = end.toISOString().split('T')[0];
  
  updateStudioStats();
}

function updateStudioStats() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const startDate = new Date(document.getElementById('date-start').value);
  const endDate = new Date(document.getElementById('date-end').value);
  
  firebase.database().ref('stories').orderByChild('userId').equalTo(user.uid).once('value')
    .then(snapshot => {
      let totalStories = 0;
      let totalViews = 0;
      let totalRating = 0;
      let ratingCount = 0;
      let viewsData = {};
      let hourlyData = new Array(24).fill(0);
      
      // Procesar datos
      snapshot.forEach(child => {
        const story = child.val();
        const storyDate = new Date(story.createdAt);
        
        if (storyDate >= startDate && storyDate <= endDate) {
          totalStories++;
          totalViews += story.views || 0;
          
          // Datos por hora
          const hour = storyDate.getHours();
          hourlyData[hour] += story.views || 0;
          
          // Datos para gráfico de tendencias
          const dateStr = storyDate.toLocaleDateString();
          viewsData[dateStr] = (viewsData[dateStr] || 0) + (story.views || 0);
          
          if (story.ratings) {
            Object.values(story.ratings).forEach(rating => {
              totalRating += rating;
              ratingCount++;
            });
          }
        }
        
        // Actualizar tabla de historias
        updateStoriesTable(story);
      });
      
      // Actualizar estadísticas
      updateStatistics(totalStories, totalViews, totalRating, ratingCount);
      
      // Actualizar gráficos
      updateCharts(viewsData, hourlyData);
      
      // Calcular y mostrar insights
      calculateInsights(hourlyData, viewsData);
    });
}

function updateStoriesTable(story) {
  const tbody = document.getElementById('stories-table');
  const row = document.createElement('tr');
  row.className = 'hover:bg-gray-50';
  
  const status = story.status || 'published';
  const statusColors = {
    'published': 'bg-green-100 text-green-800',
    'draft': 'bg-gray-100 text-gray-800',
    'scheduled': 'bg-blue-100 text-blue-800'
  };
  
  row.innerHTML = `
    <td class="p-4">
      <div class="flex items-center space-x-3">
        <img src="${story.coverImage || '/api/placeholder/50/75'}" class="w-12 h-16 object-cover rounded" alt="${story.title}">
        <div>
          <h4 class="font-bold">${story.title}</h4>
          <p class="text-sm text-gray-600">${new Date(story.createdAt).toLocaleDateString()}</p>
        </div>
      </div>
    </td>
    <td class="p-4">${(story.chapters || []).length}</td>
    <td class="p-4">${story.views || 0}</td>
    <td class="p-4">${calculateAverageRating(story.ratings)}</td>
    <td class="p-4">
      <span class="px-2 py-1 rounded-full text-xs ${statusColors[status]}">
        ${status.charAt(0).toUpperCase() + status.slice(1)}
      </span>
    </td>
    <td class="p-4">
      <div class="flex space-x-2">
        <button onclick="openStoryEdit(${JSON.stringify(story)})" class="text-blue-600 hover:text-blue-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        </button>
        <button onclick="openChapterCreationModal()" class="text-green-600 hover:text-green-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>
    </td>
  `;
  
  tbody.appendChild(row);
}

function updateStatistics(totalStories, totalViews, totalRating, ratingCount) {
  document.getElementById('total-stories').textContent = totalStories;
  document.getElementById('total-views').textContent = totalViews;
  document.getElementById('average-rating').textContent = 
    ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : "0.0";
  
  // Actualizar tendencias (ejemplo)
  document.getElementById('stories-trend').textContent = '+5%';
  document.getElementById('views-trend').textContent = '+12%';
  document.getElementById('rating-trend').textContent = '+2%';
}

function updateCharts(viewsData, hourlyData) {
  // Gráfico de tendencias
  const trendCtx = document.getElementById('reading-trends').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: Object.keys(viewsData),
      datasets: [{
        label: 'Vistas',
        data: Object.values(viewsData),
        borderColor: '#FE2C55',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
  
  // Gráfico de actividad por hora
  const hourlyCtx = document.getElementById('hourly-engagement').getContext('2d');
  new Chart(hourlyCtx, {
    type: 'bar',
    data: {
      labels: Array.from({length: 24}, (_, i) => `${i}:00`),
      datasets: [{
        label: 'Actividad',
        data: hourlyData,
        backgroundColor: '#FE2C55'
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function calculateInsights(hourlyData, viewsData) {
  // Calcular mejor hora para publicar
  const bestHour = hourlyData.indexOf(Math.max(...hourlyData));
  document.getElementById('best-time').textContent = 
    `La mejor hora para publicar es a las ${bestHour}:00, donde tienes mayor engagement.`;
  
  // Calcular contenido más exitoso
  const bestDate = Object.entries(viewsData)
    .reduce((a, b) => (b[1] > a[1] ? b : a))[0];
  document.getElementById('best-content').textContent = 
    `Tu contenido más exitoso fue publicado el ${bestDate}.`;
}

function calculateAverageRating(ratings) {
  if (!ratings) return "0.0";
  const values = Object.values(ratings);
  return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
}

function analyzeAccount() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  // Show analysis modal
  const analysisModal = document.createElement('div');
  analysisModal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[60]';
  analysisModal.innerHTML = `
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
      <div id="analysis-loading" class="text-center">
        <div class="spinner-ring mb-4">
          <div></div><div></div><div></div><div></div>
        </div>
        <h3 class="text-xl font-bold mb-2">Analizando cuenta</h3>
        <p id="analysis-status" class="text-gray-600">Recopilando datos...</p>
      </div>
      <div id="analysis-results" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">Resultados del análisis</h3>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="analysis-metrics" class="space-y-4"></div>
      </div>
    </div>
  `;

  document.body.appendChild(analysisModal);

  // Add spinner styles
  const style = document.createElement('style');
  style.textContent = `
    .spinner-ring {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }
    .spinner-ring div {
      box-sizing: border-box;
      display: block;
      position: absolute;
      width: 64px;
      height: 64px;
      margin: 8px;
      border: 8px solid #FE2C55;
      border-radius: 50%;
      animation: spinner-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
      border-color: #FE2C55 transparent transparent transparent;
    }
    .spinner-ring div:nth-child(1) { animation-delay: -0.45s; }
    .spinner-ring div:nth-child(2) { animation-delay: -0.3s; }
    .spinner-ring div:nth-child(3) { animation-delay: -0.15s; }
    @keyframes spinner-ring {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);

  // Start analysis
  let statusText = document.getElementById('analysis-status');
  let analysisData = {
    followers: 0,
    following: 0,
    posts: 0,
    warnings: [],
    suspiciousActivity: []
  };

  // Simulate analysis steps
  setTimeout(() => {
    statusText.textContent = "Analizando seguidores...";
    firebase.database().ref('followers/' + user.uid).once('value', snapshot => {
      analysisData.followers = snapshot.numChildren() || 0;
    });
  }, 5000);

  setTimeout(() => {
    statusText.textContent = "Analizando seguidos...";
    firebase.database().ref('following/' + user.uid).once('value', snapshot => {
      analysisData.following = snapshot.numChildren() || 0;
    });
  }, 10000);

  setTimeout(() => {
    statusText.textContent = "Verificando historial...";
    firebase.database().ref('userWarnings/' + user.uid).once('value', snapshot => {
      if (snapshot.exists()) {
        snapshot.forEach(child => {
          analysisData.warnings.push(child.val());
        });
      }
    });
  }, 15000);

  // Show results after 20 seconds
  setTimeout(() => {
    const loading = document.getElementById('analysis-loading');
    const results = document.getElementById('analysis-results');
    const metrics = document.getElementById('analysis-metrics');

    loading.classList.add('hidden');
    results.classList.remove('hidden');

    // Calculate account status
    let accountStatus = analysisData.warnings.length === 0 ? 
      { text: 'Cuenta en buen estado', color: 'bg-green-100 text-green-800' } :
      analysisData.warnings.length <= 2 ?
      { text: 'Advertencias activas', color: 'bg-yellow-100 text-yellow-800' } :
      { text: 'Cuenta en riesgo', color: 'bg-red-100 text-red-800' };

    metrics.innerHTML = `
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.followers}</div>
          <div class="text-sm text-gray-600">Seguidores</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.following}</div>
          <div class="text-sm text-gray-600">Seguidos</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.posts}</div>
          <div class="text-sm text-gray-600">Publicaciones</div>
        </div>
      </div>
      
      <div class="space-y-4">
        <div class="p-4 rounded-xl ${accountStatus.color}">
          <div class="font-bold">${accountStatus.text}</div>
        </div>
        
        ${analysisData.warnings.length > 0 ? `
          <div class="p-4 rounded-xl bg-gray-50">
            <div class="font-bold mb-2">Advertencias:</div>
            <ul class="list-disc list-inside space-y-1">
              ${analysisData.warnings.map(w => `<li>${w}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
    `;
  }, 20000);
}

function closeBeabooStudio() {
  document.getElementById('beaboo-studio-modal').classList.add('hidden');
  document.getElementById('story-stats').innerHTML = '';
}

<!-- Script para la vista de Live (Duolingo Live Style) -->
  const liveContainer = document.getElementById('liveContainer');
  const heartButton = document.getElementById('heartButton');
  const heartButtonViewer = document.getElementById('heartButtonViewer');
  const likeCountLive = document.getElementById('likeCountLive');
  let likesLive = 0;

  function createHeart(x, y) {
    const heart = document.createElement('img');
    heart.src = "https://cdn-0.emojis.wiki/emoji-pics/twitter/green-heart-twitter.png";
    heart.className = 'floating-heart';
    heart.style.position = 'absolute';
    heart.style.left = `${x - 12}px`;
    heart.style.top = `${y - 12}px`;
    liveContainer.appendChild(heart);
    setTimeout(() => {
      heart.remove();
    }, 1500);
  }

  function updateLikeCountLive() {
    likesLive++;
    if (likesLive >= 1000) {
      likeCountLive.textContent = (likesLive / 1000).toFixed(1) + 'K';
    } else {
      likeCountLive.textContent = likesLive;
    }
  }
  heartButton.addEventListener('click', () => {
    const rect = heartButton.getBoundingClientRect();
    createHeart(rect.left + rect.width / 2, rect.top + rect.height / 2);
    updateLikeCountLive();
  });
</script>

<!-- (El modal de compra de monedas ha sido removido) -->

<!-- Aquí se agregan las funciones para reportar perfil -->
<script>
  function openReportModal() {
    const modal = document.getElementById('report-modal');
    const modalContent = modal.querySelector('div');
    modal.style.display = 'flex';
    requestAnimationFrame(() => {
      modal.classList.remove('opacity-0', 'pointer-events-none');
      modalContent.classList.remove('translate-y-full');
    });
  }

  function closeReportModal() {
    const modal = document.getElementById('report-modal');
    const modalContent = modal.querySelector('div');
    modalContent.classList.add('translate-y-full');
    modal.classList.add('opacity-0', 'pointer-events-none');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }
</script>
<script>
  const translations = {
    es: {
      appName: "BeaBoo",
      tagline: "Tu portal de historias inolvidables",
      authTitle: "BeaBoo",
      emailPlaceholder: "Correo electrónico",
      passwordPlaceholder: "Contraseña",
      btnIniciarSesion: "Iniciar Sesión",
      btnToggleAuth: "¿No tienes cuenta? Regístrate",
      btnVolver: "Volver",
      newReleases: "Nuevos Lanzamientos",
      top10: "Top 10",
      popular: "Más Populares",
      terror: "Historias de Terror Destacadas",
      searchPlaceholder: "Buscar historias o autores",
      searchResults: "Resultados de búsqueda",
      searchBooks: "Libros",
      searchAuthors: "Autores",
      profileStories: "Mis Historias",
      editProfile: "Editar nombre",
      saveBio: "Guardar biografía",
      createStory: "Crear Historia",
      storyTitlePlaceholder: "Título de la historia",
      selectCategory: "Selecciona una categoría",
      btnCreateStory: "Crear Historia",
      editStory: "Editar Historia",
      addChapter: "Agregar Capítulo",
      deleteStory: "Eliminar Historia",
      makePrivate: "Hacer privada",
      chapterCreationTitle: "Agregar Nuevo Capítulo",
      chapterPlaceholder: "Escribe el contenido del capítulo aquí...",
      btnSaveChapter: "Guardar Capítulo",
      readChapter: "Capítulo",
      btnPrevChapter: "Anterior",
      btnNextChapter: "Siguiente",
      rateChapter: "Califica:",
      authorProfile: "Por",
      reportProfile: "Reportar Perfil",
      reportInstructions: "Selecciona un motivo o describe el problema:",
      btnSendReport: "Enviar Reporte",
      reportSuccess: "Reporte enviado con éxito. En breve recibirás una respuesta.",
      noInfraccion: "No se detectaron infracciones en este perfil.",
      followers: "Seguidores",
      following: "Siguiendo",
      ratings: "Calificaciones",
      languageModalTitle: "Selecciona tu idioma",
      editUsernamePrompt: "Introduce tu nuevo nombre de usuario:",
      usernameUpdated: "Nombre de usuario actualizado.",
      bioUpdated: "Biografía actualizada.",
      chapterAdded: "Capítulo agregado.",
      noEditingStory: "No hay historia en edición.",
      userNotAuthenticated: "Usuario no autenticado.",
      chapterNotFound: "Capítulo no encontrado.",
      firstChapter: "Este es el primer capítulo.",
      lastChapter: "Este es el último capítulo.",
      chapterRated: "Capítulo calificado con {value} estrella(s).",
      followSelfError: "No puedes seguirte a ti mismo.",
      nowFollowing: "Ahora sigues a este autor.",
      stoppedFollowing: "Has dejado de seguir a este autor.",
      alreadyFollowing: "Ya sigues a este usuario.",
      storyDeleted: "Historia eliminada.",
      editLater: "Puedes editar tu historia más tarde desde tu perfil."
    },
    en: {
      appName: "BeaBoo",
      editLater: "You can edit your story later from your profile."
    },
    pt: {
      appName: "BeaBoo",
      tagline: "Seu portal para histórias inesquecíveis",
      editLater: "Você pode editar sua história mais tarde em seu perfil."
    }
  };
  // Función que actualiza los textos de la interfaz según currentLanguage
  function updateTranslations() {
    // Ejemplo: Actualizamos el título de la aplicación y el tagline
    document.getElementById('app-name').innerText = translations[currentLanguage].appName;
    document.getElementById('tagline').innerText = translations[currentLanguage].tagline;
    // ... (continúa actualizando todos los elementos que dependan de traducciones)
  }
  // Función para establecer el idioma y guardar la selección
  function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem("selectedLanguage", lang);
    const langOverlay = document.getElementById('lang-loading-overlay');
    if (langOverlay) langOverlay.style.display = "flex";
    setTimeout(() => {
      updateTranslations();
      if (langOverlay) langOverlay.style.display = "none";
      const langModal = document.getElementById('language-modal');
      if (langModal) langModal.style.display = "none";
    }, 1000);
  }

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }
</script>

</body>
</html>
